---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import { supabase } from '../../lib/supabase';

// Check if site_settings table exists
let tableExists = false;
let errorMessage = '';

try {
  const { data, error } = await supabase
    .from('site_settings')
    .select('id')
    .eq('id', 'main')
    .single();

  if (data) {
    tableExists = true;
  } else if (error && error.code !== 'PGRST116') {
    errorMessage = error.message;
  }
} catch (e) {
  errorMessage = e instanceof Error ? e.message : 'Unknown error';
}

const projectRef = 'epsjdbnxhmeprjrgcbyw';
const sqlEditorUrl = `https://supabase.com/dashboard/project/${projectRef}/sql/new`;

const migrationSQL = `-- Create site_settings table
CREATE TABLE site_settings (
  id TEXT PRIMARY KEY DEFAULT 'main',
  site_name TEXT DEFAULT 'Qurbani Foundation USA',
  site_tagline TEXT DEFAULT 'A Muslim Charity Serving Humanity',
  site_logo TEXT DEFAULT 'https://www.staging9.qurbani.com/wp-content/uploads/2021/07/QurbaniFoundation-Logo-2.png',
  contact_phone TEXT DEFAULT '+1 (703) 596-4900',
  contact_toll_free TEXT DEFAULT '1-800-900-0027',
  contact_email TEXT DEFAULT 'info@qurbani.com',
  contact_address_street TEXT DEFAULT '145 Sherwood Ave',
  contact_address_city TEXT DEFAULT 'Teaneck',
  contact_address_state TEXT DEFAULT 'NJ',
  contact_address_zip TEXT DEFAULT '07666',
  social_facebook TEXT DEFAULT 'https://facebook.com/qurbani',
  social_youtube TEXT DEFAULT 'https://youtube.com/qurbani',
  social_instagram TEXT DEFAULT 'https://instagram.com/qurbani',
  social_twitter TEXT DEFAULT 'https://twitter.com/qurbani',
  footer_about TEXT DEFAULT 'A Muslim charity dedicated to alleviating suffering of the world''s poorest people. Operating in 53+ countries since 1999.',
  footer_zakat_policy TEXT DEFAULT '100% Zakat Policy',
  footer_ein TEXT DEFAULT '38-4109716',
  footer_copyright TEXT DEFAULT 'Qurbani Foundation USA. All rights reserved.',
  donate_button_text TEXT DEFAULT 'DONATE NOW',
  donate_button_href TEXT DEFAULT '/donate',
  donate_button_color TEXT DEFAULT '#fdc448',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert default row
INSERT INTO site_settings (id) VALUES ('main');

-- Enable Row Level Security with open policy
ALTER TABLE site_settings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow all" ON site_settings FOR ALL USING (true) WITH CHECK (true);`;
---
export const prerender = false;

<AdminLayout title="Database Setup">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Database Setup</h1>

    {tableExists ? (
      <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h2 class="text-lg font-semibold text-green-800">Database Ready!</h2>
            <p class="text-green-600">The site_settings table exists and is configured correctly.</p>
          </div>
        </div>
        <div class="mt-4">
          <a href="/admin/settings/header-footer" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
            Go to Settings
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
      </div>
    ) : (
      <div class="space-y-6">
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
          <div class="flex items-center gap-3 mb-4">
            <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
              <h2 class="text-lg font-semibold text-yellow-800">Setup Required</h2>
              <p class="text-yellow-600">The site_settings table needs to be created in your Supabase database.</p>
            </div>
          </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Setup (2 steps)</h3>

          <div class="space-y-4">
            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-teal-100 text-teal-700 rounded-full flex items-center justify-center font-bold">1</div>
              <div class="flex-1">
                <p class="font-medium text-gray-800 mb-2">Copy the SQL below</p>
                <div class="relative">
                  <pre id="sqlCode" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto max-h-64">{migrationSQL}</pre>
                  <button
                    id="copyBtn"
                    class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm"
                  >
                    Copy
                  </button>
                </div>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-teal-100 text-teal-700 rounded-full flex items-center justify-center font-bold">2</div>
              <div class="flex-1">
                <p class="font-medium text-gray-800 mb-2">Paste and run in Supabase SQL Editor</p>
                <a
                  href={sqlEditorUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded font-medium"
                >
                  Open Supabase SQL Editor
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </a>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-100 text-gray-500 rounded-full flex items-center justify-center font-bold">3</div>
              <div class="flex-1">
                <p class="font-medium text-gray-800 mb-2">Refresh this page to verify</p>
                <button
                  onclick="window.location.reload()"
                  class="inline-flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-medium"
                >
                  Refresh Page
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        {errorMessage && (
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-600 text-sm"><strong>Error:</strong> {errorMessage}</p>
          </div>
        )}
      </div>
    )}
  </div>

  <script>
    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      const sql = document.getElementById('sqlCode')?.textContent || '';
      await navigator.clipboard.writeText(sql);
      const btn = document.getElementById('copyBtn');
      if (btn) {
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
      }
    });
  </script>
</AdminLayout>
