---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabase';
import { getDonationBoxTemplates } from '../../../lib/templates';

export const prerender = false;

const { id } = Astro.params;

// Fetch the page data
let page: any = null;
let error = '';

if (id && id !== 'new') {
  const { data, error: fetchError } = await supabaseAdmin
    .from('pages')
    .select('*')
    .eq('id', id)
    .single();

  if (fetchError) {
    error = fetchError.message;
  } else {
    page = data;
  }
}

// Fetch donation box templates for the dropdown
const donationBoxTemplates = await getDonationBoxTemplates();

// Default content structure - uses page title if available
function getDefaultContent(title: string = 'Page Title') {
  return {
    sections: [
      {
        id: 'hero',
        type: 'hero',
        title: title,
        subtitle: 'Add your subtitle here',
        backgroundImage: '',
        showButton: true,
        buttonText: 'Learn More',
        buttonLink: '#'
      },
      {
        id: 'content-1',
        type: 'content',
        content: '<p>Start adding your content here...</p>'
      }
    ]
  };
}

// Parse existing content or create default
let pageContent;
if (page?.content) {
  try {
    const parsed = typeof page.content === 'string' ? JSON.parse(page.content) : page.content;
    // Check if content has valid sections
    if (parsed.sections && parsed.sections.length > 0) {
      pageContent = parsed;
    } else {
      pageContent = getDefaultContent(page.title);
    }
  } catch (e) {
    pageContent = getDefaultContent(page?.title);
  }
} else {
  pageContent = getDefaultContent(page?.title || 'New Page');
}
---

<AdminLayout title={page ? `Edit: ${page.title}` : 'New Page'} activeNav="pages">
  <div class="max-w-5xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <a href="/admin/pages" class="p-2 hover:bg-gray-100 rounded-lg transition">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">{page ? `Edit: ${page.title}` : 'Create New Page'}</h1>
          <p class="text-gray-500 text-sm">{page?.slug || 'Set page URL below'}</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        {page && (
          <a
            href={page.slug}
            target="_blank"
            class="flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Preview
          </a>
        )}
        <button
          id="saveBtn"
          class="flex items-center gap-2 px-6 py-2 bg-[#01534d] text-white rounded-lg hover:bg-[#013d39] transition font-medium"
        >
          <span id="saveBtnText">Save Page</span>
          <svg id="saveSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2"></div>

    <!-- Page Settings -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Page Settings</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Page Title *</label>
          <input
            type="text"
            id="pageTitle"
            value={page?.title || ''}
            placeholder="e.g., About Us"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">URL Slug *</label>
          <div class="flex">
            <span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-200 rounded-l-lg text-gray-500 text-sm">/</span>
            <input
              type="text"
              id="pageSlug"
              value={page?.slug?.replace(/^\/+/, '') || ''}
              placeholder="about-us"
              class="flex-1 px-4 py-2 border border-gray-200 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
              required
            />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select
            id="pageStatus"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white"
          >
            <option value="draft" selected={page?.status === 'draft'}>Draft</option>
            <option value="published" selected={page?.status === 'published'}>Published</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Template</label>
          <select
            id="pageTemplate"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white"
          >
            <option value="default" selected={page?.template === 'default'}>Default</option>
            <option value="home" selected={page?.template === 'home'}>Home</option>
            <option value="landing" selected={page?.template === 'landing'}>Landing Page</option>
            <option value="contact" selected={page?.template === 'contact'}>Contact</option>
            <option value="legal" selected={page?.template === 'legal'}>Legal (Privacy, Terms)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Donation Box Template</label>
          <select
            id="donationBoxTemplate"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white"
          >
            <option value="" selected={!page?.donation_box_template}>Use Site Default</option>
            {donationBoxTemplates.map((template) => (
              <option value={template.template_key} selected={page?.donation_box_template === template.template_key}>
                {template.template_label}
              </option>
            ))}
          </select>
          <p class="text-xs text-gray-400 mt-1">Override the default donation box for this page</p>
        </div>
      </div>
    </div>

    <!-- CW Donation Box Settings (shown when donation box = cw-donation) -->
    <div id="cwDonationSettings" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6 hidden">
      <h2 class="text-lg font-bold text-gray-800 mb-2">Donation Box Settings</h2>
      <p class="text-sm text-gray-500 mb-6">Configure amounts, impact texts, and labels for the CW Donation Box on this page</p>

      <!-- Frequency Tabs Selector -->
      <div class="mb-8">
        <div class="mb-4">
          <h3 class="font-semibold text-gray-700">Donation Frequency Tabs</h3>
          <p class="text-xs text-gray-400">Check frequencies to enable them as tabs. First checked = default tab. Drag to reorder.</p>
        </div>
        <div id="cwFrequencyList" class="space-y-3"></div>
      </div>

      <!-- General Settings -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 mb-2">General Settings</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Donation Box Heading</label>
          <input type="text" id="cwDonationBoxHeading" placeholder="e.g. Be the Reason They Smile Every Month" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
          <p class="text-xs text-gray-400 mt-1">Heading displayed above the donation box. Leave blank for no heading.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tab Icon / Emoji</label>
          <input type="text" id="cwTabEmoji" placeholder="e.g., ü§≤ üíß üåô ‚ù§Ô∏è (auto-detects if blank)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
          <p class="text-xs text-gray-400 mt-1">Icon shown on the recurring tabs and impact line</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Upsell Body Text</label>
          <textarea id="cwUpsellBody" rows="3" placeholder="By making a monthly donation, you'll empower us to make long-term investments..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
          <p class="text-xs text-gray-400 mt-1">Shown on the upsell page after one-time "GIVE" is clicked</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Upsell Sub Text</label>
          <textarea id="cwUpsellSubText" rows="2" placeholder="Please consider joining our monthly giving community..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
          <p class="text-xs text-gray-400 mt-1">Shown below the monthly toggle on the upsell page</p>
        </div>
      </div>
    </div>

    <!-- Hero Campaign Slides (shown only for home page) -->
    <div id="heroSlidesSettings" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6 hidden">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h2 class="text-lg font-bold text-gray-800">Hero Campaign Slides</h2>
          <p class="text-sm text-gray-500">Configure the homepage hero carousel. Each slide has its own content and donation box.</p>
        </div>
        <button type="button" id="addHeroSlideBtn"
          class="flex items-center gap-2 px-3 py-1.5 bg-[#01534d] text-white text-sm rounded-lg hover:bg-[#01433f]">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Slide
        </button>
      </div>

      <div id="heroSlidesContainer" class="space-y-3 mt-4">
        <!-- Slide cards rendered by JS -->
      </div>

      <div id="heroSlidesEmpty" class="hidden text-center py-8 border-2 border-dashed border-gray-300 rounded-lg mt-4">
        <svg class="w-10 h-10 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <p class="text-gray-500 mb-2">No hero slides configured</p>
        <p class="text-gray-400 text-sm">The homepage will use default hardcoded slides</p>
      </div>
    </div>

    <!-- SEO Settings -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">SEO Settings</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title</label>
          <input
            type="text"
            id="metaTitle"
            value={page?.meta_title || ''}
            placeholder="Page title for search engines"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
          />
          <p class="text-xs text-gray-500 mt-1">Leave empty to use page title</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
          <textarea
            id="metaDescription"
            rows="2"
            placeholder="Brief description for search results"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
          >{page?.meta_description || ''}</textarea>
        </div>
      </div>
    </div>

    <!-- Page Content -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-800">Page Content</h2>
        <button
          id="addSectionBtn"
          class="flex items-center gap-2 px-3 py-1.5 text-sm border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Section
        </button>
      </div>

      <div id="sectionsContainer" class="space-y-4">
        <!-- Sections will be rendered here -->
      </div>
    </div>

    <!-- Featured Image -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Featured Image</h2>
      <div class="flex gap-4">
        <div class="w-48 h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
          <img
            id="featuredImagePreview"
            src={page?.featured_image || ''}
            alt="Featured"
            class={page?.featured_image ? 'w-full h-full object-cover' : 'hidden'}
          />
          <div id="featuredImagePlaceholder" class={page?.featured_image ? 'hidden' : 'text-center text-gray-400'}>
            <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="text-xs">No image</span>
          </div>
        </div>
        <div class="flex-1">
          <input
            type="text"
            id="featuredImage"
            value={page?.featured_image || ''}
            placeholder="Image URL"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] text-sm mb-2"
          />
          <div class="flex gap-2">
            <label class="cursor-pointer">
              <input type="file" id="featuredImageUpload" accept="image/*" class="hidden" />
              <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-[#01534d] text-white rounded-lg text-sm hover:bg-[#013d39] transition">
                Upload
              </span>
            </label>
            <button type="button" id="featuredImageGalleryBtn" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50 transition">
              Gallery
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Section Modal -->
  <div id="addSectionModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-bold text-gray-800">Add Section</h3>
        <button type="button" id="closeAddSectionModal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-4 grid grid-cols-2 gap-3">
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="hero">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="font-medium text-gray-800">Hero Section</p>
          <p class="text-xs text-gray-500">Large banner with title</p>
        </button>
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="content">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="font-medium text-gray-800">Text Content</p>
          <p class="text-xs text-gray-500">Rich text editor</p>
        </button>
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="image">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="font-medium text-gray-800">Image</p>
          <p class="text-xs text-gray-500">Single image with caption</p>
        </button>
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="cta">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
          </svg>
          <p class="font-medium text-gray-800">Call to Action</p>
          <p class="text-xs text-gray-500">Button with text</p>
        </button>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ pageId: id, initialContent: pageContent, existingPage: page, existingTemplateConfig: page?.template_config || {} }}>
  let sections = initialContent?.sections || [];
  const isNew = !existingPage;

  // Render sections
  function renderSections() {
    const container = document.getElementById('sectionsContainer');
    if (!container) return;

    if (sections.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
          <p class="text-gray-500 mb-2">No sections yet</p>
          <button type="button" id="addFirstSection" class="text-[#01534d] font-medium hover:underline">Add your first section</button>
        </div>
      `;
      document.getElementById('addFirstSection')?.addEventListener('click', () => {
        document.getElementById('addSectionModal')?.classList.remove('hidden');
      });
      return;
    }

    container.innerHTML = sections.map((section, index) => {
      let content = '';

      if (section.type === 'hero') {
        content = `
          <div class="space-y-3">
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="title" value="${section.title || ''}" placeholder="Hero Title" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="subtitle" value="${section.subtitle || ''}" placeholder="Subtitle" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="backgroundImage" value="${section.backgroundImage || ''}" placeholder="Background Image URL" />
          </div>
        `;
      } else if (section.type === 'content') {
        content = `
          <textarea class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg min-h-[200px]" data-field="content" placeholder="Write your content here... (HTML supported)">${section.content || ''}</textarea>
        `;
      } else if (section.type === 'image') {
        content = `
          <div class="space-y-3">
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="imageUrl" value="${section.imageUrl || ''}" placeholder="Image URL" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="caption" value="${section.caption || ''}" placeholder="Caption (optional)" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="alt" value="${section.alt || ''}" placeholder="Alt text" />
          </div>
        `;
      } else if (section.type === 'cta') {
        content = `
          <div class="space-y-3">
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="title" value="${section.title || ''}" placeholder="CTA Title" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="description" value="${section.description || ''}" placeholder="Description" />
            <div class="grid grid-cols-2 gap-3">
              <input type="text" class="section-field px-3 py-2 border border-gray-200 rounded-lg" data-field="buttonText" value="${section.buttonText || ''}" placeholder="Button Text" />
              <input type="text" class="section-field px-3 py-2 border border-gray-200 rounded-lg" data-field="buttonLink" value="${section.buttonLink || ''}" placeholder="Button Link" />
            </div>
          </div>
        `;
      }

      return `
        <div class="section-item border border-gray-200 rounded-lg p-4" data-index="${index}">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="cursor-move text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                </svg>
              </span>
              <span class="text-sm font-medium text-gray-700 capitalize">${section.type} Section</span>
            </div>
            <button type="button" class="delete-section text-red-500 hover:text-red-700 p-1" data-index="${index}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          ${content}
        </div>
      `;
    }).join('');

    // Add event listeners to section fields
    document.querySelectorAll('.section-field').forEach(field => {
      field.addEventListener('input', (e) => {
        const target = e.target;
        const sectionItem = target.closest('.section-item');
        const index = parseInt(sectionItem?.dataset.index || '0');
        const fieldName = target.dataset.field || '';
        if (sections[index]) {
          sections[index][fieldName] = target.value;
        }
      });
    });

    // Delete section buttons
    document.querySelectorAll('.delete-section').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget;
        const index = parseInt(target.dataset.index || '0');
        if (confirm('Delete this section?')) {
          sections.splice(index, 1);
          renderSections();
        }
      });
    });
  }

  // Initialize
  renderSections();

  // Add section modal
  const addSectionBtn = document.getElementById('addSectionBtn');
  const addSectionModal = document.getElementById('addSectionModal');
  const closeAddSectionModal = document.getElementById('closeAddSectionModal');

  addSectionBtn?.addEventListener('click', () => {
    addSectionModal?.classList.remove('hidden');
  });

  closeAddSectionModal?.addEventListener('click', () => {
    addSectionModal?.classList.add('hidden');
  });

  addSectionModal?.addEventListener('click', (e) => {
    if (e.target === addSectionModal) {
      addSectionModal.classList.add('hidden');
    }
  });

  // Add section type buttons
  document.querySelectorAll('.add-section-type').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.type || 'content';
      const newSection = {
        id: `section-${Date.now()}`,
        type
      };

      if (type === 'hero') {
        newSection.title = 'Section Title';
        newSection.subtitle = '';
        newSection.backgroundImage = '';
      } else if (type === 'content') {
        newSection.content = '';
      } else if (type === 'image') {
        newSection.imageUrl = '';
        newSection.caption = '';
        newSection.alt = '';
      } else if (type === 'cta') {
        newSection.title = '';
        newSection.description = '';
        newSection.buttonText = 'Learn More';
        newSection.buttonLink = '#';
      }

      sections.push(newSection);
      renderSections();
      addSectionModal?.classList.add('hidden');
    });
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CW DONATION BOX SETTINGS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var cwMonthlyIndex = 0;
  var cwOneTimeIndex = 0;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FREQUENCY TABS SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var FREQ_DEFINITIONS = [
    { key: 'monthly', label: 'MONTHLY', type: 'recurring', stripeInterval: 'month', suffix: 'USD/mo', buttonText: 'JOIN TODAY', defaultAmounts: [10, 20, 40, 100], fallbackImpactText: 'Your monthly gift transforms lives around the world' },
    { key: 'single', label: 'GIVE ONCE', type: 'single', stripeInterval: null, suffix: 'USD', buttonText: 'GIVE', defaultAmounts: [50, 100, 150, 200], fallbackImpactText: '' },
    { key: 'yearly', label: 'YEARLY', type: 'recurring', stripeInterval: 'year', suffix: 'USD/yr', buttonText: 'GIVE YEARLY', defaultAmounts: [100, 250, 500, 1000], fallbackImpactText: 'Your yearly gift makes a lasting impact' },
    { key: 'weekly', label: 'EVERY FRIDAY', type: 'recurring', stripeInterval: 'week', suffix: 'USD/wk', buttonText: 'GIVE WEEKLY', defaultAmounts: [5, 10, 20, 50], fallbackImpactText: 'Your Jummah gift blesses every Friday' },
    { key: 'daily', label: 'DAILY', type: 'recurring', stripeInterval: 'day', suffix: 'USD/day', buttonText: 'GIVE DAILY', defaultAmounts: [1, 3, 5, 10], fallbackImpactText: 'Your daily gift provides consistent support' },
  ];
  var cwFreqAmtIndex = 0;

  function renderFrequencyList(containerId, frequencies) {
    var container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    FREQ_DEFINITIONS.forEach(function(def) {
      var existing = null;
      if (frequencies) {
        for (var i = 0; i < frequencies.length; i++) {
          if (frequencies[i].key === def.key) { existing = frequencies[i]; break; }
        }
      }
      var isChecked = existing ? true : false;
      var freq = existing || def;

      var div = document.createElement('div');
      div.className = 'cw-freq-item border border-gray-200 rounded-lg overflow-hidden';
      div.dataset.freqKey = def.key;

      var amounts = freq.amounts || def.defaultAmounts || [];
      var impactTexts = freq.impactTexts || {};
      var amountsHtml = '';
      amounts.forEach(function(amt) {
        var impact = impactTexts[amt] || '';
        amountsHtml += '<div class="cw-freq-amt-row flex gap-2 items-center mb-2">' +
          '<input type="number" placeholder="$" value="' + amt + '" class="cw-fa-amount w-24 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
          '<input type="text" placeholder="Impact text" value="' + (impact || '').replace(/"/g, '&quot;') + '" class="cw-fa-impact flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
          '<button type="button" class="cw-fa-remove p-1 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>' +
          '</div>';
      });

      div.innerHTML =
        '<div class="cw-freq-header flex items-center gap-3 px-4 py-3 bg-gray-50 cursor-pointer select-none">' +
          '<input type="checkbox" class="cw-freq-check w-4 h-4 rounded border-gray-300 text-[#01534d] focus:ring-[#01534d]" ' + (isChecked ? 'checked' : '') + ' />' +
          '<div class="flex-1">' +
            '<span class="font-semibold text-sm text-gray-700">' + def.label + '</span>' +
            '<span class="text-xs text-gray-400 ml-2">(' + (def.type === 'single' ? 'one-time' : def.stripeInterval) + ')</span>' +
          '</div>' +
          '<div class="flex gap-1">' +
            '<button type="button" class="cw-freq-up p-1 text-gray-400 hover:text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></button>' +
            '<button type="button" class="cw-freq-down p-1 text-gray-400 hover:text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>' +
          '</div>' +
          '<svg class="cw-freq-chevron w-4 h-4 text-gray-400 transition-transform ' + (isChecked ? 'rotate-180' : '') + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>' +
        '</div>' +
        '<div class="cw-freq-body px-4 py-3 space-y-3 ' + (isChecked ? '' : 'hidden') + '">' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Tab Label</label>' +
              '<input type="text" placeholder="' + def.label + '" value="' + (freq.label || '').replace(/"/g, '&quot;') + '" class="cw-freq-label w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Button Text</label>' +
              '<input type="text" placeholder="' + def.buttonText + '" value="' + (freq.buttonText || '').replace(/"/g, '&quot;') + '" class="cw-freq-btntext w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Suffix</label>' +
              '<input type="text" placeholder="' + def.suffix + '" value="' + (freq.suffix || '').replace(/"/g, '&quot;') + '" class="cw-freq-suffix w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Fallback Impact Text</label>' +
              '<input type="text" placeholder="Shown when no amount-specific text" value="' + (freq.fallbackImpactText || '').replace(/"/g, '&quot;') + '" class="cw-freq-fallback w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">&ldquo;Other&rdquo; Amount Impact Text</label>' +
            '<input type="text" placeholder="Shown when donor enters a custom amount" value="' + (freq.otherImpactText || '').replace(/"/g, '&quot;') + '" class="cw-freq-other-impact w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
          '</div>' +
          '<div>' +
            '<div class="flex items-center justify-between mb-2">' +
              '<label class="text-xs font-medium text-gray-600">Amounts & Impact Texts</label>' +
              '<button type="button" class="cw-freq-add-amt text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">+ Add</button>' +
            '</div>' +
            '<div class="cw-freq-amounts">' + amountsHtml + '</div>' +
          '</div>' +
        '</div>';

      container.appendChild(div);
      attachFreqItemListeners(div);
    });

    // Reorder based on existing frequencies order
    if (frequencies && frequencies.length > 0) {
      var orderedKeys = frequencies.map(function(f) { return f.key; });
      // Move checked items to top in order
      orderedKeys.forEach(function(key) {
        var item = container.querySelector('[data-freq-key="' + key + '"]');
        if (item) container.appendChild(item);
      });
      // Then append unchecked items
      FREQ_DEFINITIONS.forEach(function(def) {
        if (orderedKeys.indexOf(def.key) === -1) {
          var item = container.querySelector('[data-freq-key="' + def.key + '"]');
          if (item) container.appendChild(item);
        }
      });
    }
  }

  function attachFreqItemListeners(div) {
    var check = div.querySelector('.cw-freq-check');
    var body = div.querySelector('.cw-freq-body');
    var chevron = div.querySelector('.cw-freq-chevron');
    var header = div.querySelector('.cw-freq-header');

    // Toggle body on header click (but not on checkbox or buttons)
    header.addEventListener('click', function(e) {
      if (e.target.closest('.cw-freq-check') || e.target.closest('.cw-freq-up') || e.target.closest('.cw-freq-down')) return;
      if (check.checked) {
        body.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
      }
    });

    // Checkbox toggle
    check.addEventListener('change', function() {
      if (check.checked) {
        body.classList.remove('hidden');
        chevron.classList.add('rotate-180');
      } else {
        body.classList.add('hidden');
        chevron.classList.remove('rotate-180');
      }
    });

    // Move up/down
    div.querySelector('.cw-freq-up').addEventListener('click', function(e) {
      e.stopPropagation();
      var prev = div.previousElementSibling;
      if (prev) div.parentNode.insertBefore(div, prev);
    });
    div.querySelector('.cw-freq-down').addEventListener('click', function(e) {
      e.stopPropagation();
      var next = div.nextElementSibling;
      if (next) div.parentNode.insertBefore(next, div);
    });

    // Add amount
    div.querySelector('.cw-freq-add-amt').addEventListener('click', function() {
      addFreqAmountRow(div.querySelector('.cw-freq-amounts'));
    });

    // Remove amount
    div.querySelectorAll('.cw-fa-remove').forEach(function(btn) {
      btn.addEventListener('click', function() { btn.closest('.cw-freq-amt-row').remove(); });
    });
  }

  function addFreqAmountRow(container, amount, impact) {
    amount = amount || '';
    impact = impact || '';
    var row = document.createElement('div');
    row.className = 'cw-freq-amt-row flex gap-2 items-center mb-2';
    row.innerHTML = '<input type="number" placeholder="$" value="' + amount + '" class="cw-fa-amount w-24 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
      '<input type="text" placeholder="Impact text" value="' + (impact || '').replace(/"/g, '&quot;') + '" class="cw-fa-impact flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
      '<button type="button" class="cw-fa-remove p-1 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>';
    container.appendChild(row);
    row.querySelector('.cw-fa-remove').addEventListener('click', function() { row.remove(); });
  }

  function collectFrequenciesFromContainer(container) {
    if (!container) return null;
    var frequencies = [];
    container.querySelectorAll('.cw-freq-item').forEach(function(div) {
      var check = div.querySelector('.cw-freq-check');
      if (!check || !check.checked) return;
      var key = div.dataset.freqKey;
      var def = null;
      for (var i = 0; i < FREQ_DEFINITIONS.length; i++) {
        if (FREQ_DEFINITIONS[i].key === key) { def = FREQ_DEFINITIONS[i]; break; }
      }
      if (!def) return;

      var label = div.querySelector('.cw-freq-label')?.value || def.label;
      var buttonText = div.querySelector('.cw-freq-btntext')?.value || def.buttonText;
      var suffix = div.querySelector('.cw-freq-suffix')?.value || def.suffix;
      var fallbackImpactText = div.querySelector('.cw-freq-fallback')?.value || '';
      var otherImpactText = div.querySelector('.cw-freq-other-impact')?.value || '';

      var amounts = [];
      var impactTexts = {};
      div.querySelectorAll('.cw-freq-amt-row').forEach(function(row) {
        var amt = parseFloat(row.querySelector('.cw-fa-amount')?.value);
        var impact = row.querySelector('.cw-fa-impact')?.value;
        if (amt) {
          amounts.push(amt);
          if (impact) impactTexts[amt] = impact;
        }
      });

      var freqObj = {
        key: key,
        label: label,
        type: def.type,
        stripeInterval: def.stripeInterval,
        suffix: suffix,
        buttonText: buttonText,
        amounts: amounts.length > 0 ? amounts : def.defaultAmounts,
        impactTexts: impactTexts,
        defaultAmountIndex: 1,
        fallbackImpactText: fallbackImpactText,
      };
      if (otherImpactText) freqObj.otherImpactText = otherImpactText;
      frequencies.push(freqObj);
    });
    return frequencies.length > 0 ? frequencies : null;
  }

  function collectFrequencies(containerId) {
    return collectFrequenciesFromContainer(document.getElementById(containerId));
  }

  // Toggle visibility based on donation box template selection
  var donationBoxSelect = document.getElementById('donationBoxTemplate');
  var cwSettingsPanel = document.getElementById('cwDonationSettings');

  function toggleCWSettings() {
    if (!donationBoxSelect || !cwSettingsPanel) return;
    var isCW = donationBoxSelect.value === 'cw-donation';
    cwSettingsPanel.classList.toggle('hidden', !isCW);
  }

  if (donationBoxSelect) {
    donationBoxSelect.addEventListener('change', toggleCWSettings);
    toggleCWSettings();
  }

  // Add monthly amount row
  function addCWMonthlyAmount(amount, impactText) {
    amount = amount || '';
    impactText = impactText || '';
    var container = document.getElementById('cwMonthlyAmounts');
    var idx = cwMonthlyIndex++;
    var div = document.createElement('div');
    div.id = 'cw-monthly-' + idx;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = '<input type="number" placeholder="Amount ($)" value="' + amount + '" class="cw-m-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<input type="text" placeholder="Impact text (e.g., Feeds a family for a month)" value="' + (impactText || '').replace(/"/g, '&quot;') + '" class="cw-m-impact flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<button type="button" class="cw-remove-btn p-2 text-red-500 hover:bg-red-50 rounded" data-target="cw-monthly-' + idx + '">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
    div.querySelector('.cw-remove-btn').addEventListener('click', function() { div.remove(); });
  }

  // Add one-time amount row
  function addCWOneTimeAmount(amount, impactText) {
    amount = amount || '';
    impactText = impactText || '';
    var container = document.getElementById('cwOneTimeAmounts');
    var idx = cwOneTimeIndex++;
    var div = document.createElement('div');
    div.id = 'cw-onetime-' + idx;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = '<input type="number" placeholder="Amount ($)" value="' + amount + '" class="cw-o-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<input type="text" placeholder="Impact text (e.g., Provide emergency food parcels)" value="' + (impactText || '').replace(/"/g, '&quot;') + '" class="cw-o-impact flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<button type="button" class="cw-remove-btn p-2 text-red-500 hover:bg-red-50 rounded" data-target="cw-onetime-' + idx + '">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
    div.querySelector('.cw-remove-btn').addEventListener('click', function() { div.remove(); });
  }

  // Wire up add buttons (legacy - kept for backward compat)
  document.getElementById('addCWMonthlyBtn')?.addEventListener('click', function() { addCWMonthlyAmount(); });
  document.getElementById('addCWOneTimeBtn')?.addEventListener('click', function() { addCWOneTimeAmount(); });

  // Collect CW donation config into an object
  function getCWDonationConfig() {
    var config = {};

    // Collect frequencies from the frequency list
    var frequencies = collectFrequencies('cwFrequencyList');
    if (frequencies) config.frequencies = frequencies;

    var upsellBody = document.getElementById('cwUpsellBody')?.value;
    var upsellSubText = document.getElementById('cwUpsellSubText')?.value;
    var heading = document.getElementById('cwDonationBoxHeading')?.value;
    var cwTabEmoji = document.getElementById('cwTabEmoji')?.value;

    if (upsellBody) config.upsellBody = upsellBody;
    if (upsellSubText) config.upsellSubText = upsellSubText;
    if (heading) config.donationBoxHeading = heading;
    if (cwTabEmoji) config.tabEmoji = cwTabEmoji;

    return Object.keys(config).length > 0 ? config : null;
  }

  // Initialize CW settings from existing template_config
  function initCWDonationSettings() {
    var cwConfig = existingTemplateConfig?.cwDonation || {};

    // Build frequencies from saved config or convert legacy format
    var frequencies = cwConfig.frequencies || null;
    if (!frequencies && (cwConfig.monthlyAmounts || cwConfig.oneTimeAmounts)) {
      // Convert legacy format to frequencies
      frequencies = [];
      if (cwConfig.monthlyAmounts) {
        frequencies.push({
          key: 'monthly',
          label: cwConfig.tabLabelMonthly || 'MONTHLY',
          type: 'recurring',
          stripeInterval: 'month',
          suffix: 'USD/mo',
          buttonText: cwConfig.buttonTextMonthly || 'JOIN TODAY',
          amounts: cwConfig.monthlyAmounts,
          impactTexts: cwConfig.impactTexts?.monthly || {},
          defaultAmountIndex: 2,
          fallbackImpactText: cwConfig.monthlyImpactText || '',
        });
      }
      if (cwConfig.oneTimeAmounts) {
        frequencies.push({
          key: 'single',
          label: cwConfig.tabLabelOneTime || 'GIVE ONCE',
          type: 'single',
          stripeInterval: null,
          suffix: 'USD',
          buttonText: cwConfig.buttonTextOneTime || 'GIVE',
          amounts: cwConfig.oneTimeAmounts,
          impactTexts: cwConfig.impactTexts?.single || {},
          defaultAmountIndex: 1,
          fallbackImpactText: '',
        });
      }
    }

    // Render frequency list with saved or default frequencies
    renderFrequencyList('cwFrequencyList', frequencies || [
      { key: 'monthly', label: 'MONTHLY', type: 'recurring', stripeInterval: 'month', suffix: 'USD/mo', buttonText: 'JOIN TODAY', amounts: [10, 20, 40, 100], impactTexts: {}, fallbackImpactText: '' },
      { key: 'single', label: 'GIVE ONCE', type: 'single', stripeInterval: null, suffix: 'USD', buttonText: 'GIVE', amounts: [50, 100, 150, 200], impactTexts: {}, fallbackImpactText: '' },
    ]);

    // Populate general text fields
    var uBody = document.getElementById('cwUpsellBody');
    var uSub = document.getElementById('cwUpsellSubText');
    var headingInput = document.getElementById('cwDonationBoxHeading');

    if (uBody) uBody.value = cwConfig.upsellBody || '';
    if (uSub) uSub.value = cwConfig.upsellSubText || '';
    if (headingInput) headingInput.value = cwConfig.donationBoxHeading || '';

    var tabEmojiInput = document.getElementById('cwTabEmoji');
    if (tabEmojiInput) tabEmojiInput.value = cwConfig.tabEmoji || '';
  }

  // Init on load
  initCWDonationSettings();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // HERO CAMPAIGN SLIDES SETTINGS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var heroSlidesData = [];
  var heroSlideIndex = 0;

  // Toggle visibility - only show for home page
  function toggleHeroSlidesSettings() {
    var panel = document.getElementById('heroSlidesSettings');
    var slugInput = document.getElementById('pageSlug');
    var templateSelect = document.getElementById('pageTemplate');
    if (!panel) return;

    var slugVal = slugInput ? slugInput.value.replace(/^\/+/, '') : '';
    var templateVal = templateSelect ? templateSelect.value : '';
    var isHome = (slugVal === 'home' || slugVal === '' && templateVal === 'home') || templateVal === 'home';

    panel.classList.toggle('hidden', !isHome);
  }

  var pageTemplateSelect = document.getElementById('pageTemplate');
  var pageSlugField = document.getElementById('pageSlug');
  if (pageTemplateSelect) pageTemplateSelect.addEventListener('change', toggleHeroSlidesSettings);
  if (pageSlugField) pageSlugField.addEventListener('input', toggleHeroSlidesSettings);
  toggleHeroSlidesSettings();

  // Render a single hero slide card
  function renderHeroSlideCard(index, slide) {
    slide = slide || {};
    var primaryCta = slide.primaryCta || {};
    var secondaryCta = slide.secondaryCta || {};
    var donation = slide.donation || {};
    var id = 'hero-slide-' + (heroSlideIndex++);

    // Build per-slide frequencies from saved data or legacy format
    var slideFrequencies = donation.frequencies || null;
    if (!slideFrequencies && (donation.monthlyAmounts || donation.oneTimeAmounts)) {
      slideFrequencies = [];
      if (donation.monthlyAmounts) {
        slideFrequencies.push({
          key: 'monthly', label: donation.tabLabelMonthly || 'MONTHLY', type: 'recurring', stripeInterval: 'month', suffix: 'USD/mo',
          buttonText: donation.buttonTextMonthly || 'JOIN TODAY', amounts: donation.monthlyAmounts,
          impactTexts: (donation.impactTexts && donation.impactTexts.monthly) || {}, fallbackImpactText: donation.monthlyImpactText || '',
        });
      }
      if (donation.oneTimeAmounts) {
        slideFrequencies.push({
          key: 'single', label: donation.tabLabelOneTime || 'GIVE ONCE', type: 'single', stripeInterval: null, suffix: 'USD',
          buttonText: donation.buttonTextOneTime || 'GIVE', amounts: donation.oneTimeAmounts,
          impactTexts: (donation.impactTexts && donation.impactTexts.single) || {}, fallbackImpactText: '',
        });
      }
    }
    var slideFreqContainerId = 'hs-freq-' + heroSlideIndex;

    // Stats
    var defaultStatsData = [
      { value: '2M+', label: 'Lives Changed' },
      { value: '53+', label: 'Countries' },
      { value: '100%', label: 'Zakat Delivered' }
    ];
    var slideStats = (slide.stats && slide.stats.length === 3) ? slide.stats : defaultStatsData;
    var statsHtml = '';
    slideStats.forEach(function(stat, si) {
      statsHtml += '<div class="space-y-1">' +
        '<input type="text" placeholder="Value (e.g., 2M+)" value="' + (stat.value || '').replace(/"/g, '&quot;') + '" class="hs-stat-value w-full px-2 py-1.5 border border-gray-200 rounded text-sm font-bold" />' +
        '<input type="text" placeholder="Label (e.g., Lives Changed)" value="' + (stat.label || '').replace(/"/g, '&quot;') + '" class="hs-stat-label w-full px-2 py-1.5 border border-gray-200 rounded text-xs" />' +
        '</div>';
    });

    var card = document.createElement('div');
    card.className = 'hero-slide-card border border-gray-200 rounded-lg overflow-hidden';
    card.dataset.slideIndex = String(index);
    card.id = id;

    card.innerHTML = '' +
      '<!-- Header -->' +
      '<div class="flex items-center justify-between px-4 py-3 bg-gray-50 cursor-pointer hero-slide-header">' +
        '<div class="flex items-center gap-3">' +
          '<span class="text-gray-400 text-sm font-mono font-bold">#' + (index + 1) + '</span>' +
          '<div class="w-16 h-10 bg-gray-200 rounded overflow-hidden flex-shrink-0">' +
            (slide.image ? '<img src="' + slide.image + '" class="w-full h-full object-cover" />' : '<div class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No img</div>') +
          '</div>' +
          '<span class="font-medium text-gray-700 text-sm truncate max-w-[200px]">' + (slide.headline ? slide.headline + ' ' + (slide.headlineAccent || '') : 'New Slide') + '</span>' +
        '</div>' +
        '<div class="flex items-center gap-1">' +
          '<button type="button" class="hs-move-up p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Move up"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></button>' +
          '<button type="button" class="hs-move-down p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Move down"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>' +
          '<button type="button" class="hs-delete p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded" title="Delete slide"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>' +
          '<button type="button" class="hs-toggle p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Expand/collapse"><svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>' +
        '</div>' +
      '</div>' +
      '<!-- Body (collapsed by default) -->' +
      '<div class="hs-body hidden px-4 py-4 space-y-5 border-t border-gray-100">' +
        '<!-- Slide Content -->' +
        '<div class="space-y-3">' +
          '<h4 class="font-semibold text-gray-700 text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Slide Content</h4>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Background Image URL</label>' +
            '<div class="flex gap-2">' +
              '<input type="text" placeholder="https://..." value="' + (slide.image || '').replace(/"/g, '&quot;') + '" class="hs-image flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
              '<label class="cursor-pointer flex-shrink-0">' +
                '<input type="file" accept="image/*" class="hidden hs-image-upload" />' +
                '<span class="inline-flex items-center px-3 py-2 bg-[#01534d] text-white rounded-lg text-sm hover:bg-[#01433f] cursor-pointer">Upload</span>' +
              '</label>' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Eyebrow Text</label>' +
              '<input type="text" placeholder="e.g., 100% Zakat Policy" value="' + (slide.eyebrow || '').replace(/"/g, '&quot;') + '" class="hs-eyebrow w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Headline</label>' +
              '<input type="text" placeholder="e.g., Your Zakat," value="' + (slide.headline || '').replace(/"/g, '&quot;') + '" class="hs-headline w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Headline Accent (colored text)</label>' +
            '<input type="text" placeholder="e.g., Their Future" value="' + (slide.headlineAccent || '').replace(/"/g, '&quot;') + '" class="hs-headline-accent w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Description</label>' +
            '<textarea placeholder="Short paragraph about this campaign..." rows="2" class="hs-description w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">' + (slide.description || '') + '</textarea>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Primary Button Text</label>' +
              '<input type="text" placeholder="e.g., Give Zakat" value="' + (primaryCta.text || '').replace(/"/g, '&quot;') + '" class="hs-primary-text w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Primary Button Link</label>' +
              '<input type="text" placeholder="/zakat" value="' + (primaryCta.href || '').replace(/"/g, '&quot;') + '" class="hs-primary-href w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Secondary Button Text</label>' +
              '<input type="text" placeholder="e.g., Learn More" value="' + (secondaryCta.text || '').replace(/"/g, '&quot;') + '" class="hs-secondary-text w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Secondary Button Link</label>' +
              '<input type="text" placeholder="/about" value="' + (secondaryCta.href || '').replace(/"/g, '&quot;') + '" class="hs-secondary-href w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
          '</div>' +
          '<!-- Stats -->' +
          '<div class="border-t border-gray-100 pt-3 mt-3">' +
            '<div class="flex items-center justify-between mb-2">' +
              '<h4 class="font-semibold text-gray-700 text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> Stats (3 items)</h4>' +
              '<button type="button" class="hs-reset-stats text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">Reset to defaults</button>' +
            '</div>' +
            '<p class="text-xs text-gray-400 mb-2">The 3 stat numbers shown below the hero text (e.g., 2M+ Lives Changed)</p>' +
            '<div class="hs-stats-container grid grid-cols-3 gap-2">' +
              statsHtml +
            '</div>' +
          '</div>' +
        '</div>' +
        '<!-- Donation Box Config -->' +
        '<div class="border-t border-gray-100 pt-4 space-y-3">' +
          '<h4 class="font-semibold text-gray-700 text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Donation Box Config</h4>' +
          '<p class="text-xs text-gray-400">Leave blank to use the default donation box settings from above</p>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Campaign Slug</label>' +
              '<input type="text" placeholder="e.g., where-needed" value="' + (donation.campaignSlug || '').replace(/"/g, '&quot;') + '" class="hs-campaign-slug w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Campaign Title</label>' +
              '<input type="text" placeholder="e.g., Where Most Needed" value="' + (donation.campaignTitle || '').replace(/"/g, '&quot;') + '" class="hs-campaign-title w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Donation Box Heading</label>' +
            '<input type="text" placeholder="e.g., Be the Reason They Smile" value="' + (donation.donationBoxHeading || '').replace(/"/g, '&quot;') + '" class="hs-donation-heading w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Tab Icon / Emoji</label>' +
            '<input type="text" placeholder="e.g., ü§≤ üíß üåô (auto-detects if blank)" value="' + (donation.tabEmoji || '').replace(/"/g, '&quot;') + '" class="hs-tab-emoji w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
          '</div>' +
          '<!-- Frequency Tabs Selector -->' +
          '<div>' +
            '<label class="text-xs font-medium text-gray-600 mb-2 block">Frequency Tabs (leave blank to use page defaults)</label>' +
            '<div id="' + slideFreqContainerId + '" class="hs-freq-list space-y-2"></div>' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Upsell Body Text</label>' +
            '<textarea placeholder="By making a monthly donation..." rows="2" class="hs-upsell-body w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">' + (donation.upsellBody || '') + '</textarea>' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">Upsell Sub Text</label>' +
            '<textarea placeholder="Please consider joining..." rows="2" class="hs-upsell-sub w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">' + (donation.upsellSubText || '') + '</textarea>' +
          '</div>' +
        '</div>' +
      '</div>';

    card._slideFrequencies = slideFrequencies;
    return card;
  }

  // Attach event listeners to a slide card
  function attachHeroSlideListeners(card) {
    // Toggle expand/collapse
    var header = card.querySelector('.hero-slide-header');
    var body = card.querySelector('.hs-body');
    var toggleBtn = card.querySelector('.hs-toggle');
    header.addEventListener('click', function(e) {
      if (e.target.closest('.hs-move-up') || e.target.closest('.hs-move-down') || e.target.closest('.hs-delete')) return;
      body.classList.toggle('hidden');
      var svg = toggleBtn.querySelector('svg');
      if (svg) svg.style.transform = body.classList.contains('hidden') ? '' : 'rotate(180deg)';
    });

    // Delete
    card.querySelector('.hs-delete').addEventListener('click', function() {
      if (confirm('Delete this hero slide?')) {
        card.remove();
        reindexHeroSlides();
      }
    });

    // Move up
    card.querySelector('.hs-move-up').addEventListener('click', function() {
      var container = document.getElementById('heroSlidesContainer');
      var prev = card.previousElementSibling;
      if (prev) {
        container.insertBefore(card, prev);
        reindexHeroSlides();
      }
    });

    // Move down
    card.querySelector('.hs-move-down').addEventListener('click', function() {
      var container = document.getElementById('heroSlidesContainer');
      var next = card.nextElementSibling;
      if (next) {
        container.insertBefore(next, card);
        reindexHeroSlides();
      }
    });

    // Image upload
    var imageUpload = card.querySelector('.hs-image-upload');
    var imageInput = card.querySelector('.hs-image');
    if (imageUpload) {
      imageUpload.addEventListener('change', function(e) {
        var file = e.target.files && e.target.files[0];
        if (!file) return;
        var formData = new FormData();
        formData.append('file', file);
        fetch('/api/media/upload', { method: 'POST', body: formData })
          .then(function(res) { return res.json(); })
          .then(function(result) {
            if (result.success && result.url) {
              imageInput.value = result.url;
              // Update thumbnail in header
              var thumb = card.querySelector('.hero-slide-header img');
              if (thumb) {
                thumb.src = result.url;
              } else {
                var thumbContainer = card.querySelector('.hero-slide-header .w-16');
                if (thumbContainer) thumbContainer.innerHTML = '<img src="' + result.url + '" class="w-full h-full object-cover" />';
              }
            }
          })
          .catch(function() { showToast('Upload failed', true); });
      });
    }

    // Render per-slide frequency list
    var hsFreqList = card.querySelector('.hs-freq-list');
    if (hsFreqList && hsFreqList.id) {
      renderFrequencyList(hsFreqList.id, card._slideFrequencies || null);
    }

    // Reset stats to defaults
    var resetStatsBtn = card.querySelector('.hs-reset-stats');
    if (resetStatsBtn) {
      resetStatsBtn.addEventListener('click', function() {
        var statsContainer = card.querySelector('.hs-stats-container');
        var defaults = [
          { value: '2M+', label: 'Lives Changed' },
          { value: '53+', label: 'Countries' },
          { value: '100%', label: 'Zakat Delivered' }
        ];
        var statDivs = statsContainer.querySelectorAll(':scope > div');
        defaults.forEach(function(d, i) {
          if (statDivs[i]) {
            statDivs[i].querySelector('.hs-stat-value').value = d.value;
            statDivs[i].querySelector('.hs-stat-label').value = d.label;
          }
        });
      });
    }

  }

  // Add amount row helper
  function addHeroSlideAmountRow(container, type) {
    var prefix = type === 'monthly' ? 'hs-m' : 'hs-o';
    var rowClass = type === 'monthly' ? 'hs-m-row' : 'hs-o-row';
    var div = document.createElement('div');
    div.className = 'flex gap-2 items-center ' + rowClass;
    div.innerHTML = '<input type="number" placeholder="$" class="' + prefix + '-amount w-24 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
      '<input type="text" placeholder="Impact text" class="' + prefix + '-impact flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
      '<button type="button" class="hs-remove-amount p-1 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>';
    container.appendChild(div);
    div.querySelector('.hs-remove-amount').addEventListener('click', function() { div.remove(); });
  }

  // Re-index slide numbers after reorder/delete
  function reindexHeroSlides() {
    var container = document.getElementById('heroSlidesContainer');
    var emptyState = document.getElementById('heroSlidesEmpty');
    var cards = container.querySelectorAll('.hero-slide-card');
    cards.forEach(function(card, i) {
      card.dataset.slideIndex = String(i);
      var numEl = card.querySelector('.hero-slide-header .font-mono');
      if (numEl) numEl.textContent = '#' + (i + 1);
    });
    if (emptyState) {
      emptyState.classList.toggle('hidden', cards.length > 0);
    }
  }

  // Collect all hero slides data from the UI
  function getHeroSlidesConfig() {
    var container = document.getElementById('heroSlidesContainer');
    if (!container) return [];
    var cards = container.querySelectorAll('.hero-slide-card');
    var slides = [];

    cards.forEach(function(card) {
      var slide = {};

      // Slide content
      slide.image = card.querySelector('.hs-image')?.value || '';
      slide.eyebrow = card.querySelector('.hs-eyebrow')?.value || '';
      slide.headline = card.querySelector('.hs-headline')?.value || '';
      slide.headlineAccent = card.querySelector('.hs-headline-accent')?.value || '';
      slide.description = card.querySelector('.hs-description')?.value || '';
      slide.primaryCta = {
        text: card.querySelector('.hs-primary-text')?.value || '',
        href: card.querySelector('.hs-primary-href')?.value || ''
      };
      slide.secondaryCta = {
        text: card.querySelector('.hs-secondary-text')?.value || '',
        href: card.querySelector('.hs-secondary-href')?.value || ''
      };

      // Stats
      var stats = [];
      var statDivs = card.querySelectorAll('.hs-stats-container > div');
      statDivs.forEach(function(div) {
        var val = div.querySelector('.hs-stat-value')?.value || '';
        var label = div.querySelector('.hs-stat-label')?.value || '';
        if (val || label) {
          stats.push({ value: val, label: label });
        }
      });
      if (stats.length > 0) {
        slide.stats = stats;
      }

      // Donation config
      var donation = {};
      var campaignSlug = card.querySelector('.hs-campaign-slug')?.value;
      var campaignTitle = card.querySelector('.hs-campaign-title')?.value;
      var donationHeading = card.querySelector('.hs-donation-heading')?.value;
      var tabEmojiVal = card.querySelector('.hs-tab-emoji')?.value;
      var upsellBody = card.querySelector('.hs-upsell-body')?.value;
      var upsellSub = card.querySelector('.hs-upsell-sub')?.value;

      if (campaignSlug) donation.campaignSlug = campaignSlug;
      if (campaignTitle) donation.campaignTitle = campaignTitle;
      if (donationHeading) donation.donationBoxHeading = donationHeading;
      if (tabEmojiVal) donation.tabEmoji = tabEmojiVal;
      if (upsellBody) donation.upsellBody = upsellBody;
      if (upsellSub) donation.upsellSubText = upsellSub;

      // Collect per-slide frequencies
      var hsFreqList = card.querySelector('.hs-freq-list');
      if (hsFreqList && hsFreqList.id) {
        var slideFreqs = collectFrequenciesFromContainer(hsFreqList);
        if (slideFreqs && slideFreqs.length > 0) {
          donation.frequencies = slideFreqs;
        }
      }

      if (Object.keys(donation).length > 0) {
        slide.donation = donation;
      }

      slides.push(slide);
    });

    return slides;
  }

  // Initialize hero slides from existing template_config
  function initHeroSlides() {
    var slidesConfig = existingTemplateConfig?.heroSlides;
    var container = document.getElementById('heroSlidesContainer');
    var emptyState = document.getElementById('heroSlidesEmpty');
    if (!container) return;

    if (slidesConfig && Array.isArray(slidesConfig) && slidesConfig.length > 0) {
      slidesConfig.forEach(function(slideData, i) {
        var card = renderHeroSlideCard(i, slideData);
        container.appendChild(card);
        attachHeroSlideListeners(card);
      });
      if (emptyState) emptyState.classList.add('hidden');
    } else {
      if (emptyState) emptyState.classList.remove('hidden');
    }
  }

  // Add new slide button
  document.getElementById('addHeroSlideBtn')?.addEventListener('click', function() {
    var container = document.getElementById('heroSlidesContainer');
    var emptyState = document.getElementById('heroSlidesEmpty');
    var currentCount = container.querySelectorAll('.hero-slide-card').length;
    var card = renderHeroSlideCard(currentCount, {});
    container.appendChild(card);
    attachHeroSlideListeners(card);
    if (emptyState) emptyState.classList.add('hidden');
    // Auto-expand the new slide
    var body = card.querySelector('.hs-body');
    if (body) body.classList.remove('hidden');
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  // Init hero slides on load
  initHeroSlides();

  // Save page
  const saveBtn = document.getElementById('saveBtn');
  const saveBtnText = document.getElementById('saveBtnText');
  const saveSpinner = document.getElementById('saveSpinner');
  const toast = document.getElementById('toast');

  function showToast(message, isError) {
    if (isError === undefined) isError = false;
    if (!toast) return;
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
    toast.innerHTML = `
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isError ? 'M6 18L18 6M6 6l12 12' : 'M5 13l4 4L19 7'}"></path>
      </svg>
      <span>${message}</span>
    `;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }

  saveBtn?.addEventListener('click', async () => {
    const title = document.getElementById('pageTitle')?.value;
    const slugInput = document.getElementById('pageSlug')?.value;
    const status = document.getElementById('pageStatus')?.value;
    const template = document.getElementById('pageTemplate')?.value;
    const donationBoxTemplate = document.getElementById('donationBoxTemplate')?.value;
    const metaTitle = document.getElementById('metaTitle')?.value;
    const metaDescription = document.getElementById('metaDescription')?.value;
    const featuredImage = document.getElementById('featuredImage')?.value;

    if (!title || !slugInput) {
      showToast('Please fill in title and slug', true);
      return;
    }

    const slug = slugInput.startsWith('/') ? slugInput : `/${slugInput}`;

    saveSpinner?.classList.remove('hidden');
    if (saveBtnText) saveBtnText.textContent = 'Saving...';

    try {
      // Build template_config with CW donation box settings + hero slides
      var templateConfig = Object.assign({}, existingTemplateConfig);
      var cwDonation = getCWDonationConfig();
      if (cwDonation) {
        templateConfig.cwDonation = cwDonation;
      } else {
        delete templateConfig.cwDonation;
      }

      // Hero slides config
      var heroSlidesConfig = getHeroSlidesConfig();
      if (heroSlidesConfig && heroSlidesConfig.length > 0) {
        templateConfig.heroSlides = heroSlidesConfig;
      } else {
        delete templateConfig.heroSlides;
      }

      const data = {
        title,
        slug,
        status,
        template,
        donation_box_template: donationBoxTemplate || null,
        template_config: templateConfig,
        meta_title: metaTitle,
        meta_description: metaDescription,
        featured_image: featuredImage,
        content: JSON.stringify({ sections })
      };

      if (!isNew && pageId) {
        data.id = pageId;
      }

      const response = await fetch('/api/pages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        showToast('Page saved successfully!');
        if (isNew && result.page?.id) {
          setTimeout(() => {
            window.location.href = `/admin/pages/${result.page.id}`;
          }, 1000);
        }
      } else {
        showToast(result.error || 'Failed to save', true);
      }
    } catch (error) {
      showToast('Failed to save page', true);
    }

    saveSpinner?.classList.add('hidden');
    if (saveBtnText) saveBtnText.textContent = 'Save Page';
  });

  // Featured image preview
  const featuredImageInput = document.getElementById('featuredImage');
  const featuredImagePreview = document.getElementById('featuredImagePreview');
  const featuredImagePlaceholder = document.getElementById('featuredImagePlaceholder');

  featuredImageInput?.addEventListener('input', () => {
    if (featuredImageInput.value) {
      featuredImagePreview.src = featuredImageInput.value;
      featuredImagePreview.classList.remove('hidden');
      featuredImagePlaceholder?.classList.add('hidden');
    } else {
      featuredImagePreview.classList.add('hidden');
      featuredImagePlaceholder?.classList.remove('hidden');
    }
  });

  // Featured image upload
  const featuredImageUpload = document.getElementById('featuredImageUpload');
  featuredImageUpload?.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/api/media/upload', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();

      if (result.success) {
        featuredImageInput.value = result.url;
        featuredImagePreview.src = result.url;
        featuredImagePreview.classList.remove('hidden');
        featuredImagePlaceholder?.classList.add('hidden');
      }
    } catch (error) {
      showToast('Upload failed', true);
    }
  });

  // Auto-generate slug from title
  const pageTitleInput = document.getElementById('pageTitle');
  const pageSlugInput = document.getElementById('pageSlug');

  if (isNew) {
    pageTitleInput?.addEventListener('input', () => {
      const slug = pageTitleInput.value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
      pageSlugInput.value = slug;
    });
  }
</script>
