---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabase';
import { getDonationBoxTemplates } from '../../../lib/templates';

export const prerender = false;

const { id } = Astro.params;

// Fetch the page data
let page: any = null;
let error = '';

if (id && id !== 'new') {
  const { data, error: fetchError } = await supabaseAdmin
    .from('pages')
    .select('*')
    .eq('id', id)
    .single();

  if (fetchError) {
    error = fetchError.message;
  } else {
    page = data;
  }
}

// Fetch donation box templates for the dropdown
const donationBoxTemplates = await getDonationBoxTemplates();

// Default content structure - uses page title if available
function getDefaultContent(title: string = 'Page Title') {
  return {
    sections: [
      {
        id: 'hero',
        type: 'hero',
        title: title,
        subtitle: 'Add your subtitle here',
        backgroundImage: '',
        showButton: true,
        buttonText: 'Learn More',
        buttonLink: '#'
      },
      {
        id: 'content-1',
        type: 'content',
        content: '<p>Start adding your content here...</p>'
      }
    ]
  };
}

// Parse existing content or create default
let pageContent;
if (page?.content) {
  try {
    const parsed = typeof page.content === 'string' ? JSON.parse(page.content) : page.content;
    // Check if content has valid sections
    if (parsed.sections && parsed.sections.length > 0) {
      pageContent = parsed;
    } else {
      pageContent = getDefaultContent(page.title);
    }
  } catch (e) {
    pageContent = getDefaultContent(page?.title);
  }
} else {
  pageContent = getDefaultContent(page?.title || 'New Page');
}
---

<AdminLayout title={page ? `Edit: ${page.title}` : 'New Page'} activeNav="pages">
  <div class="max-w-5xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <a href="/admin/pages" class="p-2 hover:bg-gray-100 rounded-lg transition">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">{page ? `Edit: ${page.title}` : 'Create New Page'}</h1>
          <p class="text-gray-500 text-sm">{page?.slug || 'Set page URL below'}</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        {page && (
          <a
            href={page.slug}
            target="_blank"
            class="flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Preview
          </a>
        )}
        <button
          id="saveBtn"
          class="flex items-center gap-2 px-6 py-2 bg-[#01534d] text-white rounded-lg hover:bg-[#013d39] transition font-medium"
        >
          <span id="saveBtnText">Save Page</span>
          <svg id="saveSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2"></div>

    <!-- Page Settings -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Page Settings</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Page Title *</label>
          <input
            type="text"
            id="pageTitle"
            value={page?.title || ''}
            placeholder="e.g., About Us"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">URL Slug *</label>
          <div class="flex">
            <span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-200 rounded-l-lg text-gray-500 text-sm">/</span>
            <input
              type="text"
              id="pageSlug"
              value={page?.slug?.replace(/^\/+/, '') || ''}
              placeholder="about-us"
              class="flex-1 px-4 py-2 border border-gray-200 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
              required
            />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select
            id="pageStatus"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white"
          >
            <option value="draft" selected={page?.status === 'draft'}>Draft</option>
            <option value="published" selected={page?.status === 'published'}>Published</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Template</label>
          <select
            id="pageTemplate"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white"
          >
            <option value="default" selected={page?.template === 'default'}>Default</option>
            <option value="home" selected={page?.template === 'home'}>Home</option>
            <option value="landing" selected={page?.template === 'landing'}>Landing Page</option>
            <option value="contact" selected={page?.template === 'contact'}>Contact</option>
            <option value="legal" selected={page?.template === 'legal'}>Legal (Privacy, Terms)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Donation Box Template</label>
          <select
            id="donationBoxTemplate"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white"
          >
            <option value="" selected={!page?.donation_box_template}>Use Site Default</option>
            {donationBoxTemplates.map((template) => (
              <option value={template.template_key} selected={page?.donation_box_template === template.template_key}>
                {template.template_label}
              </option>
            ))}
          </select>
          <p class="text-xs text-gray-400 mt-1">Override the default donation box for this page</p>
        </div>
      </div>
    </div>

    <!-- CW Donation Box Settings (shown when donation box = cw-donation) -->
    <div id="cwDonationSettings" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6 hidden">
      <h2 class="text-lg font-bold text-gray-800 mb-2">Donation Box Settings</h2>
      <p class="text-sm text-gray-500 mb-6">Configure amounts, impact texts, and labels for the CW Donation Box on this page</p>

      <!-- Monthly Amounts -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="font-semibold text-gray-700">Monthly Amounts</h3>
            <p class="text-xs text-gray-400">Set preset monthly donation amounts and their impact descriptions</p>
          </div>
          <button type="button" id="addCWMonthlyBtn" class="px-3 py-1.5 bg-[#01534d] text-white text-sm rounded-lg hover:bg-[#01433f]">+ Add Amount</button>
        </div>
        <div id="cwMonthlyAmounts" class="space-y-3"></div>
      </div>

      <!-- One-Time Amounts -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="font-semibold text-gray-700">One-Time Amounts</h3>
            <p class="text-xs text-gray-400">Set preset one-time donation amounts and their impact descriptions</p>
          </div>
          <button type="button" id="addCWOneTimeBtn" class="px-3 py-1.5 bg-[#01534d] text-white text-sm rounded-lg hover:bg-[#01433f]">+ Add Amount</button>
        </div>
        <div id="cwOneTimeAmounts" class="space-y-3"></div>
      </div>

      <!-- Text Settings -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 mb-2">Text Settings</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Donation Box Heading</label>
          <input type="text" id="cwDonationBoxHeading" placeholder="e.g. Be the Reason They Smile Every Month" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
          <p class="text-xs text-gray-400 mt-1">Heading displayed above the donation box. Leave blank for no heading.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Button Text</label>
            <input type="text" id="cwButtonTextMonthly" placeholder="JOIN TODAY" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">One-Time Button Text</label>
            <input type="text" id="cwButtonTextOneTime" placeholder="GIVE" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Impact Text (fallback)</label>
          <input type="text" id="cwMonthlyImpactText" placeholder="Your monthly gift transforms lives around the world" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
          <p class="text-xs text-gray-400 mt-1">Shown under monthly tab when no amount-specific text exists. HTML allowed.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Upsell Body Text</label>
          <textarea id="cwUpsellBody" rows="3" placeholder="By making a monthly donation, you'll empower us to make long-term investments..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
          <p class="text-xs text-gray-400 mt-1">Shown on the monthly upsell page after one-time "GIVE" is clicked</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Upsell Sub Text</label>
          <textarea id="cwUpsellSubText" rows="2" placeholder="Please consider joining our monthly giving community..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
          <p class="text-xs text-gray-400 mt-1">Shown below the monthly toggle on the upsell page</p>
        </div>
      </div>
    </div>

    <!-- SEO Settings -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">SEO Settings</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title</label>
          <input
            type="text"
            id="metaTitle"
            value={page?.meta_title || ''}
            placeholder="Page title for search engines"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
          />
          <p class="text-xs text-gray-500 mt-1">Leave empty to use page title</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
          <textarea
            id="metaDescription"
            rows="2"
            placeholder="Brief description for search results"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
          >{page?.meta_description || ''}</textarea>
        </div>
      </div>
    </div>

    <!-- Page Content -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-800">Page Content</h2>
        <button
          id="addSectionBtn"
          class="flex items-center gap-2 px-3 py-1.5 text-sm border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Section
        </button>
      </div>

      <div id="sectionsContainer" class="space-y-4">
        <!-- Sections will be rendered here -->
      </div>
    </div>

    <!-- Featured Image -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Featured Image</h2>
      <div class="flex gap-4">
        <div class="w-48 h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
          <img
            id="featuredImagePreview"
            src={page?.featured_image || ''}
            alt="Featured"
            class={page?.featured_image ? 'w-full h-full object-cover' : 'hidden'}
          />
          <div id="featuredImagePlaceholder" class={page?.featured_image ? 'hidden' : 'text-center text-gray-400'}>
            <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="text-xs">No image</span>
          </div>
        </div>
        <div class="flex-1">
          <input
            type="text"
            id="featuredImage"
            value={page?.featured_image || ''}
            placeholder="Image URL"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] text-sm mb-2"
          />
          <div class="flex gap-2">
            <label class="cursor-pointer">
              <input type="file" id="featuredImageUpload" accept="image/*" class="hidden" />
              <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-[#01534d] text-white rounded-lg text-sm hover:bg-[#013d39] transition">
                Upload
              </span>
            </label>
            <button type="button" id="featuredImageGalleryBtn" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50 transition">
              Gallery
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Section Modal -->
  <div id="addSectionModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-bold text-gray-800">Add Section</h3>
        <button type="button" id="closeAddSectionModal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-4 grid grid-cols-2 gap-3">
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="hero">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="font-medium text-gray-800">Hero Section</p>
          <p class="text-xs text-gray-500">Large banner with title</p>
        </button>
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="content">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="font-medium text-gray-800">Text Content</p>
          <p class="text-xs text-gray-500">Rich text editor</p>
        </button>
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="image">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="font-medium text-gray-800">Image</p>
          <p class="text-xs text-gray-500">Single image with caption</p>
        </button>
        <button type="button" class="add-section-type p-4 border border-gray-200 rounded-lg hover:border-[#01534d] hover:bg-[#01534d]/5 transition text-left" data-type="cta">
          <svg class="w-8 h-8 text-[#01534d] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
          </svg>
          <p class="font-medium text-gray-800">Call to Action</p>
          <p class="text-xs text-gray-500">Button with text</p>
        </button>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ pageId: id, initialContent: pageContent, existingPage: page, existingTemplateConfig: page?.template_config || {} }}>
  let sections = initialContent?.sections || [];
  const isNew = !existingPage;

  // Render sections
  function renderSections() {
    const container = document.getElementById('sectionsContainer');
    if (!container) return;

    if (sections.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
          <p class="text-gray-500 mb-2">No sections yet</p>
          <button type="button" id="addFirstSection" class="text-[#01534d] font-medium hover:underline">Add your first section</button>
        </div>
      `;
      document.getElementById('addFirstSection')?.addEventListener('click', () => {
        document.getElementById('addSectionModal')?.classList.remove('hidden');
      });
      return;
    }

    container.innerHTML = sections.map((section, index) => {
      let content = '';

      if (section.type === 'hero') {
        content = `
          <div class="space-y-3">
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="title" value="${section.title || ''}" placeholder="Hero Title" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="subtitle" value="${section.subtitle || ''}" placeholder="Subtitle" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="backgroundImage" value="${section.backgroundImage || ''}" placeholder="Background Image URL" />
          </div>
        `;
      } else if (section.type === 'content') {
        content = `
          <textarea class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg min-h-[200px]" data-field="content" placeholder="Write your content here... (HTML supported)">${section.content || ''}</textarea>
        `;
      } else if (section.type === 'image') {
        content = `
          <div class="space-y-3">
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="imageUrl" value="${section.imageUrl || ''}" placeholder="Image URL" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="caption" value="${section.caption || ''}" placeholder="Caption (optional)" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="alt" value="${section.alt || ''}" placeholder="Alt text" />
          </div>
        `;
      } else if (section.type === 'cta') {
        content = `
          <div class="space-y-3">
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="title" value="${section.title || ''}" placeholder="CTA Title" />
            <input type="text" class="section-field w-full px-3 py-2 border border-gray-200 rounded-lg" data-field="description" value="${section.description || ''}" placeholder="Description" />
            <div class="grid grid-cols-2 gap-3">
              <input type="text" class="section-field px-3 py-2 border border-gray-200 rounded-lg" data-field="buttonText" value="${section.buttonText || ''}" placeholder="Button Text" />
              <input type="text" class="section-field px-3 py-2 border border-gray-200 rounded-lg" data-field="buttonLink" value="${section.buttonLink || ''}" placeholder="Button Link" />
            </div>
          </div>
        `;
      }

      return `
        <div class="section-item border border-gray-200 rounded-lg p-4" data-index="${index}">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="cursor-move text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                </svg>
              </span>
              <span class="text-sm font-medium text-gray-700 capitalize">${section.type} Section</span>
            </div>
            <button type="button" class="delete-section text-red-500 hover:text-red-700 p-1" data-index="${index}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          ${content}
        </div>
      `;
    }).join('');

    // Add event listeners to section fields
    document.querySelectorAll('.section-field').forEach(field => {
      field.addEventListener('input', (e) => {
        const target = e.target;
        const sectionItem = target.closest('.section-item');
        const index = parseInt(sectionItem?.dataset.index || '0');
        const fieldName = target.dataset.field || '';
        if (sections[index]) {
          sections[index][fieldName] = target.value;
        }
      });
    });

    // Delete section buttons
    document.querySelectorAll('.delete-section').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget;
        const index = parseInt(target.dataset.index || '0');
        if (confirm('Delete this section?')) {
          sections.splice(index, 1);
          renderSections();
        }
      });
    });
  }

  // Initialize
  renderSections();

  // Add section modal
  const addSectionBtn = document.getElementById('addSectionBtn');
  const addSectionModal = document.getElementById('addSectionModal');
  const closeAddSectionModal = document.getElementById('closeAddSectionModal');

  addSectionBtn?.addEventListener('click', () => {
    addSectionModal?.classList.remove('hidden');
  });

  closeAddSectionModal?.addEventListener('click', () => {
    addSectionModal?.classList.add('hidden');
  });

  addSectionModal?.addEventListener('click', (e) => {
    if (e.target === addSectionModal) {
      addSectionModal.classList.add('hidden');
    }
  });

  // Add section type buttons
  document.querySelectorAll('.add-section-type').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.type || 'content';
      const newSection = {
        id: `section-${Date.now()}`,
        type
      };

      if (type === 'hero') {
        newSection.title = 'Section Title';
        newSection.subtitle = '';
        newSection.backgroundImage = '';
      } else if (type === 'content') {
        newSection.content = '';
      } else if (type === 'image') {
        newSection.imageUrl = '';
        newSection.caption = '';
        newSection.alt = '';
      } else if (type === 'cta') {
        newSection.title = '';
        newSection.description = '';
        newSection.buttonText = 'Learn More';
        newSection.buttonLink = '#';
      }

      sections.push(newSection);
      renderSections();
      addSectionModal?.classList.add('hidden');
    });
  });

  // ═══════════════════════════════════════════
  // CW DONATION BOX SETTINGS
  // ═══════════════════════════════════════════
  var cwMonthlyIndex = 0;
  var cwOneTimeIndex = 0;

  // Toggle visibility based on donation box template selection
  var donationBoxSelect = document.getElementById('donationBoxTemplate');
  var cwSettingsPanel = document.getElementById('cwDonationSettings');

  function toggleCWSettings() {
    if (!donationBoxSelect || !cwSettingsPanel) return;
    var isCW = donationBoxSelect.value === 'cw-donation';
    cwSettingsPanel.classList.toggle('hidden', !isCW);
  }

  if (donationBoxSelect) {
    donationBoxSelect.addEventListener('change', toggleCWSettings);
    toggleCWSettings();
  }

  // Add monthly amount row
  function addCWMonthlyAmount(amount, impactText) {
    amount = amount || '';
    impactText = impactText || '';
    var container = document.getElementById('cwMonthlyAmounts');
    var idx = cwMonthlyIndex++;
    var div = document.createElement('div');
    div.id = 'cw-monthly-' + idx;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = '<input type="number" placeholder="Amount ($)" value="' + amount + '" class="cw-m-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<input type="text" placeholder="Impact text (e.g., Feeds a family for a month)" value="' + (impactText || '').replace(/"/g, '&quot;') + '" class="cw-m-impact flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<button type="button" class="cw-remove-btn p-2 text-red-500 hover:bg-red-50 rounded" data-target="cw-monthly-' + idx + '">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
    div.querySelector('.cw-remove-btn').addEventListener('click', function() { div.remove(); });
  }

  // Add one-time amount row
  function addCWOneTimeAmount(amount, impactText) {
    amount = amount || '';
    impactText = impactText || '';
    var container = document.getElementById('cwOneTimeAmounts');
    var idx = cwOneTimeIndex++;
    var div = document.createElement('div');
    div.id = 'cw-onetime-' + idx;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = '<input type="number" placeholder="Amount ($)" value="' + amount + '" class="cw-o-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<input type="text" placeholder="Impact text (e.g., Provide emergency food parcels)" value="' + (impactText || '').replace(/"/g, '&quot;') + '" class="cw-o-impact flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<button type="button" class="cw-remove-btn p-2 text-red-500 hover:bg-red-50 rounded" data-target="cw-onetime-' + idx + '">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
    div.querySelector('.cw-remove-btn').addEventListener('click', function() { div.remove(); });
  }

  // Wire up add buttons
  document.getElementById('addCWMonthlyBtn')?.addEventListener('click', function() { addCWMonthlyAmount(); });
  document.getElementById('addCWOneTimeBtn')?.addEventListener('click', function() { addCWOneTimeAmount(); });

  // Collect CW donation config into an object
  function getCWDonationConfig() {
    var monthlyAmounts = [];
    var monthlyImpacts = {};
    document.querySelectorAll('#cwMonthlyAmounts > div').forEach(function(div) {
      var amount = parseFloat(div.querySelector('.cw-m-amount').value);
      var impact = div.querySelector('.cw-m-impact').value;
      if (amount) {
        monthlyAmounts.push(amount);
        if (impact) monthlyImpacts[amount] = impact;
      }
    });

    var oneTimeAmounts = [];
    var singleImpacts = {};
    document.querySelectorAll('#cwOneTimeAmounts > div').forEach(function(div) {
      var amount = parseFloat(div.querySelector('.cw-o-amount').value);
      var impact = div.querySelector('.cw-o-impact').value;
      if (amount) {
        oneTimeAmounts.push(amount);
        if (impact) singleImpacts[amount] = impact;
      }
    });

    var config = {};
    if (monthlyAmounts.length > 0) config.monthlyAmounts = monthlyAmounts;
    if (oneTimeAmounts.length > 0) config.oneTimeAmounts = oneTimeAmounts;

    var impactTexts = {};
    if (Object.keys(monthlyImpacts).length > 0) impactTexts.monthly = monthlyImpacts;
    if (Object.keys(singleImpacts).length > 0) impactTexts.single = singleImpacts;
    if (Object.keys(impactTexts).length > 0) config.impactTexts = impactTexts;

    var monthlyImpactText = document.getElementById('cwMonthlyImpactText')?.value;
    var upsellBody = document.getElementById('cwUpsellBody')?.value;
    var upsellSubText = document.getElementById('cwUpsellSubText')?.value;
    var btnMonthly = document.getElementById('cwButtonTextMonthly')?.value;
    var btnOneTime = document.getElementById('cwButtonTextOneTime')?.value;
    var heading = document.getElementById('cwDonationBoxHeading')?.value;

    if (monthlyImpactText) config.monthlyImpactText = monthlyImpactText;
    if (upsellBody) config.upsellBody = upsellBody;
    if (upsellSubText) config.upsellSubText = upsellSubText;
    if (btnMonthly) config.buttonTextMonthly = btnMonthly;
    if (btnOneTime) config.buttonTextOneTime = btnOneTime;
    if (heading) config.donationBoxHeading = heading;

    return Object.keys(config).length > 0 ? config : null;
  }

  // Initialize CW settings from existing template_config
  function initCWDonationSettings() {
    var cwConfig = existingTemplateConfig?.cwDonation || {};

    if (cwConfig.monthlyAmounts && cwConfig.monthlyAmounts.length > 0) {
      var monthlyImpacts = cwConfig.impactTexts?.monthly || {};
      cwConfig.monthlyAmounts.forEach(function(amt) {
        addCWMonthlyAmount(amt, monthlyImpacts[amt] || '');
      });
    } else {
      // Default amounts
      [10, 20, 40, 100].forEach(function(amt) { addCWMonthlyAmount(amt, ''); });
    }

    if (cwConfig.oneTimeAmounts && cwConfig.oneTimeAmounts.length > 0) {
      var singleImpacts = cwConfig.impactTexts?.single || {};
      cwConfig.oneTimeAmounts.forEach(function(amt) {
        addCWOneTimeAmount(amt, singleImpacts[amt] || '');
      });
    } else {
      [50, 100, 150, 200].forEach(function(amt) { addCWOneTimeAmount(amt, ''); });
    }

    // Populate text fields
    var mImpact = document.getElementById('cwMonthlyImpactText');
    var uBody = document.getElementById('cwUpsellBody');
    var uSub = document.getElementById('cwUpsellSubText');
    var bMonthly = document.getElementById('cwButtonTextMonthly');
    var bOneTime = document.getElementById('cwButtonTextOneTime');
    var headingInput = document.getElementById('cwDonationBoxHeading');

    if (mImpact) mImpact.value = cwConfig.monthlyImpactText || '';
    if (uBody) uBody.value = cwConfig.upsellBody || '';
    if (uSub) uSub.value = cwConfig.upsellSubText || '';
    if (bMonthly) bMonthly.value = cwConfig.buttonTextMonthly || '';
    if (bOneTime) bOneTime.value = cwConfig.buttonTextOneTime || '';
    if (headingInput) headingInput.value = cwConfig.donationBoxHeading || '';
  }

  // Init on load
  initCWDonationSettings();

  // Save page
  const saveBtn = document.getElementById('saveBtn');
  const saveBtnText = document.getElementById('saveBtnText');
  const saveSpinner = document.getElementById('saveSpinner');
  const toast = document.getElementById('toast');

  function showToast(message, isError) {
    if (isError === undefined) isError = false;
    if (!toast) return;
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
    toast.innerHTML = `
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isError ? 'M6 18L18 6M6 6l12 12' : 'M5 13l4 4L19 7'}"></path>
      </svg>
      <span>${message}</span>
    `;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }

  saveBtn?.addEventListener('click', async () => {
    const title = document.getElementById('pageTitle')?.value;
    const slugInput = document.getElementById('pageSlug')?.value;
    const status = document.getElementById('pageStatus')?.value;
    const template = document.getElementById('pageTemplate')?.value;
    const donationBoxTemplate = document.getElementById('donationBoxTemplate')?.value;
    const metaTitle = document.getElementById('metaTitle')?.value;
    const metaDescription = document.getElementById('metaDescription')?.value;
    const featuredImage = document.getElementById('featuredImage')?.value;

    if (!title || !slugInput) {
      showToast('Please fill in title and slug', true);
      return;
    }

    const slug = slugInput.startsWith('/') ? slugInput : `/${slugInput}`;

    saveSpinner?.classList.remove('hidden');
    if (saveBtnText) saveBtnText.textContent = 'Saving...';

    try {
      // Build template_config with CW donation box settings
      var templateConfig = Object.assign({}, existingTemplateConfig);
      var cwDonation = getCWDonationConfig();
      if (cwDonation) {
        templateConfig.cwDonation = cwDonation;
      } else {
        delete templateConfig.cwDonation;
      }

      const data = {
        title,
        slug,
        status,
        template,
        donation_box_template: donationBoxTemplate || null,
        template_config: templateConfig,
        meta_title: metaTitle,
        meta_description: metaDescription,
        featured_image: featuredImage,
        content: JSON.stringify({ sections })
      };

      if (!isNew && pageId) {
        data.id = pageId;
      }

      const response = await fetch('/api/pages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        showToast('Page saved successfully!');
        if (isNew && result.page?.id) {
          setTimeout(() => {
            window.location.href = `/admin/pages/${result.page.id}`;
          }, 1000);
        }
      } else {
        showToast(result.error || 'Failed to save', true);
      }
    } catch (error) {
      showToast('Failed to save page', true);
    }

    saveSpinner?.classList.add('hidden');
    if (saveBtnText) saveBtnText.textContent = 'Save Page';
  });

  // Featured image preview
  const featuredImageInput = document.getElementById('featuredImage');
  const featuredImagePreview = document.getElementById('featuredImagePreview');
  const featuredImagePlaceholder = document.getElementById('featuredImagePlaceholder');

  featuredImageInput?.addEventListener('input', () => {
    if (featuredImageInput.value) {
      featuredImagePreview.src = featuredImageInput.value;
      featuredImagePreview.classList.remove('hidden');
      featuredImagePlaceholder?.classList.add('hidden');
    } else {
      featuredImagePreview.classList.add('hidden');
      featuredImagePlaceholder?.classList.remove('hidden');
    }
  });

  // Featured image upload
  const featuredImageUpload = document.getElementById('featuredImageUpload');
  featuredImageUpload?.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/api/media/upload', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();

      if (result.success) {
        featuredImageInput.value = result.url;
        featuredImagePreview.src = result.url;
        featuredImagePreview.classList.remove('hidden');
        featuredImagePlaceholder?.classList.add('hidden');
      }
    } catch (error) {
      showToast('Upload failed', true);
    }
  });

  // Auto-generate slug from title
  const pageTitleInput = document.getElementById('pageTitle');
  const pageSlugInput = document.getElementById('pageSlug');

  if (isNew) {
    pageTitleInput?.addEventListener('input', () => {
      const slug = pageTitleInput.value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
      pageSlugInput.value = slug;
    });
  }
</script>
