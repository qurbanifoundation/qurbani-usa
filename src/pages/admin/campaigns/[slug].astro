---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabase';
import { getPageTemplates, getDonationBoxTemplates } from '../../../lib/templates';
import { generateImpactTexts, getDefaultMonthlyImpact, DEFAULT_UPSELL_BODY, DEFAULT_UPSELL_SUBTEXT, DEFAULT_BUTTON_MONTHLY, DEFAULT_BUTTON_ONETIME } from '../../../lib/donation-defaults';
import { DEFAULT_PAGE_CONTENT } from '../../../lib/page-content-defaults';

export const prerender = false;

const { slug: id } = Astro.params;

// Fetch campaign from Supabase
let campaign: any = null;
let fetchError = '';

try {
  const { data, error } = await supabaseAdmin
    .from('campaigns')
    .select('*')
    .eq('id', id)
    .single();

  if (error) {
    fetchError = error.message;
  } else {
    campaign = data;
  }
} catch (e: any) {
  fetchError = e.message || 'Failed to fetch campaign';
}

if (!campaign && !fetchError) {
  return Astro.redirect('/admin/campaigns');
}

// Fetch templates from database (centralized)
const pageTemplates = await getPageTemplates();
const donationBoxTemplates = await getDonationBoxTemplates();

// Fetch categories for URL prefix
let categories: any[] = [];
try {
  const { data } = await supabaseAdmin
    .from('categories')
    .select('slug, label')
    .eq('is_active', true)
    .order('label');
  categories = data || [];
} catch (e) {}

// Fetch media for image selection
let mediaFiles: any[] = [];
try {
  const { data } = await supabaseAdmin.storage.from('media').list('', { limit: 100 });
  if (data) {
    const { data: { publicUrl } } = supabaseAdmin.storage.from('media').getPublicUrl('');
    mediaFiles = data
      .filter(file => file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i))
      .map(file => ({
        name: file.name,
        url: `${publicUrl}${file.name}`
      }));
  }
} catch (e) {}

// Parse existing URL to detect category prefix
const existingUrlPath = campaign?.url_path || '';
let existingCategoryPrefix = '';
let existingSlugPart = campaign?.slug || '';

// Check if url_path has a category prefix (e.g., /ramadan/fidya)
if (existingUrlPath && existingUrlPath.startsWith('/')) {
  const parts = existingUrlPath.slice(1).split('/');
  if (parts.length >= 2) {
    // Check if first part matches a category slug
    const possibleCategory = categories.find(c => c.slug === parts[0]);
    if (possibleCategory) {
      existingCategoryPrefix = parts[0];
    }
  }
}

// Generate auto-detected defaults for CW Donation Box based on campaign slug
const campaignSlug = campaign?.slug || 'general';
const autoImpactTexts = generateImpactTexts(campaignSlug);
const autoMonthlyImpact = getDefaultMonthlyImpact(campaignSlug);
---

<AdminLayout title={campaign ? `Edit: ${campaign.title}` : 'Campaign Not Found'} activeNav="campaigns">
  <div class="max-w-5xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <a href="/admin/campaigns" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Campaigns
      </a>
      {campaign && (
        <a
          href={campaign.url_path || `/appeals/${campaign.slug}`}
          target="_blank"
          class="inline-flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
          Preview Page
        </a>
      )}
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50"></div>

    {fetchError ? (
      <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
        <p class="text-red-800 mb-4">Error: {fetchError}</p>
        <a href="/admin/campaigns" class="text-[#01534d] underline">Return to campaigns</a>
      </div>
    ) : campaign ? (
      <form id="campaignForm" class="space-y-6">
        <input type="hidden" name="id" value={campaign.id} />

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- CAMPAIGN TITLE & STATUS (collapsible, folded by default) -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Campaign Title & Status</h2>
                <p class="text-sm text-gray-400">Title, URL slug, active/featured status</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Title *</label>
                <input
                  type="text"
                  name="title"
                  required
                  value={campaign.title || campaign.name || ''}
                  class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <div class="flex items-center gap-4">
                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" checked={campaign.is_active} class="w-4 h-4 text-[#01534d] rounded" />
                    <span class="text-sm">Active</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_featured" checked={campaign.is_featured} class="w-4 h-4 text-[#01534d] rounded" />
                    <span class="text-sm">Featured</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="show_on_homepage" checked={campaign.show_on_homepage} class="w-4 h-4 text-[#01534d] rounded" />
                    <span class="text-sm">Homepage</span>
                  </label>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">URL Path</label>
                <div class="flex items-center gap-1 flex-wrap">
                  <span class="text-gray-500 text-sm">/</span>
                  <select
                    name="url_category"
                    id="url-category"
                    class="px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] text-sm bg-white"
                  >
                    <option value="">appeals</option>
                    {categories.map(cat => (
                      <option value={cat.slug} selected={existingCategoryPrefix === cat.slug}>{cat.slug}</option>
                    ))}
                  </select>
                  <span class="text-gray-500 text-sm">/</span>
                  <input
                    type="text"
                    name="slug"
                    id="campaign-slug"
                    value={campaign.slug}
                    placeholder="campaign-slug"
                    class="flex-1 min-w-[200px] px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] font-mono text-sm"
                  />
                </div>
                <p class="text-xs text-gray-400 mt-1">
                  Preview: <code id="url-preview" class="bg-gray-100 px-1.5 py-0.5 rounded font-mono">{existingUrlPath || `/appeals/${campaign.slug}`}</code>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- ALL SECTIONS ‚Äî COLLAPSIBLE, FOLDED BY DEFAULT  -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

        <!-- 1. HERO IMAGE -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">1</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Hero Image</h2>
                <p class="text-sm text-gray-400">Background image ‚Äî first thing visitors see</p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              {(campaign.featured_image || campaign.hero_image_url || campaign.image_url) && (
                <img src={campaign.featured_image || campaign.hero_image_url || campaign.image_url} alt="" class="w-16 h-10 object-cover rounded border border-gray-200" />
              )}
              <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="flex items-center justify-end gap-2 mb-4">
              <input type="text" id="customSearchQuery" placeholder="Custom search (e.g., syria relief)" class="w-48 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
              <button type="button" id="fetchStockBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Fetch Stock Images
              </button>
            </div>
            <div id="featuredImagePreview" class={(campaign.featured_image || campaign.hero_image_url || campaign.image_url) ? 'mb-4' : 'hidden mb-4'}>
              <img id="featuredImg" src={campaign.featured_image || campaign.hero_image_url || campaign.image_url || ''} alt="" class="w-full max-h-48 object-cover rounded-lg" />
            </div>
            <input type="hidden" name="featured_image" id="featured_image" value={campaign.featured_image || campaign.hero_image_url || campaign.image_url || ''} />
            <div class="flex gap-3 flex-wrap">
              <button type="button" onclick="openMediaModal('featured')" class="px-4 py-2 bg-[#01534d] text-white rounded-lg text-sm hover:bg-[#01433f]">Choose from Gallery</button>
              <input type="url" id="featuredImageUrl" placeholder="Or paste image URL" class="flex-1 min-w-[200px] px-3 py-2 border border-gray-200 rounded-lg text-sm" />
              <button type="button" onclick="setFeaturedFromUrl()" class="px-4 py-2 border border-gray-200 rounded-lg text-sm hover:bg-gray-50">Use URL</button>
            </div>
            <div id="stockImagesPreview" class="hidden mt-4 border-t border-gray-200 pt-4">
              <div class="flex items-center justify-between mb-3">
                <p class="text-sm font-medium text-gray-700">Select a stock image:</p>
                <p id="stockSearchInfo" class="text-xs text-gray-400"></p>
              </div>
              <div id="stockImagesGrid" class="grid grid-cols-4 gap-3"></div>
              <div class="flex items-center justify-center gap-3 mt-4">
                <button type="button" id="stockLoadMoreBtn" class="hidden px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200 transition flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                  Load More Images
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. HERO TEXT -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">2</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Hero Text</h2>
                <p class="text-sm text-gray-400">Headline, subtext, description, trust indicators</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="space-y-5">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Hero Headline</label>
                <input type="text" name="hero_title" value={campaign.hero_title || ''} placeholder="Leave empty to use Campaign Title above" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] text-lg font-semibold" />
                <p class="text-xs text-gray-400 mt-1">The large heading on the hero banner. If empty, the Campaign Title is used.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Hero Subtext</label>
                <textarea name="subtitle" rows="2" placeholder="Short emotional text under the headline (1-2 lines)" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]">{campaign.subtitle || ''}</textarea>
                <p class="text-xs text-gray-400 mt-1">Displayed below the headline. Keep it emotional and brief.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Hero Subtext 2</label>
                <textarea name="subtitle2" rows="2" placeholder="Optional second line of subtext (e.g., a call-to-action or urgency line)" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]">{campaign.subtitle2 || ''}</textarea>
                <p class="text-xs text-gray-400 mt-1">Optional. If filled, appears as a second line below the first subtext.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Description</label>
                <textarea name="description" rows="4" placeholder="Full description of the campaign (shown in the About section below the hero)" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]">{campaign.description || ''}</textarea>
                <p class="text-xs text-gray-400 mt-1">Main campaign description used in the "About This Appeal" section.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Micro Trust Row</label>
                <div class="bg-gray-50 rounded-lg px-4 py-3 text-sm text-gray-500">
                  üîí Secure Payment &nbsp;¬∑&nbsp; ‚úî 100% Donation Policy &nbsp;¬∑&nbsp; ‚≠ê 501(c)(3) Registered &nbsp;¬∑&nbsp; üåç Delivering Aid in 50+ Countries
                </div>
                <p class="text-xs text-gray-400 mt-1">Shown automatically on all campaign pages.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. DONATION BOX SETTINGS (moved up from 9) -->
        <div id="cwDonationSettings" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">3</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Donation Box Settings</h2>
                <p class="text-sm text-gray-400">Frequency tabs, amounts, impact texts, upsell copy</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <!-- Frequency Tabs Selector -->
            <div class="mb-8">
              <div class="mb-4">
                <h3 class="font-semibold text-gray-700">Donation Frequency Tabs</h3>
                <p class="text-xs text-gray-400">Check frequencies to enable them as tabs. First checked = default tab. Drag to reorder.</p>
              </div>
              <div id="cwFrequencyList" class="space-y-3"></div>
            </div>
            <!-- General Settings -->
            <div class="space-y-4">
              <h3 class="font-semibold text-gray-700 mb-2">General Settings</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Donation Box Heading</label>
                <input type="text" id="cwDonationBoxHeading" placeholder="e.g. Be the Reason They Smile Every Month" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                <p class="text-xs text-gray-400 mt-1">Heading displayed above the donation box. Leave blank for no heading.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tab Icon / Emoji</label>
                <input type="text" id="cwTabEmoji" placeholder="e.g., ü§≤ üíß üåô ‚ù§Ô∏è (auto-detects if blank)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                <p class="text-xs text-gray-400 mt-1">Icon shown on the recurring tabs and impact line</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Upsell Body Text</label>
                <textarea id="cwUpsellBody" rows="3" placeholder="By making a monthly donation, you'll empower us to make long-term investments..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
                <p class="text-xs text-gray-400 mt-1">Shown on the upsell page after one-time "GIVE" is clicked</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Upsell Sub Text</label>
                <textarea id="cwUpsellSubText" rows="2" placeholder="Please consider joining our monthly giving community..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
                <p class="text-xs text-gray-400 mt-1">Shown below the monthly toggle on the upsell page</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 4. DONATION OPTIONS -->
        <div id="legacyDonationOptions" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">4</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Donation Options</h2>
                <p class="text-sm text-gray-400">Preset amounts for "Choose Your Impact" &amp; donation box</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="flex items-center justify-end mb-4">
              <button type="button" onclick="addDonationOption()" class="px-3 py-1.5 bg-[#01534d] text-white text-sm rounded-lg hover:bg-[#01433f]">+ Add Option</button>
            </div>
            <div id="donationOptions" class="space-y-3">
              <!-- Options added via JS -->
            </div>
          </div>
        </div>

        <!-- AQIQAH PACKAGE PRICING (shown only when page_template === 'aqiqah') -->
        <div id="aqiqahPricingSettings" class="hidden bg-white rounded-xl shadow-sm border border-amber-200 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-amber-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-amber-500 text-sm font-mono">üêê</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Aqiqah Package Pricing</h2>
                <p class="text-sm text-gray-400">Set prices for Baby Girl, Baby Boy, and Sadaqah packages</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <p class="text-xs text-gray-400 mb-4">These prices will be shown on the Aqiqah page. Leave blank to use the default prices.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Baby Girl -->
              <div class="border border-pink-200 rounded-lg p-4 bg-pink-50/30">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">üëß</span>
                  <div>
                    <p class="font-semibold text-gray-800">Baby Girl</p>
                    <p class="text-xs text-gray-400">1 Goat/Sheep per Sunnah</p>
                  </div>
                </div>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                  <input type="number" id="aqiqahPriceGirl" placeholder="150" min="1" step="1" class="w-full pl-7 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" />
                </div>
              </div>
              <!-- Baby Boy -->
              <div class="border border-blue-200 rounded-lg p-4 bg-blue-50/30">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">üë¶</span>
                  <div>
                    <p class="font-semibold text-gray-800">Baby Boy</p>
                    <p class="text-xs text-gray-400">2 Goats/Sheep per Sunnah</p>
                  </div>
                </div>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                  <input type="number" id="aqiqahPriceBoy" placeholder="300" min="1" step="1" class="w-full pl-7 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
                </div>
              </div>
              <!-- Sadaqah -->
              <div class="border border-orange-200 rounded-lg p-4 bg-orange-50/30">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">ü™ô</span>
                  <div>
                    <p class="font-semibold text-gray-800">Sadaqah</p>
                    <p class="text-xs text-gray-400">Optional gift for baby's well-being</p>
                  </div>
                </div>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                  <input type="number" id="aqiqahPriceSadaqah" placeholder="100" min="1" step="1" class="w-full pl-7 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- QURBANI PRICING (shown only when page_template === 'qurbani') -->
        <div id="qurbaniPricingSettings" class="hidden bg-white rounded-xl shadow-sm border border-green-200 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-green-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-green-600 text-sm font-mono">üêÑ</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Qurbani Country Pricing</h2>
                <p class="text-sm text-gray-400">Override prices per country and animal type ‚Äî leave blank to use defaults</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="flex items-center justify-between mb-4">
              <p class="text-xs text-gray-400">Enter prices in USD. Empty fields use the default price shown in the placeholder.</p>
              <button type="button" onclick="resetQurbaniPricing()" class="text-xs text-red-500 hover:text-red-700 font-medium">Reset All</button>
            </div>
            <div id="qurbaniPricingTable" class="overflow-x-auto">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- ORPHAN SPONSORSHIP PRICING (shown for orphan-sponsorship & tilestack-sponsorship) -->
        <div id="orphanPricingSettings" class="hidden bg-white rounded-xl shadow-sm border border-purple-200 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-purple-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-purple-500 text-sm font-mono">üë∂</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Orphan Sponsorship Pricing</h2>
                <p class="text-sm text-gray-400">Monthly and yearly sponsorship amounts per country</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <p class="text-xs text-gray-400 mb-4">Set monthly and yearly sponsorship amounts per country. Leave blank to use defaults.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="orphanPricingGrid">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- 5. CRISIS STATISTICS -->
        <div id="crisisStatsSection" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">5</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Crisis Statistics</h2>
                <p class="text-sm text-gray-400">Stats shown in the "Crisis Snapshot" box below the hero</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="flex items-center justify-end mb-4">
              <button type="button" id="fetchCrisisStatsBtn" class="px-3 py-1.5 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Fetch Crisis Stats
              </button>
            </div>
            <div id="crisisStats" class="space-y-3">
              <!-- Stats added via JS -->
            </div>
            <button type="button" onclick="addCrisisStat()" class="mt-4 text-sm text-[#01534d] hover:text-[#013d39] font-medium flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              Add stat manually
            </button>
          </div>
        </div>

        <!-- 6. PAGE CONTENT -->
        <div id="pageContentSection" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">6</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Page Content</h2>
                <p class="text-sm text-gray-400">The Crisis, How Your Donation Helps, Mid CTA, Choose Your Impact, Why Monthly, FAQ, Final CTA</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6 space-y-6">

            <!-- The Crisis -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">The Crisis</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcCrisisHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                  <textarea id="pcCrisisContent" rows="4" placeholder="Describe the crisis/cause..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]"></textarea>
                  <p class="text-xs text-gray-400 mt-1">If blank, falls back to campaign description</p>
                </div>
              </div>
            </div>

            <!-- How Your Donation Helps -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">How Your Donation Helps</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcDonationHelpsHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Impact Items</label>
                  <div id="pcDonationHelpsList" class="space-y-2"></div>
                  <button type="button" onclick="addPCDonationHelp()" class="mt-2 text-sm text-[#01534d] hover:text-[#013d39] font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Add item
                  </button>
                  <p class="text-xs text-gray-400 mt-1">If empty, auto-populates from Donation Options (Section 4)</p>
                </div>
              </div>
            </div>

            <!-- Mid-Page CTA -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">Mid-Page CTA</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcMidCtaHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Subtext</label>
                  <input type="text" id="pcMidCtaSubtext" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Primary Button</label>
                    <input type="text" id="pcMidCtaPrimary" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Secondary Button</label>
                    <input type="text" id="pcMidCtaSecondary" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Choose Your Impact -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">Choose Your Impact</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcImpactHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Subtext</label>
                  <input type="text" id="pcImpactSubtext" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Single Tab Label</label>
                    <input type="text" id="pcImpactSingleTab" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Tab Label</label>
                    <input type="text" id="pcImpactMonthlyTab" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Why Monthly -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">Why Monthly</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcWhyMonthlyHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Benefits</label>
                  <div id="pcBenefitsList" class="space-y-2"></div>
                  <button type="button" onclick="addPCBenefit()" class="mt-2 text-sm text-[#01534d] hover:text-[#013d39] font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Add benefit
                  </button>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Footer Text</label>
                  <input type="text" id="pcWhyMonthlyFooter" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
              </div>
            </div>

            <!-- FAQ -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">FAQ</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcFaqHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Q&A Items</label>
                  <div id="pcFaqList" class="space-y-3"></div>
                  <button type="button" onclick="addPCFaq()" class="mt-2 text-sm text-[#01534d] hover:text-[#013d39] font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Add FAQ item
                  </button>
                </div>
              </div>
            </div>

            <!-- Final CTA -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">Final CTA</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Heading</label>
                  <input type="text" id="pcFinalCtaHeading" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Subtext</label>
                  <input type="text" id="pcFinalCtaSubtext" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Primary Button</label>
                    <input type="text" id="pcFinalCtaPrimary" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Secondary Button</label>
                    <input type="text" id="pcFinalCtaSecondary" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Reset Button -->
            <div class="flex justify-end">
              <button type="button" id="pcResetBtn" class="px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 border border-orange-200 rounded-lg font-medium flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                Reset all to defaults
              </button>
            </div>
          </div>
        </div>

        <!-- 7. EXTRA CONTENT SECTIONS -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">7</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Extra Content Sections</h2>
                <p class="text-sm text-gray-400">Additional content cards shown below the main sections (optional)</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="flex items-center justify-end mb-4">
              <button type="button" onclick="addContentSection()" class="px-3 py-1.5 bg-[#01534d] text-white text-sm rounded-lg hover:bg-[#01433f]">+ Add Section</button>
            </div>
            <div id="contentSections" class="space-y-4">
              <!-- Sections added via JS -->
            </div>
          </div>
        </div>

        <!-- 8. GALLERY IMAGES -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">8</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Gallery Images</h2>
                <p class="text-sm text-gray-400">Images shown in "Your Donations in Action" section</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="flex items-center justify-end gap-2 mb-4 flex-wrap">
              <input type="text" id="gallerySearchQuery" placeholder="Custom search" class="w-32 px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
              <button type="button" onclick="fetchStockForGallery()" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Fetch Stock
              </button>
              <button type="button" id="galleryLoadMoreBtn" onclick="fetchStockForGallery(true)" class="hidden px-3 py-1.5 bg-purple-100 text-purple-700 text-sm rounded-lg hover:bg-purple-200 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                More Stock
              </button>
              <button type="button" onclick="openMediaModal('gallery')" class="px-3 py-1.5 bg-[#01534d] text-white text-sm rounded-lg hover:bg-[#01433f]">+ Add Images</button>
            </div>
            <div id="galleryImages" class="grid grid-cols-4 md:grid-cols-6 gap-3">
              <!-- Images added via JS -->
            </div>
            <p id="noGalleryText" class="text-gray-400 text-sm text-center py-4">No gallery images yet</p>
          </div>
        </div>

        <!-- 9. SEO SETTINGS -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">9</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">SEO Settings</h2>
                <p class="text-sm text-gray-400">Meta title &amp; description for search engines</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title</label>
                <input type="text" name="meta_title" value={campaign.meta_title || ''} placeholder="Leave blank to use campaign title" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
                <textarea name="meta_description" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]">{campaign.meta_description || ''}</textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- 10. TEMPLATE SETTINGS -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden admin-collapsible">
          <button type="button" class="admin-collapse-toggle w-full flex items-center justify-between p-6 hover:bg-gray-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-gray-400 text-sm font-mono">10</span>
              <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">Template Settings</h2>
                <p class="text-sm text-gray-400">Campaign type, page template, donation box template</p>
              </div>
            </div>
            <svg class="admin-collapse-chevron w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="admin-collapse-body hidden px-6 pb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Type</label>
                <select name="template_type" id="template_type" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white">
                  <option value="standard" selected={!campaign.template_type || campaign.template_type === 'standard'}>Standard Campaign</option>
                  <option value="tiered-donation" selected={campaign.template_type === 'tiered-donation'}>Tiered Donation (Fidya, Food Packs)</option>
                  <option value="calculator" selected={campaign.template_type === 'calculator'}>Calculator (Zakat)</option>
                  <option value="ramadan-giving" selected={campaign.template_type === 'ramadan-giving'}>Ramadan Giving Wizard</option>
                  <option value="automated-giving" selected={campaign.template_type === 'automated-giving'}>Automated Giving</option>
                </select>
                <p class="text-xs text-gray-400 mt-1">Determines the page layout and functionality</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Page Template</label>
                <select name="page_template" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white">
                  <option value="" selected={!campaign.page_template}>Use Default</option>
                  {pageTemplates.map((template) => (
                    <option value={template.template_key} selected={campaign.page_template === template.template_key}>{template.template_label}</option>
                  ))}
                </select>
                <p class="text-xs text-gray-400 mt-1">Controls the overall page layout and style</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Donation Box Template</label>
                <select name="donation_box_template" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white">
                  <option value="" selected={!campaign.donation_box_template}>Use Default</option>
                  {donationBoxTemplates.map((template) => (
                    <option value={template.template_key} selected={campaign.donation_box_template === template.template_key}>{template.template_label}</option>
                  ))}
                </select>
                <p class="text-xs text-gray-400 mt-1">Controls the donation box appearance</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between">
          <button type="button" onclick="deleteCampaign()" class="px-6 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium">
            Delete Campaign
          </button>
          <div class="flex gap-4">
            <a href="/admin/campaigns" class="px-6 py-2 border border-gray-200 rounded-lg font-medium text-gray-700 hover:bg-gray-50">Cancel</a>
            <button type="submit" class="px-6 py-2 bg-[#01534d] text-white rounded-lg font-medium hover:bg-[#01433f]">Save Changes</button>
          </div>
        </div>

        <!-- Floating Save Button -->
        <button type="submit" id="floatingSaveBtn" class="fixed bottom-6 right-6 z-50 px-5 py-3 bg-[#01534d] text-white rounded-full font-medium shadow-lg hover:bg-[#01433f] hover:shadow-xl transition-all flex items-center gap-2 group" style="display: none;">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          <span>Save Changes</span>
        </button>
      </form>
    ) : null}
  </div>

  <!-- Media Modal -->
  <div id="mediaModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
      <div class="p-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="font-bold text-lg">Select or Upload Image</h3>
        <button onclick="closeMediaModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Upload Section -->
      <div class="p-4 border-b border-gray-200 bg-gray-50">
        <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 hover:bg-blue-50 transition cursor-pointer">
          <input type="file" id="imageUpload" accept="image/*" class="hidden" />
          <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="text-gray-600 font-medium">Click to upload a new image</p>
          <p class="text-gray-400 text-sm mt-1">or drag and drop</p>
        </div>
        <div id="uploadProgress" class="hidden mt-3">
          <div class="flex items-center gap-3">
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="progressBar" class="h-full bg-[#01534d] transition-all" style="width: 0%"></div>
            </div>
            <span id="progressText" class="text-sm text-gray-600">0%</span>
          </div>
        </div>
      </div>

      <!-- Gallery Section -->
      <div class="p-4 overflow-y-auto max-h-[40vh]">
        <p class="text-sm text-gray-500 mb-3 font-medium">Or choose from gallery:</p>
        {mediaFiles.length === 0 ? (
          <p class="text-center text-gray-400 py-4">No images in gallery yet</p>
        ) : (
          <div class="grid grid-cols-4 gap-3">
            {mediaFiles.map((file) => (
              <div
                class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:opacity-75 hover:shadow-lg transition media-item"
                data-url={file.url}
              >
                <img src={file.url} alt={file.name} class="w-full h-full object-cover" />
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{
  campaignId: campaign?.id,
  campaignTitle: campaign?.title || campaign?.name || '',
  campaignCategory: campaign?.category || '',
  campaignCountry: campaign?.country || '',
  campaignDescription: campaign?.description || '',
  existingOptions: campaign?.donation_options || [],
  existingSections: campaign?.content_sections || [],
  existingGallery: campaign?.gallery_images || [],
  existingImpactStats: campaign?.impact_stats || [],
  existingTemplateConfig: campaign?.template_config || {},
  autoImpactTexts,
  autoMonthlyImpact,
  defaultUpsellBody: DEFAULT_UPSELL_BODY,
  defaultUpsellSubText: DEFAULT_UPSELL_SUBTEXT,
  defaultButtonMonthly: DEFAULT_BUTTON_MONTHLY,
  defaultButtonOneTime: DEFAULT_BUTTON_ONETIME,
  defaultPageContent: DEFAULT_PAGE_CONTENT
}}>
  let mediaTarget = 'featured';
  let galleryImages = [...existingGallery];
  let contentSections = [...existingSections];
  let crisisStats = Array.isArray(existingImpactStats) ? [...existingImpactStats] : [];
  let sectionIndex = 0;
  let optionIndex = 0;
  let statIndex = 0;
  let pcBenefitIndex = 0;
  let pcFaqIndex = 0;
  let pcDonationHelpIndex = 0;

  // Initialize on load
  document.addEventListener('DOMContentLoaded', function() {
    // Stock Images Button Handler
    var fetchStockBtn = document.getElementById('fetchStockBtn');
    if (fetchStockBtn) {
      fetchStockBtn.addEventListener('click', function() { fetchStockImages(false); });
    }

    // Stock Images Load More Handler
    var stockLoadMoreBtn = document.getElementById('stockLoadMoreBtn');
    if (stockLoadMoreBtn) {
      stockLoadMoreBtn.addEventListener('click', function() { fetchStockImages(true); });
    }

    // Crisis Stats Button Handler
    const fetchCrisisStatsBtn = document.getElementById('fetchCrisisStatsBtn');
    if (fetchCrisisStatsBtn) {
      fetchCrisisStatsBtn.addEventListener('click', fetchCrisisStats);
    }

    // Floating Save Button ‚Äî show when scrolled down
    var floatingBtn = document.getElementById('floatingSaveBtn');
    if (floatingBtn) {
      window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
          floatingBtn.style.display = 'flex';
        } else {
          floatingBtn.style.display = 'none';
        }
      });
    }

    // Collapsible sections toggle
    document.querySelectorAll('.admin-collapse-toggle').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var body = btn.nextElementSibling;
        var chevron = btn.querySelector('.admin-collapse-chevron');
        if (body) body.classList.toggle('hidden');
        if (chevron) chevron.classList.toggle('rotate-180');
      });
    });

    // Load existing donation options
    if (existingOptions.length > 0) {
      existingOptions.forEach(opt => addDonationOption(opt.amount, opt.label));
    } else {
      addDonationOption(50, 'Feed a family');
      addDonationOption(100, 'Provide clean water');
      addDonationOption(250, 'Medical supplies');
    }

    // Load existing content sections (extra sections beyond The Crisis / How Your Donation Helps)
    if (existingSections.length > 0) {
      existingSections.forEach(section => {
        addContentSection(section.title, section.content, section.image);
      });
    }

    // Load existing crisis stats
    if (crisisStats.length > 0) {
      crisisStats.forEach(stat => addCrisisStat(stat.value, stat.label));
    }

    // Load existing gallery
    renderGallery();

    // Load page content fields
    initPageContent();

    // Page Content Reset Handler
    var pcResetBtn = document.getElementById('pcResetBtn');
    if (pcResetBtn) {
      pcResetBtn.addEventListener('click', function() {
        initPageContent(true);
        showToast('Page content reset to defaults');
      });
    }

    // Media modal click handlers
    document.querySelectorAll('.media-item').forEach(item => {
      item.addEventListener('click', function() {
        const url = this.dataset.url;
        handleImageSelection(url);
      });
    });

    // Upload area click
    const uploadArea = document.getElementById('uploadArea');
    const imageUpload = document.getElementById('imageUpload');

    uploadArea.addEventListener('click', () => imageUpload.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('border-blue-500', 'bg-blue-50');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
      const files = e.dataTransfer.files;
      if (files.length > 0) uploadImage(files[0]);
    });

    imageUpload.addEventListener('change', (e) => {
      if (e.target.files.length > 0) uploadImage(e.target.files[0]);
    });
  });

  // Handle image selection (from gallery or upload)
  function handleImageSelection(url) {
    if (mediaTarget === 'featured') {
      selectFeaturedImage(url);
    } else if (mediaTarget === 'gallery') {
      addGalleryImage(url);
    } else if (mediaTarget.startsWith('section-')) {
      const idx = mediaTarget.replace('section-', '');
      document.querySelector(`#section-${idx} .section-image`).value = url;
      document.querySelector(`#section-${idx} .section-img-preview`).src = url;
      document.querySelector(`#section-${idx} .section-img-preview`).classList.remove('hidden');
    }
    closeMediaModal();
  }

  // Upload image function
  async function uploadImage(file) {
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }

    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    progressDiv.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = '0%';

    try {
      const formData = new FormData();
      formData.append('file', file);

      // Simulate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        if (progress <= 90) {
          progressBar.style.width = progress + '%';
          progressText.textContent = progress + '%';
        }
      }, 100);

      const res = await fetch('/api/media/upload', {
        method: 'POST',
        body: formData
      });

      clearInterval(progressInterval);

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Upload failed');
      }

      const data = await res.json();

      progressBar.style.width = '100%';
      progressText.textContent = '100%';

      // Use the uploaded image
      setTimeout(() => {
        progressDiv.classList.add('hidden');
        handleImageSelection(data.url);
      }, 500);

    } catch (error) {
      progressDiv.classList.add('hidden');
      alert('Upload failed: ' + error.message);
    }
  }

  // Media Modal
  window.openMediaModal = function(target) {
    mediaTarget = target;
    document.getElementById('mediaModal').classList.remove('hidden');
  };

  window.closeMediaModal = function() {
    document.getElementById('mediaModal').classList.add('hidden');
  };

  // Featured Image
  window.selectFeaturedImage = function(url) {
    document.getElementById('featured_image').value = url;
    document.getElementById('featuredImg').src = url;
    document.getElementById('featuredImagePreview').classList.remove('hidden');
  };

  window.setFeaturedFromUrl = function() {
    const url = document.getElementById('featuredImageUrl').value;
    if (url) selectFeaturedImage(url);
  };

  // Gallery Images
  window.addGalleryImage = function(url) {
    if (!galleryImages.includes(url)) {
      galleryImages.push(url);
      renderGallery();
    }
  };

  window.removeGalleryImage = function(url) {
    galleryImages = galleryImages.filter(img => img !== url);
    renderGallery();
  };

  function renderGallery() {
    const container = document.getElementById('galleryImages');
    const noText = document.getElementById('noGalleryText');

    if (galleryImages.length === 0) {
      container.innerHTML = '';
      noText.classList.remove('hidden');
      return;
    }

    noText.classList.add('hidden');
    container.innerHTML = galleryImages.map(url => `
      <div class="relative group aspect-square">
        <img src="${url}" class="w-full h-full object-cover rounded-lg" />
        <button type="button" onclick="removeGalleryImage('${url}')" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `).join('');
  }

  // Content Sections
  window.addContentSection = function(title = '', content = '', image = '') {
    const container = document.getElementById('contentSections');
    const idx = sectionIndex++;

    const div = document.createElement('div');
    div.id = `section-${idx}`;
    div.className = 'border border-gray-200 rounded-lg p-4 space-y-3';
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <span class="font-medium text-gray-700">Section ${idx + 1}</span>
        <button type="button" onclick="removeSection(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </button>
      </div>
      <input type="text" placeholder="Section Title" value="${title}" class="section-title w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
      <textarea placeholder="Section Content (HTML supported)" rows="4" class="section-content w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">${content}</textarea>
      <div class="flex gap-2 items-center">
        <input type="hidden" class="section-image" value="${image}" />
        <img src="${image}" class="section-img-preview w-16 h-16 object-cover rounded ${image ? '' : 'hidden'}" />
        <button type="button" onclick="openMediaModal('section-${idx}')" class="px-3 py-1.5 border border-gray-200 rounded text-sm hover:bg-gray-50">Add Image</button>
      </div>
    `;
    container.appendChild(div);
  };

  window.removeSection = function(idx) {
    document.getElementById(`section-${idx}`).remove();
  };

  // Crisis Stats
  window.addCrisisStat = function(value = '', label = '') {
    const container = document.getElementById('crisisStats');
    const idx = statIndex++;

    const div = document.createElement('div');
    div.id = `stat-${idx}`;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = `
      <input type="text" placeholder="Value (e.g., 2.3M)" value="${value}" class="stat-value w-32 px-3 py-2 border border-gray-200 rounded-lg text-sm font-bold" />
      <input type="text" placeholder="Label (e.g., People Displaced)" value="${label}" class="stat-label flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />
      <button type="button" onclick="removeStat(${idx})" class="p-2 text-red-500 hover:bg-red-50 rounded">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;
    container.appendChild(div);
  };

  window.removeStat = function(idx) {
    document.getElementById(`stat-${idx}`).remove();
  };

  // Fetch Crisis Stats from API
  async function fetchCrisisStats() {
    const btn = document.getElementById('fetchCrisisStatsBtn');
    const title = document.querySelector('input[name="title"]').value;

    if (!title) {
      showToast('Please enter a campaign title first', 'error');
      return;
    }

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = `
      <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Fetching...
    `;

    try {
      const res = await fetch('/api/campaigns/crisis-stats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title,
          category: campaignCategory,
          country: campaignCountry
        })
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Failed to fetch stats');
      }

      const data = await res.json();

      // Clear existing stats
      document.getElementById('crisisStats').innerHTML = '';
      statIndex = 0;

      // Add new stats
      data.stats.forEach(stat => addCrisisStat(stat.value, stat.label));

      showToast(`Fetched ${data.stats.length} crisis statistics`);

    } catch (error) {
      showToast(error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        Fetch Crisis Stats
      `;
    }
  }

  // Collect crisis stats data
  function getCrisisStats() {
    const stats = [];
    document.querySelectorAll('#crisisStats > div').forEach(div => {
      const value = div.querySelector('.stat-value').value;
      const label = div.querySelector('.stat-label').value;
      if (value && label) stats.push({ value, label });
    });
    return stats;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGE CONTENT (Section 9)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function initPageContent(useDefaults) {
    var saved = useDefaults ? {} : (existingTemplateConfig.pageContent || {});
    var d = defaultPageContent;

    // The Crisis
    document.getElementById('pcCrisisHeading').value = (saved.theCrisis && saved.theCrisis.heading) || d.theCrisis.heading;
    // Auto-populate crisis content from campaign description if nothing is saved
    var crisisContent = (saved.theCrisis && saved.theCrisis.content) || '';
    if (!crisisContent && !useDefaults) {
      crisisContent = campaignDescription || '';
    }
    document.getElementById('pcCrisisContent').value = crisisContent;

    // How Your Donation Helps
    document.getElementById('pcDonationHelpsHeading').value = (saved.howDonationHelps && saved.howDonationHelps.heading) || d.howDonationHelps.heading;
    document.getElementById('pcDonationHelpsList').innerHTML = '';
    pcDonationHelpIndex = 0;
    var helpItems = (saved.howDonationHelps && saved.howDonationHelps.items && saved.howDonationHelps.items.length > 0)
      ? saved.howDonationHelps.items
      : [];
    // If no saved items and not resetting, auto-populate from donation options
    if (helpItems.length === 0 && !useDefaults && existingOptions.length > 0) {
      existingOptions.forEach(function(opt) {
        if (opt.amount && opt.label) helpItems.push({ amount: '$' + opt.amount, label: opt.label });
      });
    }
    helpItems.forEach(function(item) { addPCDonationHelp(item.amount, item.label); });

    // Mid CTA
    document.getElementById('pcMidCtaHeading').value = (saved.midCta && saved.midCta.heading) || d.midCta.heading;
    document.getElementById('pcMidCtaSubtext').value = (saved.midCta && saved.midCta.subtext) || d.midCta.subtext;
    document.getElementById('pcMidCtaPrimary').value = (saved.midCta && saved.midCta.primaryButtonText) || d.midCta.primaryButtonText;
    document.getElementById('pcMidCtaSecondary').value = (saved.midCta && saved.midCta.secondaryButtonText) || d.midCta.secondaryButtonText;

    // Choose Your Impact
    document.getElementById('pcImpactHeading').value = (saved.chooseYourImpact && saved.chooseYourImpact.heading) || d.chooseYourImpact.heading;
    document.getElementById('pcImpactSubtext').value = (saved.chooseYourImpact && saved.chooseYourImpact.subtext) || d.chooseYourImpact.subtext;
    document.getElementById('pcImpactSingleTab').value = (saved.chooseYourImpact && saved.chooseYourImpact.singleTabText) || d.chooseYourImpact.singleTabText;
    document.getElementById('pcImpactMonthlyTab').value = (saved.chooseYourImpact && saved.chooseYourImpact.monthlyTabText) || d.chooseYourImpact.monthlyTabText;

    // Why Monthly
    document.getElementById('pcWhyMonthlyHeading').value = (saved.whyMonthly && saved.whyMonthly.heading) || d.whyMonthly.heading;
    document.getElementById('pcWhyMonthlyFooter').value = (saved.whyMonthly && saved.whyMonthly.footerText) || d.whyMonthly.footerText;

    // Benefits list
    document.getElementById('pcBenefitsList').innerHTML = '';
    pcBenefitIndex = 0;
    var benefits = (saved.whyMonthly && saved.whyMonthly.benefits) || d.whyMonthly.benefits;
    benefits.forEach(function(b) { addPCBenefit(b); });

    // FAQ
    document.getElementById('pcFaqHeading').value = (saved.faq && saved.faq.heading) || d.faq.heading;

    // FAQ items list
    document.getElementById('pcFaqList').innerHTML = '';
    pcFaqIndex = 0;
    var faqItems = (saved.faq && saved.faq.items) || d.faq.items;
    faqItems.forEach(function(item) { addPCFaq(item.question, item.answer); });

    // Final CTA
    document.getElementById('pcFinalCtaHeading').value = (saved.finalCta && saved.finalCta.heading) || d.finalCta.heading;
    document.getElementById('pcFinalCtaSubtext').value = (saved.finalCta && saved.finalCta.subtext) || d.finalCta.subtext;
    document.getElementById('pcFinalCtaPrimary').value = (saved.finalCta && saved.finalCta.primaryButtonText) || d.finalCta.primaryButtonText;
    document.getElementById('pcFinalCtaSecondary').value = (saved.finalCta && saved.finalCta.secondaryButtonText) || d.finalCta.secondaryButtonText;
  }

  window.addPCBenefit = function(text) {
    text = text || '';
    var container = document.getElementById('pcBenefitsList');
    var idx = pcBenefitIndex++;

    var div = document.createElement('div');
    div.id = 'pcBenefit-' + idx;
    div.className = 'flex gap-2 items-center';
    div.innerHTML = '<input type="text" value="' + text.replace(/"/g, '&quot;') + '" placeholder="Benefit text" class="pc-benefit flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />' +
      '<button type="button" onclick="removePCBenefit(' + idx + ')" class="p-2 text-red-500 hover:bg-red-50 rounded">' +
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
  };

  window.removePCBenefit = function(idx) {
    var el = document.getElementById('pcBenefit-' + idx);
    if (el) el.remove();
  };

  window.addPCDonationHelp = function(amount, label) {
    amount = amount || '';
    label = label || '';
    var container = document.getElementById('pcDonationHelpsList');
    var idx = pcDonationHelpIndex++;

    var div = document.createElement('div');
    div.id = 'pcDonHelp-' + idx;
    div.className = 'flex gap-2 items-center';
    div.innerHTML = '<input type="text" value="' + String(amount).replace(/"/g, '&quot;') + '" placeholder="$35" class="pc-dh-amount w-24 px-3 py-2 border border-gray-200 rounded-lg text-sm font-bold focus:outline-none focus:ring-2 focus:ring-[#01534d]" />' +
      '<span class="text-gray-400">‚Äî</span>' +
      '<input type="text" value="' + String(label).replace(/"/g, '&quot;') + '" placeholder="Emergency food" class="pc-dh-label flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]" />' +
      '<button type="button" onclick="removePCDonationHelp(' + idx + ')" class="p-2 text-red-500 hover:bg-red-50 rounded">' +
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
  };

  window.removePCDonationHelp = function(idx) {
    var el = document.getElementById('pcDonHelp-' + idx);
    if (el) el.remove();
  };

  window.addPCFaq = function(question, answer) {
    question = question || '';
    answer = answer || '';
    var container = document.getElementById('pcFaqList');
    var idx = pcFaqIndex++;

    var div = document.createElement('div');
    div.id = 'pcFaq-' + idx;
    div.className = 'border border-gray-100 rounded-lg p-3 bg-gray-50';
    div.innerHTML = '<div class="flex items-start gap-2">' +
      '<div class="flex-1 space-y-2">' +
      '<input type="text" value="' + question.replace(/"/g, '&quot;') + '" placeholder="Question" class="pc-faq-q w-full px-3 py-2 border border-gray-200 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-[#01534d]" />' +
      '<textarea placeholder="Answer" rows="2" class="pc-faq-a w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#01534d]">' + answer.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</textarea>' +
      '</div>' +
      '<button type="button" onclick="removePCFaq(' + idx + ')" class="p-2 text-red-500 hover:bg-red-50 rounded flex-shrink-0">' +
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>' +
      '</div>';
    container.appendChild(div);
  };

  window.removePCFaq = function(idx) {
    var el = document.getElementById('pcFaq-' + idx);
    if (el) el.remove();
  };

  function getPageContent() {
    var benefits = [];
    document.querySelectorAll('#pcBenefitsList .pc-benefit').forEach(function(input) {
      var val = input.value.trim();
      if (val) benefits.push(val);
    });

    var faqItems = [];
    document.querySelectorAll('#pcFaqList > div').forEach(function(div) {
      var q = div.querySelector('.pc-faq-q').value.trim();
      var a = div.querySelector('.pc-faq-a').value.trim();
      if (q && a) faqItems.push({ question: q, answer: a });
    });

    var donationHelpItems = [];
    document.querySelectorAll('#pcDonationHelpsList > div').forEach(function(div) {
      var amt = div.querySelector('.pc-dh-amount').value.trim();
      var lbl = div.querySelector('.pc-dh-label').value.trim();
      if (amt && lbl) donationHelpItems.push({ amount: amt, label: lbl });
    });

    return {
      theCrisis: {
        heading: document.getElementById('pcCrisisHeading').value.trim(),
        content: document.getElementById('pcCrisisContent').value.trim()
      },
      howDonationHelps: {
        heading: document.getElementById('pcDonationHelpsHeading').value.trim(),
        items: donationHelpItems
      },
      midCta: {
        heading: document.getElementById('pcMidCtaHeading').value.trim(),
        subtext: document.getElementById('pcMidCtaSubtext').value.trim(),
        primaryButtonText: document.getElementById('pcMidCtaPrimary').value.trim(),
        secondaryButtonText: document.getElementById('pcMidCtaSecondary').value.trim()
      },
      chooseYourImpact: {
        heading: document.getElementById('pcImpactHeading').value.trim(),
        subtext: document.getElementById('pcImpactSubtext').value.trim(),
        singleTabText: document.getElementById('pcImpactSingleTab').value.trim(),
        monthlyTabText: document.getElementById('pcImpactMonthlyTab').value.trim()
      },
      whyMonthly: {
        heading: document.getElementById('pcWhyMonthlyHeading').value.trim(),
        benefits: benefits,
        footerText: document.getElementById('pcWhyMonthlyFooter').value.trim()
      },
      faq: {
        heading: document.getElementById('pcFaqHeading').value.trim(),
        items: faqItems
      },
      finalCta: {
        heading: document.getElementById('pcFinalCtaHeading').value.trim(),
        subtext: document.getElementById('pcFinalCtaSubtext').value.trim(),
        primaryButtonText: document.getElementById('pcFinalCtaPrimary').value.trim(),
        secondaryButtonText: document.getElementById('pcFinalCtaSecondary').value.trim()
      }
    };
  }

  // Donation Options
  window.addDonationOption = function(amount = '', label = '') {
    const container = document.getElementById('donationOptions');
    const idx = optionIndex++;

    const div = document.createElement('div');
    div.id = `option-${idx}`;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = `
      <input type="number" placeholder="Amount ($)" value="${amount}" class="opt-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />
      <input type="text" placeholder="Label (e.g., Feed a family)" value="${label}" class="opt-label flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />
      <button type="button" onclick="removeOption(${idx})" class="p-2 text-red-500 hover:bg-red-50 rounded">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;
    container.appendChild(div);
  };

  window.removeOption = function(idx) {
    document.getElementById(`option-${idx}`).remove();
  };

  // Collect data
  function getDonationOptions() {
    const options = [];
    document.querySelectorAll('#donationOptions > div').forEach(div => {
      const amount = div.querySelector('.opt-amount').value;
      const label = div.querySelector('.opt-label').value;
      if (amount) options.push({ amount: parseFloat(amount), label: label || `$${amount}` });
    });
    return options;
  }

  function getContentSections() {
    const sections = [];
    document.querySelectorAll('#contentSections > div').forEach(div => {
      const title = div.querySelector('.section-title').value;
      const content = div.querySelector('.section-content').value;
      const image = div.querySelector('.section-image').value;
      if (title || content) sections.push({ title, content, image });
    });
    return sections;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CW DONATION BOX SETTINGS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let cwMonthlyIndex = 0;
  let cwOneTimeIndex = 0;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FREQUENCY TABS SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var FREQ_DEFINITIONS = [
    { key: 'monthly', label: 'MONTHLY', type: 'recurring', stripeInterval: 'month', suffix: 'USD/mo', buttonText: 'JOIN TODAY', defaultAmounts: [10, 20, 40, 100], fallbackImpactText: 'Your monthly gift transforms lives around the world' },
    { key: 'single', label: 'GIVE ONCE', type: 'single', stripeInterval: null, suffix: 'USD', buttonText: 'GIVE', defaultAmounts: [50, 100, 150, 200], fallbackImpactText: '' },
    { key: 'yearly', label: 'YEARLY', type: 'recurring', stripeInterval: 'year', suffix: 'USD/yr', buttonText: 'GIVE YEARLY', defaultAmounts: [100, 250, 500, 1000], fallbackImpactText: 'Your yearly gift makes a lasting impact' },
    { key: 'weekly', label: 'EVERY FRIDAY', type: 'recurring', stripeInterval: 'week', suffix: 'USD/wk', buttonText: 'GIVE WEEKLY', defaultAmounts: [5, 10, 20, 50], fallbackImpactText: 'Your Jummah gift blesses every Friday' },
    { key: 'daily', label: 'DAILY', type: 'recurring', stripeInterval: 'day', suffix: 'USD/day', buttonText: 'GIVE DAILY', defaultAmounts: [1, 3, 5, 10], fallbackImpactText: 'Your daily gift provides consistent support' },
  ];

  function renderFrequencyList(containerId, frequencies) {
    var container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    FREQ_DEFINITIONS.forEach(function(def) {
      var existing = null;
      if (frequencies) {
        for (var i = 0; i < frequencies.length; i++) {
          if (frequencies[i].key === def.key) { existing = frequencies[i]; break; }
        }
      }
      var isChecked = existing ? true : false;
      var freq = existing || def;

      var amounts = freq.amounts || def.defaultAmounts || [];
      var impactTexts = freq.impactTexts || {};
      var amountsHtml = '';
      amounts.forEach(function(amt) {
        var impact = impactTexts[amt] || '';
        amountsHtml += '<div class="cw-freq-amt-row flex gap-2 items-center mb-2">' +
          '<input type="number" placeholder="$" value="' + amt + '" class="cw-fa-amount w-24 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
          '<input type="text" placeholder="Impact text" value="' + (impact || '').replace(/"/g, '&quot;') + '" class="cw-fa-impact flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
          '<button type="button" class="cw-fa-remove p-1 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>' +
          '</div>';
      });

      var div = document.createElement('div');
      div.className = 'cw-freq-item border border-gray-200 rounded-lg overflow-hidden';
      div.dataset.freqKey = def.key;

      div.innerHTML =
        '<div class="cw-freq-header flex items-center gap-3 px-4 py-3 bg-gray-50 cursor-pointer select-none">' +
          '<input type="checkbox" class="cw-freq-check w-4 h-4 rounded border-gray-300 text-[#01534d] focus:ring-[#01534d]" ' + (isChecked ? 'checked' : '') + ' />' +
          '<div class="flex-1">' +
            '<span class="font-semibold text-sm text-gray-700">' + def.label + '</span>' +
            '<span class="text-xs text-gray-400 ml-2">(' + (def.type === 'single' ? 'one-time' : def.stripeInterval) + ')</span>' +
          '</div>' +
          '<div class="flex gap-1">' +
            '<button type="button" class="cw-freq-up p-1 text-gray-400 hover:text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></button>' +
            '<button type="button" class="cw-freq-down p-1 text-gray-400 hover:text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>' +
          '</div>' +
          '<svg class="cw-freq-chevron w-4 h-4 text-gray-400 transition-transform ' + (isChecked ? 'rotate-180' : '') + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>' +
        '</div>' +
        '<div class="cw-freq-body px-4 py-3 space-y-3 ' + (isChecked ? '' : 'hidden') + '">' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Tab Label</label>' +
              '<input type="text" placeholder="' + def.label + '" value="' + (freq.label || '').replace(/"/g, '&quot;') + '" class="cw-freq-label w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Button Text</label>' +
              '<input type="text" placeholder="' + def.buttonText + '" value="' + (freq.buttonText || '').replace(/"/g, '&quot;') + '" class="cw-freq-btntext w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Suffix</label>' +
              '<input type="text" placeholder="' + def.suffix + '" value="' + (freq.suffix || '').replace(/"/g, '&quot;') + '" class="cw-freq-suffix w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-600 mb-1">Fallback Impact Text</label>' +
              '<input type="text" placeholder="Shown when no amount-specific text" value="' + (freq.fallbackImpactText || '').replace(/"/g, '&quot;') + '" class="cw-freq-fallback w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-600 mb-1">&ldquo;Other&rdquo; Amount Impact Text</label>' +
            '<input type="text" placeholder="Shown when donor enters a custom amount" value="' + (freq.otherImpactText || '').replace(/"/g, '&quot;') + '" class="cw-freq-other-impact w-full px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
          '</div>' +
          '<div>' +
            '<div class="flex items-center justify-between mb-2">' +
              '<label class="text-xs font-medium text-gray-600">Amounts & Impact Texts</label>' +
              '<button type="button" class="cw-freq-add-amt text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">+ Add</button>' +
            '</div>' +
            '<div class="cw-freq-amounts">' + amountsHtml + '</div>' +
          '</div>' +
        '</div>';

      container.appendChild(div);
      attachFreqItemListeners(div);
    });

    // Reorder based on existing frequencies order
    if (frequencies && frequencies.length > 0) {
      var orderedKeys = frequencies.map(function(f) { return f.key; });
      orderedKeys.forEach(function(key) {
        var item = container.querySelector('[data-freq-key="' + key + '"]');
        if (item) container.appendChild(item);
      });
      FREQ_DEFINITIONS.forEach(function(def) {
        if (orderedKeys.indexOf(def.key) === -1) {
          var item = container.querySelector('[data-freq-key="' + def.key + '"]');
          if (item) container.appendChild(item);
        }
      });
    }
  }

  function attachFreqItemListeners(div) {
    var check = div.querySelector('.cw-freq-check');
    var body = div.querySelector('.cw-freq-body');
    var chevron = div.querySelector('.cw-freq-chevron');
    var header = div.querySelector('.cw-freq-header');

    header.addEventListener('click', function(e) {
      if (e.target.closest('.cw-freq-check') || e.target.closest('.cw-freq-up') || e.target.closest('.cw-freq-down')) return;
      if (check.checked) {
        body.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
      }
    });

    check.addEventListener('change', function() {
      if (check.checked) {
        body.classList.remove('hidden');
        chevron.classList.add('rotate-180');
      } else {
        body.classList.add('hidden');
        chevron.classList.remove('rotate-180');
      }
    });

    div.querySelector('.cw-freq-up').addEventListener('click', function(e) {
      e.stopPropagation();
      var prev = div.previousElementSibling;
      if (prev) div.parentNode.insertBefore(div, prev);
    });
    div.querySelector('.cw-freq-down').addEventListener('click', function(e) {
      e.stopPropagation();
      var next = div.nextElementSibling;
      if (next) div.parentNode.insertBefore(next, div);
    });

    div.querySelector('.cw-freq-add-amt').addEventListener('click', function() {
      addFreqAmountRow(div.querySelector('.cw-freq-amounts'));
    });

    div.querySelectorAll('.cw-fa-remove').forEach(function(btn) {
      btn.addEventListener('click', function() { btn.closest('.cw-freq-amt-row').remove(); });
    });
  }

  function addFreqAmountRow(container, amount, impact) {
    amount = amount || '';
    impact = impact || '';
    var row = document.createElement('div');
    row.className = 'cw-freq-amt-row flex gap-2 items-center mb-2';
    row.innerHTML = '<input type="number" placeholder="$" value="' + amount + '" class="cw-fa-amount w-24 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
      '<input type="text" placeholder="Impact text" value="' + (impact || '').replace(/"/g, '&quot;') + '" class="cw-fa-impact flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm" />' +
      '<button type="button" class="cw-fa-remove p-1 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>';
    container.appendChild(row);
    row.querySelector('.cw-fa-remove').addEventListener('click', function() { row.remove(); });
  }

  function collectFrequencies(containerId) {
    var container = document.getElementById(containerId);
    if (!container) return null;
    var frequencies = [];
    container.querySelectorAll('.cw-freq-item').forEach(function(div) {
      var check = div.querySelector('.cw-freq-check');
      if (!check || !check.checked) return;
      var key = div.dataset.freqKey;
      var def = null;
      for (var i = 0; i < FREQ_DEFINITIONS.length; i++) {
        if (FREQ_DEFINITIONS[i].key === key) { def = FREQ_DEFINITIONS[i]; break; }
      }
      if (!def) return;

      var label = div.querySelector('.cw-freq-label')?.value || def.label;
      var buttonText = div.querySelector('.cw-freq-btntext')?.value || def.buttonText;
      var suffix = div.querySelector('.cw-freq-suffix')?.value || def.suffix;
      var fallbackImpactText = div.querySelector('.cw-freq-fallback')?.value || '';
      var otherImpactText = div.querySelector('.cw-freq-other-impact')?.value || '';

      var amounts = [];
      var impactTexts = {};
      div.querySelectorAll('.cw-freq-amt-row').forEach(function(row) {
        var amt = parseFloat(row.querySelector('.cw-fa-amount')?.value);
        var impact = row.querySelector('.cw-fa-impact')?.value;
        if (amt) {
          amounts.push(amt);
          if (impact) impactTexts[amt] = impact;
        }
      });

      var freqObj = {
        key: key,
        label: label,
        type: def.type,
        stripeInterval: def.stripeInterval,
        suffix: suffix,
        buttonText: buttonText,
        amounts: amounts.length > 0 ? amounts : def.defaultAmounts,
        impactTexts: impactTexts,
        defaultAmountIndex: 1,
        fallbackImpactText: fallbackImpactText,
      };
      if (otherImpactText) freqObj.otherImpactText = otherImpactText;
      frequencies.push(freqObj);
    });
    return frequencies.length > 0 ? frequencies : null;
  }

  // Toggle visibility: CW Donation Settings vs Legacy Donation Options
  const donationBoxSelect = document.querySelector('select[name="donation_box_template"]');
  const cwSettingsPanel = document.getElementById('cwDonationSettings');
  const legacyDonationPanel = document.getElementById('legacyDonationOptions');

  function toggleDonationPanels() {
    if (!donationBoxSelect) return;
    // Check both explicit selection and site default (empty = site default which is cw-donation)
    const isCW = donationBoxSelect.value === 'cw-donation' || donationBoxSelect.value === '';
    if (cwSettingsPanel) cwSettingsPanel.classList.toggle('hidden', !isCW);
    if (legacyDonationPanel) legacyDonationPanel.classList.toggle('hidden', isCW);
  }

  if (donationBoxSelect) {
    donationBoxSelect.addEventListener('change', toggleDonationPanels);
    toggleDonationPanels();
  }

  // ============ SMART SECTION VISIBILITY ============
  // Template-specific panels and standard-only sections
  const pageTemplateSelect = document.querySelector('select[name="page_template"]');
  const aqiqahPricingPanel = document.getElementById('aqiqahPricingSettings');
  const qurbaniPricingPanel = document.getElementById('qurbaniPricingSettings');
  const orphanPricingPanel = document.getElementById('orphanPricingSettings');
  const crisisStatsSection = document.getElementById('crisisStatsSection');
  const pageContentSection = document.getElementById('pageContentSection');

  const CUSTOM_TEMPLATES = ['aqiqah', 'qurbani', 'zakat-calculator', 'orphan-sponsorship', 'tilestack-sponsorship'];

  function toggleTemplateSections() {
    const template = pageTemplateSelect?.value || '';
    const isCustom = CUSTOM_TEMPLATES.includes(template);

    // Hide standard-only sections for custom templates
    if (crisisStatsSection) crisisStatsSection.classList.toggle('hidden', isCustom);
    if (pageContentSection) pageContentSection.classList.toggle('hidden', isCustom);

    // Show/hide template-specific sections
    if (aqiqahPricingPanel) aqiqahPricingPanel.classList.toggle('hidden', template !== 'aqiqah');
    if (qurbaniPricingPanel) qurbaniPricingPanel.classList.toggle('hidden', template !== 'qurbani');
    if (orphanPricingPanel) orphanPricingPanel.classList.toggle('hidden', template !== 'orphan-sponsorship' && template !== 'tilestack-sponsorship');
  }

  if (pageTemplateSelect) {
    pageTemplateSelect.addEventListener('change', toggleTemplateSections);
    toggleTemplateSections();
  }

  // ============ AQIQAH PRICING ============
  function initAqiqahPricing() {
    const aqConfig = existingTemplateConfig?.aqiqahPackages || {};
    if (aqConfig.girl) document.getElementById('aqiqahPriceGirl').value = aqConfig.girl;
    if (aqConfig.boy) document.getElementById('aqiqahPriceBoy').value = aqConfig.boy;
    if (aqConfig.sadaqah) document.getElementById('aqiqahPriceSadaqah').value = aqConfig.sadaqah;
  }
  initAqiqahPricing();

  function getAqiqahPricing() {
    const girl = parseFloat(document.getElementById('aqiqahPriceGirl')?.value);
    const boy = parseFloat(document.getElementById('aqiqahPriceBoy')?.value);
    const sadaqah = parseFloat(document.getElementById('aqiqahPriceSadaqah')?.value);
    const pricing = {};
    if (girl > 0) pricing.girl = girl;
    if (boy > 0) pricing.boy = boy;
    if (sadaqah > 0) pricing.sadaqah = sadaqah;
    return Object.keys(pricing).length > 0 ? pricing : null;
  }

  // ============ QURBANI PRICING ============
  const QURBANI_DEFAULTS = [
    { id: 'palestine-gaza', name: 'Palestine Gaza', flag: 'üáµüá∏', cat: 'Most Needed', goat: null, sheep: 425, cow_share: 400, cow_full: 2800 },
    { id: 'palestine-jerusalem', name: 'Palestine Jerusalem', flag: 'üáµüá∏', cat: 'Most Needed', goat: null, sheep: 325, cow_share: 300, cow_full: 2100 },
    { id: 'yemen', name: 'Yemen', flag: 'üáæüá™', cat: 'Most Needed', goat: 155, sheep: 155, cow_share: 130, cow_full: 910 },
    { id: 'syria', name: 'Syria', flag: 'üá∏üáæ', cat: 'Most Needed', goat: null, sheep: 225, cow_share: 200, cow_full: 1400 },
    { id: 'afghanistan', name: 'Afghanistan', flag: 'üá¶üá´', cat: 'Most Needed', goat: 200, sheep: 200, cow_share: 175, cow_full: 1225 },
    { id: 'iraq', name: 'Iraq', flag: 'üáÆüá∂', cat: 'Most Needed', goat: null, sheep: 275, cow_share: 250, cow_full: 1750 },
    { id: 'iraq-refugees', name: 'Iraq Refugees', flag: 'üáÆüá∂', cat: 'Most Needed', goat: null, sheep: 225, cow_share: 200, cow_full: 1400 },
    { id: 'sudan', name: 'Sudan', flag: 'üá∏üá©', cat: 'Most Needed', goat: 145, sheep: 145, cow_share: 120, cow_full: 840 },
    { id: 'kashmir-pakistan', name: 'Kashmir Pakistan', flag: 'üáµüá∞', cat: 'Most Needed', goat: 125, sheep: 125, cow_share: 100, cow_full: 700 },
    { id: 'kashmir-india', name: 'Kashmir India', flag: 'üáÆüá≥', cat: 'Most Needed', goat: 75, sheep: 75, cow_share: 50, cow_full: 350 },
    { id: 'myanmar-refugees', name: 'Myanmar Refugees', flag: 'üá≤üá≤', cat: 'Most Needed', goat: 125, sheep: null, cow_share: 100, cow_full: 700 },
    { id: 'refugees-jordan', name: 'Refugees in Jordan', flag: 'üáØüá¥', cat: 'Most Needed', goat: null, sheep: 275, cow_share: 250, cow_full: 1750 },
    { id: 'refugees-lebanon', name: 'Refugees in Lebanon', flag: 'üá±üáß', cat: 'Most Needed', goat: null, sheep: 225, cow_share: 200, cow_full: 1400 },
    { id: 'bosnia', name: 'Bosnia', flag: 'üáßüá¶', cat: 'Most Needed', goat: null, sheep: 300, cow_share: 250, cow_full: 1750 },
    { id: 'india', name: 'India', flag: 'üáÆüá≥', cat: 'Lowest Price', goat: 75, sheep: 75, cow_share: 50, cow_full: 350 },
    { id: 'burundi', name: 'Burundi', flag: 'üáßüáÆ', cat: 'Lowest Price', goat: 100, sheep: null, cow_share: 75, cow_full: 525 },
    { id: 'kenya', name: 'Kenya', flag: 'üá∞üá™', cat: 'Lowest Price', goat: 85, sheep: 85, cow_share: 80, cow_full: 560 },
    { id: 'bangladesh', name: 'Bangladesh', flag: 'üáßüá©', cat: 'Lowest Price', goat: 125, sheep: 125, cow_share: 100, cow_full: 700 },
    { id: 'rohingya-malaysia', name: 'Rohingya Malaysia', flag: 'üá≤üáæ', cat: 'Lowest Price', goat: 110, sheep: null, cow_share: 85, cow_full: 595 },
    { id: 'nepal', name: 'Nepal', flag: 'üá≥üáµ', cat: 'Lowest Price', goat: 100, sheep: null, cow_share: 75, cow_full: 525 },
    { id: 'pakistan', name: 'Pakistan', flag: 'üáµüá∞', cat: 'All Countries', goat: 140, sheep: 140, cow_share: 115, cow_full: 805 },
    { id: 'somalia', name: 'Somalia', flag: 'üá∏üá¥', cat: 'All Countries', goat: 150, sheep: 150, cow_share: 125, cow_full: 875 },
    { id: 'jordan', name: 'Jordan', flag: 'üáØüá¥', cat: 'All Countries', goat: null, sheep: 300, cow_share: 275, cow_full: 1925 },
    { id: 'lebanon', name: 'Lebanon', flag: 'üá±üáß', cat: 'All Countries', goat: null, sheep: 250, cow_share: 225, cow_full: 1575 },
    { id: 'turkey', name: 'Turkey', flag: 'üáπüá∑', cat: 'All Countries', goat: null, sheep: 275, cow_share: 250, cow_full: 1750 },
    { id: 'indonesia', name: 'Indonesia', flag: 'üáÆüá©', cat: 'All Countries', goat: 225, sheep: null, cow_share: 200, cow_full: 1400 },
    { id: 'mali', name: 'Mali', flag: 'üá≤üá±', cat: 'All Countries', goat: 125, sheep: 125, cow_share: 100, cow_full: 700 },
    { id: 'niger', name: 'Niger', flag: 'üá≥üá™', cat: 'All Countries', goat: 125, sheep: 125, cow_share: 100, cow_full: 700 },
    { id: 'ethiopia', name: 'Ethiopia', flag: 'üá™üáπ', cat: 'All Countries', goat: 115, sheep: 115, cow_share: 90, cow_full: 630 },
    { id: 'ghana', name: 'Ghana', flag: 'üá¨üá≠', cat: 'All Countries', goat: 135, sheep: 135, cow_share: 110, cow_full: 770 },
    { id: 'senegal', name: 'Senegal', flag: 'üá∏üá≥', cat: 'All Countries', goat: 135, sheep: 135, cow_share: 110, cow_full: 770 },
    { id: 'mauritania', name: 'Mauritania', flag: 'üá≤üá∑', cat: 'All Countries', goat: 100, sheep: 100, cow_share: null, cow_full: null },
    { id: 'chad', name: 'Chad', flag: 'üáπüá©', cat: 'All Countries', goat: 120, sheep: 120, cow_share: 95, cow_full: 665 },
    { id: 'cameroon', name: 'Cameroon', flag: 'üá®üá≤', cat: 'All Countries', goat: 125, sheep: 125, cow_share: 100, cow_full: 700 },
    { id: 'nigeria', name: 'Nigeria', flag: 'üá≥üá¨', cat: 'All Countries', goat: 125, sheep: 125, cow_share: 100, cow_full: 700 },
    { id: 'tanzania', name: 'Tanzania', flag: 'üáπüáø', cat: 'All Countries', goat: 110, sheep: 110, cow_share: 85, cow_full: 595 },
    { id: 'uganda', name: 'Uganda', flag: 'üá∫üá¨', cat: 'All Countries', goat: 110, sheep: null, cow_share: 85, cow_full: 595 },
    { id: 'egypt', name: 'Egypt', flag: 'üá™üá¨', cat: 'All Countries', goat: null, sheep: 225, cow_share: 200, cow_full: 1400 },
    { id: 'morocco', name: 'Morocco', flag: 'üá≤üá¶', cat: 'All Countries', goat: null, sheep: 250, cow_share: 225, cow_full: 1575 },
    { id: 'tunisia', name: 'Tunisia', flag: 'üáπüá≥', cat: 'All Countries', goat: null, sheep: 225, cow_share: 200, cow_full: 1400 },
    { id: 'albania', name: 'Albania', flag: 'üá¶üá±', cat: 'All Countries', goat: null, sheep: 275, cow_share: 250, cow_full: 1750 },
    { id: 'kosovo', name: 'Kosovo', flag: 'üáΩüá∞', cat: 'All Countries', goat: null, sheep: 300, cow_share: 275, cow_full: 1925 },
    { id: 'philippines', name: 'Philippines', flag: 'üáµüá≠', cat: 'All Countries', goat: 175, sheep: null, cow_share: 150, cow_full: 1050 },
    { id: 'sri-lanka', name: 'Sri Lanka', flag: 'üá±üá∞', cat: 'All Countries', goat: 125, sheep: null, cow_share: 100, cow_full: 700 },
  ];

  function initQurbaniPricing() {
    const container = document.getElementById('qurbaniPricingTable');
    if (!container) return;

    const savedPricing = existingTemplateConfig?.qurbaniPricing || {};
    const animalTypes = ['goat', 'sheep', 'cow_share', 'cow_full'];
    const animalLabels = { goat: 'Goat', sheep: 'Sheep', cow_share: 'Cow Share', cow_full: 'Full Cow' };

    let html = '<table class="w-full text-sm border-collapse">';
    html += '<thead><tr class="bg-gray-50 border-b border-gray-200">';
    html += '<th class="text-left py-2 px-2 font-medium text-gray-600 w-48">Country</th>';
    animalTypes.forEach(t => {
      html += '<th class="text-center py-2 px-1 font-medium text-gray-600 w-20">' + animalLabels[t] + '</th>';
    });
    html += '</tr></thead><tbody>';

    let lastCat = '';
    QURBANI_DEFAULTS.forEach(country => {
      if (country.cat !== lastCat) {
        html += '<tr><td colspan="5" class="pt-4 pb-1 px-2 text-xs font-bold text-green-700 uppercase tracking-wider border-b border-green-100">' + country.cat + '</td></tr>';
        lastCat = country.cat;
      }
      const saved = savedPricing[country.id] || {};
      html += '<tr class="border-b border-gray-100 hover:bg-gray-50">';
      html += '<td class="py-1.5 px-2 text-gray-700 whitespace-nowrap">' + country.flag + ' ' + country.name + '</td>';
      animalTypes.forEach(t => {
        const def = country[t];
        if (def === null) {
          html += '<td class="py-1.5 px-1 text-center"><span class="text-gray-300">‚Äî</span></td>';
        } else {
          const savedVal = saved[t];
          html += '<td class="py-1.5 px-1"><div class="relative">';
          html += '<span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-gray-300 text-xs">$</span>';
          html += '<input type="number" data-country="' + country.id + '" data-animal="' + t + '" ';
          html += 'placeholder="' + def + '" ';
          if (savedVal !== undefined && savedVal !== null) html += 'value="' + savedVal + '" ';
          html += 'min="1" step="1" class="qurbani-price-input w-full pl-5 pr-1 py-1 border border-gray-200 rounded text-xs text-center focus:outline-none focus:ring-1 focus:ring-green-400 focus:border-green-400" />';
          html += '</div></td>';
        }
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }
  initQurbaniPricing();

  function getQurbaniPricing() {
    const inputs = document.querySelectorAll('.qurbani-price-input');
    const pricing = {};
    inputs.forEach(input => {
      const val = parseFloat(input.value);
      if (val > 0) {
        const country = input.dataset.country;
        const animal = input.dataset.animal;
        if (!pricing[country]) pricing[country] = {};
        pricing[country][animal] = val;
      }
    });
    return Object.keys(pricing).length > 0 ? pricing : null;
  }

  window.resetQurbaniPricing = function() {
    document.querySelectorAll('.qurbani-price-input').forEach(input => {
      input.value = '';
    });
  };

  // ============ ORPHAN SPONSORSHIP PRICING ============
  const ORPHAN_DEFAULTS = [
    { id: 'pakistan', name: 'Pakistan', flag: 'üáµüá∞', monthly: 45, yearly: 540 },
    { id: 'palestine', name: 'Palestine', flag: 'üáµüá∏', monthly: 45, yearly: 540 },
    { id: 'yemen', name: 'Yemen', flag: 'üáæüá™', monthly: 40, yearly: 480 },
    { id: 'syria', name: 'Syria', flag: 'üá∏üáæ', monthly: 45, yearly: 540 },
    { id: 'afghanistan', name: 'Afghanistan', flag: 'üá¶üá´', monthly: 40, yearly: 480 },
    { id: 'bangladesh', name: 'Bangladesh', flag: 'üáßüá©', monthly: 35, yearly: 420 },
    { id: 'general', name: 'Where Most Needed', flag: 'üåç', monthly: 35, yearly: 420 },
  ];

  function initOrphanPricing() {
    const container = document.getElementById('orphanPricingGrid');
    if (!container) return;

    const savedPricing = existingTemplateConfig?.orphanPricing || {};

    let html = '';
    ORPHAN_DEFAULTS.forEach(country => {
      const saved = savedPricing[country.id] || {};
      html += '<div class="border border-purple-200 rounded-lg p-3 bg-purple-50/20">';
      html += '<div class="flex items-center gap-2 mb-3">';
      html += '<span class="text-xl">' + country.flag + '</span>';
      html += '<p class="font-semibold text-gray-800 text-sm">' + country.name + '</p>';
      html += '</div>';
      html += '<div class="space-y-2">';
      // Monthly
      html += '<div class="flex items-center gap-2">';
      html += '<label class="text-xs text-gray-500 w-14">Monthly</label>';
      html += '<div class="relative flex-1">';
      html += '<span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span>';
      html += '<input type="number" data-orphan-country="' + country.id + '" data-orphan-freq="monthly" ';
      html += 'placeholder="' + country.monthly + '" ';
      if (saved.monthly) html += 'value="' + saved.monthly + '" ';
      html += 'min="1" step="1" class="orphan-price-input w-full pl-5 pr-2 py-1.5 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-purple-400" />';
      html += '</div></div>';
      // Yearly
      html += '<div class="flex items-center gap-2">';
      html += '<label class="text-xs text-gray-500 w-14">Yearly</label>';
      html += '<div class="relative flex-1">';
      html += '<span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span>';
      html += '<input type="number" data-orphan-country="' + country.id + '" data-orphan-freq="yearly" ';
      html += 'placeholder="' + country.yearly + '" ';
      if (saved.yearly) html += 'value="' + saved.yearly + '" ';
      html += 'min="1" step="1" class="orphan-price-input w-full pl-5 pr-2 py-1.5 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-purple-400" />';
      html += '</div></div>';
      html += '</div></div>';
    });

    container.innerHTML = html;
  }
  initOrphanPricing();

  function getOrphanPricing() {
    const inputs = document.querySelectorAll('.orphan-price-input');
    const pricing = {};
    inputs.forEach(input => {
      const val = parseFloat(input.value);
      if (val > 0) {
        const country = input.dataset.orphanCountry;
        const freq = input.dataset.orphanFreq;
        if (!pricing[country]) pricing[country] = {};
        pricing[country][freq] = val;
      }
    });
    return Object.keys(pricing).length > 0 ? pricing : null;
  }

  // Add monthly amount row
  window.addCWMonthlyAmount = function(amount, impactText) {
    amount = amount || '';
    impactText = impactText || '';
    const container = document.getElementById('cwMonthlyAmounts');
    const idx = cwMonthlyIndex++;
    const div = document.createElement('div');
    div.id = 'cw-monthly-' + idx;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = '<input type="number" placeholder="Amount ($)" value="' + amount + '" class="cw-m-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<input type="text" placeholder="Impact text (e.g., Feeds a family for a month)" value="' + (impactText || '').replace(/"/g, '&quot;') + '" class="cw-m-impact flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<button type="button" onclick="document.getElementById(\'cw-monthly-' + idx + '\').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
  };

  // Add one-time amount row
  window.addCWOneTimeAmount = function(amount, impactText) {
    amount = amount || '';
    impactText = impactText || '';
    const container = document.getElementById('cwOneTimeAmounts');
    const idx = cwOneTimeIndex++;
    const div = document.createElement('div');
    div.id = 'cw-onetime-' + idx;
    div.className = 'flex gap-3 items-center';
    div.innerHTML = '<input type="number" placeholder="Amount ($)" value="' + amount + '" class="cw-o-amount w-28 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<input type="text" placeholder="Impact text (e.g., Provide emergency food parcels)" value="' + (impactText || '').replace(/"/g, '&quot;') + '" class="cw-o-impact flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" />' +
      '<button type="button" onclick="document.getElementById(\'cw-onetime-' + idx + '\').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
      '</button>';
    container.appendChild(div);
  };

  // Collect CW donation config
  function getCWDonationConfig() {
    var config = {};

    // Collect frequencies
    var frequencies = collectFrequencies('cwFrequencyList');
    if (frequencies) config.frequencies = frequencies;

    var upsellBody = document.getElementById('cwUpsellBody')?.value;
    var upsellSubText = document.getElementById('cwUpsellSubText')?.value;
    var heading = document.getElementById('cwDonationBoxHeading')?.value;
    var cwTabEmoji = document.getElementById('cwTabEmoji')?.value;

    if (upsellBody) config.upsellBody = upsellBody;
    if (upsellSubText) config.upsellSubText = upsellSubText;
    if (heading) config.donationBoxHeading = heading;
    if (cwTabEmoji) config.tabEmoji = cwTabEmoji;

    return Object.keys(config).length > 0 ? config : null;
  }

  // Initialize CW Donation Box settings from existing template_config
  // Falls back to auto-generated defaults based on campaign slug
  function initCWDonationSettings() {
    var cwConfig = existingTemplateConfig?.cwDonation || {};
    var autoMonthly = autoImpactTexts?.monthly || {};
    var autoSingle = autoImpactTexts?.single || {};

    // Build frequencies from saved config or convert legacy format
    var frequencies = cwConfig.frequencies || null;
    if (!frequencies && (cwConfig.monthlyAmounts || cwConfig.oneTimeAmounts)) {
      frequencies = [];
      if (cwConfig.monthlyAmounts) {
        var mImpacts = cwConfig.impactTexts?.monthly || {};
        var mAmtImpacts = {};
        cwConfig.monthlyAmounts.forEach(function(amt) { mAmtImpacts[amt] = mImpacts[amt] || autoMonthly[amt] || ''; });
        frequencies.push({
          key: 'monthly', label: 'MONTHLY', type: 'recurring', stripeInterval: 'month', suffix: 'USD/mo',
          buttonText: cwConfig.buttonTextMonthly || defaultButtonMonthly || 'JOIN TODAY',
          amounts: cwConfig.monthlyAmounts, impactTexts: mAmtImpacts,
          fallbackImpactText: cwConfig.monthlyImpactText || autoMonthlyImpact || '',
        });
      }
      if (cwConfig.oneTimeAmounts) {
        var sImpacts = cwConfig.impactTexts?.single || {};
        var sAmtImpacts = {};
        cwConfig.oneTimeAmounts.forEach(function(amt) { sAmtImpacts[amt] = sImpacts[amt] || autoSingle[amt] || ''; });
        frequencies.push({
          key: 'single', label: 'GIVE ONCE', type: 'single', stripeInterval: null, suffix: 'USD',
          buttonText: cwConfig.buttonTextOneTime || defaultButtonOneTime || 'GIVE',
          amounts: cwConfig.oneTimeAmounts, impactTexts: sAmtImpacts, fallbackImpactText: '',
        });
      }
    }

    // If no saved frequencies and no legacy config, create defaults with auto-generated impact texts
    if (!frequencies) {
      var defaultMonthlyImpacts = {};
      [10, 20, 40, 100].forEach(function(amt) { if (autoMonthly[amt]) defaultMonthlyImpacts[amt] = autoMonthly[amt]; });
      var defaultSingleImpacts = {};
      [50, 100, 150, 200].forEach(function(amt) { if (autoSingle[amt]) defaultSingleImpacts[amt] = autoSingle[amt]; });
      frequencies = [
        { key: 'monthly', label: 'MONTHLY', type: 'recurring', stripeInterval: 'month', suffix: 'USD/mo', buttonText: defaultButtonMonthly || 'JOIN TODAY', amounts: [10, 20, 40, 100], impactTexts: defaultMonthlyImpacts, fallbackImpactText: autoMonthlyImpact || '' },
        { key: 'single', label: 'GIVE ONCE', type: 'single', stripeInterval: null, suffix: 'USD', buttonText: defaultButtonOneTime || 'GIVE', amounts: [50, 100, 150, 200], impactTexts: defaultSingleImpacts, fallbackImpactText: '' },
      ];
    }

    renderFrequencyList('cwFrequencyList', frequencies);

    // Populate general text fields
    var uBody = document.getElementById('cwUpsellBody');
    var uSub = document.getElementById('cwUpsellSubText');

    if (uBody) uBody.value = cwConfig.upsellBody || defaultUpsellBody || '';
    if (uSub) uSub.value = cwConfig.upsellSubText || defaultUpsellSubText || '';

    var headingInput = document.getElementById('cwDonationBoxHeading');
    if (headingInput) headingInput.value = cwConfig.donationBoxHeading || '';

    var tabEmojiInput = document.getElementById('cwTabEmoji');
    if (tabEmojiInput) tabEmojiInput.value = cwConfig.tabEmoji || '';
  }

  initCWDonationSettings();

  // Toast
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
    setTimeout(() => { toast.className = 'hidden'; }, 3000);
  }

  // Delete
  window.deleteCampaign = async function() {
    if (!confirm(`Delete "${campaignTitle}"? This cannot be undone.`)) return;

    try {
      const res = await fetch(`/api/campaigns?id=${campaignId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Failed to delete');
      showToast('Campaign deleted');
      setTimeout(() => { window.location.href = '/admin/campaigns'; }, 1000);
    } catch (e) {
      showToast(e.message, 'error');
    }
  };

  // Stock image pagination tracking
  var stockCurrentPage = 1;
  var stockLastQuery = '';
  var galleryStockPage = 1;
  var galleryLastQuery = '';

  // Fetch Stock Images (with pagination)
  async function fetchStockImages(loadMore) {
    var btn = document.getElementById('fetchStockBtn');
    var title = document.querySelector('input[name="title"]').value;
    var customQuery = document.getElementById('customSearchQuery').value.trim();

    // Use custom query if provided, otherwise use campaign title
    var searchTitle = customQuery || title;

    if (!searchTitle) {
      showToast('Please enter a campaign title or custom search query', 'error');
      return;
    }

    // If this is a new search (different query), reset page to 1
    if (!loadMore || searchTitle !== stockLastQuery) {
      stockCurrentPage = 1;
      stockLastQuery = searchTitle;
    } else {
      stockCurrentPage++;
    }

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Searching...';

    var loadMoreBtn = document.getElementById('stockLoadMoreBtn');
    if (loadMoreBtn && loadMore) {
      loadMoreBtn.disabled = true;
      loadMoreBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Loading...';
    }

    try {
      var res = await fetch('/api/images/stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: searchTitle,
          category: campaignCategory,
          country: campaignCountry,
          count: 8,
          page: stockCurrentPage
        })
      });

      if (!res.ok) {
        var errData = await res.json();
        throw new Error(errData.error || 'Failed to fetch images');
      }

      var data = await res.json();

      // Show the preview section
      var previewSection = document.getElementById('stockImagesPreview');
      var grid = document.getElementById('stockImagesGrid');
      var searchInfo = document.getElementById('stockSearchInfo');

      previewSection.classList.remove('hidden');

      // Update search info
      if (searchInfo) {
        searchInfo.textContent = 'Search: "' + (data.query || searchTitle) + '" \u2022 Page ' + stockCurrentPage;
      }

      // Build image HTML
      var imagesHtml = data.images.map(function(img, idx) {
        return '<div class="relative group cursor-pointer stock-img-option" data-url="' + img.url + '">' +
          '<img src="' + img.thumbnail + '" alt="Stock image ' + (idx + 1) + '" class="w-full aspect-video object-cover rounded-lg border-2 border-transparent group-hover:border-purple-500 transition" />' +
          '<div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 rounded-lg transition flex items-center justify-center">' +
          '<span class="opacity-0 group-hover:opacity-100 text-white text-xs font-medium bg-purple-600 px-2 py-1 rounded">Select</span>' +
          '</div></div>';
      }).join('');

      // If loading more, append; otherwise replace
      if (loadMore && stockCurrentPage > 1) {
        grid.innerHTML = grid.innerHTML + imagesHtml;
      } else {
        grid.innerHTML = imagesHtml;
      }

      // Add click handlers to each image
      grid.querySelectorAll('.stock-img-option').forEach(function(el) {
        el.addEventListener('click', function() {
          var url = this.dataset.url;
          selectFeaturedImage(url);
          showToast('Stock image selected!');

          // Highlight selected
          grid.querySelectorAll('.stock-img-option img').forEach(function(img) {
            img.classList.remove('border-green-500', 'border-2');
            img.classList.add('border-transparent');
          });
          this.querySelector('img').classList.remove('border-transparent');
          this.querySelector('img').classList.add('border-green-500', 'border-2');
        });
      });

      // Show/hide Load More button
      if (loadMoreBtn) {
        if (data.images.length >= 8) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }
      }

      showToast('Found ' + data.images.length + ' images for: ' + (data.query || searchTitle) + (stockCurrentPage > 1 ? ' (page ' + stockCurrentPage + ')' : ''));

    } catch (error) {
      showToast(error.message, 'error');
      // Reset page on error
      if (stockCurrentPage > 1) stockCurrentPage--;
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Fetch Stock Images';
      if (loadMoreBtn) {
        loadMoreBtn.disabled = false;
        loadMoreBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Load More Images';
      }
    }
  }

  // Also add stock images to gallery (with pagination)
  window.fetchStockForGallery = async function(loadMore) {
    var title = document.querySelector('input[name="title"]').value;
    var customQuery = document.getElementById('gallerySearchQuery').value.trim();

    // Use custom query if provided, otherwise use campaign title
    var searchTitle = customQuery || title;

    if (!searchTitle) {
      showToast('Please enter a campaign title or custom search query', 'error');
      return;
    }

    // If this is a new search (different query), reset page to 1
    if (!loadMore || searchTitle !== galleryLastQuery) {
      galleryStockPage = 1;
      galleryLastQuery = searchTitle;
    } else {
      galleryStockPage++;
    }

    try {
      var res = await fetch('/api/images/stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: searchTitle,
          category: campaignCategory,
          country: campaignCountry,
          count: 4,
          page: galleryStockPage
        })
      });

      if (!res.ok) throw new Error('Failed to fetch images');

      var data = await res.json();
      var added = 0;

      // Add to gallery (skip duplicates)
      data.images.forEach(function(img) {
        if (!galleryImages.includes(img.url)) {
          galleryImages.push(img.url);
          added++;
        }
      });

      renderGallery();

      // Show/hide Load More button
      var loadMoreBtn = document.getElementById('galleryLoadMoreBtn');
      if (loadMoreBtn) {
        if (data.images.length >= 4) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }
      }

      showToast('Added ' + added + ' stock images to gallery' + (galleryStockPage > 1 ? ' (page ' + galleryStockPage + ')' : ''));

    } catch (error) {
      showToast(error.message, 'error');
      if (galleryStockPage > 1) galleryStockPage--;
    }
  };

  // URL path handling
  const slugInput = document.getElementById('campaign-slug');
  const categorySelect = document.getElementById('url-category');
  const urlPreview = document.getElementById('url-preview');

  function updateUrlPreview() {
    const category = categorySelect?.value || '';
    const slug = slugInput?.value || '';
    const prefix = category || 'appeals';
    const fullPath = `/${prefix}/${slug}`;
    if (urlPreview) {
      urlPreview.textContent = fullPath;
    }
  }

  // Slug sanitization
  if (slugInput) {
    slugInput.addEventListener('input', function() {
      // Convert to lowercase, replace spaces with hyphens, remove invalid chars
      this.value = this.value
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '')
        .replace(/-+/g, '-');
      updateUrlPreview();
    });
  }

  // Category change updates preview
  if (categorySelect) {
    categorySelect.addEventListener('change', updateUrlPreview);
  }

  // Form Submit
  document.getElementById('campaignForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    // Build url_path from category select and slug
    const urlCategory = formData.get('url_category') || '';
    const slug = formData.get('slug');
    const urlPrefix = urlCategory || 'appeals';
    const urlPath = `/${urlPrefix}/${slug}`;

    const data = {
      id: formData.get('id'),
      name: formData.get('title'),
      title: formData.get('title'),
      hero_title: formData.get('hero_title') || null,
      slug: slug,
      subtitle: formData.get('subtitle') || null,
      subtitle2: formData.get('subtitle2') || null,
      description: formData.get('description') || null,
      featured_image: formData.get('featured_image') || null,
      gallery_images: galleryImages,
      content_sections: getContentSections(),
      donation_options: getDonationOptions(),
      impact_stats: getCrisisStats(),
      is_active: formData.get('is_active') === 'on',
      is_featured: formData.get('is_featured') === 'on',
      show_on_homepage: formData.get('show_on_homepage') === 'on',
      meta_title: formData.get('meta_title') || null,
      meta_description: formData.get('meta_description') || null,
      url_path: urlPath,
      category: urlCategory || null, // Also store category for filtering
      template_type: formData.get('template_type') || 'standard',
      page_template: formData.get('page_template') || null,
      donation_box_template: formData.get('donation_box_template') || null,
    };

    // Build template_config with CW donation box settings
    const cwDonation = getCWDonationConfig();
    const templateConfig = Object.assign({}, existingTemplateConfig);
    if (cwDonation) {
      templateConfig.cwDonation = cwDonation;
    } else {
      delete templateConfig.cwDonation;
    }
    templateConfig.pageContent = getPageContent();
    // Aqiqah package pricing
    const aqiqahPrices = getAqiqahPricing();
    if (aqiqahPrices) {
      templateConfig.aqiqahPackages = aqiqahPrices;
    } else {
      delete templateConfig.aqiqahPackages;
    }
    // Qurbani country pricing
    const qurbaniPrices = getQurbaniPricing();
    if (qurbaniPrices) {
      templateConfig.qurbaniPricing = qurbaniPrices;
    } else {
      delete templateConfig.qurbaniPricing;
    }
    // Orphan sponsorship pricing
    const orphanPrices = getOrphanPricing();
    if (orphanPrices) {
      templateConfig.orphanPricing = orphanPrices;
    } else {
      delete templateConfig.orphanPricing;
    }
    data.template_config = templateConfig;

    try {
      const res = await fetch('/api/campaigns', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const result = await res.json();
        throw new Error(result.error || 'Failed to save');
      }

      showToast('Campaign saved successfully!');
    } catch (e) {
      showToast(e.message, 'error');
    }
  });
</script>
