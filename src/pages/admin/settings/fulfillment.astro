---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import SettingsTabs from '../../../components/admin/SettingsTabs.astro';
import { supabaseAdmin } from '../../../lib/supabase';

export const prerender = false;

// Fetch settings
let eidStart = '2026-06-16';
let eidEnd = '2026-06-18';
let fulfillmentEnabled = true;

try {
  const { data } = await supabaseAdmin
    .from('site_settings')
    .select('eid_ul_adha_start, eid_ul_adha_end, qurbani_fulfillment_enabled')
    .single();

  if (data) {
    eidStart = data.eid_ul_adha_start || eidStart;
    eidEnd = data.eid_ul_adha_end || eidEnd;
    fulfillmentEnabled = data.qurbani_fulfillment_enabled ?? true;
  }
} catch (e) {}

// Fetch fulfillment stats
let stats = { pending: 0, fulfilled: 0, failed: 0, emails_pending: 0 };
try {
  const now = new Date().toISOString();

  const [pending, fulfilled, failed, emailsPending] = await Promise.all([
    supabaseAdmin.from('donations').select('*', { count: 'exact', head: true })
      .eq('fulfillment_status', 'pending').eq('status', 'completed'),
    supabaseAdmin.from('donations').select('*', { count: 'exact', head: true })
      .eq('fulfillment_status', 'fulfilled'),
    supabaseAdmin.from('donations').select('*', { count: 'exact', head: true })
      .eq('fulfillment_status', 'failed'),
    supabaseAdmin.from('donations').select('*', { count: 'exact', head: true })
      .eq('fulfillment_status', 'fulfilled')
      .eq('fulfillment_email_sent', false),
  ]);

  stats = {
    pending: pending.count || 0,
    fulfilled: fulfilled.count || 0,
    failed: failed.count || 0,
    emails_pending: emailsPending.count || 0,
  };
} catch (e) {}

// Recent fulfilled donations
let recentFulfilled: Array<Record<string, unknown>> = [];
try {
  const { data } = await supabaseAdmin
    .from('donations')
    .select('id, donor_name, donor_email, amount, campaign_name, fulfillment_status, fulfilled_at, fulfillment_email_sent, fulfillment_mode, scheduled_fulfillment_at')
    .in('fulfillment_status', ['fulfilled', 'pending', 'failed'])
    .order('created_at', { ascending: false })
    .limit(10);
  recentFulfilled = data || [];
} catch (e) {}

// API key for manual trigger
const cronApiKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY?.substring(0, 32) || '';

// Format date for display
function formatDate(dateStr: string | null): string {
  if (!dateStr) return 'N/A';
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'America/New_York' });
}
---

<AdminLayout title="Fulfillment Settings" activeNav="settings">
  <div class="max-w-4xl">
    <SettingsTabs active="fulfillment" />

    <!-- Fulfillment Status Banner -->
    <div class={`mb-6 p-4 rounded-xl flex items-center justify-between ${fulfillmentEnabled ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
      <div class="flex items-center gap-3">
        <div class={`w-10 h-10 rounded-full flex items-center justify-center ${fulfillmentEnabled ? 'bg-green-100' : 'bg-red-100'}`}>
          {fulfillmentEnabled ? (
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          ) : (
            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          )}
        </div>
        <div>
          <p class={`font-semibold ${fulfillmentEnabled ? 'text-green-800' : 'text-red-800'}`}>
            {fulfillmentEnabled ? 'Auto-Fulfillment Active' : 'Auto-Fulfillment Disabled'}
          </p>
          <p class={`text-sm ${fulfillmentEnabled ? 'text-green-600' : 'text-red-600'}`}>
            {fulfillmentEnabled ? 'Cron runs every 15 min. Donations are auto-fulfilled on schedule.' : 'Fulfillment processing is paused.'}
          </p>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
        <p class="text-3xl font-bold text-amber-600">{stats.pending}</p>
        <p class="text-sm text-gray-500 mt-1">Pending</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
        <p class="text-3xl font-bold text-green-600">{stats.fulfilled}</p>
        <p class="text-sm text-gray-500 mt-1">Fulfilled</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
        <p class="text-3xl font-bold text-red-600">{stats.failed}</p>
        <p class="text-sm text-gray-500 mt-1">Failed</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
        <p class="text-3xl font-bold text-blue-600">{stats.emails_pending}</p>
        <p class="text-sm text-gray-500 mt-1">Emails Queued</p>
      </div>
    </div>

    <!-- Eid ul-Adha Settings -->
    <form id="fulfillment-form">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-2">Eid ul-Adha Dates</h2>
        <p class="text-sm text-gray-500 mb-6">Qurbani and Aqeeqah orders placed before Eid are fulfilled on Day 1. Orders during Eid are fulfilled the next day.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Eid Start Date (Day 1)</label>
            <input
              type="date"
              name="eid_start"
              value={eidStart}
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
            />
            <p class="text-xs text-gray-400 mt-1">First day of Eid ul-Adha (10th Dhul Hijjah)</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Eid End Date (Day 3)</label>
            <input
              type="date"
              name="eid_end"
              value={eidEnd}
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#01534d]"
            />
            <p class="text-xs text-gray-400 mt-1">Last day of Eid ul-Adha (12th Dhul Hijjah)</p>
          </div>
        </div>

        <!-- Current Eid dates display -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-600">
            <span class="font-medium">Current Eid dates:</span>
            {formatDate(eidStart)} &mdash; {formatDate(eidEnd)}
            <span class="text-gray-400 ml-2">({Math.ceil((new Date(eidEnd).getTime() - new Date(eidStart).getTime()) / (1000 * 60 * 60 * 24)) + 1} days)</span>
          </p>
        </div>
      </div>

      <!-- Fulfillment Rules -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-2">Fulfillment Rules</h2>
        <p class="text-sm text-gray-500 mb-6">How donations are auto-fulfilled based on campaign type.</p>

        <div class="space-y-4">
          <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
            <div class="w-8 h-8 bg-[#01534d] text-white rounded-lg flex items-center justify-center flex-shrink-0 text-sm font-bold">1</div>
            <div>
              <p class="font-medium text-gray-800">General / Zakat / Sadaqah</p>
              <p class="text-sm text-gray-500">Auto-fulfilled <strong>24 hours</strong> after payment. Email sent at 1:30 PM donor's local time.</p>
            </div>
          </div>

          <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
            <div class="w-8 h-8 bg-[#01534d] text-white rounded-lg flex items-center justify-center flex-shrink-0 text-sm font-bold">2</div>
            <div>
              <p class="font-medium text-gray-800">Qurbani / Aqeeqah (Before Eid)</p>
              <p class="text-sm text-gray-500">Fulfilled on <strong>Day 1 of Eid ul-Adha</strong>. Email at 1:30 PM donor's time.</p>
            </div>
          </div>

          <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
            <div class="w-8 h-8 bg-[#01534d] text-white rounded-lg flex items-center justify-center flex-shrink-0 text-sm font-bold">3</div>
            <div>
              <p class="font-medium text-gray-800">Qurbani / Aqeeqah (During Eid)</p>
              <p class="text-sm text-gray-500">Fulfilled the <strong>next day</strong>. Day 1 orders on Day 2, Day 2 on Day 3, Day 3 on Day 4.</p>
            </div>
          </div>

          <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
            <div class="w-8 h-8 bg-[#01534d] text-white rounded-lg flex items-center justify-center flex-shrink-0 text-sm font-bold">4</div>
            <div>
              <p class="font-medium text-gray-800">Qurbani / Aqeeqah (After Eid)</p>
              <p class="text-sm text-gray-500">Auto-fulfilled <strong>24 hours</strong> after payment, same as general donations.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Auto-Fulfillment Toggle -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-bold text-gray-800">Auto-Fulfillment</h2>
            <p class="text-sm text-gray-500 mt-1">Enable or disable the automatic fulfillment processor (runs every 15 minutes via Cloudflare Cron).</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" name="fulfillment_enabled" class="sr-only peer" checked={fulfillmentEnabled} />
            <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
            <span class="ms-3 text-sm font-medium text-gray-700">Enabled</span>
          </label>
        </div>
      </div>

      <!-- Save Button -->
      <div class="flex items-center gap-4">
        <button
          type="submit"
          id="saveBtn"
          class="px-6 py-2.5 bg-[#01534d] text-white rounded-lg hover:bg-[#01534d]/90 transition-colors flex items-center gap-2 font-medium"
        >
          <span>Save Settings</span>
          <svg id="saveSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
        </button>

        <button
          type="button"
          id="triggerBtn"
          class="px-6 py-2.5 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors flex items-center gap-2 font-medium"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          <span>Run Fulfillment Now</span>
        </button>
      </div>
    </form>

    <!-- Recent Donations Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Recent Donations</h2>
      {recentFulfilled.length === 0 ? (
        <p class="text-gray-400 text-sm">No donations with fulfillment data yet.</p>
      ) : (
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-100">
                <th class="text-left py-2 px-3 text-gray-500 font-medium">Donor</th>
                <th class="text-left py-2 px-3 text-gray-500 font-medium">Campaign</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">Amount</th>
                <th class="text-center py-2 px-3 text-gray-500 font-medium">Mode</th>
                <th class="text-center py-2 px-3 text-gray-500 font-medium">Status</th>
                <th class="text-center py-2 px-3 text-gray-500 font-medium">Email</th>
                <th class="text-left py-2 px-3 text-gray-500 font-medium">Scheduled</th>
              </tr>
            </thead>
            <tbody>
              {recentFulfilled.map((d) => (
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                  <td class="py-2 px-3">
                    <p class="font-medium text-gray-800">{d.donor_name || 'Anonymous'}</p>
                    <p class="text-xs text-gray-400">{d.donor_email}</p>
                  </td>
                  <td class="py-2 px-3 text-gray-600">{d.campaign_name || 'N/A'}</td>
                  <td class="py-2 px-3 text-right font-medium">${Number(d.amount || 0).toLocaleString()}</td>
                  <td class="py-2 px-3 text-center">
                    <span class={`inline-block px-2 py-0.5 rounded text-xs font-medium ${
                      d.fulfillment_mode === 'eid_scheduled' ? 'bg-purple-100 text-purple-700' :
                      d.fulfillment_mode === 'eid_next_day' ? 'bg-blue-100 text-blue-700' :
                      'bg-gray-100 text-gray-600'
                    }`}>
                      {d.fulfillment_mode || 'auto_24h'}
                    </span>
                  </td>
                  <td class="py-2 px-3 text-center">
                    <span class={`inline-block px-2 py-0.5 rounded text-xs font-medium ${
                      d.fulfillment_status === 'fulfilled' ? 'bg-green-100 text-green-700' :
                      d.fulfillment_status === 'failed' ? 'bg-red-100 text-red-700' :
                      'bg-amber-100 text-amber-700'
                    }`}>
                      {d.fulfillment_status}
                    </span>
                  </td>
                  <td class="py-2 px-3 text-center">
                    {d.fulfillment_email_sent ? (
                      <span class="text-green-500">Sent</span>
                    ) : (
                      <span class="text-gray-400">Pending</span>
                    )}
                  </td>
                  <td class="py-2 px-3 text-gray-500 text-xs">{formatDate(d.scheduled_fulfillment_at as string)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  </div>
</AdminLayout>

<script define:vars={{ cronApiKey }}>
  // Save settings
  document.getElementById('fulfillment-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const saveBtn = document.getElementById('saveBtn');
    const spinner = document.getElementById('saveSpinner');
    if (saveBtn) saveBtn.setAttribute('disabled', 'true');
    if (spinner) spinner.classList.remove('hidden');

    const form = e.target;
    const formData = new FormData(form);

    const data = {
      eid_ul_adha_start: formData.get('eid_start'),
      eid_ul_adha_end: formData.get('eid_end'),
      qurbani_fulfillment_enabled: formData.has('fulfillment_enabled'),
    };

    try {
      const res = await fetch('/api/settings/fulfillment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await res.json();

      if (res.ok) {
        alert('Fulfillment settings saved!');
        window.location.reload();
      } else {
        alert('Error: ' + (result.error || 'Failed to save'));
      }
    } catch (err) {
      alert('Error saving settings');
    } finally {
      if (saveBtn) saveBtn.removeAttribute('disabled');
      if (spinner) spinner.classList.add('hidden');
    }
  });

  // Manual trigger
  document.getElementById('triggerBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('triggerBtn');
    if (btn) {
      btn.setAttribute('disabled', 'true');
      btn.querySelector('span').textContent = 'Running...';
    }

    try {
      const res = await fetch('/api/fulfillment/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': cronApiKey },
      });

      const result = await res.json();

      if (res.ok) {
        const msg = `Fulfillment complete!\n\nPhase 1 (Fulfill): ${result.phase1_fulfillment?.fulfilled || 0} fulfilled, ${result.phase1_fulfillment?.failed || 0} failed\nPhase 2 (Emails): ${result.phase2_emails?.sent || 0} sent, ${result.phase2_emails?.failed || 0} failed`;
        alert(msg);
        window.location.reload();
      } else {
        alert('Error: ' + (result.error || 'Fulfillment failed'));
      }
    } catch (err) {
      alert('Error running fulfillment');
    } finally {
      if (btn) {
        btn.removeAttribute('disabled');
        btn.querySelector('span').textContent = 'Run Fulfillment Now';
      }
    }
  });
</script>
