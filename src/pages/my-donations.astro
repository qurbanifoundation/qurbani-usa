---
import Layout from '../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="My Donations - Qurbani Foundation">
  <div class="min-h-screen bg-stone-50">
    <!-- Header -->
    <div class="bg-gradient-to-br from-[#01534d] via-[#016d5b] to-[#01534d] text-white">
      <div class="max-w-2xl mx-auto px-4 py-10 text-center">
        <a href="/" class="inline-block mb-6">
          <img src="/images/logo-white.png" alt="Qurbani Foundation" class="h-10 mx-auto" onerror="this.style.display='none'" />
        </a>
        <h1 class="text-3xl font-bold mb-2" style="font-family: 'Signika', sans-serif;">My Donations</h1>
        <p class="text-white/80">View your donation history and manage subscriptions</p>
      </div>
    </div>

    <div class="max-w-2xl mx-auto px-4 -mt-6">
      <!-- Email Lookup Card -->
      <div id="lookup-card" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="text-center mb-5">
          <div class="w-14 h-14 mx-auto bg-emerald-100 rounded-full flex items-center justify-center mb-3">
            <svg class="w-7 h-7 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
            </svg>
          </div>
          <p class="text-stone-600">Enter the email address you used for your donation</p>
        </div>
        <form id="lookup-form" class="space-y-4">
          <div class="relative">
            <input
              type="email"
              id="donor-email"
              placeholder="your@email.com"
              required
              class="w-full px-4 py-3.5 border border-stone-300 rounded-xl text-base focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition placeholder:text-stone-400"
            />
          </div>
          <button
            type="submit"
            id="lookup-btn"
            class="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-700 hover:to-teal-700 transition shadow-sm text-base flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <span id="lookup-btn-text">Look Up My Donations</span>
          </button>
        </form>
        <div id="lookup-error" class="hidden mt-4 p-3 bg-red-50 rounded-xl text-red-600 text-sm text-center"></div>
      </div>

      <!-- Results Section (hidden by default) -->
      <div id="results-section" class="hidden space-y-6 pb-12">
        <!-- Welcome Back -->
        <div id="welcome-card" class="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-5 text-white">
            <p class="text-sm text-white/80">Welcome back</p>
            <h2 id="donor-name-display" class="text-2xl font-bold" style="font-family: 'Signika', sans-serif;">Donor</h2>
          </div>
          <div class="grid grid-cols-3 divide-x divide-stone-200">
            <div class="p-4 text-center">
              <p class="text-2xl font-bold text-emerald-700" id="stat-total">$0</p>
              <p class="text-xs text-stone-500 mt-1">Total Given</p>
            </div>
            <div class="p-4 text-center">
              <p class="text-2xl font-bold text-emerald-700" id="stat-donations">0</p>
              <p class="text-xs text-stone-500 mt-1">Donations</p>
            </div>
            <div class="p-4 text-center">
              <p class="text-2xl font-bold text-emerald-700" id="stat-active">0</p>
              <p class="text-xs text-stone-500 mt-1">Active Recurring</p>
            </div>
          </div>
        </div>

        <!-- Active Subscriptions -->
        <div id="subscriptions-section" class="hidden">
          <h3 class="text-lg font-bold text-stone-800 mb-3 px-1" style="font-family: 'Signika', sans-serif;">Recurring Donations</h3>
          <div id="subscriptions-list" class="space-y-4"></div>
        </div>

        <!-- Donation History -->
        <div id="history-section" class="hidden">
          <h3 class="text-lg font-bold text-stone-800 mb-3 px-1" style="font-family: 'Signika', sans-serif;">Donation History</h3>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div id="donations-list" class="divide-y divide-stone-100"></div>
          </div>
        </div>

        <!-- No Results -->
        <div id="no-results" class="hidden bg-white rounded-2xl shadow-lg p-8 text-center">
          <div class="w-16 h-16 mx-auto bg-stone-100 rounded-full flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-bold text-stone-800 mb-2">No Donations Found</h3>
          <p class="text-stone-500 mb-6">We couldn't find any donations with this email address.</p>
          <a href="/donate" class="inline-block px-6 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-700 hover:to-teal-700 transition">
            Make Your First Donation
          </a>
        </div>

        <!-- Back Button -->
        <div class="text-center pt-2">
          <button id="back-btn" class="text-emerald-700 font-medium hover:text-emerald-800 transition text-sm">
            Look up a different email
          </button>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center py-8 text-stone-400 text-sm">
        <p>Questions? <a href="mailto:info@qurbani.com" class="text-emerald-700 hover:underline">info@qurbani.com</a> | <a href="tel:1-800-900-0027" class="text-emerald-700 hover:underline">1-800-900-0027</a></p>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 id="modal-title" class="text-xl font-bold text-stone-900 mb-2">Confirm Action</h3>
      <p id="modal-message" class="text-stone-600 mb-6"></p>
      <div class="flex gap-4">
        <button id="modal-cancel" class="flex-1 px-4 py-3 bg-stone-100 text-stone-700 rounded-xl font-medium hover:bg-stone-200 transition">
          Go Back
        </button>
        <button id="modal-confirm" class="flex-1 px-4 py-3 bg-[#01534d] text-white rounded-xl font-medium hover:bg-[#013d39] transition">
          Confirm
        </button>
      </div>
    </div>
  </div>

  <script is:inline>
    var currentEmail = '';
    var currentSubscriptions = [];

    document.getElementById('lookup-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      var email = document.getElementById('donor-email').value.trim();
      if (!email) return;
      currentEmail = email;

      var btn = document.getElementById('lookup-btn');
      var btnText = document.getElementById('lookup-btn-text');
      var errorDiv = document.getElementById('lookup-error');
      btn.disabled = true;
      btnText.textContent = 'Looking up...';
      errorDiv.classList.add('hidden');

      try {
        var res = await fetch('/api/donor/lookup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email }),
        });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Lookup failed');

        showResults(data);
      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Look Up My Donations';
      }
    });

    document.getElementById('back-btn').addEventListener('click', function() {
      document.getElementById('results-section').classList.add('hidden');
      document.getElementById('lookup-card').classList.remove('hidden');
      document.getElementById('donor-email').value = '';
      document.getElementById('donor-email').focus();
    });

    function showResults(data) {
      document.getElementById('lookup-card').classList.add('hidden');
      document.getElementById('results-section').classList.remove('hidden');
      currentSubscriptions = data.subscriptions || [];

      var hasData = (data.subscriptions && data.subscriptions.length > 0) || (data.donations && data.donations.length > 0);
      if (!hasData) {
        document.getElementById('no-results').classList.remove('hidden');
        document.getElementById('welcome-card').classList.add('hidden');
        document.getElementById('subscriptions-section').classList.add('hidden');
        document.getElementById('history-section').classList.add('hidden');
        return;
      }

      document.getElementById('no-results').classList.add('hidden');
      document.getElementById('welcome-card').classList.remove('hidden');

      // Populate stats
      var name = data.donorName || currentEmail.split('@')[0];
      document.getElementById('donor-name-display').textContent = name;
      document.getElementById('stat-total').textContent = '$' + (data.totalDonated || 0).toFixed(0);
      document.getElementById('stat-donations').textContent = (data.donations || []).filter(function(d) { return d.status === 'completed'; }).length;
      document.getElementById('stat-active').textContent = (data.subscriptions || []).filter(function(s) { return s.status === 'active'; }).length;

      // Render subscriptions
      if (data.subscriptions && data.subscriptions.length > 0) {
        document.getElementById('subscriptions-section').classList.remove('hidden');
        var subList = document.getElementById('subscriptions-list');
        subList.innerHTML = data.subscriptions.map(function(sub) {
          var isWeekly = sub.interval === 'weekly';
          var freq = isWeekly ? 'Every Jummah' : 'Monthly';
          var freqShort = isWeekly ? '/wk' : '/mo';
          var statusColor = sub.status === 'active' ? 'bg-emerald-100 text-emerald-800' :
                           sub.status === 'paused' ? 'bg-amber-100 text-amber-800' :
                           sub.status === 'cancelled' ? 'bg-stone-200 text-stone-600' :
                           'bg-red-100 text-red-800';
          var statusLabel = sub.status.charAt(0).toUpperCase() + sub.status.slice(1).replace('_', ' ');
          var items = (sub.items || []).map(function(i) { return i.name || i.label || 'General'; }).join(', ');
          var nextDate = sub.next_billing_date ? new Date(sub.next_billing_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
          var card = sub.card_brand && sub.card_last4 ? sub.card_brand + ' ****' + sub.card_last4 : '';

          var actionsHtml = '';
          if (sub.status === 'active') {
            actionsHtml = '<div class="flex gap-2 mt-4">' +
              '<button onclick="doSubscriptionAction(\'' + sub.id + '\', \'' + sub.management_token + '\', \'pause\', \'' + freq + '\')" class="flex-1 py-2.5 text-sm font-medium bg-amber-50 text-amber-700 rounded-xl hover:bg-amber-100 transition">Pause</button>' +
              '<button onclick="doSubscriptionAction(\'' + sub.id + '\', \'' + sub.management_token + '\', \'skip\', \'' + freq + '\')" class="flex-1 py-2.5 text-sm font-medium bg-blue-50 text-blue-700 rounded-xl hover:bg-blue-100 transition">Skip Next</button>' +
              '<button onclick="doSubscriptionAction(\'' + sub.id + '\', \'' + sub.management_token + '\', \'cancel\', \'' + freq + '\')" class="flex-1 py-2.5 text-sm font-medium bg-stone-100 text-stone-600 rounded-xl hover:bg-red-50 hover:text-red-600 transition">Cancel</button>' +
              '</div>';
          } else if (sub.status === 'paused') {
            actionsHtml = '<div class="flex gap-2 mt-4">' +
              '<button onclick="doSubscriptionAction(\'' + sub.id + '\', \'' + sub.management_token + '\', \'resume\', \'' + freq + '\')" class="flex-1 py-2.5 text-sm font-medium bg-emerald-50 text-emerald-700 rounded-xl hover:bg-emerald-100 transition">Resume</button>' +
              '<button onclick="doSubscriptionAction(\'' + sub.id + '\', \'' + sub.management_token + '\', \'cancel\', \'' + freq + '\')" class="flex-1 py-2.5 text-sm font-medium bg-stone-100 text-stone-600 rounded-xl hover:bg-red-50 hover:text-red-600 transition">Cancel</button>' +
              '</div>';
          }

          return '<div class="bg-white rounded-2xl shadow-lg overflow-hidden">' +
            '<div class="p-5">' +
              '<div class="flex items-start justify-between mb-3">' +
                '<div>' +
                  '<div class="flex items-center gap-2 mb-1">' +
                    '<span class="text-xs font-semibold px-2 py-0.5 rounded-full ' + (isWeekly ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700') + '">' + freq + '</span>' +
                    '<span class="text-xs font-medium px-2 py-0.5 rounded-full ' + statusColor + '">' + statusLabel + '</span>' +
                  '</div>' +
                  '<p class="text-2xl font-bold text-stone-900">$' + sub.amount.toFixed(2) + '<span class="text-sm font-normal text-stone-500">' + freqShort + '</span></p>' +
                '</div>' +
                '<div class="w-10 h-10 bg-gradient-to-br ' + (isWeekly ? 'from-purple-400 to-purple-600' : 'from-blue-400 to-blue-600') + ' rounded-xl flex items-center justify-center flex-shrink-0">' +
                  '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>' +
                '</div>' +
              '</div>' +
              '<div class="space-y-1.5 text-sm text-stone-500">' +
                (items ? '<p>Supporting: <span class="text-stone-700">' + items + '</span></p>' : '') +
                (nextDate && sub.status === 'active' ? '<p>Next billing: <span class="text-stone-700">' + nextDate + '</span></p>' : '') +
                (card ? '<p>Card: <span class="text-stone-700">' + card + '</span></p>' : '') +
              '</div>' +
              actionsHtml +
            '</div>' +
          '</div>';
        }).join('');
      } else {
        document.getElementById('subscriptions-section').classList.add('hidden');
      }

      // Render donation history
      if (data.donations && data.donations.length > 0) {
        document.getElementById('history-section').classList.remove('hidden');
        var donList = document.getElementById('donations-list');
        donList.innerHTML = data.donations.map(function(don) {
          var statusColor = don.status === 'completed' ? 'bg-emerald-100 text-emerald-800' :
                           don.status === 'pending' ? 'bg-amber-100 text-amber-800' :
                           don.status === 'failed' ? 'bg-red-100 text-red-800' :
                           'bg-stone-100 text-stone-600';
          var date = new Date(don.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          var typeLabel = don.donation_type === 'monthly' ? 'Monthly' : don.donation_type === 'weekly' ? 'Jummah' : 'One-time';
          var typeBg = don.donation_type === 'monthly' ? 'text-blue-600' : don.donation_type === 'weekly' ? 'text-purple-600' : 'text-stone-500';
          var items = (don.items || []).map(function(i) { return i.name || i.label || 'Donation'; }).join(', ');

          return '<div class="p-4 flex items-center gap-4">' +
            '<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ' + (don.status === 'completed' ? 'bg-emerald-100' : 'bg-stone-100') + '">' +
              (don.status === 'completed'
                ? '<svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                : '<svg class="w-5 h-5 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>') +
            '</div>' +
            '<div class="flex-1 min-w-0">' +
              '<p class="font-medium text-stone-800 truncate">' + items + '</p>' +
              '<p class="text-xs text-stone-400 mt-0.5">' + date + ' &middot; <span class="' + typeBg + '">' + typeLabel + '</span></p>' +
            '</div>' +
            '<div class="text-right flex-shrink-0">' +
              '<p class="font-bold text-stone-900">$' + don.amount.toFixed(2) + '</p>' +
              '<span class="text-xs font-medium px-2 py-0.5 rounded-full ' + statusColor + '">' + don.status + '</span>' +
            '</div>' +
          '</div>';
        }).join('');
      } else {
        document.getElementById('history-section').classList.add('hidden');
      }
    }

    // Subscription actions
    var pendingAction = null;
    var modal = document.getElementById('confirm-modal');

    window.doSubscriptionAction = function(subId, token, action, freq) {
      var titles = {
        pause: 'Pause ' + freq + ' Donation',
        resume: 'Resume ' + freq + ' Donation',
        skip: 'Skip Next Payment',
        cancel: 'Cancel Subscription',
      };
      var messages = {
        pause: 'Your donation will be paused. You will not be charged until you resume.',
        resume: 'Your donation will resume and regular billing will continue.',
        skip: 'The next scheduled payment will be skipped. Your subscription stays active.',
        cancel: 'This will cancel your recurring donation. You will not be charged again after the current period.',
      };
      document.getElementById('modal-title').textContent = titles[action] || 'Confirm';
      document.getElementById('modal-message').textContent = messages[action] || 'Are you sure?';
      pendingAction = { subId: subId, token: token, action: action };
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };

    document.getElementById('modal-cancel').addEventListener('click', function() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      pendingAction = null;
    });

    document.getElementById('modal-confirm').addEventListener('click', async function() {
      if (!pendingAction) return;
      var confirmBtn = this;
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      try {
        var res;
        if (pendingAction.action === 'cancel') {
          res = await fetch('/api/subscriptions/manage?subscription_id=' + pendingAction.subId + '&token=' + pendingAction.token, { method: 'DELETE' });
        } else {
          res = await fetch('/api/subscriptions/manage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subscription_id: pendingAction.subId,
              token: pendingAction.token,
              action: pendingAction.action,
            }),
          });
        }

        if (res.ok) {
          // Re-fetch data
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          pendingAction = null;

          var lookupRes = await fetch('/api/donor/lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail }),
          });
          var data = await lookupRes.json();
          showResults(data);
        } else {
          var err = await res.json();
          alert(err.error || 'Action failed');
        }
      } catch (e) {
        alert('An error occurred. Please try again.');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm';
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });

    // Check URL params for pre-filled email
    var urlParams = new URLSearchParams(window.location.search);
    var preEmail = urlParams.get('email');
    if (preEmail) {
      document.getElementById('donor-email').value = preEmail;
      document.getElementById('lookup-form').dispatchEvent(new Event('submit'));
    }
  </script>
</Layout>
