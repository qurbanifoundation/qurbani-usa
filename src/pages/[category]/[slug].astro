---
/**
 * Category-based Campaign/Page Route
 * Handles URLs like /zakat/zakat-fund, /ramadan/fidya, /ramadan/30days, etc.
 *
 * Lookup order:
 * 1. Check `campaigns` table by url_path
 * 2. Check `campaigns` table by slug + category (fallback)
 * 3. Check `campaign_pages` table by url_path → redirect to static .astro file
 */
import GreenWithYellowTemplate from '../../templates/GreenWithYellowTemplate.astro';
import EmergencyAppealTemplate from '../../templates/EmergencyAppealTemplate.astro';
import OrphanSponsorshipTemplate from '../../templates/OrphanSponsorshipTemplate.astro';
import TileStackSponsorshipTemplate from '../../templates/TileStackSponsorshipTemplate.astro';
import AqiqahTemplate from '../../templates/AqiqahTemplate.astro';
import { supabaseAdmin } from '../../lib/supabase';

export const prerender = false;

const { category, slug } = Astro.params;

// Skip reserved routes (these have their own pages)
const reservedCategories = ['admin', 'api', 'appeals', 'about', 'contact', 'donate', 'cart', 'checkout', 'thank-you', 'reports', 'impact', 'news', 'blog', 'faq', 'privacy', 'terms'];
if (reservedCategories.includes(category?.toLowerCase() || '')) {
  return Astro.redirect('/404', 404);
}

// Build the expected url_path
const urlPath = `/${category}/${slug}`;

// Fetch campaign by url_path
let campaign: any = null;
let siteSettings: any = null;

try {
  const { data } = await supabaseAdmin
    .from('campaigns')
    .select('*')
    .eq('url_path', urlPath)
    .eq('is_active', true)
    .single();
  campaign = data;
} catch (e) {
  // url_path lookup failed
}

// If not found by url_path, try by slug + category as fallback
if (!campaign) {
  try {
    const { data } = await supabaseAdmin
      .from('campaigns')
      .select('*')
      .eq('slug', slug)
      .eq('category', category)
      .eq('is_active', true)
      .single();
    campaign = data;
  } catch (e2) {
    // Not in campaigns table — will check campaign_pages below
  }
}

// If no campaign found, check campaign_pages table
// Campaign pages have their own static .astro files — serve via rewrite or redirect
if (!campaign) {
  let foundPage: { file_path: string; slug: string; url_path: string } | null = null;

  try {
    const { data: page } = await supabaseAdmin
      .from('campaign_pages')
      .select('file_path, slug, url_path')
      .eq('url_path', urlPath)
      .eq('is_active', true)
      .single();
    if (page) foundPage = page;
  } catch (e) {
    // Also try matching by slug alone in campaign_pages
    try {
      const { data: page } = await supabaseAdmin
        .from('campaign_pages')
        .select('file_path, slug, url_path')
        .eq('slug', slug)
        .eq('is_active', true)
        .single();
      if (page) foundPage = page;
    } catch (e2) {
      // Not found anywhere
    }
  }

  if (foundPage && foundPage.file_path) {
    // Serve the static page at the current category URL
    // Astro.rewrite() doesn't work for prerendered pages on Cloudflare Pages,
    // so we fetch the static HTML from the CDN and return it directly
    let filePath = foundPage.file_path.replace('.astro', '');
    if (filePath.endsWith('/index')) filePath = filePath.replace('/index', '');
    try {
      const staticUrl = new URL(`/${filePath}`, Astro.url.origin);
      const res = await fetch(staticUrl.toString(), {
        headers: { 'Accept': 'text/html' },
        redirect: 'follow',
      });
      if (res.ok) {
        const html = await res.text();
        return new Response(html, {
          status: 200,
          headers: {
            'Content-Type': 'text/html; charset=utf-8',
            'Cache-Control': 'public, max-age=0, must-revalidate',
          },
        });
      }
    } catch (fetchErr) {
      console.error('Campaign page proxy error:', fetchErr);
    }
    // Last resort fallback: redirect to the static page directly
    return Astro.redirect(`/${filePath}`, 302);
  }

  return Astro.redirect('/404', 404);
}

// Fetch site settings for default templates
try {
  const { data, error } = await supabaseAdmin
    .from('site_settings')
    .select('default_campaign_page_template, default_donation_box_template, orphan_sponsorship_template')
    .limit(1);

  if (!error && data && data.length > 0) {
    siteSettings = data[0];
  }
} catch (e) {
  console.error('Error fetching site settings:', e);
}

// Determine which template to use
const templateKey = campaign.page_template || siteSettings?.default_campaign_page_template || 'green-with-yellow';
const donationBoxTemplate = campaign.donation_box_template || siteSettings?.default_donation_box_template || 'teal-yellow';

// Map template keys to components
const templateMap: Record<string, any> = {
  'green-with-yellow': GreenWithYellowTemplate,
  'emergency-appeal': EmergencyAppealTemplate,
  'orphan-sponsorship': OrphanSponsorshipTemplate,
  'tilestack-sponsorship': TileStackSponsorshipTemplate,
  'tile-stack-sponsorship': TileStackSponsorshipTemplate,
  'aqiqah': AqiqahTemplate,
};

const TemplateComponent = templateMap[templateKey] || GreenWithYellowTemplate;
---

<TemplateComponent campaign={campaign} donationBoxTemplate={donationBoxTemplate} />
