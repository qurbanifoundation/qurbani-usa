---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';

const orderId = Astro.url.searchParams.get('order_id');
---

<Layout title="Thank You for Your Donation">
  <Navbar />
  <main class="min-h-[60vh] flex items-center justify-center py-20 bg-[#f1efea]">
    <div class="max-w-lg mx-auto px-4 text-center">
      <div class="bg-white rounded-2xl shadow-lg p-8">
        <!-- Success Icon -->
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>

        <h1 class="text-3xl font-bold text-[#312e2b] mb-4">JazakAllah Khair!</h1>
        <p class="text-gray-600 mb-6">
          Your Qurbani donation has been received successfully. May Allah accept your sacrifice and reward you abundantly.
        </p>

        {orderId && (
          <div class="bg-[#f1efea] rounded-lg p-4 mb-6">
            <p class="text-sm text-gray-500">Order Reference</p>
            <p class="text-lg font-mono font-bold text-[#312e2b]" id="order-number">Loading...</p>
          </div>
        )}

        <div class="space-y-3 text-left mb-6">
          <div class="flex items-start gap-3">
            <span class="text-[#ef7c01]">‚úâÔ∏è</span>
            <p class="text-gray-600 text-sm">A confirmation email has been sent to your email address.</p>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-[#ef7c01]">üì∏</span>
            <p class="text-gray-600 text-sm">You will receive photos and updates after your Qurbani is performed.</p>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-[#ef7c01]">üìÑ</span>
            <p class="text-gray-600 text-sm">A tax-deductible receipt will be emailed to you.</p>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
          <a href="/" class="flex-1 bg-[#ef7c01] hover:bg-[#d96e00] text-white font-semibold py-3 px-6 rounded-lg transition text-center">
            Return Home
          </a>
          <a href="#packages" class="flex-1 border-2 border-[#ef7c01] text-[#ef7c01] hover:bg-[#ef7c01] hover:text-white font-semibold py-3 px-6 rounded-lg transition text-center">
            Donate Again
          </a>
        </div>
      </div>

      <!-- Share Section -->
      <div class="mt-8 text-center">
        <p class="text-gray-600 mb-4">Share the blessing with others</p>
        <div class="flex justify-center gap-4">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://qurbani.com" target="_blank" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition">
            <span>f</span>
          </a>
          <a href="https://twitter.com/intent/tweet?text=I%20just%20gave%20my%20Qurbani%20with%20Qurbani%20Foundation%20USA!&url=https://qurbani.com" target="_blank" class="w-10 h-10 bg-sky-500 text-white rounded-full flex items-center justify-center hover:bg-sky-600 transition">
            <span>ùïè</span>
          </a>
          <a href="https://wa.me/?text=I%20just%20gave%20my%20Qurbani%20with%20Qurbani%20Foundation%20USA!%20https://qurbani.com" target="_blank" class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition">
            <span>W</span>
          </a>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  // Get order number from URL
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order_id');

  if (orderId) {
    // Fetch order details
    const { data: order } = await supabase
      .from('orders')
      .select('order_number')
      .eq('id', orderId)
      .single();

    if (order) {
      const orderNumberEl = document.getElementById('order-number');
      if (orderNumberEl) {
        orderNumberEl.textContent = order.order_number;
      }
    }
  }

  // Backup GA4 purchase tracking ‚Äî fires if the DonationCart event didn't fully send
  // GA4 deduplicates by transaction_id, so firing again is safe
  try {
    const purchaseData = sessionStorage.getItem('qurbani_purchase');
    if (purchaseData) {
      const purchase = JSON.parse(purchaseData);
      // Only fire if purchase was recent (within 5 minutes)
      if (Date.now() - purchase.timestamp < 300000) {
        if (typeof window.gtag === 'function') {
          window.gtag('event', 'purchase', {
            transaction_id: purchase.transaction_id,
            currency: 'USD',
            value: purchase.value,
            items: purchase.items,
            send_to: 'G-0WC0W1PBKC'
          });
          window.gtag('event', 'conversion', {
            'send_to': 'AW-793369119/2lawCM74xKcBEJ-0p_oC',
            'value': purchase.value,
            'currency': 'USD',
            'transaction_id': purchase.transaction_id
          });
          console.log('[GA4] Backup purchase event fired on success page:', purchase.transaction_id);
        }
      }
      // Clear so it doesn't fire again on page refresh
      sessionStorage.removeItem('qurbani_purchase');
    }
  } catch(e) {
    console.error('[GA4] Backup tracking error:', e);
  }
</script>
