---
// Donation Cart Sidebar + Full-Screen Checkout Modal
import { supabaseAdmin } from '../lib/supabase';

interface Props {
  checkoutTemplate?: string;
  showCartReminder?: boolean;
  showSidecartMonthly?: boolean;
  showSidecartJummah?: boolean;
}

const { checkoutTemplate = 'three-step', showCartReminder = true, showSidecartMonthly = true, showSidecartJummah = true } = Astro.props;

// Google Places API key
const googlePlacesApiKey = import.meta.env.PUBLIC_GOOGLE_PLACES_API_KEY || '';

// Fetch payment settings
let paymentSettings = {
  stripe_enabled: true,
  stripe_publishable_key: '',
  google_pay_enabled: true,
  apple_pay_enabled: true,
  paypal_enabled: false,
};
let siteLogo = '';

try {
  const { data } = await supabaseAdmin
    .from('site_settings')
    .select('stripe_enabled, stripe_publishable_key, google_pay_enabled, apple_pay_enabled, paypal_enabled, site_logo')
    .single();

  if (data) {
    paymentSettings = {
      stripe_enabled: data.stripe_enabled ?? true,
      stripe_publishable_key: data.stripe_publishable_key || '',
      google_pay_enabled: data.google_pay_enabled ?? true,
      apple_pay_enabled: data.apple_pay_enabled ?? true,
      paypal_enabled: data.paypal_enabled ?? false,
    };
    siteLogo = (data as any)?.site_logo || '';
  }
} catch (e) {}
---

<!-- Stripe.js -->
<script is:inline src="https://js.stripe.com/v3/"></script>

<!-- Caveat font for handwritten style -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500&display=swap" rel="stylesheet">

<!-- Google Places Autocomplete Dropdown Fix -->
<style is:global>
  .pac-container {
    z-index: 10000 !important;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    margin-top: 4px;
  }
  .pac-item {
    padding: 10px 12px;
    cursor: pointer;
  }
  .pac-item:hover {
    background-color: #f3f4f6;
  }
  .pac-item-query {
    font-size: 14px;
    color: #111827;
  }
  .pac-matched {
    font-weight: 600;
  }

  /* Highlight checked recurring option */
  .recurring-option:has(input:checked) {
    background-color: #fef3c7 !important;
    border-color: #d97706 !important;
  }

  /* Custom checkbox - grey style for Keep in Touch */
  .custom-checkbox {
    position: relative;
    display: inline-block;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }
  .custom-checkbox input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 1;
  }
  .custom-checkbox .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    background-color: white;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    transition: all 0.15s ease;
  }
  .custom-checkbox input:checked + .checkmark {
    background-color: white;
    border-color: #9ca3af;
  }
  .custom-checkbox .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid #9ca3af;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
  }
  .custom-checkbox input:checked + .checkmark:after {
    display: block;
  }

  /* Orange checkbox style for Please Support Us Further */
  .custom-checkbox-orange .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    background-color: white;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    transition: all 0.15s ease;
  }
  .custom-checkbox-orange input:checked + .checkmark {
    background-color: white;
    border-color: #d97706;
  }
  .custom-checkbox-orange .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid #d97706;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
  }
  .custom-checkbox-orange input:checked + .checkmark:after {
    display: block;
  }
</style>

<!-- Checkout template setting for client-side JS -->
<div id="checkout-template-setting" data-checkout-template={checkoutTemplate} data-site-logo={siteLogo} class="hidden"></div>

<!-- ==================== CART REMINDER POPUP ==================== -->
{showCartReminder && (
<div id="cart-reminder" class="fixed bottom-6 left-6 bg-white rounded-xl shadow-2xl border border-gray-200 p-4 z-[99] hidden max-w-xs transform transition-all duration-300 translate-y-4 opacity-0">
  <button id="close-cart-reminder" class="absolute top-2 right-2 p-1 text-gray-400 hover:text-gray-600 transition" aria-label="Close reminder">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>
  <div class="flex items-start gap-3">
    <div class="flex-shrink-0">
      <svg class="w-10 h-10 text-[#d97706]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
      </svg>
    </div>
    <div class="flex-1 pr-4">
      <h4 class="font-bold text-gray-800 text-sm" style="font-family: 'Signika', sans-serif;">Make a difference!</h4>
      <p class="text-gray-600 text-xs mt-1">Finish your <strong id="reminder-amount" class="text-[#d97706]">$0</strong> gift to create an impact today.</p>
    </div>
  </div>
  <button id="reminder-give-btn" class="mt-3 w-full bg-[#d97706] hover:bg-[#b45309] text-white font-bold py-2 px-4 rounded-lg text-sm transition">
    Give Now
  </button>
</div>
)}

<!-- ==================== SIDECART ==================== -->
<div id="cart-overlay" class="fixed inset-0 bg-black/50 z-[100] hidden opacity-0 transition-opacity duration-300"></div>

<div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-white z-[101] shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
  <!-- Header -->
  <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-[#d97706]">
    <h2 class="text-lg font-bold text-white" style="font-family: 'Signika', sans-serif;">Your Donations</h2>
    <button id="close-cart" class="p-2 hover:bg-white/10 rounded-full transition" aria-label="Close donation cart">
      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Cart Content -->
  <div class="flex-1 overflow-y-auto p-4 flex flex-col">
    <!-- Empty State -->
    <div id="cart-empty" class="text-center py-8">
      <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
      </svg>
      <p class="text-gray-500 font-medium">Your cart is empty</p>
      <p class="text-gray-400 text-sm mt-1">Add a donation to get started</p>
    </div>

    <!-- Cart Items List -->
    <div id="cart-items" class="space-y-3 hidden">
      <!-- Items rendered via JS -->
    </div>

    <!-- Spacer to push checkout to middle (shrinks when more items) -->
    <div id="cart-spacer" class="flex-1 min-h-[60px] max-h-[30vh]"></div>

    <!-- Make it Monthly + Checkout Section -->
    <div id="cart-footer">
      <!-- Make a Bigger Impact Section -->
      {(showSidecartMonthly || showSidecartJummah) && (
      <div id="recurring-options" class="mb-5 hidden">
        <!-- Handwritten-style header -->
        <div class="relative mb-1">
          <p class="text-gray-500 text-[18px] sm:text-[24px] text-center whitespace-nowrap" style={`font-family: 'Caveat', cursive;${showSidecartJummah ? ' padding-right: 2rem;' : ''}`}>
            {showSidecartJummah ? 'Make a bigger impact with every Friday gift' : 'Make a bigger impact with recurring giving'}
          </p>
          {showSidecartJummah && (
          <!-- Clear curved arrow pointing down to Jummah -->
          <svg class="absolute right-0 top-3 w-10 h-14 text-[#d97706]" viewBox="0 0 40 56" fill="none">
            <path d="M4 4 C18 8, 26 20, 26 34" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
            <line x1="18" y1="42" x2="26" y2="52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="34" y1="42" x2="26" y2="52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M26 34 L26 52" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
          </svg>
          )}
        </div>

        <!-- Recurring option checkboxes -->
        <div class={`grid gap-2 ${showSidecartMonthly && showSidecartJummah ? 'grid-cols-2' : 'grid-cols-1'}`}>
          {showSidecartMonthly && (
          <!-- Monthly -->
          <label class="cursor-pointer">
            <div class="recurring-option p-3 bg-gray-50 hover:bg-amber-50 rounded-xl transition border border-gray-200 hover:border-[#d97706] h-full">
              <div class="flex items-start gap-2">
                <input type="checkbox" name="recurring-type" value="monthly" class="mt-0.5 w-4 h-4 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706] accent-[#d97706] flex-shrink-0" />
                <div>
                  <p class="font-bold text-gray-700 text-xs uppercase tracking-wide">Make it Monthly</p>
                  <p class="text-[10px] text-gray-400 mt-1 leading-tight">Monthly donations help us transform communities faster!</p>
                </div>
              </div>
            </div>
          </label>
          )}

          {showSidecartJummah && (
          <!-- Every Jummah (Friday) -->
          <label class="cursor-pointer">
            <div class="recurring-option p-3 bg-gray-50 hover:bg-amber-50 rounded-xl transition border border-gray-200 hover:border-[#d97706] h-full">
              <div class="flex items-start gap-2">
                <input type="checkbox" name="recurring-type" value="weekly" class="mt-0.5 w-4 h-4 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706] accent-[#d97706] flex-shrink-0" />
                <div>
                  <p class="font-bold text-gray-700 text-xs uppercase tracking-wide">Every Jummah</p>
                  <p class="text-[10px] text-gray-400 mt-1">Friday</p>
                </div>
              </div>
            </div>
          </label>
          )}
        </div>
      </div>
      )}

      <!-- Total -->
      <div class="flex justify-between items-center mb-3">
        <span class="text-gray-600 text-sm" id="payment-type-label">One-time Payment</span>
        <span class="text-xl font-bold text-[#d97706]" id="cart-total">$0.00</span>
      </div>

      <!-- Checkout Button -->
      <button id="proceed-checkout-btn" disabled class="w-full bg-[#d97706] text-white font-bold py-3 rounded-xl hover:bg-[#b45309] transition disabled:opacity-50 disabled:cursor-not-allowed" style="font-family: 'Signika', sans-serif;">
        Continue to Secure Payment
      </button>
    </div>
  </div>
</div>

<!-- ==================== FULL-SCREEN CHECKOUT MODAL ==================== -->
<div id="checkout-modal" class="fixed inset-0 z-[200] hidden">
  <!-- Modal Content - True Full Screen -->
  <div class="absolute inset-0 bg-white overflow-y-auto">

    <!-- Close Button -->
    <button id="close-checkout-modal" class="fixed top-2 right-3 z-20 p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition shadow-md" aria-label="Close checkout">
      <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

        <!-- Step 1: Your Information + Cart Summary -->
        <div id="modal-step-1">
          <!-- Progress Indicator -->
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-[#d97706] text-white flex items-center justify-center font-bold text-sm">1</div>
                <span class="font-semibold text-gray-800">Your Information</span>
                <div class="hidden md:flex items-center gap-2 text-gray-400 ml-2">
                  <div class="w-6 h-0.5 bg-gray-300"></div>
                  <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold text-sm">2</div>
                  <span class="text-gray-500">Payment</span>
                </div>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2">
            <!-- Left: Your Information -->
            <div class="p-6 md:p-8 bg-white">
              <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Signika', sans-serif;">Your Information</h2>

              <form id="checkout-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                    <input type="text" name="firstName" id="modal-firstName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                    <input type="text" name="lastName" id="modal-lastName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                  <input type="email" name="email" id="modal-email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                  <input type="tel" name="phone" id="modal-phone" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                </div>

                <!-- Privacy & Communication Preferences -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                  <h4 class="text-lg font-bold text-gray-800 mb-4">Keep in Touch</h4>

                  <!-- Communication Preferences -->
                  <div class="mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">I am happy to hear from Qurbani Foundation by:</p>
                    <div class="flex flex-wrap gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-email" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">Email</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-sms" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">SMS</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-whatsapp" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">WhatsApp</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-phone" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">Phone</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-post" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">Post</span>
                      </label>
                    </div>
                  </div>

                  <p class="text-xs text-gray-500">To opt-out, email to: <a href="mailto:donorcare@qurbani.com" class="text-[#01534d] hover:underline">donorcare@qurbani.com</a></p>
                </div>

              </form>
            </div>

            <!-- Right: Donation Basket + Upsell -->
            <div class="p-6 md:p-8 bg-gray-50 md:border-l border-gray-200">
              <!-- Donation Basket Box -->
              <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4" style="font-family: 'Signika', sans-serif;">Donation Basket</h3>

                <!-- Cart Items Summary -->
                <div id="modal-cart-items" class="space-y-3">
                  <!-- Rendered via JS -->
                </div>

                <!-- Subtotal -->
                <div class="flex justify-between items-center pt-3 mt-3 border-t border-gray-200">
                  <span class="font-medium text-gray-700">Subtotal</span>
                  <span class="text-xl font-bold text-[#d97706]" id="modal-subtotal">$0.00</span>
                </div>
              </div>

              <!-- Please Support Us Further Box -->
              <div class="bg-white rounded-xl border border-gray-200 p-4">
                <p class="text-sm font-semibold text-gray-700 mb-4">Please Support Us Further</p>

                <!-- Upsell Item 1: Prophetic Qurbani -->
                <label class="flex items-center gap-3 cursor-pointer mb-4">
                  <div class="custom-checkbox custom-checkbox-orange">
                    <input type="checkbox" id="upsell-checkbox-1" />
                    <span class="checkmark"></span>
                  </div>
                  <span class="text-sm text-gray-700">YES, Give Prophetic Qurbani</span>
                </label>

                <div class="bg-gray-50 rounded-xl p-4 mb-4">
                  <div class="flex gap-4">
                    <img src="/images/campaigns/prophetic-qurbani.jpg" alt="Prophetic Qurbani" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1545167496-5a24ed2d68b4?w=200&q=80'" />
                    <div>
                      <p class="font-bold text-gray-800 text-sm">I WANT TO GIVE $50 TO PROPHETIC QURBANI</p>
                      <p class="text-xs text-gray-600 mt-2 leading-relaxed">The Prophet (&#65018;) used to give his Qurbani and then give a second Qurbani for those in his Ummah who were unable to do so themselves. This act of generous giving is for those who cannot. Follow in the footsteps of The Prophet (&#65018;) and give today!</p>
                    </div>
                  </div>
                </div>

                <!-- Upsell Item 2: Feed a Family -->
                <label class="flex items-center gap-3 cursor-pointer mb-4">
                  <div class="custom-checkbox custom-checkbox-orange">
                    <input type="checkbox" id="upsell-checkbox-2" />
                    <span class="checkmark"></span>
                  </div>
                  <span class="text-sm text-gray-700">YES, Feed a Family for a Week</span>
                </label>

                <div class="bg-gray-50 rounded-xl p-4">
                  <div class="flex gap-4">
                    <img src="/images/campaigns/feed-family.jpg" alt="Feed a Family" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1593113598332-cd288d649433?w=200&q=80'" />
                    <div>
                      <p class="font-bold text-gray-800 text-sm">I WANT TO GIVE $25 TO FEED A FAMILY</p>
                      <p class="text-xs text-gray-600 mt-2 leading-relaxed">Provide 21 nutritious meals for a family in need. Your generosity ensures they have food on the table for an entire week. Be the reason a family doesn't go hungry.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Continue to Payment Button - Separate from boxes above -->
              <div class="mt-8 pt-6 border-t border-gray-200">
                <button type="button" id="modal-continue-btn" class="w-full bg-[#d97706] text-white font-bold py-4 rounded-xl hover:bg-[#b45309] transition text-lg shadow-lg">
                  Continue to Payment
                  <svg class="w-5 h-5 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Payment Details -->
        <div id="modal-step-2" class="hidden">
          <!-- Progress Indicator - Step 2 -->
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <div class="max-w-2xl mx-auto flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <span class="text-gray-400">Your Information</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-12 h-0.5 bg-[#d97706]"></div>
                <div class="w-8 h-8 rounded-full bg-[#d97706] text-white flex items-center justify-center font-bold text-sm">2</div>
                <span class="font-semibold text-gray-800">Payment</span>
              </div>
              <!-- Trust Badge in Header -->
              <div class="hidden md:flex items-center gap-2 text-sm text-gray-500">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="font-medium">256-bit SSL Secure</span>
              </div>
            </div>
          </div>

          <div class="p-6 md:p-8 max-w-2xl mx-auto">
            <!-- Back Button -->
            <button type="button" id="modal-back-btn" class="flex items-center gap-2 text-[#d97706] font-medium mb-6 hover:underline">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Back to Information
            </button>

            <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Signika', sans-serif;">Payment Details</h2>

            <!-- Order Summary with Impact -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6 border border-green-200">
              <div class="flex justify-between items-center">
                <div>
                  <span class="text-gray-600">Your Total Impact</span>
                  <p class="text-xs text-green-600 mt-1">100% of your donation goes to those in need</p>
                </div>
                <span class="text-2xl font-bold text-[#d97706]" id="payment-total">$0.00</span>
              </div>
            </div>

            <!-- Card Element with Trust Badges -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Card Details *</label>
                <div class="flex items-center gap-2">
                  <img src="https://cdn.jsdelivr.net/gh/nicerobot/stripe-badge@master/svg/badge-solid-dark.svg" alt="Powered by Stripe" class="h-6" onerror="this.style.display='none'" />
                </div>
              </div>
              <div id="card-element" class="p-4 border border-gray-300 rounded-xl bg-white min-h-[50px]"></div>
              <div id="card-errors" class="text-red-500 text-sm mt-2" role="alert"></div>
              <!-- Card Brands -->
              <div class="flex items-center gap-2 mt-2">
                <span class="text-xs text-gray-400">We accept:</span>
                <div class="flex gap-1">
                  <div class="w-8 h-5 bg-blue-600 rounded flex items-center justify-center text-white text-xs font-bold">VISA</div>
                  <div class="w-8 h-5 bg-red-500 rounded flex items-center justify-center text-white text-xs font-bold">MC</div>
                  <div class="w-8 h-5 bg-blue-400 rounded flex items-center justify-center text-white text-xs font-bold">AMEX</div>
                </div>
              </div>
            </div>

            <!-- Billing Address -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Billing Address</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
                  <input type="text" name="address" id="modal-address" required autocomplete="off" placeholder="Start typing to search..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  <p class="text-xs text-gray-400 mt-1">Start typing to auto-fill your address</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                    <input type="text" name="city" id="modal-city" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                    <input type="text" name="state" id="modal-state" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code *</label>
                    <input type="text" name="zipCode" id="modal-zip" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                    <select name="country" id="modal-country" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] bg-white">
                      <option value="US" selected>United States</option>
                      <option value="CA">Canada</option>
                      <option value="GB">United Kingdom</option>
                      <option value="AU">Australia</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cover Transaction Fees -->
            <div class="mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" id="cover-fees-checkbox" class="mt-1 w-5 h-5 text-[#d97706] rounded focus:ring-[#d97706] accent-[#d97706]" />
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="font-semibold text-gray-800 text-sm group-hover:text-[#d97706] transition">Cover Transaction Fees</span>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">+3%</span>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Add <span id="fee-amount-display">$0.00</span> so 100% of your donation reaches those in need.</p>
                </div>
              </label>
            </div>

            <!-- Total Display -->
            <div class="flex justify-between items-center mb-4 py-3 px-4 bg-white rounded-xl border border-gray-200">
              <span class="font-medium text-gray-700">Your Total</span>
              <span class="text-2xl font-bold text-[#d97706]" id="step2-total">$0.00</span>
            </div>

            <!-- Pay Button -->
            <button type="button" id="pay-btn" class="w-full bg-[#d97706] text-white font-bold py-4 rounded-xl hover:bg-[#b45309] transition text-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              <span id="pay-btn-text">Complete Secure Donation</span>
            </button>

            <!-- Trust Indicators Below Button -->
            <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-xs text-gray-500">
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Secure Payment</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Tax Deductible</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                </svg>
                <span>Receipt Emailed</span>
              </div>
            </div>

            <!-- Processing -->
            <div id="processing-indicator" class="hidden mt-4 text-center">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#d97706]"></div>
              <p class="text-gray-600 mt-2">Processing your donation...</p>
            </div>

            <!-- Error -->
            <div id="payment-error" class="hidden mt-4 p-4 bg-red-50 rounded-xl text-center">
              <p class="text-red-600" id="payment-error-text"></p>
            </div>
          </div>
        </div>

        <!-- Success State -->
        <div id="modal-success" class="hidden max-w-lg mx-auto">
          <!-- Confetti-style top banner -->
          <div class="relative bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-700 pt-10 pb-8 px-6 text-center overflow-hidden">
            <!-- Decorative circles -->
            <div class="absolute top-3 left-6 w-3 h-3 bg-yellow-300 rounded-full opacity-80"></div>
            <div class="absolute top-8 left-16 w-2 h-2 bg-white rounded-full opacity-60"></div>
            <div class="absolute top-4 right-8 w-4 h-4 bg-amber-300 rounded-full opacity-70"></div>
            <div class="absolute top-10 right-20 w-2 h-2 bg-emerald-200 rounded-full opacity-80"></div>
            <div class="absolute bottom-4 left-10 w-2 h-2 bg-yellow-200 rounded-full opacity-60"></div>
            <div class="absolute bottom-6 right-12 w-3 h-3 bg-white rounded-full opacity-40"></div>

            <div class="w-20 h-20 mx-auto bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center mb-5 ring-4 ring-white/30">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2" style="font-family: 'Signika', sans-serif;">JazakAllah Khair!</h2>
            <p class="text-emerald-100 text-base" id="success-message">Your donation has been processed successfully.</p>
          </div>

          <!-- Content area -->
          <div class="px-6 py-6 bg-white">
            <!-- Donation summary card -->
            <div id="success-donation-summary" class="bg-stone-50 rounded-2xl p-5 mb-5 border border-stone-200">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-stone-500 uppercase tracking-wide">Donation Amount</span>
                <span id="success-amount" class="text-2xl font-bold text-emerald-700" style="font-family: 'Signika', sans-serif;">$0.00</span>
              </div>
              <div class="h-px bg-stone-200 mb-3"></div>
              <div id="success-items-list" class="space-y-2 text-sm text-stone-600"></div>
            </div>

            <!-- Subscription Info (hidden by default) -->
            <div id="subscription-info" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-5 mb-5">
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p id="subscription-type-title" class="font-bold text-stone-800 text-lg">Recurring Donation</p>
                  <p class="text-stone-600 mt-1">You will be automatically charged <span id="monthly-amount" class="font-bold text-amber-700"></span> <span id="billing-interval-text">each month</span>.</p>
                  <div class="flex items-center gap-2 mt-2 text-sm text-stone-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Next billing: <span id="next-billing-date" class="font-medium text-stone-700"></span>
                  </div>
                </div>
              </div>
              <a href="#" id="manage-subscription-link" class="mt-4 flex items-center justify-center gap-2 text-sm font-semibold text-amber-700 bg-white border border-amber-200 rounded-xl py-2.5 px-4 hover:bg-amber-50 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Manage Your Subscription
              </a>
            </div>

            <!-- Trust signals -->
            <div class="flex items-center gap-3 bg-emerald-50 rounded-xl p-4 mb-5">
              <svg class="w-5 h-5 text-emerald-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              <p class="text-sm text-emerald-800">A tax-deductible receipt has been sent to your email.</p>
            </div>

            <!-- Impact message -->
            <div class="text-center mb-6 px-4">
              <p class="text-stone-500 text-sm italic">"Whoever saves a life, it is as if they have saved all of humanity." - Quran 5:32</p>
            </div>

            <!-- Action buttons -->
            <div class="space-y-3">
              <button type="button" id="close-success-btn" class="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-700 hover:to-teal-700 transition shadow-sm text-base">
                Continue Browsing
              </button>
              <a href="/appeals" class="block w-full py-3 text-center text-emerald-700 font-medium rounded-xl border border-emerald-200 hover:bg-emerald-50 transition text-sm">
                View More Campaigns
              </a>
            </div>
          </div>
        </div>
</div>

<!-- ==================== 2-STEP CHECKOUT MODAL ==================== -->
<div id="two-step-checkout" class="fixed inset-0 z-[200] hidden">
  <div class="absolute inset-0 bg-white overflow-y-auto">

    <!-- Header Bar -->
    <div class="sticky top-0 z-20 bg-white border-b border-gray-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6 text-[#01534d]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
          </svg>
          <span class="font-bold text-gray-800 text-lg" style="font-family: 'Signika', sans-serif;">Secure Checkout</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="hidden sm:flex items-center gap-2 text-sm text-gray-500">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
            </svg>
            <span>256-bit SSL Encrypted</span>
          </div>
          <button id="close-two-step" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition" aria-label="Close checkout">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 md:py-8">
      <div class="grid md:grid-cols-5 gap-8">

        <!-- LEFT COLUMN: Forms (3 cols on desktop) -->
        <div class="md:col-span-3 space-y-0">

          <!-- YOUR CART - Mobile Accordion -->
          <div class="md:hidden mb-6">
            <button type="button" id="ts-cart-toggle" class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 rounded-xl border border-gray-200 hover:bg-gray-100 transition">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-[#d97706]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <span class="font-semibold text-gray-800" style="font-family: 'Signika', sans-serif;">Your Cart</span>
                <span id="ts-cart-count-badge" class="px-2 py-0.5 bg-[#d97706] text-white text-xs font-bold rounded-full">0</span>
              </div>
              <div class="flex items-center gap-2">
                <span id="ts-cart-total-badge" class="font-bold text-[#d97706]">$0.00</span>
                <svg id="ts-cart-chevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </button>
            <div id="ts-cart-mobile-body" class="hidden mt-2 bg-gray-50 rounded-xl border border-gray-200 p-4">
              <div id="ts-cart-mobile-items"><!-- Items rendered by JS --></div>
            </div>
          </div>

          <!-- YOUR INFORMATION -->
          <div class="bg-white rounded-xl border border-gray-200 p-5 sm:p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-2" style="font-family: 'Signika', sans-serif;">
              <span class="w-7 h-7 rounded-full bg-[#01534d] text-white flex items-center justify-center text-sm font-bold">1</span>
              Your Information
            </h2>
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                  <input type="text" id="ts-firstName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] focus:border-transparent transition" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                  <input type="text" id="ts-lastName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] focus:border-transparent transition" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                <input type="email" id="ts-email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] focus:border-transparent transition" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input type="tel" id="ts-phone" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] focus:border-transparent transition" />
              </div>

              <!-- Communication Preferences -->
              <div class="pt-4 border-t border-gray-100">
                <p class="text-sm font-medium text-gray-700 mb-2">Keep in touch:</p>
                <div class="flex flex-wrap gap-3">
                  <label class="flex items-center gap-1.5 cursor-pointer text-sm text-gray-600">
                    <input type="checkbox" id="ts-pref-email" checked class="w-4 h-4 text-[#01534d] border-gray-300 rounded focus:ring-[#01534d]" /> Email
                  </label>
                  <label class="flex items-center gap-1.5 cursor-pointer text-sm text-gray-600">
                    <input type="checkbox" id="ts-pref-sms" checked class="w-4 h-4 text-[#01534d] border-gray-300 rounded focus:ring-[#01534d]" /> SMS
                  </label>
                  <label class="flex items-center gap-1.5 cursor-pointer text-sm text-gray-600">
                    <input type="checkbox" id="ts-pref-whatsapp" checked class="w-4 h-4 text-[#01534d] border-gray-300 rounded focus:ring-[#01534d]" /> WhatsApp
                  </label>
                  <label class="flex items-center gap-1.5 cursor-pointer text-sm text-gray-600">
                    <input type="checkbox" id="ts-pref-phone" checked class="w-4 h-4 text-[#01534d] border-gray-300 rounded focus:ring-[#01534d]" /> Phone
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- PAYMENT DETAILS -->
          <div class="bg-white rounded-xl border border-gray-200 p-5 sm:p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-2" style="font-family: 'Signika', sans-serif;">
              <span class="w-7 h-7 rounded-full bg-[#01534d] text-white flex items-center justify-center text-sm font-bold">2</span>
              Payment Details
            </h2>

            <!-- Card Element -->
            <div class="mb-5">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Card Details *</label>
                <div class="flex items-center gap-1">
                  <div class="w-8 h-5 bg-blue-600 rounded flex items-center justify-center text-white text-[9px] font-bold">VISA</div>
                  <div class="w-8 h-5 bg-red-500 rounded flex items-center justify-center text-white text-[9px] font-bold">MC</div>
                  <div class="w-8 h-5 bg-blue-400 rounded flex items-center justify-center text-white text-[9px] font-bold">AMEX</div>
                </div>
              </div>
              <div id="ts-card-element" class="p-4 border border-gray-300 rounded-xl bg-white min-h-[50px]"></div>
              <div id="ts-card-errors" class="text-red-500 text-sm mt-2" role="alert"></div>
            </div>

            <!-- Billing Address -->
            <h3 class="text-base font-semibold text-gray-800 mb-3">Billing Address</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
                <input type="text" id="ts-address" required autocomplete="off" placeholder="Start typing to search..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] transition" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                  <input type="text" id="ts-city" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] transition" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                  <input type="text" id="ts-state" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] transition" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code *</label>
                  <input type="text" id="ts-zip" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] transition" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                  <select id="ts-country" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#01534d] bg-white transition">
                    <option value="US" selected>United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Cover Transaction Fees -->
            <div class="mt-5 p-4 bg-amber-50 rounded-xl border border-amber-200">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="ts-cover-fees" class="mt-1 w-5 h-5 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706]" />
                <div>
                  <span class="font-semibold text-gray-800 text-sm">Cover transaction fees</span>
                  <span class="ml-1 px-1.5 py-0.5 bg-amber-200 text-amber-800 text-xs font-bold rounded">+3%</span>
                  <p id="ts-fee-description" class="text-xs text-gray-500 mt-0.5">Add $0.00 so 100% of your donation reaches those in need</p>
                </div>
              </label>
            </div>

            <!-- Pay Error Display -->
            <div id="ts-payment-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm"></div>

            <!-- Complete Donation Button -->
            <div class="mt-6">
              <button type="button" id="ts-pay-btn" disabled class="w-full py-4 bg-[#01534d] text-white font-bold text-lg rounded-xl hover:bg-[#013d39] disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg" style="font-family: 'Signika', sans-serif;">
                <span id="ts-pay-btn-text">Complete Secure Donation</span>
                <span id="ts-pay-btn-spinner" class="hidden">
                  <svg class="animate-spin inline w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                  </svg>
                  Processing...
                </span>
              </button>
            </div>

            <!-- Trust Signals -->
            <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-xs text-gray-400">
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Secure Payment</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span>Tax-Deductible</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                </svg>
                <span>Receipt Emailed</span>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Order Summary (2 cols on desktop, sticky) -->
        <div class="md:col-span-2">
          <div class="md:sticky md:top-20">
            <div class="bg-white rounded-xl border border-gray-200 p-5 sm:p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4" style="font-family: 'Signika', sans-serif;">Order Summary</h3>

              <!-- Cart Items -->
              <div id="ts-cart-items" class="space-y-3 mb-4">
                <!-- Items rendered by JS -->
              </div>

              <div id="ts-empty-cart" class="hidden text-center py-6 text-gray-400">
                <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <p class="text-sm">Your cart is empty</p>
              </div>

              <!-- Recurring Option -->
              <div id="ts-recurring-section" class="hidden mb-4 pt-3 border-t border-gray-100">
                <p class="text-sm font-medium text-gray-700 mb-2">Make it recurring:</p>
                <div class="flex gap-2">
                  <label class="flex-1 flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition recurring-option">
                    <input type="radio" name="ts-recurring" value="monthly" class="text-[#d97706] focus:ring-[#d97706]" />
                    <span class="text-sm font-medium text-gray-700">Monthly</span>
                  </label>
                  <label class="flex-1 flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition recurring-option">
                    <input type="radio" name="ts-recurring" value="weekly" class="text-[#d97706] focus:ring-[#d97706]" />
                    <span class="text-sm font-medium text-gray-700">Every Jummah</span>
                  </label>
                </div>
                <button type="button" id="ts-clear-recurring" class="hidden text-xs text-gray-400 hover:text-gray-600 mt-1 ml-1">Clear selection</button>
              </div>

              <!-- Divider -->
              <div class="border-t border-gray-200 pt-3 mb-3"></div>

              <!-- Upsells -->
              <div class="space-y-3 mb-4">
                <p class="text-sm font-semibold text-gray-700">Please support us further:</p>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition border border-transparent hover:border-gray-200">
                  <input type="checkbox" id="ts-upsell-prophetic" class="w-5 h-5 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706]" />
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">Prophetic Qurbani</p>
                    <p class="text-xs text-gray-500">Follow the Sunnah of the Prophet </p>
                  </div>
                  <span class="font-bold text-[#d97706]">$50</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition border border-transparent hover:border-gray-200">
                  <input type="checkbox" id="ts-upsell-feed" class="w-5 h-5 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706]" />
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">Feed a Family</p>
                    <p class="text-xs text-gray-500">Provide meals for a family in need</p>
                  </div>
                  <span class="font-bold text-[#d97706]">$25</span>
                </label>
              </div>

              <!-- Totals -->
              <div class="border-t border-gray-200 pt-3 space-y-2">
                <div class="flex justify-between text-sm text-gray-600">
                  <span>Subtotal</span>
                  <span id="ts-subtotal">$0.00</span>
                </div>
                <div id="ts-fee-row" class="hidden flex justify-between text-sm text-gray-600">
                  <span>Transaction fee (3%)</span>
                  <span id="ts-fee-amount">$0.00</span>
                </div>
                <div class="flex justify-between text-lg font-bold text-gray-800 pt-2 border-t border-gray-100">
                  <span>Total</span>
                  <span id="ts-total" class="text-[#d97706]">$0.00</span>
                </div>
              </div>

              <!-- Quick Trust -->
              <div class="mt-4 p-3 bg-green-50 rounded-lg text-center">
                <p class="text-xs text-green-700 font-medium">100% of your donation goes to those in need</p>
                <p class="text-xs text-green-600 mt-0.5">Qurbani Foundation USA  501(c)(3)  Tax-Deductible</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script is:inline define:vars={{ stripePublishableKey: paymentSettings.stripe_publishable_key, stripeEnabled: paymentSettings.stripe_enabled, googlePlacesApiKey: googlePlacesApiKey }}>
// Cart State
window.donationCart = {
  items: [],
  isOpen: false,
  stripe: null,
  cardElement: null,
  cardMounted: false,
  placesLoaded: false,
  autocomplete: null,
  upsellItems: [
    { id: 'prophetic-qurbani', name: 'Prophetic Qurbani', amount: 50, type: 'single' },
    { id: 'feed-family', name: 'Feed a Family', amount: 25, type: 'single' },
  ],
};

// Load Google Places API
function loadGooglePlaces() {
  console.log('loadGooglePlaces called, API key present:', !!googlePlacesApiKey, 'key length:', googlePlacesApiKey?.length || 0);

  if (window.donationCart.placesLoaded) {
    console.log('Google Places already loaded');
    return;
  }

  if (!googlePlacesApiKey) {
    console.error('Google Places API key is missing! Address autocomplete will not work.');
    return;
  }

  console.log('Loading Google Places API script...');
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${googlePlacesApiKey}&libraries=places&callback=initPlacesAutocomplete`;
  script.async = true;
  script.defer = true;
  script.onerror = function() {
    console.error('Failed to load Google Places API script');
  };
  document.head.appendChild(script);
  window.donationCart.placesLoaded = true;
}

// Initialize Places Autocomplete
window.initPlacesAutocomplete = function() {
  console.log('=== initPlacesAutocomplete called ===');

  // Skip if already initialized
  if (window.donationCart.autocomplete) {
    console.log('Places autocomplete already initialized, skipping');
    return;
  }

  const addressInput = document.getElementById('modal-address');
  console.log('Address input element:', addressInput);
  console.log('Address input visible:', addressInput ? getComputedStyle(addressInput).display : 'N/A');

  if (!addressInput) {
    console.error('ERROR: Address input not found in DOM');
    return;
  }

  console.log('Google object:', typeof window.google);
  console.log('Google maps:', typeof window.google?.maps);
  console.log('Google places:', typeof window.google?.maps?.places);

  if (!window.google?.maps?.places) {
    console.error('ERROR: Google Places API not loaded');
    return;
  }

  try {
    console.log('Creating Autocomplete instance...');
    window.donationCart.autocomplete = new google.maps.places.Autocomplete(addressInput, {
      types: ['address'],
      componentRestrictions: { country: ['us', 'ca', 'gb', 'au'] },
      fields: ['address_components', 'formatted_address'],
    });
    console.log('SUCCESS: Autocomplete created:', window.donationCart.autocomplete);

    // Debug: Listen for any autocomplete events
    window.donationCart.autocomplete.addListener('place_changed', function() {
      console.log('place_changed event fired!');
    });

    // Force the pac-container to be visible
    setTimeout(function() {
      const pacContainers = document.querySelectorAll('.pac-container');
      console.log('pac-container elements found:', pacContainers.length);
      pacContainers.forEach(function(pac, i) {
        console.log('pac-container ' + i + ':', pac, 'z-index:', getComputedStyle(pac).zIndex);
      });
    }, 500);

    window.donationCart.autocomplete.addListener('place_changed', function() {
      const place = window.donationCart.autocomplete.getPlace();
      if (!place.address_components) return;

      // Parse address components
      let streetNumber = '';
      let route = '';
      let city = '';
      let state = '';
      let zip = '';
      let country = 'US';

      for (const component of place.address_components) {
        const type = component.types[0];
        if (type === 'street_number') streetNumber = component.long_name;
        if (type === 'route') route = component.long_name;
        if (type === 'locality') city = component.long_name;
        if (type === 'administrative_area_level_1') state = component.short_name;
        if (type === 'postal_code') zip = component.long_name;
        if (type === 'country') country = component.short_name;
      }

      // Fill in the form fields
      document.getElementById('modal-address').value = `${streetNumber} ${route}`.trim();
      document.getElementById('modal-city').value = city;
      document.getElementById('modal-state').value = state;
      document.getElementById('modal-zip').value = zip;
      document.getElementById('modal-country').value = country;
    });
  } catch (e) {
    console.log('Google Places not available:', e.message);
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Load cart from localStorage
  const savedCart = localStorage.getItem('donationCart');
  if (savedCart) {
    try {
      window.donationCart.items = JSON.parse(savedCart);
      updateCartUI();
    } catch (e) {}
  }

  // Initialize Stripe
  if (stripeEnabled && stripePublishableKey && typeof Stripe !== 'undefined') {
    window.donationCart.stripe = Stripe(stripePublishableKey);
    initializeStripeElements();
  }

  // Load Google Places API
  loadGooglePlaces();

  // Event Listeners
  document.getElementById('close-cart').addEventListener('click', closeCart);
  document.getElementById('cart-overlay').addEventListener('click', closeCart);
  document.getElementById('proceed-checkout-btn').addEventListener('click', openCheckoutModal);

  // Cart Reminder Popup Event Listeners
  document.getElementById('close-cart-reminder')?.addEventListener('click', hideCartReminder);
  document.getElementById('reminder-give-btn')?.addEventListener('click', () => {
    hideCartReminder();
    openCart();
  });
  document.getElementById('close-checkout-modal').addEventListener('click', closeCheckoutModal);
  document.getElementById('modal-continue-btn').addEventListener('click', goToPaymentStep);
  document.getElementById('modal-continue-btn-mobile')?.addEventListener('click', goToPaymentStep);
  document.getElementById('modal-back-btn').addEventListener('click', goToInfoStep);
  document.getElementById('pay-btn').addEventListener('click', handlePayment);
  document.getElementById('close-success-btn').addEventListener('click', function() {
    closeCheckoutModal();
    window.donationCart.items = [];
    localStorage.removeItem('donationCart');
    updateCartUI();
  });

  // Upsell checkboxes - update total and visual styles
  document.getElementById('upsell-checkbox-1').addEventListener('change', function() {
    if (this.checked) {
      // Add Prophetic Qurbani to basket
      const exists = window.donationCart.items.find(i => i.id === 'prophetic-qurbani-upsell');
      if (!exists) {
        window.donationCart.items.push({
          id: 'prophetic-qurbani-upsell',
          name: 'Prophetic Qurbani',
          amount: 50,
          quantity: 1,
          type: 'single',
          campaign: 'qurbani',
          isUpsell: true
        });
      }
    } else {
      // Remove from basket
      window.donationCart.items = window.donationCart.items.filter(i => i.id !== 'prophetic-qurbani-upsell');
    }
    updateModalCart();
    updateModalTotal();
    saveCart();
  });
  document.getElementById('upsell-checkbox-2').addEventListener('change', function() {
    if (this.checked) {
      // Add Feed a Family to basket
      const exists = window.donationCart.items.find(i => i.id === 'feed-family-upsell');
      if (!exists) {
        window.donationCart.items.push({
          id: 'feed-family-upsell',
          name: 'Feed a Family',
          amount: 25,
          quantity: 1,
          type: 'single',
          campaign: 'food-aid',
          isUpsell: true
        });
      }
    } else {
      // Remove from basket
      window.donationCart.items = window.donationCart.items.filter(i => i.id !== 'feed-family-upsell');
    }
    updateModalCart();
    updateModalTotal();
  });

  // Cover fees checkbox
  document.getElementById('cover-fees-checkbox').addEventListener('change', function() {
    updateModalTotal();
  });

  // Recurring type checkboxes (only one can be selected at a time)
  document.querySelectorAll('input[name="recurring-type"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const thisCheckbox = this;
      if (thisCheckbox.checked) {
        // Uncheck the other checkbox
        document.querySelectorAll('input[name="recurring-type"]').forEach(function(cb) {
          if (cb !== thisCheckbox) cb.checked = false;
        });
        updateCartRecurringType(thisCheckbox.value);
      } else {
        // If unchecked, revert to single
        updateCartRecurringType('single');
      }
      updateCartUI();
    });
  });

  // ESC to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (document.getElementById('checkout-modal').classList.contains('hidden') === false) {
        closeCheckoutModal();
      } else if (window.donationCart.isOpen) {
        closeCart();
      }
    }
  });
});

// Initialize Stripe Elements - now deferred until we have a clientSecret
function initializeStripeElements() {
  // No-op: Payment Element requires clientSecret, initialized in mountPaymentElement()
}

// Mount Payment Element IMMEDIATELY  no API calls, no waiting for email
// Uses Stripe deferred mode: mode='payment' for one-time, mode='setup' for recurring
// All Stripe objects (PaymentIntent/SetupIntent/Subscription) are created at submit time only
function mountPaymentElement() {
  var container = document.getElementById('card-element');
  if (!container || !window.donationCart.stripe) return;

  // Determine donation type from cart
  var items = window.donationCart.items.slice();
  var total = items.reduce(function(sum, item) { return sum + (item.amount * item.quantity); }, 0);
  var hasWeekly = items.some(function(i) { return i.type === 'weekly' || i.recurringInterval === 'weekly'; });
  var hasMonthly = items.some(function(i) { return i.type === 'monthly' || i.recurringInterval === 'monthly'; });
  var hasYearly = items.some(function(i) { return i.type === 'yearly' || i.recurringInterval === 'yearly'; });
  var hasDaily = items.some(function(i) { return i.type === 'daily' || i.recurringInterval === 'daily'; });
  var donationType = hasWeekly ? 'weekly' : (hasMonthly ? 'monthly' : (hasYearly ? 'yearly' : (hasDaily ? 'daily' : 'single')));
  var isRecurring = (donationType === 'monthly' || donationType === 'weekly' || donationType === 'yearly' || donationType === 'daily');
  var coverFees = window.donationCart.coverFees || false;
  var feeAmount = coverFees ? (total * 0.03) : 0;
  total = total + feeAmount;

  // Store donation type for handlePayment
  window.donationCart.pendingDonationType = donationType;

  try {
    // Unmount previous Payment Element if any
    if (window.donationCart.stripeElements) {
      container.innerHTML = '';
      window.donationCart.cardMounted = false;
    }

    // Mount with deferred mode  NO API calls, card fields appear instantly
    var elementsConfig = {
      mode: isRecurring ? 'setup' : 'payment',
      currency: 'usd',
      appearance: {
        theme: 'stripe',
        variables: {
          colorPrimary: '#d97706',
          fontFamily: 'system-ui, sans-serif',
          borderRadius: '12px',
        },
      },
    };

    // For one-time payments, include amount so Stripe can show relevant payment methods
    if (!isRecurring) {
      elementsConfig.amount = Math.round(total * 100);
    }

    var elements = window.donationCart.stripe.elements(elementsConfig);
    window.donationCart.stripeElements = elements;

    // Create and mount Payment Element
    var checkoutMode = (document.getElementById('checkout-template-setting')?.dataset?.checkoutTemplate) || 'three-step';
    var paymentOpts = { layout: 'tabs' };
    if (checkoutMode === 'two-step') {
      paymentOpts.fields = {
        billingDetails: {
          address: {
            country: 'never',
            postalCode: 'never',
          }
        }
      };
    }
    var paymentElement = elements.create('payment', paymentOpts);
    paymentElement.mount('#card-element');
    window.donationCart.cardMounted = true;

    // Clear any previous pending data
    window.donationCart.pendingPayment = null;
    window.donationCart.setupIntentData = null;

    paymentElement.on('change', function(event) {
      document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
    });
  } catch (err) {
    document.getElementById('card-errors').textContent = 'Failed to load payment form. Please try again.';
    console.error('Payment Element mount error:', err);
  }
}

// Recurring option functions
function updateCartRecurringType(type) {
  // Only update items that were originally added as single/one-time
  // Items added as monthly/weekly (like orphan sponsorship) stay as they are
  window.donationCart.items.forEach(function(item) {
    if (item.originalType === 'single' || !item.originalType) {
      // This item can be converted
      // type can be: 'single', 'weekly' (Jummah), or 'monthly'
      item.type = type === 'single' ? 'single' : type;
      item.recurringInterval = type;
    }
    // Items with originalType === 'monthly' or 'weekly' are not changed
  });
  saveCart();
  updateCartUI();
}

// Cart Functions
function saveCart() {
  localStorage.setItem('donationCart', JSON.stringify(window.donationCart.items));
}

window.addToCart = function(item) {
  // Track add to cart in GA4
  if (window.trackAddToCart) {
    window.trackAddToCart(item);
  }

  const existingIndex = window.donationCart.items.findIndex(i => i.id === item.id && i.type === item.type);
  if (existingIndex >= 0) {
    window.donationCart.items[existingIndex].quantity += item.quantity || 1;
  } else {
    // Store originalType so we know if this item can be converted later
    const originalType = item.type || 'single';
    window.donationCart.items.push({
      ...item,
      quantity: item.quantity || 1,
      originalType: originalType // Remember how it was added
    });
  }
  saveCart();
  try { updateCartUI(); } catch(e) { console.warn('updateCartUI error:', e); }

  // Check checkout template mode - two-step skips side cart, opens checkout directly
  var mode = (document.getElementById('checkout-template-setting')?.dataset?.checkoutTemplate) || 'three-step';
  if (mode === 'two-step') {
    openCheckoutModal();
  } else {
    openCart();
  }
};

window.removeFromCart = function(index) {
  const item = window.donationCart.items[index];

  // Track remove_from_cart in GA4
  if (window.trackRemoveFromCart && item) {
    window.trackRemoveFromCart(item);
  }

  window.donationCart.items.splice(index, 1);
  saveCart();
  updateCartUI();
};

window.updateQuantity = function(index, delta) {
  const item = window.donationCart.items[index];
  if (item) {
    item.quantity = Math.max(1, item.quantity + delta);
    saveCart();
    updateCartUI();
  }
};

function updateCartUI() {
  const items = window.donationCart.items;
  const cartEmpty = document.getElementById('cart-empty');
  const cartItems = document.getElementById('cart-items');
  const recurringOptions = document.getElementById('recurring-options');
  const proceedBtn = document.getElementById('proceed-checkout-btn');

  if (items.length === 0) {
    if (cartEmpty) cartEmpty.classList.remove('hidden');
    if (cartItems) cartItems.classList.add('hidden');
    if (recurringOptions) recurringOptions.classList.add('hidden');
    if (proceedBtn) proceedBtn.disabled = true;
  } else {
    if (cartEmpty) cartEmpty.classList.add('hidden');
    if (cartItems) cartItems.classList.remove('hidden');
    if (proceedBtn) proceedBtn.disabled = false;

    // Always show recurring options when there are items
    if (recurringOptions) recurringOptions.classList.remove('hidden');

    // Check if there are any convertible items (originally single)
    // Only show the checkbox option if there are items that CAN be converted
    const hasConvertibleItems = items.some(item => item.originalType === 'single' || !item.originalType);

    // Don't auto-check the checkbox - user must manually select it
    // The checkbox state is preserved as-is unless user interacts with it

    if (cartItems) cartItems.innerHTML = items.map((item, index) => {
      // Each item shows its own type
      const itemType = item.recurringInterval || item.type || 'single';
      const itemTypeLabel = itemType === 'weekly' ? 'Every Jummah' : itemType === 'monthly' ? 'Monthly' : itemType === 'annual' ? 'Annual' : itemType === 'yearly' ? 'Yearly' : itemType === 'daily' ? 'Daily' : 'One-time';

      // Check for notes in metadata (Aqiqah items)
      const hasNotes = item.metadata?.notes && item.metadata.notes.trim() !== '';
      const notesHtml = hasNotes ? `<p class="text-xs text-gray-500 italic mt-1 bg-gray-50 p-1.5 rounded"> ${item.metadata.notes}</p>` : '';

      return `
      <div class="bg-white rounded-xl p-3 border border-gray-200 shadow-sm">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h4 class="font-semibold text-gray-800 text-sm">${item.name}</h4>
            <p class="text-xs text-gray-500">${itemTypeLabel}</p>
            ${notesHtml}
          </div>
          <p class="font-bold text-[#d97706]">$${(item.amount * item.quantity).toFixed(2)}</p>
        </div>
        <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-100">
          <div class="flex items-center gap-2">
            <button onclick="updateQuantity(${index}, -1)" class="w-7 h-7 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 transition text-gray-600"></button>
            <span class="w-6 text-center text-sm font-medium">${item.quantity}</span>
            <button onclick="updateQuantity(${index}, 1)" class="w-7 h-7 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 transition text-gray-600">+</button>
          </div>
          <button onclick="removeFromCart(${index})" class="text-gray-400 text-xs font-medium hover:text-gray-600">Remove</button>
        </div>
      </div>
    `}).join('');
  }

  // Update total
  const total = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);

  // Determine payment label based on cart contents
  const hasWeekly = items.some(item => (item.recurringInterval || item.type) === 'weekly');
  const hasMonthly = items.some(item => (item.recurringInterval || item.type) === 'monthly');
  const hasAnnual = items.some(item => (item.recurringInterval || item.type) === 'annual');
  const hasYearly = items.some(item => (item.recurringInterval || item.type) === 'yearly');
  const hasDaily = items.some(item => (item.recurringInterval || item.type) === 'daily');
  const hasSingle = items.some(item => !item.type || item.type === 'single');
  const hasRecurring = hasWeekly || hasMonthly || hasAnnual || hasYearly || hasDaily;

  let paymentLabel = 'One-time Payment';
  if (hasWeekly && !hasMonthly && !hasAnnual && !hasYearly && !hasDaily && !hasSingle) {
    paymentLabel = 'Every Jummah';
  } else if (hasMonthly && !hasWeekly && !hasAnnual && !hasYearly && !hasDaily && !hasSingle) {
    paymentLabel = 'Monthly Payment';
  } else if (hasAnnual && !hasWeekly && !hasMonthly && !hasYearly && !hasDaily && !hasSingle) {
    paymentLabel = 'Annual Payment';
  } else if (hasYearly && !hasWeekly && !hasMonthly && !hasAnnual && !hasDaily && !hasSingle) {
    paymentLabel = 'Yearly Payment';
  } else if (hasDaily && !hasWeekly && !hasMonthly && !hasAnnual && !hasYearly && !hasSingle) {
    paymentLabel = 'Daily Payment';
  } else if (hasRecurring) {
    paymentLabel = 'Includes Recurring';
  }

  var cartTotalEl = document.getElementById('cart-total');
  var paymentLabelEl = document.getElementById('payment-type-label');
  if (cartTotalEl) cartTotalEl.textContent = '$' + total.toFixed(2);
  if (paymentLabelEl) paymentLabelEl.textContent = paymentLabel;

  // Update cart count badge (if exists)
  const badge = document.getElementById('cart-count');
  const count = items.reduce((sum, item) => sum + item.quantity, 0);
  if (badge) {
    badge.textContent = count;
    badge.classList.toggle('hidden', count === 0);
  }

  // Dispatch event so Navbar can update its cart display
  window.dispatchEvent(new CustomEvent('cartUpdated'));

  // Update cart reminder popup
  updateCartReminder();
}

// Cart Reminder Popup Logic
let reminderTimeout = null;
let reminderDismissed = false;

function updateCartReminder() {
  const reminder = document.getElementById('cart-reminder');
  const reminderAmount = document.getElementById('reminder-amount');
  if (!reminder || !reminderAmount) return;

  const items = window.donationCart.items;
  const total = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);

  // Update the amount display
  reminderAmount.textContent = '$' + total.toFixed(0);

  // Clear any existing timeout
  if (reminderTimeout) {
    clearTimeout(reminderTimeout);
    reminderTimeout = null;
  }

  // Show reminder if cart has items, cart is closed, not dismissed, and on desktop (lg: breakpoint = 1024px)
  const isDesktop = window.innerWidth >= 1024;
  if (items.length > 0 && !window.donationCart.isOpen && !reminderDismissed && isDesktop) {
    // Show after 5 seconds of inactivity
    reminderTimeout = setTimeout(() => {
      // Double-check we're still on desktop when timeout fires
      if (window.innerWidth >= 1024) {
        reminder.classList.remove('hidden');
        setTimeout(() => {
          reminder.classList.remove('translate-y-4', 'opacity-0');
        }, 10);
      }
    }, 5000);
  } else {
    // Hide the reminder
    reminder.classList.add('translate-y-4', 'opacity-0');
    setTimeout(() => {
      reminder.classList.add('hidden');
    }, 300);
  }
}

function hideCartReminder() {
  const reminder = document.getElementById('cart-reminder');
  if (reminder) {
    reminder.classList.add('translate-y-4', 'opacity-0');
    setTimeout(() => {
      reminder.classList.add('hidden');
    }, 300);
  }
  reminderDismissed = true;
}

// Open/Close Cart
function openCart() {
  window.donationCart.isOpen = true;
  var overlay = document.getElementById('cart-overlay');
  var sidebar = document.getElementById('cart-sidebar');
  if (overlay) overlay.classList.remove('hidden');
  if (sidebar) sidebar.classList.remove('translate-x-full');
  setTimeout(function() { if (overlay) overlay.classList.remove('opacity-0'); }, 10);
  document.body.style.overflow = 'hidden';

  // Track view_cart in GA4
  if (window.trackViewCart && window.donationCart.items.length > 0) {
    const total = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    window.trackViewCart(window.donationCart.items, total);
  }
}

function closeCart() {
  window.donationCart.isOpen = false;
  var overlay = document.getElementById('cart-overlay');
  var sidebar = document.getElementById('cart-sidebar');
  if (overlay) overlay.classList.add('opacity-0');
  if (sidebar) sidebar.classList.add('translate-x-full');
  setTimeout(function() { if (overlay) overlay.classList.add('hidden'); }, 300);
  document.body.style.overflow = '';
}

window.openCart = openCart;
window.closeCart = closeCart;

// Checkout Modal Functions
function openCheckoutModal() {
  closeCart();
  var checkoutModal = document.getElementById('checkout-modal');
  if (!checkoutModal) return;
  checkoutModal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  // Check if we're in two-step mode
  var isTwoStep = (document.getElementById('checkout-template-setting')?.dataset?.checkoutTemplate) === 'two-step';

  // Track begin_checkout in GA4
  if (window.trackBeginCheckout) {
    const total = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    window.trackBeginCheckout(window.donationCart.items, total);
  }

  var step1 = document.getElementById('modal-step-1');
  var step2 = document.getElementById('modal-step-2');
  var success = document.getElementById('modal-success');
  if (success) success.classList.add('hidden');

  if (isTwoStep) {
    // Two-step mode: single centered page with everything on one screen
    // Hide step 1 entirely (we'll rebuild the layout)
    if (step1) step1.classList.add('hidden');
    if (step2) step2.classList.remove('hidden');

    // Hide step progress indicators
    var stepBars = checkoutModal.querySelectorAll('.bg-gray-100.px-6.py-4.border-b');
    stepBars.forEach(function(bar) { bar.classList.add('hidden'); });

    // Hide back button
    var backBtn = document.getElementById('modal-back-btn');
    if (backBtn) backBtn.classList.add('hidden');

    // Rebuild step 2 content for two-step layout (only once)
    if (!checkoutModal.dataset.twoStepInit) {
      checkoutModal.dataset.twoStepInit = 'true';

      // Find the step 2 content container
      var step2Inner = document.querySelector('#modal-step-2 .p-6');
      if (!step2Inner) step2Inner = document.querySelector('#modal-step-2 > div > div:last-child');
      if (!step2Inner) return;

      // Replace entire step 2 inner content with clean single-column layout
      step2Inner.className = 'p-6 md:py-8 max-w-lg mx-auto';
      step2Inner.innerHTML =
        // Logo left + Secure badge right  sticky on mobile
        '<div class="flex items-center justify-between mb-5 sticky top-0 z-10 bg-white py-3 md:static md:py-0">' +
          '<img src="https://epsjdbnxhmeprjrgcbyw.supabase.co/storage/v1/object/public/media/1771815947323-nkje6c.png" alt="Qurbani Foundation" class="h-10" onerror="this.style.display=\'none\'" />' +
          '<div class="flex items-center gap-1.5 text-green-700">' +
            '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>' +
            '<span class="text-xs font-medium">Secure &amp; Encrypted</span>' +
          '</div>' +
        '</div>' +

        // Total Impact banner with expandable breakdown
        '<div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6 border border-green-200">' +
          '<div class="flex justify-between items-center">' +
            '<div>' +
              '<span class="text-gray-600 font-medium">Your Total Impact</span>' +
              '<p class="text-xs text-green-600 mt-0.5">100% of your donation goes to those in need</p>' +
            '</div>' +
            '<span class="text-2xl font-bold text-[#d97706]" id="payment-total">$0.00</span>' +
          '</div>' +
          '<button type="button" id="toggle-breakdown" class="text-xs text-[#d97706] hover:text-[#b45309] mt-2 flex items-center gap-1 font-medium transition">' +
            '<svg id="breakdown-arrow" class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>' +
            'See full donation breakdown' +
          '</button>' +
          '<div id="donation-breakdown" class="hidden mt-3 pt-3 border-t border-green-200 space-y-1.5">' +
          '</div>' +
        '</div>' +

        // Your Information  single heading for personal + billing
        '<h3 class="text-lg font-bold text-gray-800 mb-3" style="font-family: \'Signika\', sans-serif;">Your Information</h3>' +
        '<div class="space-y-3 mb-5">' +
          // First Name + Last Name
          '<div class="grid grid-cols-2 gap-3">' +
            '<input type="text" id="ts-info-firstName" placeholder="First Name *" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent text-sm" />' +
            '<input type="text" id="ts-info-lastName" placeholder="Last Name *" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent text-sm" />' +
          '</div>' +
          // Email + Phone
          '<div class="grid grid-cols-2 gap-3">' +
            '<input type="email" id="ts-info-email" placeholder="Email Address *" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent text-sm" />' +
            '<input type="tel" id="ts-info-phone" placeholder="Phone Number" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent text-sm" />' +
          '</div>' +
        '</div>' +

        // Payment (Stripe Payment Element)
        '<div class="mb-5">' +
          '<div id="card-element" class="min-h-[44px]">' +
            '<div class="animate-pulse text-gray-400 text-sm text-center py-3">Loading secure payment...</div>' +
          '</div>' +
          '<div id="card-errors" class="text-red-500 text-sm mt-1" role="alert"></div>' +
        '</div>' +

        // Billing Address  below card details
        '<div class="space-y-3 mb-5">' +
          '<label class="block text-sm font-medium text-gray-700">Billing Address</label>' +
          // Address search (Google Places autocomplete)
          '<div>' +
            '<input type="text" id="modal-address" autocomplete="off" placeholder="Search address..." class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent text-sm" />' +
          '</div>' +
          // City, State, Zip, Country  compact row, auto-populated
          '<div class="grid grid-cols-4 gap-2">' +
            '<input type="text" id="modal-city" placeholder="City" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-[#d97706] text-sm" />' +
            '<input type="text" id="modal-state" placeholder="State" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-[#d97706] text-sm" />' +
            '<input type="text" id="modal-zip" placeholder="ZIP" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-[#d97706] text-sm" />' +
            '<select id="modal-country" required class="w-full px-2 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-[#d97706] bg-white text-sm">' +
              '<option value="US" selected>US</option>' +
              '<option value="CA">CA</option>' +
              '<option value="GB">UK</option>' +
              '<option value="AU">AU</option>' +
            '</select>' +
          '</div>' +
        '</div>' +

        // Cover fees
        '<div class="mb-4 p-3 bg-gray-50 rounded-xl border border-gray-200">' +
          '<label class="flex items-center gap-3 cursor-pointer">' +
            '<input type="checkbox" id="cover-fees-checkbox" class="w-4 h-4 text-[#d97706] rounded focus:ring-[#d97706] accent-[#d97706]" />' +
            '<span class="text-sm text-gray-700">Cover transaction fees <span class="text-xs text-green-600 font-medium">(+3%)</span>  <span id="fee-amount-display" class="font-medium">$0.00</span></span>' +
          '</label>' +
        '</div>' +

        // Total
        '<div class="flex justify-between items-center mb-4 py-2.5 px-4 bg-white rounded-xl border border-gray-200">' +
          '<span class="font-medium text-gray-700">Your Total</span>' +
          '<span class="text-xl font-bold text-[#d97706]" id="step2-total">$0.00</span>' +
        '</div>' +

        // Pay button
        '<button type="button" id="pay-btn" class="w-full bg-[#d97706] text-white font-bold py-4 rounded-xl hover:bg-[#b45309] transition text-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">' +
          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>' +
          '<span id="pay-btn-text">Complete Secure Donation</span>' +
        '</button>' +

        // Trust indicators
        '<div class="mt-4 flex items-center justify-center gap-5 text-xs text-gray-500">' +
          '<div class="flex items-center gap-1"><svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg><span>Secure Payment</span></div>' +
          '<div class="flex items-center gap-1"><svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>100% Zakat Eligible</span></div>' +
          '<div class="flex items-center gap-1"><svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg><span>Instant Tax Receipt</span></div>' +
        '</div>' +

        // Processing + Error (hidden)
        '<div id="processing-indicator" class="hidden mt-4 text-center">' +
          '<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#d97706]"></div>' +
          '<p class="text-gray-600 mt-2">Processing your donation...</p>' +
        '</div>' +
        '<div id="payment-error" class="hidden mt-4 p-4 bg-red-50 rounded-xl text-center">' +
          '<p class="text-red-600" id="payment-error-text"></p>' +
        '</div>';

      // Sync two-step info fields  original modal fields (for payment handler)
      ['firstName', 'lastName', 'email', 'phone'].forEach(function(field) {
        var tsField = document.getElementById('ts-info-' + field);
        var modalField = document.getElementById('modal-' + field);
        if (tsField) {
          tsField.addEventListener('input', function() {
            if (modalField) modalField.value = this.value;
          });
        }
      });

      // Re-attach pay button handler
      document.getElementById('pay-btn')?.addEventListener('click', handlePayment);

      // Re-attach cover fees handler
      document.getElementById('cover-fees-checkbox')?.addEventListener('change', function() {
        try { updateModalTotal(); } catch(e) {}
      });

      // Init Google Places on the address field
      setTimeout(function() {
        if (window.google?.maps?.places) {
          var addrInput = document.getElementById('modal-address');
          if (addrInput && !addrInput._placesInit) {
            addrInput._placesInit = true;
            var autocomplete = new window.google.maps.places.Autocomplete(addrInput, {
              types: ['address'],
              componentRestrictions: { country: ['us', 'ca', 'gb', 'au'] },
              fields: ['address_components', 'formatted_address'],
            });
            autocomplete.addListener('place_changed', function() {
              var place = autocomplete.getPlace();
              if (!place.address_components) return;
              var streetNumber = '', route = '';
              place.address_components.forEach(function(c) {
                var t = c.types[0];
                if (t === 'street_number') streetNumber = c.long_name;
                if (t === 'route') route = c.long_name;
                if (t === 'locality') document.getElementById('modal-city').value = c.long_name;
                if (t === 'administrative_area_level_1') document.getElementById('modal-state').value = c.short_name;
                if (t === 'postal_code') document.getElementById('modal-zip').value = c.long_name;
                if (t === 'country') {
                  var sel = document.getElementById('modal-country');
                  for (var i = 0; i < sel.options.length; i++) {
                    if (sel.options[i].value === c.short_name) { sel.selectedIndex = i; break; }
                  }
                }
              });
              addrInput.value = (streetNumber + ' ' + route).trim();
            });
          }
        }
      }, 300);
    }

    // Toggle breakdown visibility
    var toggleBtn = document.getElementById('toggle-breakdown');
    var breakdownDiv = document.getElementById('donation-breakdown');
    var breakdownArrow = document.getElementById('breakdown-arrow');
    // Render breakdown items with remove buttons
    function renderBreakdown() {
      if (!breakdownDiv) return;
      var items = window.donationCart.items || [];
      var html = '';
      items.forEach(function(item, index) {
        var itemTotal = (item.amount * (item.quantity || 1));
        var isMonthly = item.type === 'monthly' || item.recurringInterval === 'monthly' || item.originalType === 'monthly' || (item.label && item.label.indexOf('/mo') >= 0);
        var isWeekly = item.type === 'weekly' || item.recurringInterval === 'weekly' || item.originalType === 'weekly';
        var isYearly = item.type === 'yearly' || item.recurringInterval === 'yearly' || item.originalType === 'yearly';
        var isDaily = item.type === 'daily' || item.recurringInterval === 'daily' || item.originalType === 'daily';
        var recurLabel = '';
        if (isMonthly) recurLabel = '/mo';
        else if (isWeekly) recurLabel = '/wk';
        else if (isYearly) recurLabel = '/yr';
        else if (isDaily) recurLabel = '/day';
        html += '<div class="flex items-center text-sm py-1.5">' +
          '<div class="flex-1 min-w-0">' +
            '<span class="text-gray-700">' + (item.name || item.label || item.campaign || 'Donation') + '</span>' +
            (item.quantity > 1 ? '<span class="text-gray-400 ml-1">x' + item.quantity + '</span>' : '') +
          '</div>' +
          '<span class="font-medium text-gray-800 flex-shrink-0 mr-3">$' + itemTotal.toFixed(2) +
            (recurLabel ? '<span class="text-xs text-[#d97706] font-medium ml-0.5">' + recurLabel + '</span>' : '') +
          '</span>' +
          '<button type="button" data-remove-idx="' + index + '" class="breakdown-remove flex-shrink-0 text-gray-300 hover:text-gray-500 transition ml-1" title="Remove">' +
            '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
          '</button>' +
        '</div>';
      });
      breakdownDiv.innerHTML = html || '<p class="text-sm text-gray-500">No items in cart</p>';

      // Attach remove handlers
      breakdownDiv.querySelectorAll('.breakdown-remove').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var idx = parseInt(this.getAttribute('data-remove-idx'));
          if (isNaN(idx)) return;
          window.donationCart.items.splice(idx, 1);
          saveCart();
          try { updateCartUI(); } catch(e) {}
          try { updateModalTotal(); } catch(e) {}
          renderBreakdown();
          // If cart is empty, close the checkout
          if (window.donationCart.items.length === 0) {
            closeCheckoutModal();
          }
        });
      });
    }

    if (toggleBtn && breakdownDiv && !toggleBtn._listenerAttached) {
      toggleBtn._listenerAttached = true;
      toggleBtn.addEventListener('click', function() {
        var bd = document.getElementById('donation-breakdown');
        var ba = document.getElementById('breakdown-arrow');
        if (!bd) return;
        var isHidden = bd.classList.contains('hidden');
        bd.classList.toggle('hidden');
        if (ba) ba.style.transform = isHidden ? 'rotate(180deg)' : '';
        if (!isHidden) return;
        renderBreakdown();
      });
    }

    // Two-step mode: Mount payment element IMMEDIATELY  no waiting for email
    mountPaymentElement();
  } else {
    // Three-step mode: show step 1, hide step 2
    if (step1) step1.classList.remove('hidden');
    if (step2) step2.classList.add('hidden');
  }

  // Pre-check first upsell (opt-out strategy for higher conversions)
  var upsell1 = document.getElementById('upsell-checkbox-1');
  var upsell2 = document.getElementById('upsell-checkbox-2');
  if (upsell1) upsell1.checked = false;
  if (upsell2) upsell2.checked = false;

  // Update upsell card styling
  try { updateUpsellCardStyles(); } catch(e) {}

  // Initialize Google Places autocomplete after modal is visible
  setTimeout(function() {
    if (!window.donationCart.autocomplete && window.google?.maps?.places) {
      window.initPlacesAutocomplete();
    }
  }, 100);

  // Update cart display with upsell included
  try { updateModalCart(); } catch(e) {}
}

// Update upsell card visual styles based on checked state
function updateUpsellCardStyles() {
  const checkbox1 = document.getElementById('upsell-checkbox-1');
  const checkbox2 = document.getElementById('upsell-checkbox-2');
  if (!checkbox1 || !checkbox2) return;
  const card1 = checkbox1.closest('.upsell-card');
  const card2 = checkbox2.closest('.upsell-card');

  if (card1) {
    if (checkbox1.checked) {
      card1.classList.remove('border-gray-200', 'bg-white');
      card1.classList.add('border-[#d97706]', 'bg-orange-50');
    } else {
      card1.classList.remove('border-[#d97706]', 'bg-orange-50');
      card1.classList.add('border-gray-200', 'bg-white');
    }
  }

  if (card2) {
    if (checkbox2.checked) {
      card2.classList.remove('border-gray-200', 'bg-white');
      card2.classList.add('border-[#d97706]', 'bg-orange-50');
    } else {
      card2.classList.remove('border-[#d97706]', 'bg-orange-50');
      card2.classList.add('border-gray-200', 'bg-white');
    }
  }
}

function closeCheckoutModal() {
  var modal = document.getElementById('checkout-modal');
  if (modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
  // Sync side cart with current cart state (items may have been removed during checkout)
  try { updateCartUI(); } catch(e) {}
}

function updateModalCart() {
  const items = window.donationCart.items;
  const container = document.getElementById('modal-cart-items');

  container.innerHTML = items.map(item => {
    const itemType = item.recurringInterval || item.type || 'single';
    const typeLabel = itemType === 'weekly' ? 'Every Jummah' : itemType === 'monthly' ? 'Monthly' : itemType === 'yearly' ? 'Yearly' : itemType === 'daily' ? 'Daily' : 'One-time';
    const hasNotes = item.metadata?.notes && item.metadata.notes.trim() !== '';
    const notesHtml = hasNotes ? `<p class="text-xs text-gray-500 italic"> ${item.metadata.notes}</p>` : '';
    return `
    <div class="flex justify-between items-center py-2 border-b border-gray-100">
      <div>
        <p class="font-medium text-gray-800 text-sm">${item.name}</p>
        <p class="text-xs text-gray-500">${typeLabel}  ${item.quantity}</p>
        ${notesHtml}
      </div>
      <p class="font-semibold text-gray-800">$${(item.amount * item.quantity).toFixed(2)}</p>
    </div>
  `}).join('');

  updateModalTotal();
}

function updateModalTotal() {
  // Upsells are now added directly to cart, so no need to add them separately
  let baseTotal = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
  const hasWeekly = window.donationCart.items.some(i => i.type === 'weekly' || i.recurringInterval === 'weekly');
  const hasMonthly = window.donationCart.items.some(i => i.type === 'monthly' || i.recurringInterval === 'monthly');
  const hasYearly = window.donationCart.items.some(i => i.type === 'yearly' || i.recurringInterval === 'yearly');
  const hasDaily = window.donationCart.items.some(i => i.type === 'daily' || i.recurringInterval === 'daily');
  const hasRecurring = hasWeekly || hasMonthly || hasYearly || hasDaily;

  // Calculate fees (3% processing fee)
  const feePercentage = 0.03;
  const feeAmount = baseTotal * feePercentage;
  const coverFees = document.getElementById('cover-fees-checkbox').checked;
  const total = coverFees ? baseTotal + feeAmount : baseTotal;

  // Update fee display
  document.getElementById('fee-amount-display').textContent = '$' + feeAmount.toFixed(2);

  // Store fee state for payment
  window.donationCart.coverFees = coverFees;
  window.donationCart.feeAmount = feeAmount;
  window.donationCart.baseTotal = baseTotal;

  document.getElementById('modal-subtotal').textContent = '$' + total.toFixed(2);
  const modalTotal = document.getElementById('modal-total');
  if (modalTotal) modalTotal.textContent = '$' + total.toFixed(2);

  const paymentTotalEl = document.getElementById('payment-total');
  if (paymentTotalEl) paymentTotalEl.textContent = '$' + total.toFixed(2);

  // Update step 2 total display
  const step2Total = document.getElementById('step2-total');
  if (step2Total) step2Total.innerHTML = '$' + total.toFixed(2);

  // Determine payment type label
  let paymentTypeLabel = 'One-time donation';
  if (hasWeekly && !hasMonthly && !hasYearly && !hasDaily) {
    paymentTypeLabel = coverFees ? 'Every Jummah + fees covered' : 'Every Jummah (Friday)';
  } else if (hasMonthly && !hasWeekly && !hasYearly && !hasDaily) {
    paymentTypeLabel = coverFees ? 'Monthly + fees covered' : 'Monthly donation';
  } else if (hasYearly && !hasWeekly && !hasMonthly && !hasDaily) {
    paymentTypeLabel = coverFees ? 'Yearly + fees covered' : 'Yearly donation';
  } else if (hasDaily && !hasWeekly && !hasMonthly && !hasYearly) {
    paymentTypeLabel = coverFees ? 'Daily + fees covered' : 'Daily donation';
  } else if (hasRecurring) {
    paymentTypeLabel = coverFees ? 'Recurring + fees covered' : 'Includes recurring';
  } else if (coverFees) {
    paymentTypeLabel = 'One-time + fees covered';
  }
  const paymentTypeEl = document.getElementById('modal-payment-type');
  if (paymentTypeEl) paymentTypeEl.textContent = paymentTypeLabel;
}

function goToPaymentStep() {
  // Validate
  const firstName = document.getElementById('modal-firstName').value.trim();
  const lastName = document.getElementById('modal-lastName').value.trim();
  const email = document.getElementById('modal-email').value.trim();

  if (!firstName) { document.getElementById('modal-firstName').focus(); return; }
  if (!lastName) { document.getElementById('modal-lastName').focus(); return; }
  if (!email) { document.getElementById('modal-email').focus(); return; }

  document.getElementById('modal-step-1').classList.add('hidden');
  document.getElementById('modal-step-2').classList.remove('hidden');
  mountPaymentElement();

  // Track add_payment_info in GA4
  if (window.trackAddPaymentInfo) {
    const total = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    window.trackAddPaymentInfo(window.donationCart.items, total, 'credit_card');
  }

  // Update fee display for step 2
  updateModalTotal();

  // Initialize Google Places autocomplete if not already done
  if (!window.donationCart.autocomplete && window.google?.maps?.places) {
    window.initPlacesAutocomplete();
  }
}

function goToInfoStep() {
  document.getElementById('modal-step-2').classList.add('hidden');
  document.getElementById('modal-step-1').classList.remove('hidden');
}

// Handle Payment  Two distinct flows:
//
// ONE-TIME:
//   1. elements.submit()  validate payment method
//   2. POST /api/payments/create-intent  create PaymentIntent NOW
//   3. stripe.confirmPayment()  charge the card
//
// RECURRING (SetupIntent  Subscription):
//   1. stripe.confirmSetup()  confirm the SetupIntent (saves payment method)
//   2. POST /api/payments/create-subscription  create Subscription with saved PM
//   3. Subscription charges immediately with the saved payment method
//
async function handlePayment() {
  const payBtn = document.getElementById('pay-btn');
  const payText = document.getElementById('pay-btn-text');
  const processing = document.getElementById('processing-indicator');
  const errorDiv = document.getElementById('payment-error');

  // Prevent double-click while processing
  if (payBtn.disabled) return;

  payBtn.disabled = true;
  payText.textContent = 'Processing...';
  processing.classList.remove('hidden');
  errorDiv.classList.add('hidden');

  try {
    // CRITICAL: Sync ts-info fields to modal fields before payment (catch any missed input events)
    ['firstName', 'lastName', 'email', 'phone'].forEach(function(f) {
      var ts = document.getElementById('ts-info-' + f);
      var modal = document.getElementById('modal-' + f);
      if (ts && modal) modal.value = ts.value.trim();
    });

    // Validate required customer fields
    var firstName = (document.getElementById('modal-firstName')?.value || '').trim();
    var lastName = (document.getElementById('modal-lastName')?.value || '').trim();
    var email = (document.getElementById('modal-email')?.value || '').trim();

    if (!firstName || !lastName) {
      throw new Error('Please enter your first and last name.');
    }
    if (!email || email.indexOf('@') < 1) {
      throw new Error('Please enter a valid email address.');
    }

    // Validate billing address
    var billingLine1 = (document.getElementById('modal-address')?.value || '').trim();
    var billingCity = (document.getElementById('modal-city')?.value || '').trim();
    var billingState = (document.getElementById('modal-state')?.value || '').trim();
    var billingZip = (document.getElementById('modal-zip')?.value || '').trim();
    if (!billingLine1 || !billingCity || !billingState || !billingZip) {
      throw new Error('Please fill in your billing address.');
    }

    // Ensure Payment Element is mounted
    if (!window.donationCart.stripeElements) {
      throw new Error('Payment form not loaded. Please refresh and try again.');
    }

    const customer = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      phone: (document.getElementById('modal-phone')?.value || '').trim(),
    };

    const billingAddress = {
      line1: billingLine1,
      city: billingCity,
      state: billingState,
      postal_code: billingZip,
      country: (document.getElementById('modal-country')?.value || 'US').trim(),
    };

    let items = [...window.donationCart.items];
    let total = items.reduce(function(sum, item) { return sum + (item.amount * item.quantity); }, 0);
    const coverFees = window.donationCart.coverFees || false;
    const feeAmount = coverFees ? (total * 0.03) : 0;
    total = total + feeAmount;

    var donationType = window.donationCart.pendingDonationType || 'single';
    var isRecurring = (donationType === 'monthly' || donationType === 'weekly' || donationType === 'yearly' || donationType === 'daily');

    if (isRecurring) {
      // 
      // RECURRING FLOW (fully deferred):
      //   1. elements.submit()  validate card
      //   2. create-setup-intent  create SetupIntent + Customer
      //   3. confirmSetup()  save the payment method
      //   4. create-subscription  create real Subscription with saved PM
      // 

      // STEP 1: Validate payment method (elements.submit)
      var submitResult = await window.donationCart.stripeElements.submit();
      if (submitResult.error) {
        throw new Error(submitResult.error.message);
      }

      // STEP 2: Create SetupIntent + Customer on server
      payText.textContent = 'Securing payment...';

      var setupRes = await fetch('/api/payments/create-setup-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customer: customer, billingAddress: billingAddress }),
      });

      var setupData = await setupRes.json();
      if (!setupRes.ok) {
        throw new Error(setupData.error || 'Failed to initialize payment. Please try again.');
      }

      // STEP 3: Confirm the SetupIntent  saves the payment method
      var setupResult2 = await window.donationCart.stripe.confirmSetup({
        elements: window.donationCart.stripeElements,
        clientSecret: setupData.clientSecret,
        confirmParams: {
          return_url: window.location.origin + '/donate/success',
          payment_method_data: {
            billing_details: {
              name: customer.firstName + ' ' + customer.lastName,
              email: customer.email,
              phone: customer.phone,
              address: billingAddress,
            },
          },
        },
        redirect: 'if_required',
      });

      if (setupResult2.error) {
        throw new Error(setupResult2.error.message);
      }

      var setupIntent = setupResult2.setupIntent;
      if (!setupIntent || !setupIntent.payment_method) {
        throw new Error('Payment setup failed. Please try again.');
      }

      // STEP 4: Create the REAL subscription with the saved payment method
      payText.textContent = 'Creating subscription...';

      var subResponse = await fetch('/api/payments/create-subscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paymentMethodId: setupIntent.payment_method,
          customerId: setupData.customerId,
          amount: total,
          items: items,
          customer: customer,
          billingAddress: billingAddress,
          interval: donationType,
          coverFees: coverFees,
          feeAmount: feeAmount,
          baseAmount: total - feeAmount,
        }),
      });

      var subData = await subResponse.json();
      if (!subResponse.ok) {
        throw new Error(subData.error || 'Failed to create subscription. Please try again.');
      }

      // Store for success page
      var successData = {
        transaction_id: subData.paymentIntentId || setupIntent.id,
        donation_id: subData.donationId || '',
        total: total,
        items: items.map(function(item) {
          return {
            id: item.id || item.slug,
            name: item.name || item.campaign || 'Donation',
            category: item.campaign || 'donation',
            amount: item.amount,
            quantity: item.quantity || 1
          };
        }),
        cover_fees: coverFees && feeAmount > 0,
        fee_amount: feeAmount,
        is_subscription: true,
        subscription_id: subData.subscriptionId || '',
        is_jummah: subData.isJummah || donationType === 'weekly',
        interval: subData.interval || donationType,
        next_billing_date: subData.nextBillingDate || '',
        donor_email: customer.email,
        timestamp: Date.now()
      };
      sessionStorage.setItem('qurbani_purchase', JSON.stringify(successData));

      // Clear cart and redirect
      window.donationCart.items = [];
      localStorage.removeItem('donationCart');
      window.location.href = '/donate/success?donation_id=' + (subData.donationId || '') + '&subscription_id=' + (subData.subscriptionId || '');

    } else {
      // 
      // ONE-TIME FLOW: elements.submit  create-intent  confirmPayment
      // 

      // STEP 1: Validate payment method with Stripe
      var submitResult = await window.donationCart.stripeElements.submit();
      if (submitResult.error) {
        throw new Error(submitResult.error.message);
      }

      // STEP 2: Create the PaymentIntent NOW (not earlier)
      var response = await fetch('/api/payments/create-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: total,
          items: items,
          customer: customer,
          billingAddress: billingAddress,
          type: 'single',
          coverFees: coverFees,
          feeAmount: feeAmount,
          baseAmount: total - feeAmount,
        }),
      });

      var data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Failed to create payment. Please try again.');
      }

      window.donationCart.pendingPayment = data;

      // STEP 3: Confirm the payment
      const result = await window.donationCart.stripe.confirmPayment({
        elements: window.donationCart.stripeElements,
        clientSecret: data.clientSecret,
        confirmParams: {
          return_url: window.location.origin + '/donate/success?donation_id=' + (data.donationId || '') + '&type=single',
          payment_method_data: {
            billing_details: {
              name: customer.firstName + ' ' + customer.lastName,
              email: customer.email,
              phone: customer.phone,
              address: billingAddress,
            },
          },
        },
        redirect: 'if_required',
      });

      if (result.error) throw new Error(result.error.message);

      const paymentIntent = result.paymentIntent;
      if (!paymentIntent) throw new Error('Payment confirmation failed. Please try again.');

      if (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_capture') {
        var successData = {
          transaction_id: paymentIntent.id,
          donation_id: data.donationId || '',
          total: total,
          items: items.map(function(item) {
            return {
              id: item.id || item.slug,
              name: item.name || item.campaign || 'Donation',
              category: item.campaign || 'donation',
              amount: item.amount,
              quantity: item.quantity || 1
            };
          }),
          cover_fees: coverFees && feeAmount > 0,
          fee_amount: feeAmount,
          is_subscription: false,
          subscription_id: '',
          is_jummah: false,
          interval: '',
          next_billing_date: '',
          donor_email: customer.email,
          timestamp: Date.now()
        };
        sessionStorage.setItem('qurbani_purchase', JSON.stringify(successData));

        // Clear cart and redirect
        window.donationCart.items = [];
        localStorage.removeItem('donationCart');
        window.location.href = '/donate/success?payment_intent=' + paymentIntent.id + '&donation_id=' + (data.donationId || '');
      }
    }

  } catch (err) {
    errorDiv.classList.remove('hidden');
    document.getElementById('payment-error-text').textContent = err.message;
  } finally {
    payBtn.disabled = false;
    payText.textContent = 'Complete Donation';
    processing.classList.add('hidden');
  }
}

// ==================== TWO-STEP CHECKOUT LOGIC ====================

function openTwoStepCheckout() {
  // Close side cart if open
  if (window.donationCart.isOpen) {
    closeCart();
  }
  var modal = document.getElementById('two-step-checkout');
  if (!modal) return;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  // Track begin_checkout in GA4
  if (window.trackBeginCheckout) {
    var total = window.donationCart.items.reduce(function(sum, item) { return sum + (item.amount * item.quantity); }, 0);
    window.trackBeginCheckout(window.donationCart.items, total);
  }

  updateTwoStepCart();

  // Init Google Places for the 2-step address field
  setTimeout(function() {
    initTwoStepPlaces();
  }, 200);
}

function closeTwoStepCheckout() {
  var modal = document.getElementById('two-step-checkout');
  if (modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
}

// Close button handler
document.getElementById('close-two-step')?.addEventListener('click', closeTwoStepCheckout);

// Mobile cart accordion toggle
document.getElementById('ts-cart-toggle')?.addEventListener('click', function() {
  var body = document.getElementById('ts-cart-mobile-body');
  var chevron = document.getElementById('ts-cart-chevron');
  if (body) {
    body.classList.toggle('hidden');
    if (chevron) chevron.classList.toggle('rotate-180');
  }
});

// Upsell checkbox handlers
document.getElementById('ts-upsell-prophetic')?.addEventListener('change', function() {
  var upsellItem = { id: 'prophetic-qurbani', name: 'Prophetic Qurbani', amount: 50, type: 'single', quantity: 1, isUpsell: true };
  if (this.checked) {
    window.donationCart.items.push(Object.assign({}, upsellItem, { originalType: 'single' }));
  } else {
    window.donationCart.items = window.donationCart.items.filter(function(i) { return i.id !== 'prophetic-qurbani'; });
  }
  saveCart();
  updateCartUI();
  updateTwoStepCart();
});

document.getElementById('ts-upsell-feed')?.addEventListener('change', function() {
  var upsellItem = { id: 'feed-family', name: 'Feed a Family', amount: 25, type: 'single', quantity: 1, isUpsell: true };
  if (this.checked) {
    window.donationCart.items.push(Object.assign({}, upsellItem, { originalType: 'single' }));
  } else {
    window.donationCart.items = window.donationCart.items.filter(function(i) { return i.id !== 'feed-family'; });
  }
  saveCart();
  updateCartUI();
  updateTwoStepCart();
});

// Recurring radio handlers
document.querySelectorAll('input[name="ts-recurring"]').forEach(function(radio) {
  radio.addEventListener('change', function() {
    var type = this.value;
    window.donationCart.items.forEach(function(item) {
      if (item.originalType === 'single' || !item.originalType) {
        item.type = type;
        item.recurringInterval = type;
      }
    });
    saveCart();
    updateCartUI();
    updateTwoStepCart();
    document.getElementById('ts-clear-recurring')?.classList.remove('hidden');
  });
});

document.getElementById('ts-clear-recurring')?.addEventListener('click', function() {
  document.querySelectorAll('input[name="ts-recurring"]').forEach(function(r) { r.checked = false; });
  window.donationCart.items.forEach(function(item) {
    if (item.originalType === 'single' || !item.originalType) {
      item.type = 'single';
      item.recurringInterval = 'single';
    }
  });
  saveCart();
  updateCartUI();
  updateTwoStepCart();
  this.classList.add('hidden');
});

// Cover fees checkbox
document.getElementById('ts-cover-fees')?.addEventListener('change', function() {
  window.donationCart.coverFees = this.checked;
  updateTwoStepTotals();
});

// Update the two-step cart display
function updateTwoStepCart() {
  var items = window.donationCart.items;

  // Desktop sidebar items
  var cartContainer = document.getElementById('ts-cart-items');
  var emptyCart = document.getElementById('ts-empty-cart');
  var mobileItems = document.getElementById('ts-cart-mobile-items');
  var recurringSection = document.getElementById('ts-recurring-section');
  var countBadge = document.getElementById('ts-cart-count-badge');
  var totalBadge = document.getElementById('ts-cart-total-badge');

  if (items.length === 0) {
    if (cartContainer) cartContainer.innerHTML = '';
    if (emptyCart) emptyCart.classList.remove('hidden');
    if (mobileItems) mobileItems.innerHTML = '<p class="text-sm text-gray-400">No items in cart</p>';
    if (recurringSection) recurringSection.classList.add('hidden');
  } else {
    if (emptyCart) emptyCart.classList.add('hidden');

    // Show recurring if there are convertible items
    var hasConvertible = items.some(function(i) { return i.originalType === 'single' || !i.originalType; });
    if (recurringSection) recurringSection.classList.toggle('hidden', !hasConvertible);

    var itemsHtml = items.filter(function(i) { return !i.isUpsell; }).map(function(item, index) {
      var itemType = item.recurringInterval || item.type || 'single';
      var typeLabel = itemType === 'weekly' ? 'Jummah' : itemType === 'monthly' ? 'Monthly' : itemType === 'yearly' ? 'Yearly' : itemType === 'daily' ? 'Daily' : '';
      var typeBadge = typeLabel ? '<span class="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-bold rounded">' + typeLabel + '</span>' : '';

      return '<div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">' +
        '<div class="flex-1 min-w-0">' +
          '<p class="text-sm font-medium text-gray-800 truncate">' + item.name + typeBadge + '</p>' +
        '</div>' +
        '<div class="flex items-center gap-2 ml-3">' +
          '<button onclick="tsTwoStepUpdateQty(' + index + ', -1)" class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center text-gray-500 hover:bg-gray-200 text-xs"></button>' +
          '<span class="w-5 text-center text-sm">' + item.quantity + '</span>' +
          '<button onclick="tsTwoStepUpdateQty(' + index + ', 1)" class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center text-gray-500 hover:bg-gray-200 text-xs">+</button>' +
          '<span class="font-semibold text-gray-800 text-sm w-14 text-right">$' + (item.amount * item.quantity).toFixed(2) + '</span>' +
          '<button onclick="tsTwoStepRemove(' + index + ')" class="text-gray-300 hover:text-red-400 transition ml-1">' +
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
          '</button>' +
        '</div>' +
      '</div>';
    }).join('');

    if (cartContainer) cartContainer.innerHTML = itemsHtml;
    if (mobileItems) mobileItems.innerHTML = itemsHtml;
  }

  // Update count badge
  var count = items.reduce(function(sum, i) { return sum + i.quantity; }, 0);
  if (countBadge) countBadge.textContent = count;

  // Sync upsell checkboxes
  var hasProphetic = items.some(function(i) { return i.id === 'prophetic-qurbani'; });
  var hasFeed = items.some(function(i) { return i.id === 'feed-family'; });
  var propheticCb = document.getElementById('ts-upsell-prophetic');
  var feedCb = document.getElementById('ts-upsell-feed');
  if (propheticCb) propheticCb.checked = hasProphetic;
  if (feedCb) feedCb.checked = hasFeed;

  updateTwoStepTotals();
}

function updateTwoStepTotals() {
  var items = window.donationCart.items;
  var subtotal = items.reduce(function(sum, i) { return sum + (i.amount * i.quantity); }, 0);
  var coverFees = window.donationCart.coverFees || false;
  var feeAmount = coverFees ? Math.round(subtotal * 0.03 * 100) / 100 : 0;
  var total = subtotal + feeAmount;

  document.getElementById('ts-subtotal').textContent = '$' + subtotal.toFixed(2);
  document.getElementById('ts-total').textContent = '$' + total.toFixed(2);
  document.getElementById('ts-cart-total-badge').textContent = '$' + total.toFixed(2);

  var feeRow = document.getElementById('ts-fee-row');
  if (feeRow) {
    feeRow.classList.toggle('hidden', !coverFees);
    document.getElementById('ts-fee-amount').textContent = '$' + feeAmount.toFixed(2);
  }

  var feeDesc = document.getElementById('ts-fee-description');
  if (feeDesc) {
    feeDesc.textContent = 'Add $' + (subtotal * 0.03).toFixed(2) + ' so 100% of your donation reaches those in need';
  }

  // Enable/disable pay button
  var payBtn = document.getElementById('ts-pay-btn');
  if (payBtn) payBtn.disabled = items.length === 0;
}

// Global functions for inline onclick handlers
window.tsTwoStepUpdateQty = function(index, delta) {
  var item = window.donationCart.items[index];
  if (item) {
    item.quantity = Math.max(1, item.quantity + delta);
    saveCart();
    updateCartUI();
    updateTwoStepCart();
  }
};

window.tsTwoStepRemove = function(index) {
  window.donationCart.items.splice(index, 1);
  saveCart();
  updateCartUI();
  updateTwoStepCart();
  // Close checkout if cart is empty
  if (window.donationCart.items.length === 0) {
    closeTwoStepCheckout();
  }
};

// Two-step Stripe mount
var twoStepStripeElements = null;
var twoStepPendingPayment = null;

async function mountTwoStepPaymentElement() {
  var container = document.getElementById('ts-card-element');
  if (!container || !window.donationCart.stripe) return;

  var items = window.donationCart.items.slice();
  var total = items.reduce(function(sum, item) { return sum + (item.amount * item.quantity); }, 0);
  var hasWeekly = items.some(function(i) { return i.type === 'weekly' || i.recurringInterval === 'weekly'; });
  var hasMonthly = items.some(function(i) { return i.type === 'monthly' || i.recurringInterval === 'monthly'; });
  var hasYearly = items.some(function(i) { return i.type === 'yearly' || i.recurringInterval === 'yearly'; });
  var hasDaily = items.some(function(i) { return i.type === 'daily' || i.recurringInterval === 'daily'; });
  var donationType = hasWeekly ? 'weekly' : (hasMonthly ? 'monthly' : (hasYearly ? 'yearly' : (hasDaily ? 'daily' : 'single')));
  var coverFees = window.donationCart.coverFees || false;
  var feeAmount = coverFees ? Math.round(total * 0.03 * 100) / 100 : 0;
  total = total + feeAmount;

  var customer = {
    firstName: document.getElementById('ts-firstName').value,
    lastName: document.getElementById('ts-lastName').value,
    email: document.getElementById('ts-email').value,
    phone: document.getElementById('ts-phone').value,
  };

  var billingAddress = {
    line1: document.getElementById('ts-address').value || '',
    city: document.getElementById('ts-city').value || '',
    state: document.getElementById('ts-state').value || '',
    postal_code: document.getElementById('ts-zip').value || '',
    country: document.getElementById('ts-country').value || 'US',
  };

  try {
    var response = await fetch('/api/payments/create-intent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount: total,
        items: items,
        customer: customer,
        billingAddress: billingAddress,
        type: donationType,
        coverFees: coverFees,
        feeAmount: feeAmount,
        baseAmount: total - feeAmount,
      }),
    });

    var data = await response.json();
    if (!response.ok) {
      document.getElementById('ts-card-errors').textContent = data.error || 'Failed to initialize payment';
      return;
    }

    twoStepPendingPayment = data;

    // Unmount previous if any
    if (twoStepStripeElements) {
      container.innerHTML = '';
    }

    var elements = window.donationCart.stripe.elements({
      clientSecret: data.clientSecret,
      appearance: {
        theme: 'stripe',
        variables: {
          colorPrimary: '#01534d',
          fontFamily: 'system-ui, sans-serif',
          borderRadius: '12px',
        },
      },
    });
    twoStepStripeElements = elements;

    var paymentElement = elements.create('payment', { layout: 'tabs' });
    paymentElement.mount('#ts-card-element');

    paymentElement.on('change', function(event) {
      document.getElementById('ts-card-errors').textContent = event.error ? event.error.message : '';
    });
  } catch (err) {
    document.getElementById('ts-card-errors').textContent = 'Failed to load payment form. Please try again.';
    console.error('2-step Payment Element mount error:', err);
  }
}

// Two-step payment handler
document.getElementById('ts-pay-btn')?.addEventListener('click', async function() {
  var payBtn = this;
  var payText = document.getElementById('ts-pay-btn-text');
  var spinner = document.getElementById('ts-pay-btn-spinner');
  var errorDiv = document.getElementById('ts-payment-error');

  // Validate required fields
  var firstName = document.getElementById('ts-firstName').value.trim();
  var lastName = document.getElementById('ts-lastName').value.trim();
  var email = document.getElementById('ts-email').value.trim();
  var address = document.getElementById('ts-address').value.trim();
  var city = document.getElementById('ts-city').value.trim();
  var state = document.getElementById('ts-state').value.trim();
  var zip = document.getElementById('ts-zip').value.trim();

  if (!firstName) { document.getElementById('ts-firstName').focus(); return; }
  if (!lastName) { document.getElementById('ts-lastName').focus(); return; }
  if (!email) { document.getElementById('ts-email').focus(); return; }
  if (!address) { document.getElementById('ts-address').focus(); return; }
  if (!city) { document.getElementById('ts-city').focus(); return; }
  if (!state) { document.getElementById('ts-state').focus(); return; }
  if (!zip) { document.getElementById('ts-zip').focus(); return; }

  if (payBtn.disabled && payText.classList.contains('hidden')) return; // Already processing
  payBtn.disabled = true;
  payText.classList.add('hidden');
  spinner.classList.remove('hidden');
  errorDiv.classList.add('hidden');

  try {
    // If stripe elements not yet mounted, mount now
    if (!twoStepStripeElements || !twoStepPendingPayment) {
      await mountTwoStepPaymentElement();
    }

    if (!twoStepPendingPayment || !twoStepPendingPayment.clientSecret) {
      throw new Error('Payment session expired. Please try again.');
    }

    if (!twoStepStripeElements) {
      throw new Error('Payment form not loaded. Please refresh and try again.');
    }

    var customer = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      phone: document.getElementById('ts-phone').value,
    };

    var billingAddress = {
      line1: address,
      city: city,
      state: state,
      postal_code: zip,
      country: document.getElementById('ts-country').value,
    };

    var items = window.donationCart.items.slice();
    var total = items.reduce(function(sum, item) { return sum + (item.amount * item.quantity); }, 0);
    var coverFees = window.donationCart.coverFees || false;
    var feeAmount = coverFees ? Math.round(total * 0.03 * 100) / 100 : 0;
    total = total + feeAmount;

    var data = twoStepPendingPayment;

    var result = await window.donationCart.stripe.confirmPayment({
      elements: twoStepStripeElements,
      confirmParams: {
        return_url: window.location.origin + '/donate/success?donation_id=' + (data.donationId || '') + '&type=' + (data.type || 'single'),
        payment_method_data: {
          billing_details: {
            name: customer.firstName + ' ' + customer.lastName,
            email: customer.email,
            phone: customer.phone,
            address: billingAddress,
          },
        },
      },
      redirect: 'if_required',
    });

    if (result.error) throw new Error(result.error.message);

    var paymentIntent = result.paymentIntent;
    if (!paymentIntent) throw new Error('Payment confirmation failed. Please try again.');

    if (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_capture') {
      var successData = {
        transaction_id: paymentIntent.id,
        donation_id: data.donationId || '',
        total: total,
        items: items.map(function(item) {
          return {
            id: item.id || item.slug,
            name: item.name || item.campaign || 'Donation',
            category: item.campaign || 'donation',
            amount: item.amount,
            quantity: item.quantity || 1
          };
        }),
        cover_fees: coverFees && feeAmount > 0,
        fee_amount: feeAmount,
        is_subscription: data.type === 'subscription' && !!data.subscriptionId,
        subscription_id: data.subscriptionId || '',
        is_jummah: data.isJummah || data.interval === 'weekly',
        interval: data.interval || '',
        next_billing_date: data.nextBillingDate || '',
        donor_email: customer.email,
        timestamp: Date.now()
      };
      sessionStorage.setItem('qurbani_purchase', JSON.stringify(successData));

      window.donationCart.items = [];
      localStorage.removeItem('donationCart');

      window.location.href = '/donate/success?payment_intent=' + paymentIntent.id + '&donation_id=' + (data.donationId || '');
    }
  } catch (err) {
    errorDiv.classList.remove('hidden');
    errorDiv.textContent = err.message;
  } finally {
    payBtn.disabled = false;
    payText.classList.remove('hidden');
    spinner.classList.add('hidden');
  }
});

// Google Places for two-step checkout
function initTwoStepPlaces() {
  var addressInput = document.getElementById('ts-address');
  if (!addressInput || !window.google?.maps?.places) return;
  if (addressInput._placesInit) return;
  addressInput._placesInit = true;

  var autocomplete = new window.google.maps.places.Autocomplete(addressInput, {
    types: ['address'],
    componentRestrictions: { country: ['us', 'ca', 'gb', 'au'] },
  });

  autocomplete.addListener('place_changed', function() {
    var place = autocomplete.getPlace();
    if (!place.address_components) return;

    var streetNumber = '';
    var route = '';

    place.address_components.forEach(function(component) {
      var types = component.types;
      if (types.includes('street_number')) streetNumber = component.long_name;
      if (types.includes('route')) route = component.long_name;
      if (types.includes('locality')) document.getElementById('ts-city').value = component.long_name;
      if (types.includes('administrative_area_level_1')) document.getElementById('ts-state').value = component.short_name;
      if (types.includes('postal_code')) document.getElementById('ts-zip').value = component.long_name;
      if (types.includes('country')) {
        var countrySelect = document.getElementById('ts-country');
        for (var i = 0; i < countrySelect.options.length; i++) {
          if (countrySelect.options[i].value === component.short_name) {
            countrySelect.selectedIndex = i;
            break;
          }
        }
      }
    });

    addressInput.value = (streetNumber + ' ' + route).trim();
  });
}

// Fetch management link for subscription
async function fetchManagementLink(email, donationId) {
  try {
    const response = await fetch(`/api/subscriptions/manage?email=${encodeURIComponent(email)}`);
    if (response.ok) {
      const data = await response.json();
      if (data.subscriptions && data.subscriptions.length > 0) {
        const subscription = data.subscriptions[0];
        const managementUrl = `/manage-subscription/${subscription.id}_${subscription.management_token}`;
        document.getElementById('manage-subscription-link').href = managementUrl;
      }
    }
  } catch (e) {
    console.error('Error fetching management link:', e);
  }
}
</script>
