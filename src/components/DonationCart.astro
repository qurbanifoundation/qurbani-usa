---
// Donation Cart Sidebar + Full-Screen Checkout Modal
import { supabaseAdmin } from '../lib/supabase';

// Google Places API key
const googlePlacesApiKey = import.meta.env.PUBLIC_GOOGLE_PLACES_API_KEY || '';

// Fetch payment settings
let paymentSettings = {
  stripe_enabled: true,
  stripe_publishable_key: '',
  google_pay_enabled: true,
  apple_pay_enabled: true,
  paypal_enabled: false,
};

try {
  const { data } = await supabaseAdmin
    .from('site_settings')
    .select('stripe_enabled, stripe_publishable_key, google_pay_enabled, apple_pay_enabled, paypal_enabled')
    .single();

  if (data) {
    paymentSettings = {
      stripe_enabled: data.stripe_enabled ?? true,
      stripe_publishable_key: data.stripe_publishable_key || '',
      google_pay_enabled: data.google_pay_enabled ?? true,
      apple_pay_enabled: data.apple_pay_enabled ?? true,
      paypal_enabled: data.paypal_enabled ?? false,
    };
  }
} catch (e) {}
---

<!-- Stripe.js -->
<script is:inline src="https://js.stripe.com/v3/"></script>

<!-- Caveat font for handwritten style -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500&display=swap" rel="stylesheet">

<!-- Google Places Autocomplete Dropdown Fix -->
<style is:global>
  .pac-container {
    z-index: 10000 !important;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    margin-top: 4px;
  }
  .pac-item {
    padding: 10px 12px;
    cursor: pointer;
  }
  .pac-item:hover {
    background-color: #f3f4f6;
  }
  .pac-item-query {
    font-size: 14px;
    color: #111827;
  }
  .pac-matched {
    font-weight: 600;
  }

  /* Highlight checked recurring option */
  .recurring-option:has(input:checked) {
    background-color: #fef3c7 !important;
    border-color: #d97706 !important;
  }

  /* Custom checkbox - grey style for Keep in Touch */
  .custom-checkbox {
    position: relative;
    display: inline-block;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }
  .custom-checkbox input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 1;
  }
  .custom-checkbox .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    background-color: white;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    transition: all 0.15s ease;
  }
  .custom-checkbox input:checked + .checkmark {
    background-color: white;
    border-color: #9ca3af;
  }
  .custom-checkbox .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid #9ca3af;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
  }
  .custom-checkbox input:checked + .checkmark:after {
    display: block;
  }

  /* Orange checkbox style for Please Support Us Further */
  .custom-checkbox-orange .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    background-color: white;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    transition: all 0.15s ease;
  }
  .custom-checkbox-orange input:checked + .checkmark {
    background-color: white;
    border-color: #d97706;
  }
  .custom-checkbox-orange .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid #d97706;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
  }
  .custom-checkbox-orange input:checked + .checkmark:after {
    display: block;
  }
</style>

<!-- ==================== CART REMINDER POPUP ==================== -->
<div id="cart-reminder" class="fixed bottom-6 left-6 bg-white rounded-xl shadow-2xl border border-gray-200 p-4 z-[99] hidden max-w-xs transform transition-all duration-300 translate-y-4 opacity-0">
  <button id="close-cart-reminder" class="absolute top-2 right-2 p-1 text-gray-400 hover:text-gray-600 transition" aria-label="Close reminder">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>
  <div class="flex items-start gap-3">
    <div class="flex-shrink-0">
      <svg class="w-10 h-10 text-[#d97706]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
      </svg>
    </div>
    <div class="flex-1 pr-4">
      <h4 class="font-bold text-gray-800 text-sm" style="font-family: 'Signika', sans-serif;">Make a difference!</h4>
      <p class="text-gray-600 text-xs mt-1">Finish your <strong id="reminder-amount" class="text-[#d97706]">$0</strong> gift to create an impact today.</p>
    </div>
  </div>
  <button id="reminder-give-btn" class="mt-3 w-full bg-[#d97706] hover:bg-[#b45309] text-white font-bold py-2 px-4 rounded-lg text-sm transition">
    Give Now
  </button>
</div>

<!-- ==================== SIDECART ==================== -->
<div id="cart-overlay" class="fixed inset-0 bg-black/50 z-[100] hidden opacity-0 transition-opacity duration-300"></div>

<div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-white z-[101] shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
  <!-- Header -->
  <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-[#d97706]">
    <h2 class="text-lg font-bold text-white" style="font-family: 'Signika', sans-serif;">Your Donations</h2>
    <button id="close-cart" class="p-2 hover:bg-white/10 rounded-full transition" aria-label="Close donation cart">
      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Cart Content -->
  <div class="flex-1 overflow-y-auto p-4 flex flex-col">
    <!-- Empty State -->
    <div id="cart-empty" class="text-center py-8">
      <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
      </svg>
      <p class="text-gray-500 font-medium">Your cart is empty</p>
      <p class="text-gray-400 text-sm mt-1">Add a donation to get started</p>
    </div>

    <!-- Cart Items List -->
    <div id="cart-items" class="space-y-3 hidden">
      <!-- Items rendered via JS -->
    </div>

    <!-- Spacer to push checkout to middle (shrinks when more items) -->
    <div id="cart-spacer" class="flex-1 min-h-[60px] max-h-[30vh]"></div>

    <!-- Make it Monthly + Checkout Section -->
    <div id="cart-footer">
      <!-- Make a Bigger Impact Section -->
      <div id="recurring-options" class="mb-5 hidden">
        <!-- Handwritten-style header with arrow pointing to Jummah -->
        <div class="relative mb-1">
          <p class="text-gray-500 text-[24px] text-center pr-8" style="font-family: 'Caveat', cursive;">Make a bigger impact with every Friday gift</p>
          <!-- Clear curved arrow pointing down -->
          <svg class="absolute right-0 top-3 w-10 h-14 text-[#d97706]" viewBox="0 0 40 56" fill="none">
            <!-- Curved line ending before the arrowhead -->
            <path d="M4 4 C18 8, 26 20, 26 34" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
            <!-- Arrow head - left line -->
            <line x1="18" y1="42" x2="26" y2="52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <!-- Arrow head - right line -->
            <line x1="34" y1="42" x2="26" y2="52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <!-- Connecting curve to arrowhead -->
            <path d="M26 34 L26 52" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
          </svg>
        </div>

        <!-- Two checkboxes side by side: Monthly (left), Jummah (right) -->
        <div class="grid grid-cols-2 gap-2">
          <!-- Monthly -->
          <label class="cursor-pointer">
            <div class="recurring-option p-3 bg-gray-50 hover:bg-amber-50 rounded-xl transition border border-gray-200 hover:border-[#d97706] h-full">
              <div class="flex items-start gap-2">
                <input type="checkbox" name="recurring-type" value="monthly" class="mt-0.5 w-4 h-4 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706] accent-[#d97706] flex-shrink-0" />
                <div>
                  <p class="font-bold text-gray-700 text-xs uppercase tracking-wide">Make it Monthly</p>
                  <p class="text-[10px] text-gray-400 mt-1 leading-tight">Monthly donations help us transform communities faster!</p>
                </div>
              </div>
            </div>
          </label>

          <!-- Every Jummah (Friday) -->
          <label class="cursor-pointer">
            <div class="recurring-option p-3 bg-gray-50 hover:bg-amber-50 rounded-xl transition border border-gray-200 hover:border-[#d97706] h-full">
              <div class="flex items-start gap-2">
                <input type="checkbox" name="recurring-type" value="weekly" class="mt-0.5 w-4 h-4 text-[#d97706] border-gray-300 rounded focus:ring-[#d97706] accent-[#d97706] flex-shrink-0" />
                <div>
                  <p class="font-bold text-gray-700 text-xs uppercase tracking-wide">Every Jummah</p>
                  <p class="text-[10px] text-gray-400 mt-1">Friday</p>
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Total -->
      <div class="flex justify-between items-center mb-3">
        <span class="text-gray-600 text-sm" id="payment-type-label">One-time Payment</span>
        <span class="text-xl font-bold text-[#d97706]" id="cart-total">$0.00</span>
      </div>

      <!-- Checkout Button -->
      <button id="proceed-checkout-btn" disabled class="w-full bg-[#d97706] text-white font-bold py-3 rounded-xl hover:bg-[#b45309] transition disabled:opacity-50 disabled:cursor-not-allowed" style="font-family: 'Signika', sans-serif;">
        Proceed To Checkout
      </button>
    </div>
  </div>
</div>

<!-- ==================== FULL-SCREEN CHECKOUT MODAL ==================== -->
<div id="checkout-modal" class="fixed inset-0 z-[200] hidden">
  <!-- Modal Content - True Full Screen -->
  <div class="absolute inset-0 bg-white overflow-y-auto">

    <!-- Close Button -->
    <button id="close-checkout-modal" class="fixed top-4 right-4 z-20 p-3 bg-gray-100 hover:bg-gray-200 rounded-full transition shadow-lg" aria-label="Close checkout">
      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

        <!-- Step 1: Your Information + Cart Summary -->
        <div id="modal-step-1">
          <!-- Progress Indicator -->
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-[#d97706] text-white flex items-center justify-center font-bold text-sm">1</div>
                <span class="font-semibold text-gray-800">Your Information</span>
                <div class="hidden md:flex items-center gap-2 text-gray-400 ml-2">
                  <div class="w-6 h-0.5 bg-gray-300"></div>
                  <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold text-sm">2</div>
                  <span class="text-gray-500">Payment</span>
                </div>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2">
            <!-- Left: Your Information -->
            <div class="p-6 md:p-8 bg-white">
              <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Signika', sans-serif;">Your Information</h2>

              <form id="checkout-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                    <input type="text" name="firstName" id="modal-firstName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                    <input type="text" name="lastName" id="modal-lastName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                  <input type="email" name="email" id="modal-email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                  <input type="tel" name="phone" id="modal-phone" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] focus:border-transparent" />
                </div>

                <!-- Privacy & Communication Preferences -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                  <h4 class="text-lg font-bold text-gray-800 mb-4">Keep in Touch</h4>

                  <!-- Communication Preferences -->
                  <div class="mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">I am happy to hear from Qurbani Foundation by:</p>
                    <div class="flex flex-wrap gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-email" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">Email</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-sms" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">SMS</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-whatsapp" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">WhatsApp</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-phone" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">Phone</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <div class="custom-checkbox">
                          <input type="checkbox" id="pref-post" checked />
                          <span class="checkmark"></span>
                        </div>
                        <span class="text-sm text-gray-700">Post</span>
                      </label>
                    </div>
                  </div>

                  <p class="text-xs text-gray-500">To opt-out, email to: <a href="mailto:donorcare@qurbani.com" class="text-[#01534d] hover:underline">donorcare@qurbani.com</a></p>
                </div>

              </form>
            </div>

            <!-- Right: Donation Basket + Upsell -->
            <div class="p-6 md:p-8 bg-gray-50 md:border-l border-gray-200">
              <!-- Donation Basket Box -->
              <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4" style="font-family: 'Signika', sans-serif;">Donation Basket</h3>

                <!-- Cart Items Summary -->
                <div id="modal-cart-items" class="space-y-3">
                  <!-- Rendered via JS -->
                </div>

                <!-- Subtotal -->
                <div class="flex justify-between items-center pt-3 mt-3 border-t border-gray-200">
                  <span class="font-medium text-gray-700">Subtotal</span>
                  <span class="text-xl font-bold text-[#d97706]" id="modal-subtotal">$0.00</span>
                </div>
              </div>

              <!-- Please Support Us Further Box -->
              <div class="bg-white rounded-xl border border-gray-200 p-4">
                <p class="text-sm font-semibold text-gray-700 mb-4">Please Support Us Further</p>

                <!-- Upsell Item 1: Prophetic Qurbani -->
                <label class="flex items-center gap-3 cursor-pointer mb-4">
                  <div class="custom-checkbox custom-checkbox-orange">
                    <input type="checkbox" id="upsell-checkbox-1" />
                    <span class="checkmark"></span>
                  </div>
                  <span class="text-sm text-gray-700">YES, Give Prophetic Qurbani</span>
                </label>

                <div class="bg-gray-50 rounded-xl p-4 mb-4">
                  <div class="flex gap-4">
                    <img src="/images/campaigns/prophetic-qurbani.jpg" alt="Prophetic Qurbani" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1545167496-5a24ed2d68b4?w=200&q=80'" />
                    <div>
                      <p class="font-bold text-gray-800 text-sm">I WANT TO GIVE $50 TO PROPHETIC QURBANI</p>
                      <p class="text-xs text-gray-600 mt-2 leading-relaxed">The Prophet (&#65018;) used to give his Qurbani and then give a second Qurbani for those in his Ummah who were unable to do so themselves. This act of generous giving is for those who cannot. Follow in the footsteps of The Prophet (&#65018;) and give today!</p>
                    </div>
                  </div>
                </div>

                <!-- Upsell Item 2: Feed a Family -->
                <label class="flex items-center gap-3 cursor-pointer mb-4">
                  <div class="custom-checkbox custom-checkbox-orange">
                    <input type="checkbox" id="upsell-checkbox-2" />
                    <span class="checkmark"></span>
                  </div>
                  <span class="text-sm text-gray-700">YES, Feed a Family for a Week</span>
                </label>

                <div class="bg-gray-50 rounded-xl p-4">
                  <div class="flex gap-4">
                    <img src="/images/campaigns/feed-family.jpg" alt="Feed a Family" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1593113598332-cd288d649433?w=200&q=80'" />
                    <div>
                      <p class="font-bold text-gray-800 text-sm">I WANT TO GIVE $25 TO FEED A FAMILY</p>
                      <p class="text-xs text-gray-600 mt-2 leading-relaxed">Provide 21 nutritious meals for a family in need. Your generosity ensures they have food on the table for an entire week. Be the reason a family doesn't go hungry.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Continue to Payment Button - Separate from boxes above -->
              <div class="mt-8 pt-6 border-t border-gray-200">
                <button type="button" id="modal-continue-btn" class="w-full bg-[#d97706] text-white font-bold py-4 rounded-xl hover:bg-[#b45309] transition text-lg shadow-lg">
                  Continue to Payment
                  <svg class="w-5 h-5 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Payment Details -->
        <div id="modal-step-2" class="hidden">
          <!-- Progress Indicator - Step 2 -->
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <div class="max-w-2xl mx-auto flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <span class="text-gray-400">Your Information</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-12 h-0.5 bg-[#d97706]"></div>
                <div class="w-8 h-8 rounded-full bg-[#d97706] text-white flex items-center justify-center font-bold text-sm">2</div>
                <span class="font-semibold text-gray-800">Payment</span>
              </div>
              <!-- Trust Badge in Header -->
              <div class="hidden md:flex items-center gap-2 text-sm text-gray-500">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="font-medium">256-bit SSL Secure</span>
              </div>
            </div>
          </div>

          <div class="p-6 md:p-8 max-w-2xl mx-auto">
            <!-- Back Button -->
            <button type="button" id="modal-back-btn" class="flex items-center gap-2 text-[#d97706] font-medium mb-6 hover:underline">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Back to Information
            </button>

            <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Signika', sans-serif;">Payment Details</h2>

            <!-- Order Summary with Impact -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6 border border-green-200">
              <div class="flex justify-between items-center">
                <div>
                  <span class="text-gray-600">Your Total Impact</span>
                  <p class="text-xs text-green-600 mt-1">100% of your donation goes to those in need</p>
                </div>
                <span class="text-2xl font-bold text-[#d97706]" id="payment-total">$0.00</span>
              </div>
            </div>

            <!-- Card Element with Trust Badges -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Card Details *</label>
                <div class="flex items-center gap-2">
                  <img src="https://cdn.jsdelivr.net/gh/nicerobot/stripe-badge@master/svg/badge-solid-dark.svg" alt="Powered by Stripe" class="h-6" onerror="this.style.display='none'" />
                </div>
              </div>
              <div id="card-element" class="p-4 border border-gray-300 rounded-xl bg-white min-h-[50px]"></div>
              <div id="card-errors" class="text-red-500 text-sm mt-2" role="alert"></div>
              <!-- Card Brands -->
              <div class="flex items-center gap-2 mt-2">
                <span class="text-xs text-gray-400">We accept:</span>
                <div class="flex gap-1">
                  <div class="w-8 h-5 bg-blue-600 rounded flex items-center justify-center text-white text-xs font-bold">VISA</div>
                  <div class="w-8 h-5 bg-red-500 rounded flex items-center justify-center text-white text-xs font-bold">MC</div>
                  <div class="w-8 h-5 bg-blue-400 rounded flex items-center justify-center text-white text-xs font-bold">AMEX</div>
                </div>
              </div>
            </div>

            <!-- Billing Address -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Billing Address</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
                  <input type="text" name="address" id="modal-address" required autocomplete="off" placeholder="Start typing to search..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  <p class="text-xs text-gray-400 mt-1">Start typing to auto-fill your address</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                    <input type="text" name="city" id="modal-city" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                    <input type="text" name="state" id="modal-state" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code *</label>
                    <input type="text" name="zipCode" id="modal-zip" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706]" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                    <select name="country" id="modal-country" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#d97706] bg-white">
                      <option value="US" selected>United States</option>
                      <option value="CA">Canada</option>
                      <option value="GB">United Kingdom</option>
                      <option value="AU">Australia</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cover Transaction Fees -->
            <div class="mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" id="cover-fees-checkbox" class="mt-1 w-5 h-5 text-[#d97706] rounded focus:ring-[#d97706] accent-[#d97706]" />
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="font-semibold text-gray-800 text-sm group-hover:text-[#d97706] transition">Cover Transaction Fees</span>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">+3%</span>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Add <span id="fee-amount-display">$0.00</span> so 100% of your donation reaches those in need.</p>
                </div>
              </label>
            </div>

            <!-- Total Display -->
            <div class="flex justify-between items-center mb-4 py-3 px-4 bg-white rounded-xl border border-gray-200">
              <span class="font-medium text-gray-700">Your Total</span>
              <span class="text-2xl font-bold text-[#d97706]" id="step2-total">$0.00</span>
            </div>

            <!-- Pay Button -->
            <button type="button" id="pay-btn" class="w-full bg-[#d97706] text-white font-bold py-4 rounded-xl hover:bg-[#b45309] transition text-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              <span id="pay-btn-text">Complete Secure Donation</span>
            </button>

            <!-- Trust Indicators Below Button -->
            <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-xs text-gray-500">
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Secure Payment</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Tax Deductible</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                </svg>
                <span>Receipt Emailed</span>
              </div>
            </div>

            <!-- Processing -->
            <div id="processing-indicator" class="hidden mt-4 text-center">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#d97706]"></div>
              <p class="text-gray-600 mt-2">Processing your donation...</p>
            </div>

            <!-- Error -->
            <div id="payment-error" class="hidden mt-4 p-4 bg-red-50 rounded-xl text-center">
              <p class="text-red-600" id="payment-error-text"></p>
            </div>
          </div>
        </div>

        <!-- Success State -->
        <div id="modal-success" class="hidden p-8 text-center max-w-lg mx-auto">
          <div class="w-20 h-20 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-gray-800 mb-2" style="font-family: 'Signika', sans-serif;">Thank You!</h2>
          <p class="text-gray-600 mb-4" id="success-message">Your donation has been processed successfully.</p>

          <!-- Subscription Info (hidden by default) -->
          <div id="subscription-info" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-left">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </div>
              <div>
                <p id="subscription-type-title" class="font-semibold text-blue-800">Recurring Donation</p>
                <p class="text-sm text-blue-600 mt-1">You will be automatically charged <span id="monthly-amount" class="font-bold"></span> <span id="billing-interval-text">each month</span>.</p>
                <p class="text-sm text-blue-600 mt-1">Next billing date: <span id="next-billing-date" class="font-medium"></span></p>
              </div>
            </div>
            <a href="#" id="manage-subscription-link" class="mt-3 inline-flex items-center gap-2 text-sm text-blue-700 hover:text-blue-900 font-medium">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Manage Your Subscription
            </a>
          </div>

          <p class="text-sm text-gray-500 mb-8">A confirmation email has been sent to your email address.</p>
          <button type="button" id="close-success-btn" class="px-8 py-3 bg-[#d97706] text-white font-semibold rounded-xl hover:bg-[#b45309] transition">
            Continue Browsing
          </button>
  </div>
</div>

<script is:inline define:vars={{ stripePublishableKey: paymentSettings.stripe_publishable_key, stripeEnabled: paymentSettings.stripe_enabled, googlePlacesApiKey: googlePlacesApiKey }}>
// Cart State
window.donationCart = {
  items: [],
  isOpen: false,
  stripe: null,
  cardElement: null,
  cardMounted: false,
  placesLoaded: false,
  autocomplete: null,
  upsellItems: [
    { id: 'prophetic-qurbani', name: 'Prophetic Qurbani', amount: 50, type: 'single' },
    { id: 'feed-family', name: 'Feed a Family', amount: 25, type: 'single' },
  ],
};

// Load Google Places API
function loadGooglePlaces() {
  console.log('loadGooglePlaces called, API key present:', !!googlePlacesApiKey, 'key length:', googlePlacesApiKey?.length || 0);

  if (window.donationCart.placesLoaded) {
    console.log('Google Places already loaded');
    return;
  }

  if (!googlePlacesApiKey) {
    console.error('Google Places API key is missing! Address autocomplete will not work.');
    return;
  }

  console.log('Loading Google Places API script...');
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${googlePlacesApiKey}&libraries=places&callback=initPlacesAutocomplete`;
  script.async = true;
  script.defer = true;
  script.onerror = function() {
    console.error('Failed to load Google Places API script');
  };
  document.head.appendChild(script);
  window.donationCart.placesLoaded = true;
}

// Initialize Places Autocomplete
window.initPlacesAutocomplete = function() {
  console.log('=== initPlacesAutocomplete called ===');

  // Skip if already initialized
  if (window.donationCart.autocomplete) {
    console.log('Places autocomplete already initialized, skipping');
    return;
  }

  const addressInput = document.getElementById('modal-address');
  console.log('Address input element:', addressInput);
  console.log('Address input visible:', addressInput ? getComputedStyle(addressInput).display : 'N/A');

  if (!addressInput) {
    console.error('ERROR: Address input not found in DOM');
    return;
  }

  console.log('Google object:', typeof window.google);
  console.log('Google maps:', typeof window.google?.maps);
  console.log('Google places:', typeof window.google?.maps?.places);

  if (!window.google?.maps?.places) {
    console.error('ERROR: Google Places API not loaded');
    return;
  }

  try {
    console.log('Creating Autocomplete instance...');
    window.donationCart.autocomplete = new google.maps.places.Autocomplete(addressInput, {
      types: ['address'],
      componentRestrictions: { country: ['us', 'ca', 'gb', 'au'] },
      fields: ['address_components', 'formatted_address'],
    });
    console.log('SUCCESS: Autocomplete created:', window.donationCart.autocomplete);

    // Debug: Listen for any autocomplete events
    window.donationCart.autocomplete.addListener('place_changed', function() {
      console.log('place_changed event fired!');
    });

    // Force the pac-container to be visible
    setTimeout(function() {
      const pacContainers = document.querySelectorAll('.pac-container');
      console.log('pac-container elements found:', pacContainers.length);
      pacContainers.forEach(function(pac, i) {
        console.log('pac-container ' + i + ':', pac, 'z-index:', getComputedStyle(pac).zIndex);
      });
    }, 500);

    window.donationCart.autocomplete.addListener('place_changed', function() {
      const place = window.donationCart.autocomplete.getPlace();
      if (!place.address_components) return;

      // Parse address components
      let streetNumber = '';
      let route = '';
      let city = '';
      let state = '';
      let zip = '';
      let country = 'US';

      for (const component of place.address_components) {
        const type = component.types[0];
        if (type === 'street_number') streetNumber = component.long_name;
        if (type === 'route') route = component.long_name;
        if (type === 'locality') city = component.long_name;
        if (type === 'administrative_area_level_1') state = component.short_name;
        if (type === 'postal_code') zip = component.long_name;
        if (type === 'country') country = component.short_name;
      }

      // Fill in the form fields
      document.getElementById('modal-address').value = `${streetNumber} ${route}`.trim();
      document.getElementById('modal-city').value = city;
      document.getElementById('modal-state').value = state;
      document.getElementById('modal-zip').value = zip;
      document.getElementById('modal-country').value = country;
    });
  } catch (e) {
    console.log('Google Places not available:', e.message);
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Load cart from localStorage
  const savedCart = localStorage.getItem('donationCart');
  if (savedCart) {
    try {
      window.donationCart.items = JSON.parse(savedCart);
      updateCartUI();
    } catch (e) {}
  }

  // Initialize Stripe
  if (stripeEnabled && stripePublishableKey && typeof Stripe !== 'undefined') {
    window.donationCart.stripe = Stripe(stripePublishableKey);
    initializeStripeElements();
  }

  // Load Google Places API
  loadGooglePlaces();

  // Event Listeners
  document.getElementById('close-cart').addEventListener('click', closeCart);
  document.getElementById('cart-overlay').addEventListener('click', closeCart);
  document.getElementById('proceed-checkout-btn').addEventListener('click', openCheckoutModal);

  // Cart Reminder Popup Event Listeners
  document.getElementById('close-cart-reminder')?.addEventListener('click', hideCartReminder);
  document.getElementById('reminder-give-btn')?.addEventListener('click', () => {
    hideCartReminder();
    openCart();
  });
  document.getElementById('close-checkout-modal').addEventListener('click', closeCheckoutModal);
  document.getElementById('modal-continue-btn').addEventListener('click', goToPaymentStep);
  document.getElementById('modal-continue-btn-mobile')?.addEventListener('click', goToPaymentStep);
  document.getElementById('modal-back-btn').addEventListener('click', goToInfoStep);
  document.getElementById('pay-btn').addEventListener('click', handlePayment);
  document.getElementById('close-success-btn').addEventListener('click', function() {
    closeCheckoutModal();
    window.donationCart.items = [];
    localStorage.removeItem('donationCart');
    updateCartUI();
  });

  // Upsell checkboxes - update total and visual styles
  document.getElementById('upsell-checkbox-1').addEventListener('change', function() {
    if (this.checked) {
      // Add Prophetic Qurbani to basket
      const exists = window.donationCart.items.find(i => i.id === 'prophetic-qurbani-upsell');
      if (!exists) {
        window.donationCart.items.push({
          id: 'prophetic-qurbani-upsell',
          name: 'Prophetic Qurbani',
          amount: 50,
          quantity: 1,
          type: 'single',
          campaign: 'qurbani',
          isUpsell: true
        });
      }
    } else {
      // Remove from basket
      window.donationCart.items = window.donationCart.items.filter(i => i.id !== 'prophetic-qurbani-upsell');
    }
    updateModalCart();
    updateModalTotal();
    saveCart();
  });
  document.getElementById('upsell-checkbox-2').addEventListener('change', function() {
    if (this.checked) {
      // Add Feed a Family to basket
      const exists = window.donationCart.items.find(i => i.id === 'feed-family-upsell');
      if (!exists) {
        window.donationCart.items.push({
          id: 'feed-family-upsell',
          name: 'Feed a Family',
          amount: 25,
          quantity: 1,
          type: 'single',
          campaign: 'food-aid',
          isUpsell: true
        });
      }
    } else {
      // Remove from basket
      window.donationCart.items = window.donationCart.items.filter(i => i.id !== 'feed-family-upsell');
    }
    updateModalCart();
    updateModalTotal();
  });

  // Cover fees checkbox
  document.getElementById('cover-fees-checkbox').addEventListener('change', function() {
    updateModalTotal();
  });

  // Recurring type checkboxes (only one can be selected at a time)
  document.querySelectorAll('input[name="recurring-type"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const thisCheckbox = this;
      if (thisCheckbox.checked) {
        // Uncheck the other checkbox
        document.querySelectorAll('input[name="recurring-type"]').forEach(function(cb) {
          if (cb !== thisCheckbox) cb.checked = false;
        });
        updateCartRecurringType(thisCheckbox.value);
      } else {
        // If unchecked, revert to single
        updateCartRecurringType('single');
      }
      updateCartUI();
    });
  });

  // ESC to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (document.getElementById('checkout-modal').classList.contains('hidden') === false) {
        closeCheckoutModal();
      } else if (window.donationCart.isOpen) {
        closeCart();
      }
    }
  });
});

// Initialize Stripe Elements
function initializeStripeElements() {
  if (!window.donationCart.stripe) return;
  const elements = window.donationCart.stripe.elements();
  window.donationCart.cardElement = elements.create('card', {
    style: {
      base: { fontSize: '16px', color: '#333', fontFamily: 'system-ui, sans-serif' },
      invalid: { color: '#dc2626' },
    },
  });
}

// Mount card element
function mountCardElement() {
  if (!window.donationCart.cardElement || window.donationCart.cardMounted) return;
  const container = document.getElementById('card-element');
  if (container) {
    window.donationCart.cardElement.mount('#card-element');
    window.donationCart.cardMounted = true;
    window.donationCart.cardElement.on('change', function(event) {
      document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
    });
  }
}

// Recurring option functions
function updateCartRecurringType(type) {
  // Only update items that were originally added as single/one-time
  // Items added as monthly/weekly (like orphan sponsorship) stay as they are
  window.donationCart.items.forEach(function(item) {
    if (item.originalType === 'single' || !item.originalType) {
      // This item can be converted
      // type can be: 'single', 'weekly' (Jummah), or 'monthly'
      item.type = type === 'single' ? 'single' : type;
      item.recurringInterval = type;
    }
    // Items with originalType === 'monthly' or 'weekly' are not changed
  });
  saveCart();
  updateCartUI();
}

// Cart Functions
function saveCart() {
  localStorage.setItem('donationCart', JSON.stringify(window.donationCart.items));
}

window.addToCart = function(item) {
  // Track add to cart in GA4
  if (window.trackAddToCart) {
    window.trackAddToCart(item);
  }

  const existingIndex = window.donationCart.items.findIndex(i => i.id === item.id && i.type === item.type);
  if (existingIndex >= 0) {
    window.donationCart.items[existingIndex].quantity += item.quantity || 1;
  } else {
    // Store originalType so we know if this item can be converted later
    const originalType = item.type || 'single';
    window.donationCart.items.push({
      ...item,
      quantity: item.quantity || 1,
      originalType: originalType // Remember how it was added
    });
  }
  saveCart();
  updateCartUI();
  openCart();
};

window.removeFromCart = function(index) {
  const item = window.donationCart.items[index];

  // Track remove_from_cart in GA4
  if (window.trackRemoveFromCart && item) {
    window.trackRemoveFromCart(item);
  }

  window.donationCart.items.splice(index, 1);
  saveCart();
  updateCartUI();
};

window.updateQuantity = function(index, delta) {
  const item = window.donationCart.items[index];
  if (item) {
    item.quantity = Math.max(1, item.quantity + delta);
    saveCart();
    updateCartUI();
  }
};

function updateCartUI() {
  const items = window.donationCart.items;
  const cartEmpty = document.getElementById('cart-empty');
  const cartItems = document.getElementById('cart-items');
  const recurringOptions = document.getElementById('recurring-options');
  const proceedBtn = document.getElementById('proceed-checkout-btn');

  if (items.length === 0) {
    cartEmpty.classList.remove('hidden');
    cartItems.classList.add('hidden');
    recurringOptions.classList.add('hidden');
    proceedBtn.disabled = true;
  } else {
    cartEmpty.classList.add('hidden');
    cartItems.classList.remove('hidden');
    proceedBtn.disabled = false;

    // Always show recurring options when there are items
    recurringOptions.classList.remove('hidden');

    // Check if there are any convertible items (originally single)
    // Only show the checkbox option if there are items that CAN be converted
    const hasConvertibleItems = items.some(item => item.originalType === 'single' || !item.originalType);

    // Don't auto-check the checkbox - user must manually select it
    // The checkbox state is preserved as-is unless user interacts with it

    cartItems.innerHTML = items.map((item, index) => {
      // Each item shows its own type
      const itemType = item.recurringInterval || item.type || 'single';
      const itemTypeLabel = itemType === 'weekly' ? 'Every Jummah' : itemType === 'monthly' ? 'Monthly' : itemType === 'annual' ? 'Annual' : 'One-time';

      // Check for notes in metadata (Aqiqah items)
      const hasNotes = item.metadata?.notes && item.metadata.notes.trim() !== '';
      const notesHtml = hasNotes ? `<p class="text-xs text-gray-500 italic mt-1 bg-gray-50 p-1.5 rounded">üìù ${item.metadata.notes}</p>` : '';

      return `
      <div class="bg-white rounded-xl p-3 border border-gray-200 shadow-sm">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h4 class="font-semibold text-gray-800 text-sm">${item.name}</h4>
            <p class="text-xs text-gray-500">${itemTypeLabel}</p>
            ${notesHtml}
          </div>
          <p class="font-bold text-[#d97706]">$${(item.amount * item.quantity).toFixed(2)}</p>
        </div>
        <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-100">
          <div class="flex items-center gap-2">
            <button onclick="updateQuantity(${index}, -1)" class="w-7 h-7 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 transition text-gray-600">‚àí</button>
            <span class="w-6 text-center text-sm font-medium">${item.quantity}</span>
            <button onclick="updateQuantity(${index}, 1)" class="w-7 h-7 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 transition text-gray-600">+</button>
          </div>
          <button onclick="removeFromCart(${index})" class="text-gray-400 text-xs font-medium hover:text-gray-600">Remove</button>
        </div>
      </div>
    `}).join('');
  }

  // Update total
  const total = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);

  // Determine payment label based on cart contents
  const hasWeekly = items.some(item => (item.recurringInterval || item.type) === 'weekly');
  const hasMonthly = items.some(item => (item.recurringInterval || item.type) === 'monthly');
  const hasAnnual = items.some(item => (item.recurringInterval || item.type) === 'annual');
  const hasSingle = items.some(item => !item.type || item.type === 'single');
  const hasRecurring = hasWeekly || hasMonthly || hasAnnual;

  let paymentLabel = 'One-time Payment';
  if (hasWeekly && !hasMonthly && !hasAnnual && !hasSingle) {
    paymentLabel = 'Every Jummah';
  } else if (hasMonthly && !hasWeekly && !hasAnnual && !hasSingle) {
    paymentLabel = 'Monthly Payment';
  } else if (hasAnnual && !hasWeekly && !hasMonthly && !hasSingle) {
    paymentLabel = 'Annual Payment';
  } else if (hasRecurring) {
    paymentLabel = 'Includes Recurring';
  }

  document.getElementById('cart-total').textContent = '$' + total.toFixed(2);
  document.getElementById('payment-type-label').textContent = paymentLabel;

  // Update cart count badge (if exists)
  const badge = document.getElementById('cart-count');
  const count = items.reduce((sum, item) => sum + item.quantity, 0);
  if (badge) {
    badge.textContent = count;
    badge.classList.toggle('hidden', count === 0);
  }

  // Dispatch event so Navbar can update its cart display
  window.dispatchEvent(new CustomEvent('cartUpdated'));

  // Update cart reminder popup
  updateCartReminder();
}

// Cart Reminder Popup Logic
let reminderTimeout = null;
let reminderDismissed = false;

function updateCartReminder() {
  const reminder = document.getElementById('cart-reminder');
  const reminderAmount = document.getElementById('reminder-amount');
  if (!reminder || !reminderAmount) return;

  const items = window.donationCart.items;
  const total = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);

  // Update the amount display
  reminderAmount.textContent = '$' + total.toFixed(0);

  // Clear any existing timeout
  if (reminderTimeout) {
    clearTimeout(reminderTimeout);
    reminderTimeout = null;
  }

  // Show reminder if cart has items, cart is closed, not dismissed, and on desktop (lg: breakpoint = 1024px)
  const isDesktop = window.innerWidth >= 1024;
  if (items.length > 0 && !window.donationCart.isOpen && !reminderDismissed && isDesktop) {
    // Show after 5 seconds of inactivity
    reminderTimeout = setTimeout(() => {
      // Double-check we're still on desktop when timeout fires
      if (window.innerWidth >= 1024) {
        reminder.classList.remove('hidden');
        setTimeout(() => {
          reminder.classList.remove('translate-y-4', 'opacity-0');
        }, 10);
      }
    }, 5000);
  } else {
    // Hide the reminder
    reminder.classList.add('translate-y-4', 'opacity-0');
    setTimeout(() => {
      reminder.classList.add('hidden');
    }, 300);
  }
}

function hideCartReminder() {
  const reminder = document.getElementById('cart-reminder');
  if (reminder) {
    reminder.classList.add('translate-y-4', 'opacity-0');
    setTimeout(() => {
      reminder.classList.add('hidden');
    }, 300);
  }
  reminderDismissed = true;
}

// Open/Close Cart
function openCart() {
  window.donationCart.isOpen = true;
  document.getElementById('cart-overlay').classList.remove('hidden');
  document.getElementById('cart-sidebar').classList.remove('translate-x-full');
  setTimeout(() => document.getElementById('cart-overlay').classList.remove('opacity-0'), 10);
  document.body.style.overflow = 'hidden';

  // Track view_cart in GA4
  if (window.trackViewCart && window.donationCart.items.length > 0) {
    const total = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    window.trackViewCart(window.donationCart.items, total);
  }
}

function closeCart() {
  window.donationCart.isOpen = false;
  document.getElementById('cart-overlay').classList.add('opacity-0');
  document.getElementById('cart-sidebar').classList.add('translate-x-full');
  setTimeout(() => document.getElementById('cart-overlay').classList.add('hidden'), 300);
  document.body.style.overflow = '';
}

window.openCart = openCart;
window.closeCart = closeCart;

// Checkout Modal Functions
function openCheckoutModal() {
  closeCart();
  document.getElementById('checkout-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  // Track begin_checkout in GA4
  if (window.trackBeginCheckout) {
    const total = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    window.trackBeginCheckout(window.donationCart.items, total);
  }

  // Reset to step 1
  document.getElementById('modal-step-1').classList.remove('hidden');
  document.getElementById('modal-step-2').classList.add('hidden');
  document.getElementById('modal-success').classList.add('hidden');

  // Pre-check first upsell (opt-out strategy for higher conversions)
  document.getElementById('upsell-checkbox-1').checked = false;
  document.getElementById('upsell-checkbox-2').checked = false;

  // Update upsell card styling
  updateUpsellCardStyles();

  // Initialize Google Places autocomplete after modal is visible
  setTimeout(function() {
    if (!window.donationCart.autocomplete && window.google?.maps?.places) {
      window.initPlacesAutocomplete();
    }
  }, 100);

  // Update cart display with upsell included
  updateModalCart();
}

// Update upsell card visual styles based on checked state
function updateUpsellCardStyles() {
  const checkbox1 = document.getElementById('upsell-checkbox-1');
  const checkbox2 = document.getElementById('upsell-checkbox-2');
  const card1 = checkbox1.closest('.upsell-card');
  const card2 = checkbox2.closest('.upsell-card');

  if (card1) {
    if (checkbox1.checked) {
      card1.classList.remove('border-gray-200', 'bg-white');
      card1.classList.add('border-[#d97706]', 'bg-orange-50');
    } else {
      card1.classList.remove('border-[#d97706]', 'bg-orange-50');
      card1.classList.add('border-gray-200', 'bg-white');
    }
  }

  if (card2) {
    if (checkbox2.checked) {
      card2.classList.remove('border-gray-200', 'bg-white');
      card2.classList.add('border-[#d97706]', 'bg-orange-50');
    } else {
      card2.classList.remove('border-[#d97706]', 'bg-orange-50');
      card2.classList.add('border-gray-200', 'bg-white');
    }
  }
}

function closeCheckoutModal() {
  document.getElementById('checkout-modal').classList.add('hidden');
  document.body.style.overflow = '';
}

function updateModalCart() {
  const items = window.donationCart.items;
  const container = document.getElementById('modal-cart-items');

  container.innerHTML = items.map(item => {
    const itemType = item.recurringInterval || item.type || 'single';
    const typeLabel = itemType === 'weekly' ? 'Every Jummah' : itemType === 'monthly' ? 'Monthly' : 'One-time';
    const hasNotes = item.metadata?.notes && item.metadata.notes.trim() !== '';
    const notesHtml = hasNotes ? `<p class="text-xs text-gray-500 italic">üìù ${item.metadata.notes}</p>` : '';
    return `
    <div class="flex justify-between items-center py-2 border-b border-gray-100">
      <div>
        <p class="font-medium text-gray-800 text-sm">${item.name}</p>
        <p class="text-xs text-gray-500">${typeLabel} √ó ${item.quantity}</p>
        ${notesHtml}
      </div>
      <p class="font-semibold text-gray-800">$${(item.amount * item.quantity).toFixed(2)}</p>
    </div>
  `}).join('');

  updateModalTotal();
}

function updateModalTotal() {
  // Upsells are now added directly to cart, so no need to add them separately
  let baseTotal = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
  const hasWeekly = window.donationCart.items.some(i => i.type === 'weekly' || i.recurringInterval === 'weekly');
  const hasMonthly = window.donationCart.items.some(i => i.type === 'monthly' || i.recurringInterval === 'monthly');
  const hasRecurring = hasWeekly || hasMonthly;

  // Calculate fees (3% processing fee)
  const feePercentage = 0.03;
  const feeAmount = baseTotal * feePercentage;
  const coverFees = document.getElementById('cover-fees-checkbox').checked;
  const total = coverFees ? baseTotal + feeAmount : baseTotal;

  // Update fee display
  document.getElementById('fee-amount-display').textContent = '$' + feeAmount.toFixed(2);

  // Store fee state for payment
  window.donationCart.coverFees = coverFees;
  window.donationCart.feeAmount = feeAmount;
  window.donationCart.baseTotal = baseTotal;

  document.getElementById('modal-subtotal').textContent = '$' + total.toFixed(2);
  const modalTotal = document.getElementById('modal-total');
  if (modalTotal) modalTotal.textContent = '$' + total.toFixed(2);
  document.getElementById('payment-total').textContent = '$' + total.toFixed(2);

  // Update step 2 total display
  const step2Total = document.getElementById('step2-total');
  if (step2Total) step2Total.textContent = '$' + total.toFixed(2);

  // Determine payment type label
  let paymentTypeLabel = 'One-time donation';
  if (hasWeekly && !hasMonthly) {
    paymentTypeLabel = coverFees ? 'Every Jummah + fees covered' : 'Every Jummah (Friday)';
  } else if (hasMonthly && !hasWeekly) {
    paymentTypeLabel = coverFees ? 'Monthly + fees covered' : 'Monthly donation';
  } else if (hasRecurring) {
    paymentTypeLabel = coverFees ? 'Recurring + fees covered' : 'Includes recurring';
  } else if (coverFees) {
    paymentTypeLabel = 'One-time + fees covered';
  }
  const paymentTypeEl = document.getElementById('modal-payment-type');
  if (paymentTypeEl) paymentTypeEl.textContent = paymentTypeLabel;
}

function goToPaymentStep() {
  // Validate
  const firstName = document.getElementById('modal-firstName').value.trim();
  const lastName = document.getElementById('modal-lastName').value.trim();
  const email = document.getElementById('modal-email').value.trim();

  if (!firstName) { document.getElementById('modal-firstName').focus(); return; }
  if (!lastName) { document.getElementById('modal-lastName').focus(); return; }
  if (!email) { document.getElementById('modal-email').focus(); return; }

  document.getElementById('modal-step-1').classList.add('hidden');
  document.getElementById('modal-step-2').classList.remove('hidden');
  mountCardElement();

  // Track add_payment_info in GA4
  if (window.trackAddPaymentInfo) {
    const total = window.donationCart.items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    window.trackAddPaymentInfo(window.donationCart.items, total, 'credit_card');
  }

  // Update fee display for step 2
  updateModalTotal();

  // Initialize Google Places autocomplete if not already done
  if (!window.donationCart.autocomplete && window.google?.maps?.places) {
    window.initPlacesAutocomplete();
  }
}

function goToInfoStep() {
  document.getElementById('modal-step-2').classList.add('hidden');
  document.getElementById('modal-step-1').classList.remove('hidden');
}

// Handle Payment
async function handlePayment() {
  const payBtn = document.getElementById('pay-btn');
  const payText = document.getElementById('pay-btn-text');
  const processing = document.getElementById('processing-indicator');
  const errorDiv = document.getElementById('payment-error');

  payBtn.disabled = true;
  payText.textContent = 'Processing...';
  processing.classList.remove('hidden');
  errorDiv.classList.add('hidden');

  try {
    // Get form data
    const customer = {
      firstName: document.getElementById('modal-firstName').value,
      lastName: document.getElementById('modal-lastName').value,
      email: document.getElementById('modal-email').value,
      phone: document.getElementById('modal-phone').value,
    };

    const billingAddress = {
      line1: document.getElementById('modal-address').value,
      city: document.getElementById('modal-city').value,
      state: document.getElementById('modal-state').value,
      postal_code: document.getElementById('modal-zip').value,
      country: document.getElementById('modal-country').value,
    };

    // Calculate total - upsells are already in cart from checkbox change
    let items = [...window.donationCart.items];
    let total = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
    const hasWeekly = items.some(i => i.type === 'weekly' || i.recurringInterval === 'weekly');
    const hasMonthly = items.some(i => i.type === 'monthly' || i.recurringInterval === 'monthly');

    // Determine donation type: weekly (Jummah) takes priority, then monthly, then single
    let donationType = 'single';
    if (hasWeekly) {
      donationType = 'weekly';
    } else if (hasMonthly) {
      donationType = 'monthly';
    }

    // Add fee coverage if selected
    const coverFees = window.donationCart.coverFees || false;
    const feeAmount = coverFees ? (total * 0.03) : 0;
    total = total + feeAmount;

    // Create payment intent
    const response = await fetch('/api/payments/create-intent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount: total,
        items: items,
        customer,
        billingAddress,
        type: donationType,
        coverFees: coverFees,
        feeAmount: feeAmount,
        baseAmount: total - feeAmount,
      }),
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || 'Payment failed');

    // Confirm payment
    const { error, paymentIntent } = await window.donationCart.stripe.confirmCardPayment(data.clientSecret, {
      payment_method: {
        card: window.donationCart.cardElement,
        billing_details: {
          name: `${customer.firstName} ${customer.lastName}`,
          email: customer.email,
          phone: customer.phone,
          address: billingAddress,
        },
      },
    });

    if (error) throw new Error(error.message);

    if (paymentIntent.status === 'succeeded') {
      // Track purchase in GA4
      if (window.trackPurchase) {
        window.trackPurchase(paymentIntent.id, items, total);
      }

      // Show success
      document.getElementById('modal-step-2').classList.add('hidden');
      document.getElementById('modal-success').classList.remove('hidden');

      // Show subscription info if this was a recurring donation
      if (data.type === 'subscription' && data.subscriptionId) {
        document.getElementById('subscription-info').classList.remove('hidden');

        // Customize message based on interval (Jummah vs Monthly)
        const isJummah = data.isJummah || data.interval === 'weekly';
        if (isJummah) {
          document.getElementById('success-message').textContent = 'Your Jummah (Friday) donation has been set up successfully!';
          document.getElementById('subscription-type-title').textContent = 'Jummah (Friday) Recurring Donation';
          document.getElementById('billing-interval-text').textContent = 'every Friday';
        } else {
          document.getElementById('success-message').textContent = 'Your monthly donation has been set up successfully!';
          document.getElementById('subscription-type-title').textContent = 'Monthly Recurring Donation';
          document.getElementById('billing-interval-text').textContent = 'each month';
        }
        document.getElementById('monthly-amount').textContent = '$' + total.toFixed(2);

        // Format next billing date
        if (data.nextBillingDate) {
          const nextDate = new Date(data.nextBillingDate);
          const dateStr = nextDate.toLocaleDateString('en-US', {
            weekday: isJummah ? 'long' : undefined,
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          document.getElementById('next-billing-date').textContent = dateStr;
        }

        // Set management link (we'll need to fetch the token from the API)
        fetchManagementLink(customer.email, data.donationId);
      } else {
        document.getElementById('subscription-info').classList.add('hidden');
        document.getElementById('success-message').textContent = 'Your donation has been processed successfully.';
      }

      // Clear cart
      window.donationCart.items = [];
      localStorage.removeItem('donationCart');
      updateCartUI();
    }

  } catch (err) {
    errorDiv.classList.remove('hidden');
    document.getElementById('payment-error-text').textContent = err.message;
  } finally {
    payBtn.disabled = false;
    payText.textContent = 'Complete Donation';
    processing.classList.add('hidden');
  }
}

// Fetch management link for subscription
async function fetchManagementLink(email, donationId) {
  try {
    const response = await fetch(`/api/subscriptions/manage?email=${encodeURIComponent(email)}`);
    if (response.ok) {
      const data = await response.json();
      if (data.subscriptions && data.subscriptions.length > 0) {
        const subscription = data.subscriptions[0];
        const managementUrl = `/manage-subscription/${subscription.id}_${subscription.management_token}`;
        document.getElementById('manage-subscription-link').href = managementUrl;
      }
    }
  } catch (e) {
    console.error('Error fetching management link:', e);
  }
}
</script>
