---
import { getSettings, formatPhoneLink } from '../lib/settings';
import { getIconSvg } from '../lib/categories';
import { getNavbarData, hasWidgets, getMenuWidgets } from '../lib/menus';
import DynamicMegaMenu from './DynamicMegaMenu.astro';

const settings = await getSettings();

// Fetch all navbar data from cache (single optimized call)
const navbarData = await getNavbarData();
const { menuOrder, menuNames, menuColors, categories: dbCategories, campaignsByCategory: rawCampaigns, widgets } = navbarData;

// Check which menus have custom widgets configured
const useCustomWidgets = {
  'our-work': hasWidgets(widgets, 'our-work'),
  'zakat': hasWidgets(widgets, 'zakat'),
  'appeals': hasWidgets(widgets, 'appeals'),
  'about': hasWidgets(widgets, 'about'),
};

// Identify extra menus (not one of the 4 hardcoded ones)
const hardcodedMenus = ['our-work', 'zakat', 'appeals', 'about'];
const extraMenus = menuOrder
  .filter(menuId => !hardcodedMenus.includes(menuId))
  .map(menuId => ({
    id: menuId,
    name: menuNames[menuId] || menuId,
    color: menuColors[menuId] || '#01534d',
    hasWidgets: hasWidgets(widgets, menuId),
    order: menuOrder.indexOf(menuId)
  }));

// Create sorted menu list for mobile (all menus in correct order)
const allMenusSorted = menuOrder.map(menuId => ({
  id: menuId,
  name: menuNames[menuId] || menuId,
  color: menuColors[menuId] || '#01534d',
  isHardcoded: hardcodedMenus.includes(menuId),
  hasWidgets: hasWidgets(widgets, menuId)
}));

// Check if a hardcoded menu should be shown (is active in database)
const isMenuActive = (menuId: string) => menuOrder.includes(menuId);

// Filter categories for "Our Work" mega menu only
let categories = dbCategories
  .filter(cat => !cat.menu || cat.menu === 'our-work')
  .map(cat => ({
    id: cat.slug,
    label: cat.label,
    color: cat.color,
    icon: cat.icon
  }));

// Helper to get live DB categories for any menu (used by DynamicMegaMenu)
function getCategoriesForMenu(menuId: string) {
  return dbCategories
    .filter(cat => cat.menu === menuId || (!cat.menu && menuId === 'our-work'))
    .map(cat => ({ slug: cat.slug, label: cat.label, color: cat.color, icon: cat.icon }));
}

// Transform campaigns for template use
let campaignsByCategory: Record<string, any[]> = {};
Object.entries(rawCampaigns).forEach(([cat, campaigns]) => {
  campaignsByCategory[cat] = campaigns.map(c => ({
    slug: c.slug,
    name: c.name,
    featured_image: c.image,
    hero_image_url: c.image,
    image_url: c.image
  }));
});

// Helper to get campaign image
const getCampaignImage = (c: any) => c.featured_image || c.hero_image_url || c.image_url || 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=400';

// Get featured campaigns for mobile menu (first 4 from all categories)
const mobileFeaturedCampaigns: any[] = [];
const maxMobileCampaigns = 4;
for (const [catId, catCampaigns] of Object.entries(campaignsByCategory)) {
  for (const campaign of catCampaigns) {
    if (mobileFeaturedCampaigns.length >= maxMobileCampaigns) break;
    mobileFeaturedCampaigns.push({ ...campaign, category: catId });
  }
  if (mobileFeaturedCampaigns.length >= maxMobileCampaigns) break;
}

// Serialize campaigns data for JavaScript
const campaignsJson = JSON.stringify(campaignsByCategory);
---

<header class="absolute top-0 left-0 right-0 z-50 pt-2" id="main-header">
  <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex">
      <!-- Logo -->
      <a href="/" class="flex items-center flex-shrink-0">
        <img src={settings.site_logo} alt={settings.site_name} class="h-16 w-auto" />
      </a>

      <!-- Desktop Nav -->
      <div class="flex-1 hidden lg:flex flex-col ml-8">
        <!-- TOP ROW -->
        <div class="flex items-center text-xs text-white mb-2">
          <div class="flex-1 flex items-center justify-center gap-6">
            <!-- Search Button -->
            <button type="button" id="search-trigger" class="text-white/80 hover:text-white transition flex items-center gap-1" aria-label="Open search">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <span class="hidden sm:inline">Search</span>
            </button>

            <!-- Currency (disabled for now - code saved in /src/lib/currency-converter-PAUSED.js) -->
            <span class="text-white/80">USD</span>

            <!-- Language Selector -->
            <div class="relative" id="language-dropdown">
              <button type="button" id="language-trigger" class="flex items-center gap-1 text-white/80 hover:text-white transition" aria-label="Select language" aria-expanded="false" aria-haspopup="true">
                <img id="current-flag" src="https://flagcdn.com/w20/us.png" alt="EN" class="w-5 h-3 object-cover rounded-sm" />
                <span id="current-language">English</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <div id="language-menu" class="hidden absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-100 py-2 min-w-[160px] z-[9999]">
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="en" data-flag="us" data-name="English">
                  <img src="https://flagcdn.com/w20/us.png" alt="EN" class="w-5 h-3 object-cover rounded-sm" /> English
                </button>
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="ar" data-flag="sa" data-name="العربية">
                  <img src="https://flagcdn.com/w20/sa.png" alt="AR" class="w-5 h-3 object-cover rounded-sm" /> العربية
                </button>
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="ur" data-flag="pk" data-name="اردو">
                  <img src="https://flagcdn.com/w20/pk.png" alt="UR" class="w-5 h-3 object-cover rounded-sm" /> اردو
                </button>
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="fr" data-flag="fr" data-name="Français">
                  <img src="https://flagcdn.com/w20/fr.png" alt="FR" class="w-5 h-3 object-cover rounded-sm" /> Français
                </button>
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="es" data-flag="es" data-name="Español">
                  <img src="https://flagcdn.com/w20/es.png" alt="ES" class="w-5 h-3 object-cover rounded-sm" /> Español
                </button>
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="tr" data-flag="tr" data-name="Türkçe">
                  <img src="https://flagcdn.com/w20/tr.png" alt="TR" class="w-5 h-3 object-cover rounded-sm" /> Türkçe
                </button>
                <button type="button" class="language-option w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-50 flex items-center gap-3 text-sm" data-lang="bn" data-flag="bd" data-name="বাংলা">
                  <img src="https://flagcdn.com/w20/bd.png" alt="BN" class="w-5 h-3 object-cover rounded-sm" /> বাংলা
                </button>
              </div>
            </div>

            <a href="/contact" class="text-white/80 hover:text-white transition uppercase tracking-wide">Contact Us</a>
            <a href="/zakat-calculator" class="text-white/80 hover:text-white transition uppercase tracking-wide">Zakat Calculator</a>
          </div>
          <div class="flex flex-col items-center text-center">
            <span class="text-white/60 italic text-xs">Donation Line</span>
            <a href="tel:+18009000027" class="text-white hover:text-[#D97706] transition text-xs uppercase tracking-wide font-medium">
              1(800) 900 0027
            </a>
          </div>
        </div>

        <!-- BOTTOM ROW -->
        <div class="flex items-center">
          <div class="flex-1 flex items-center justify-center gap-2" id="nav-menus-container">
            <!-- Our Work with Mega Menu -->
            {isMenuActive('our-work') && (
            <div class="relative" id="our-work-trigger" style={`order: ${menuOrder.indexOf('our-work')}`}>
              <button type="button" class="nav-link flex items-center gap-2" id="our-work-btn">
                {menuNames['our-work']?.toUpperCase() || 'OUR WORK'}
                <svg class="w-3 h-3 transition-transform" id="our-work-arrow" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>

              <!-- OUR WORK MEGA MENU -->
              <div id="our-work-mega-menu" class="mega-menu-panel fixed left-0 right-0 z-[9999] hidden w-full max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8" style="top: var(--menu-top, 72px);">
                {useCustomWidgets['our-work'] ? (
                  <DynamicMegaMenu menuId="our-work" menuColor={menuColors['our-work'] || '#D97718'} widgets={getMenuWidgets(widgets, 'our-work')} campaignsByCategory={rawCampaigns} dbCategories={getCategoriesForMenu('our-work')} />
                ) : (
                <div class="bg-[#f8f6f2] shadow-[0_25px_80px_rgba(0,0,0,0.2)] rounded-b-xl overflow-hidden">
                  <!-- Orange top border -->
                  <div class="h-1 bg-[#D97718]"></div>

                  <div class="flex">
                    <!-- Left Column - Categories (Tabs) -->
                    <div class="w-[280px] bg-[#f8f6f2] py-3 flex-shrink-0">
                      <nav class="space-y-0">
                        {categories.map((cat, index) => (
                          <button
                            type="button"
                            class={`mega-category-btn w-full flex items-center gap-3 px-4 py-2.5 transition-colors border-b border-gray-200/60 text-left ${index === 0 ? 'bg-[#fbefdd]' : 'hover:bg-[#fbefdd]'}`}
                            data-category={cat.id}
                            data-label={cat.label}
                          >
                            <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0" style={`background-color: ${cat.color}`}>
                              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20" set:html={getIconSvg(cat.icon)} />
                            </div>
                            <span class="flex-1 font-medium text-[#333] text-[15px]">{cat.label}</span>
                            <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                          </button>
                        ))}
                        <a href="/appeals" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors text-left">
                          <div class="w-8 h-8 bg-[#db2777] rounded flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">View All Appeals</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                          </svg>
                        </a>
                      </nav>
                    </div>

                    <!-- Middle Column - Campaign Cards (Dynamic) -->
                    <div class="flex-1 bg-[#f8f6f2] p-6 border-l border-r border-gray-200/60">
                      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                        Popular Appeals & Projects in <span id="category-title" class="text-[#333] font-bold">Emergencies</span>
                      </p>

                      <div id="campaigns-grid" class="grid grid-cols-2 gap-3 mb-4 max-h-[280px] overflow-y-auto pr-1 custom-scrollbar">
                        <!-- Campaigns will be populated by JavaScript -->
                      </div>

                      <div id="no-campaigns-message" class="hidden text-center py-8 text-gray-500">
                        <p>No campaigns in this category yet.</p>
                        <a href="/appeals" class="text-[#D97718] hover:underline mt-2 inline-block">View all appeals</a>
                      </div>

                      <a id="view-all-link" href="/appeals" class="block w-full bg-[#D97718] hover:bg-[#c46a14] text-white font-semibold py-2.5 rounded-full text-center transition text-[15px]">
                        All Projects & Appeals in Emergencies
                      </a>
                    </div>

                    <!-- Right Column - Orphan Sponsorship Promotion -->
                    <div class="w-[280px] p-4 flex-shrink-0">
                      <a href="/appeals/sponsor-an-orphan" class="block bg-gradient-to-br from-[#01534d] to-[#013d38] rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 group">
                        <div class="relative h-32 overflow-hidden">
                          <img src="https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=400&q=80" alt="Sponsor an Orphan" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                          <div class="absolute inset-0 bg-gradient-to-t from-[#01534d] to-transparent"></div>
                          <div class="absolute bottom-2 left-3 right-3">
                            <span class="inline-block bg-[#D97718] text-white text-xs font-bold px-2 py-1 rounded">FEATURED</span>
                          </div>
                        </div>
                        <div class="p-4 text-white">
                          <h4 class="font-bold text-lg mb-1">Sponsor an Orphan</h4>
                          <p class="text-white/80 text-sm mb-3">Change a child's life with monthly support for education, food & healthcare.</p>
                          <div class="flex items-center justify-between mb-3">
                            <div>
                              <p class="text-xs text-white/60">Starting from</p>
                              <p class="text-2xl font-bold text-[#D97718]">$50<span class="text-sm font-normal text-white/80">/month</span></p>
                            </div>
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                              </svg>
                            </div>
                          </div>
                          <div class="bg-[#D97718] hover:bg-[#c56a15] text-white font-bold py-2.5 rounded-lg text-center transition flex items-center justify-center gap-2">
                            Sponsor Now
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                            </svg>
                          </div>
                        </div>
                      </a>
                    </div>
                  </div>
                </div>
                )}
              </div>
            </div>
            )}

            <!-- Zakat with Mega Menu -->
            {isMenuActive('zakat') && (
            <div class="relative" id="zakat-trigger" style={`order: ${menuOrder.indexOf('zakat')}`}>
              <button type="button" class="nav-link flex items-center gap-2" id="zakat-btn">
                {menuNames['zakat'].toUpperCase()}
                <svg class="w-3 h-3 transition-transform" id="zakat-arrow" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>

              <!-- ZAKAT MEGA MENU -->
              <div id="zakat-mega-menu" class="mega-menu-panel fixed left-0 right-0 z-[9999] hidden w-full max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8" style="top: var(--menu-top, 72px);">
                {useCustomWidgets['zakat'] ? (
                  <DynamicMegaMenu menuId="zakat" menuColor={menuColors['zakat'] || '#0096D6'} widgets={getMenuWidgets(widgets, 'zakat')} campaignsByCategory={rawCampaigns} dbCategories={getCategoriesForMenu('zakat')} />
                ) : (
                <div class="bg-[#f8f6f2] shadow-[0_25px_80px_rgba(0,0,0,0.2)] rounded-b-xl overflow-hidden">
                  <div class="h-1 bg-[#0096D6]"></div>
                  <div class="flex">
                    <!-- Left Column - Zakat Links -->
                    <div class="w-[280px] bg-[#f8f6f2] py-3 flex-shrink-0">
                      <nav class="space-y-0">
                        <a href="/zakat" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#e6f4fa] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#0096D6]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Pay Your Zakat</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/zakat-calculator" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#e6f4fa] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#16a34a]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zm-3 1a1 1 0 10-2 0v2a1 1 0 102 0v-2zm-3-1a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Zakat Calculator</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/zakat-faq" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#e6f4fa] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#7c3aed]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Zakat FAQ</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/what-is-zakat" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#e6f4fa] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#ea580c]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">What is Zakat?</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/zakat-on-gold" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#e6f4fa] transition-colors">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#eab308]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v14l3.5-2 3.5 2 3.5-2 3.5 2V4a2 2 0 00-2-2H5zm2.5 3a1.5 1.5 0 100 3 1.5 1.5 0 000-3zm6.207.293a1 1 0 00-1.414 0l-6 6a1 1 0 101.414 1.414l6-6a1 1 0 000-1.414zM12.5 10a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Zakat on Gold & Silver</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                      </nav>
                    </div>

                    <!-- Middle Column - Zakat Info -->
                    <div class="flex-1 bg-[#f8f6f2] p-6 border-l border-r border-gray-200/60">
                      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Understanding Zakat</p>
                      <div class="bg-white rounded-xl p-5 border border-gray-100 mb-4">
                        <h4 class="font-bold text-[#333] mb-2" style="font-family: 'Signika', sans-serif;">The Third Pillar of Islam</h4>
                        <p class="text-sm text-gray-600 mb-3">Zakat is an obligatory form of charity for Muslims who meet the necessary criteria of wealth (nisab). It purifies your wealth and helps those in need.</p>
                        <div class="grid grid-cols-2 gap-3 text-center">
                          <a href="/zakat-calculator" class="bg-[#e6f4fa] rounded-lg p-3 hover:bg-[#cce9f5] transition-colors block">
                            <p class="text-2xl font-bold text-[#0096D6]">2.5%</p>
                            <p class="text-xs text-gray-600">Of qualifying wealth</p>
                          </a>
                          <a href="/zakat-calculator" class="bg-[#fef3c7] rounded-lg p-3 hover:bg-[#fde68a] transition-colors block">
                            <p class="text-2xl font-bold text-[#eab308]">$5,500</p>
                            <p class="text-xs text-gray-600">Approx. Nisab threshold</p>
                          </a>
                        </div>
                      </div>
                      <a href="/zakat-calculator" class="block w-full bg-[#0096D6] hover:bg-[#0077b3] text-white font-semibold py-2.5 rounded-full text-center transition text-[15px]">
                        Calculate Your Zakat Now
                      </a>
                    </div>

                    <!-- Right Column - Quick Zakat -->
                    <div class="w-[280px] p-4 flex-shrink-0">
                      <div class="bg-white rounded-xl p-4 shadow-lg border border-gray-100">
                        <p class="text-[15px] text-[#0096D6] italic text-center mb-0.5" style="font-family: 'Playfair Display', serif;">Give Zakat</p>
                        <h4 class="text-lg font-bold text-[#333] text-center mb-3">Quick Zakat Payment</h4>
                        <div class="grid grid-cols-3 gap-1.5 mb-3">
                          <button class="zakat-amount-btn py-2 border border-gray-300 rounded bg-white text-[#333] font-bold text-[15px] hover:border-[#0096D6] transition" data-amount="100">$100</button>
                          <button class="zakat-amount-btn py-2 border border-gray-300 rounded bg-white text-[#333] font-bold text-[15px] hover:border-[#0096D6] transition" data-amount="250">$250</button>
                          <button class="zakat-amount-btn py-2 border-2 border-[#0096D6] bg-white text-[#333] rounded font-bold text-[15px]" data-amount="500">$500</button>
                        </div>
                        <div class="relative mb-3">
                          <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm">$</span>
                          <input type="number" placeholder="Enter Zakat amount" class="w-full pl-6 pr-2 py-2 border border-gray-300 rounded bg-[#f5f3ef] text-sm focus:border-[#0096D6] focus:outline-none" />
                        </div>
                        <a href="/zakat" class="block w-full bg-[#0096D6] hover:bg-[#0077b3] text-white font-bold py-2.5 rounded transition text-[15px] text-center">
                          Pay Zakat Now
                        </a>
                        <p class="text-xs text-gray-500 text-center mt-2">100% Zakat policy - all funds reach those in need</p>
                      </div>
                    </div>
                  </div>
                </div>
                )}
              </div>
            </div>
            )}

            <!-- Appeals Menu with Mega Menu -->
            {isMenuActive('appeals') && (
            <div class="relative" id="appeals-trigger" style={`order: ${menuOrder.indexOf('appeals')}`}>
              <button type="button" class="nav-link flex items-center gap-2" id="appeals-btn">
                {menuNames['appeals']?.toUpperCase() || 'APPEALS'}
                <svg class="w-3 h-3 transition-transform" id="appeals-arrow" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>

              <!-- APPEALS MEGA MENU -->
              <div id="appeals-mega-menu" class="mega-menu-panel fixed left-0 right-0 z-[9999] hidden w-full max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8" style="top: var(--menu-top, 72px);">
                {useCustomWidgets['appeals'] ? (
                  <DynamicMegaMenu menuId="appeals" menuColor={menuColors['appeals'] || '#024139'} widgets={getMenuWidgets(widgets, 'appeals')} campaignsByCategory={rawCampaigns} dbCategories={getCategoriesForMenu('appeals')} />
                ) : (
                <div class="bg-[#f8f6f2] shadow-[0_25px_80px_rgba(0,0,0,0.2)] rounded-b-xl overflow-hidden">
                  <div class="h-1 bg-[#024139]"></div>
                  <div class="flex">
                    <!-- Left Column - Ramadan Links -->
                    <div class="w-[280px] bg-[#f8f6f2] py-3 flex-shrink-0">
                      <nav class="space-y-0">
                        <a href="/ramadan" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#024139]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Ramadan 2026</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/30-days-of-ramadan" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors border-b border-gray-200/60 bg-gradient-to-r from-[#024139]/5 to-transparent">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-gradient-to-br from-[#024139] to-[#013028]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                          </div>
                          <div class="flex-1">
                            <span class="font-medium text-[#333] text-[15px]">30 Days of Ramadan</span>
                            <span class="block text-xs text-[#024139]">Automate Your Giving</span>
                          </div>
                          <svg class="w-3.5 h-3.5 text-[#024139]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/fidya" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#16a34a]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Fidya</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/kaffarah" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#dc2626]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Kaffarah</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/zakat-ul-fitr" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#0096D6]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Zakat ul-Fitr</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/iftar" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#ea580c]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 3a1 1 0 011-1h.01a1 1 0 010 2H7a1 1 0 01-1-1zm2 3a1 1 0 00-2 0v1a2 2 0 00-2 2v1a2 2 0 00-2 2v.683a3.7 3.7 0 011.055.485 1.704 1.704 0 001.89 0 3.704 3.704 0 014.11 0 1.704 1.704 0 001.89 0 3.704 3.704 0 014.11 0 1.704 1.704 0 001.89 0A3.7 3.7 0 0118 12.683V12a2 2 0 00-2-2V9a2 2 0 00-2-2V6a1 1 0 10-2 0v1h-1V6a1 1 0 10-2 0v1H8V6zm10 8.868a3.704 3.704 0 01-4.055-.036 1.704 1.704 0 00-1.89 0 3.704 3.704 0 01-4.11 0 1.704 1.704 0 00-1.89 0A3.704 3.704 0 012 14.868V17a1 1 0 001 1h14a1 1 0 001-1v-2.132z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Feed Iftar</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/food-packs" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#024139]/10 transition-colors">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#eab308]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Food Packs</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                      </nav>
                    </div>

                    <!-- Middle Column - Ramadan Info -->
                    <div class="flex-1 bg-[#f8f6f2] p-6 border-l border-r border-gray-200/60">
                      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Ramadan 2026</p>
                      <div class="bg-gradient-to-br from-[#024139] to-[#013028] rounded-xl p-5 text-white mb-4">
                        <h4 class="font-bold text-xl mb-2" style="font-family: 'Signika', sans-serif;">The Blessed Month</h4>
                        <p class="text-sm text-white/90 mb-3">Multiply your rewards this Ramadan. Every good deed is multiplied many times over during this sacred month.</p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                          <a href="/ramadan" class="bg-white/20 rounded-lg p-2 hover:bg-white/30 transition-colors block">
                            <p class="text-lg font-bold">$10</p>
                            <p class="text-xs text-white/80">Fidya/day</p>
                          </a>
                          <a href="/ramadan" class="bg-white/20 rounded-lg p-2 hover:bg-white/30 transition-colors block">
                            <p class="text-lg font-bold">$15</p>
                            <p class="text-xs text-white/80">Zakat ul-Fitr</p>
                          </a>
                          <a href="/ramadan" class="bg-white/20 rounded-lg p-2 hover:bg-white/30 transition-colors block">
                            <p class="text-lg font-bold">$5</p>
                            <p class="text-xs text-white/80">Feed Iftar</p>
                          </a>
                        </div>
                      </div>
                      <a href="/ramadan" class="block w-full bg-[#024139] hover:bg-[#013028] text-white font-semibold py-2.5 rounded-full text-center transition text-[15px]">
                        Explore Ramadan Giving
                      </a>
                    </div>

                    <!-- Right Column - 30 Days of Ramadan Promotion -->
                    <div class="w-[280px] p-4 flex-shrink-0">
                      <a href="/30-days-of-ramadan" class="block bg-gradient-to-br from-[#024139] to-[#012d28] rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 group">
                        <div class="relative h-28 overflow-hidden bg-[#024139]">
                          <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                              <div class="flex items-center justify-center gap-1 mb-1">
                                <svg class="w-5 h-5 text-[#D97718]" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                <span class="text-4xl font-bold text-white">30</span>
                              </div>
                              <p class="text-white/90 text-sm font-medium">Days of Giving</p>
                            </div>
                          </div>
                          <div class="absolute top-2 right-2">
                            <span class="inline-block bg-[#D97718] text-white text-xs font-bold px-2 py-1 rounded">AUTOMATE</span>
                          </div>
                        </div>
                        <div class="p-4 text-white">
                          <h4 class="font-bold text-lg mb-1">30 Days of Ramadan</h4>
                          <p class="text-white/80 text-sm mb-3">Automate your daily giving throughout Ramadan. Set it once, earn rewards every day.</p>
                          <div class="flex items-center gap-2 mb-3 text-sm">
                            <div class="flex items-center gap-1 text-white/80">
                              <svg class="w-4 h-4 text-[#D97718]" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                              <span>Auto-scheduled</span>
                            </div>
                            <div class="flex items-center gap-1 text-white/80">
                              <svg class="w-4 h-4 text-[#D97718]" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                              <span>Daily rewards</span>
                            </div>
                          </div>
                          <div class="bg-[#D97718] hover:bg-[#c56a15] text-white font-bold py-2.5 rounded-lg text-center transition flex items-center justify-center gap-2">
                            Start Giving
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                            </svg>
                          </div>
                        </div>
                      </a>
                    </div>
                  </div>
                </div>
                )}
              </div>
            </div>
            )}

            <!-- About Us with Mega Menu -->
            {isMenuActive('about') && (
            <div class="relative" id="about-trigger" style={`order: ${menuOrder.indexOf('about')}`}>
              <button type="button" class="nav-link flex items-center gap-2" id="about-btn">
                {menuNames['about'].toUpperCase()}
                <svg class="w-3 h-3 transition-transform" id="about-arrow" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>

              <!-- ABOUT US MEGA MENU -->
              <div id="about-mega-menu" class="mega-menu-panel fixed left-0 right-0 z-[9999] hidden w-full max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8" style="top: var(--menu-top, 72px);">
                {useCustomWidgets['about'] ? (
                  <DynamicMegaMenu menuId="about" menuColor={menuColors['about'] || '#D97718'} widgets={getMenuWidgets(widgets, 'about')} campaignsByCategory={rawCampaigns} dbCategories={getCategoriesForMenu('about')} />
                ) : (
                <div class="bg-[#f8f6f2] shadow-[0_25px_80px_rgba(0,0,0,0.2)] rounded-b-xl overflow-hidden">
                  <div class="h-1 bg-[#D97718]"></div>
                  <div class="flex">
                    <!-- Left Column - About Links -->
                    <div class="w-[280px] bg-[#f8f6f2] py-3 flex-shrink-0">
                      <nav class="space-y-0">
                        <a href="/about" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#D97718]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Our Story</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <!-- Hidden for now - Our Team page
                        <a href="/team" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#0096D6]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Our Team</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        -->
                        <a href="/reports" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#16a34a]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Annual Reports</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/impact" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#7c3aed]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Our Impact</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/media" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors border-b border-gray-200/60">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#dc2626]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Media Center</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        <a href="/contact" class="mega-link w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#fbefdd] transition-colors">
                          <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-[#333]">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                          </div>
                          <span class="flex-1 font-medium text-[#333] text-[15px]">Contact Us</span>
                          <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                      </nav>
                    </div>

                    <!-- Middle Column - Impact Stats -->
                    <div class="flex-1 bg-[#f8f6f2] p-6 border-l border-r border-gray-200/60">
                      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Our Impact</p>
                      <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-white rounded-xl p-4 text-center border border-gray-100">
                          <p class="text-3xl font-bold text-[#D97718]" style="font-family: 'Signika', sans-serif;">25+</p>
                          <p class="text-xs text-gray-600">Years of Service</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center border border-gray-100">
                          <p class="text-3xl font-bold text-[#0096D6]" style="font-family: 'Signika', sans-serif;">53+</p>
                          <p class="text-xs text-gray-600">Countries Served</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center border border-gray-100">
                          <p class="text-3xl font-bold text-[#16a34a]" style="font-family: 'Signika', sans-serif;">2M+</p>
                          <p class="text-xs text-gray-600">Lives Impacted</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center border border-gray-100">
                          <p class="text-3xl font-bold text-[#7c3aed]" style="font-family: 'Signika', sans-serif;">100%</p>
                          <p class="text-xs text-gray-600">Zakat Policy</p>
                        </div>
                      </div>
                      <a href="/about" class="block w-full bg-[#D97718] hover:bg-[#c46a14] text-white font-semibold py-2.5 rounded-full text-center transition text-[15px]">
                        Learn More About Us
                      </a>
                    </div>

                    <!-- Right Column - Newsletter -->
                    <div class="w-[280px] p-4 flex-shrink-0">
                      <div class="bg-white rounded-xl p-4 shadow-lg border border-gray-100">
                        <p class="text-[15px] text-[#D97718] italic text-center mb-0.5" style="font-family: 'Playfair Display', serif;">Stay Connected</p>
                        <h4 class="text-lg font-bold text-[#333] text-center mb-3">Newsletter</h4>
                        <p class="text-xs text-gray-600 text-center mb-3">Get updates on our projects and impact stories delivered to your inbox.</p>
                        <input type="email" placeholder="Enter your email" class="w-full px-3 py-2 border border-gray-300 rounded bg-[#f5f3ef] text-sm focus:border-[#D97718] focus:outline-none mb-2" />
                        <button class="w-full bg-[#D97718] hover:bg-[#c46a14] text-white font-bold py-2.5 rounded transition text-[15px]">
                          Subscribe
                        </button>
                        <div class="flex justify-center gap-3 mt-3">
                          <a href="#" class="text-gray-400 hover:text-[#1877f2] transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>
                          <a href="#" class="text-gray-400 hover:text-[#1da1f2] transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a>
                          <a href="#" class="text-gray-400 hover:text-[#e4405f] transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                )}
              </div>
            </div>
            )}

            {/* Dynamic Extra Menus - for any menus created beyond the 4 hardcoded ones */}
            {extraMenus.map(menu => (
              <div class="relative" id={`${menu.id}-trigger`} style={`order: ${menu.order}`}>
                <button type="button" class="nav-link flex items-center gap-2 dynamic-menu-btn" id={`${menu.id}-btn`} data-menu-id={menu.id}>
                  {menu.name.toUpperCase()}
                  <svg class="w-3 h-3 transition-transform dynamic-menu-arrow" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </button>

                {/* Dynamic Mega Menu */}
                <div id={`${menu.id}-mega-menu`} class="mega-menu-panel dynamic-mega-menu fixed left-0 right-0 z-[9999] hidden w-full max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8" style="top: var(--menu-top, 72px);">
                  {menu.hasWidgets ? (
                    <DynamicMegaMenu menuId={menu.id} menuColor={menu.color} widgets={getMenuWidgets(widgets, menu.id)} campaignsByCategory={rawCampaigns} dbCategories={getCategoriesForMenu(menu.id)} />
                  ) : (
                    <div class="bg-[#f8f6f2] shadow-[0_25px_80px_rgba(0,0,0,0.2)] rounded-b-xl overflow-hidden">
                      <div class="h-1" style={`background-color: ${menu.color}`}></div>
                      <div class="p-8 text-center">
                        <p class="text-gray-500 mb-4">No widgets configured for this menu yet.</p>
                        <a href="/admin/menu-builder" class="text-[#01534d] hover:underline">Configure in Menu Builder →</a>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          <!-- Right side -->
          <div class="flex items-center gap-4">
            <button type="button" id="navbar-cart-btn" class="flex items-center gap-1 text-white hover:text-[#D97706] transition" onclick="openCart()" aria-label="Open donation cart">
              <span class="cart-total text-sm">$0.00</span>
              <div class="relative">
                <svg class="w-5 h-5 text-[#D97706]" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
                </svg>
                <span id="cart-badge" class="absolute -top-2 -right-2 bg-[#D97706] text-white text-xs w-4 h-4 rounded-full flex items-center justify-center font-bold" style="display: none;">0</span>
              </div>
            </button>
            <a href="/donate" class="donate-btn">
              DONATE NOW
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>

      <!-- Mobile Cart & Menu Buttons -->
      <div class="lg:hidden flex items-center gap-1 ml-auto">
        <!-- Mobile Cart Button -->
        <button type="button" id="mobile-navbar-cart-btn" onclick="openCart()" class="relative text-white p-3 hover:text-[#D97706] transition" aria-label="Open donation cart">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
          </svg>
          <span id="mobile-cart-badge" class="absolute top-1 right-1 bg-[#D97706] text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold" style="display: none;">0</span>
        </button>

        <!-- Mobile Menu Button -->
        <button type="button" class="text-white p-3 -mr-2" id="mobile-menu-btn" aria-label="Open mobile menu" aria-expanded="false">
          <svg class="w-6 h-6 mobile-menu-open-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg class="w-6 h-6 mobile-menu-close-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu - Accordion Style -->
  <div class="hidden lg:hidden bg-[#f8f6f2] shadow-lg max-h-[85vh] overflow-y-auto" id="mobile-menu">
    <div class="px-4 py-4 space-y-1">

      {/* Render all menus in database order */}
      {allMenusSorted.map(menu => (
        menu.id === 'ramadan' ? (
          /* Ramadan Menu */
          <div class="mobile-accordion" data-menu="ramadan">
            <button type="button" class="mobile-accordion-btn w-full flex items-center justify-between py-3 text-[#333] font-medium border-b border-gray-200">
              <span style="font-family: 'Oswald', sans-serif;" class="text-[#024139]">{menu.name.toUpperCase()}</span>
              <svg class="mobile-accordion-icon w-4 h-4 transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-accordion-content hidden pl-4 pb-3 space-y-1">
              <a href="/ramadan" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#024139] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#024139]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </div>
                <span class="text-sm">Ramadan Home</span>
              </a>
              <a href="/ramadan-giving" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#024139] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#024139]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Ramadan Giving</span>
              </a>
              <a href="/fidya" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#16a34a] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#16a34a]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Fidya</span>
              </a>
              <a href="/kaffarah" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#dc2626] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#dc2626]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Kaffarah</span>
              </a>
              <a href="/zakat-ul-fitr" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#0096D6] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#0096D6]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                </div>
                <span class="text-sm">Zakat ul-Fitr</span>
              </a>
              <a href="/iftar" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#ea580c] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#ea580c]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 3a1 1 0 011-1h.01a1 1 0 010 2H7a1 1 0 01-1-1zm2 3a1 1 0 00-2 0v1a2 2 0 00-2 2v1a2 2 0 00-2 2v.683a3.7 3.7 0 011.055.485 1.704 1.704 0 001.89 0 3.704 3.704 0 014.11 0 1.704 1.704 0 001.89 0 3.704 3.704 0 014.11 0 1.704 1.704 0 001.89 0A3.7 3.7 0 0118 12.683V12a2 2 0 00-2-2V9a2 2 0 00-2-2V6a1 1 0 10-2 0v1h-1V6a1 1 0 10-2 0v1H8V6z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Iftar Meals</span>
              </a>
              <a href="/ramadan/food-packs" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#ca8a04] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#ca8a04]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z"></path></svg>
                </div>
                <span class="text-sm">Food Packs</span>
              </a>
            </div>
          </div>
        ) : menu.id === 'our-work' ? (
          /* Our Work Menu */
          <div class="mobile-accordion" data-menu="our-work">
            <button type="button" class="mobile-accordion-btn w-full flex items-center justify-between py-3 text-[#333] font-medium border-b border-gray-200">
              <span style="font-family: 'Oswald', sans-serif;">{menu.name.toUpperCase()}</span>
              <svg class="mobile-accordion-icon w-4 h-4 transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-accordion-content hidden pl-2 pb-3 space-y-1">
              {/* Categories as expandable sub-accordions */}
              {categories.map(cat => (
                <div class="mobile-sub-accordion" data-category={cat.id}>
                  <button type="button" class="mobile-sub-accordion-btn w-full flex items-center justify-between py-2 text-gray-700 hover:text-[#D97718] transition">
                    <div class="flex items-center gap-2">
                      <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0" style={`background-color: ${cat.color}`}>
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20" set:html={getIconSvg(cat.icon)} />
                      </div>
                      <span class="text-sm font-medium">{cat.label}</span>
                    </div>
                    <svg class="mobile-sub-accordion-icon w-3 h-3 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                  <div class="mobile-sub-accordion-content hidden pl-8 pb-2 space-y-1">
                    {(campaignsByCategory[cat.id] || []).slice(0, 6).map(campaign => (
                      <a href={campaign.slug} class="block py-1.5 text-sm text-gray-600 hover:text-[#D97718] transition">
                        {campaign.name}
                      </a>
                    ))}
                    <a href={`/appeals?category=${cat.id}`} class="block py-1.5 text-xs text-[#D97718] font-medium">
                      View All {cat.label} →
                    </a>
                  </div>
                </div>
              ))}
              <a href="/appeals" class="flex items-center gap-2 py-2 text-[#D97718] hover:text-[#c46a14] transition mt-2 border-t border-gray-200 pt-3">
                <span class="text-sm font-medium">View All Appeals →</span>
              </a>
            </div>
          </div>
        ) : menu.id === 'zakat' ? (
          /* Zakat Menu */
          <div class="mobile-accordion" data-menu="zakat">
            <button type="button" class="mobile-accordion-btn w-full flex items-center justify-between py-3 text-[#333] font-medium border-b border-gray-200">
              <span style="font-family: 'Oswald', sans-serif;">{menu.name.toUpperCase()}</span>
              <svg class="mobile-accordion-icon w-4 h-4 transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-accordion-content hidden pl-4 pb-3 space-y-1">
              <a href="/zakat" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#0096D6] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#0096D6]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                </div>
                <span class="text-sm">Pay Your Zakat</span>
              </a>
              <a href="/zakat-calculator" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#16a34a] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#16a34a]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7z"></path></svg>
                </div>
                <span class="text-sm">Zakat Calculator</span>
              </a>
              <a href="/zakat-faq" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#7c3aed] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#7c3aed]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Zakat FAQ</span>
              </a>
              <a href="/what-is-zakat" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#ea580c] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#ea580c]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path></svg>
                </div>
                <span class="text-sm">What is Zakat?</span>
              </a>
            </div>
          </div>
        ) : menu.id === 'about' ? (
          /* About Menu */
          <div class="mobile-accordion" data-menu="about">
            <button type="button" class="mobile-accordion-btn w-full flex items-center justify-between py-3 text-[#333] font-medium border-b border-gray-200">
              <span style="font-family: 'Oswald', sans-serif;">{menu.name.toUpperCase()}</span>
              <svg class="mobile-accordion-icon w-4 h-4 transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-accordion-content hidden pl-4 pb-3 space-y-1">
              <a href="/about" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#D97718] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#D97718]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Our Story</span>
              </a>
              <a href="/reports" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#16a34a] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#16a34a]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Annual Reports</span>
              </a>
              <a href="/impact" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#7c3aed] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#7c3aed]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Our Impact</span>
              </a>
              <a href="/media" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#dc2626] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#dc2626]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>
                </div>
                <span class="text-sm">Media Center</span>
              </a>
              <a href="/contact" class="flex items-center gap-2 py-2 text-gray-700 hover:text-[#333] transition">
                <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 bg-[#333]">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                </div>
                <span class="text-sm">Contact Us</span>
              </a>
            </div>
          </div>
        ) : menu.id === 'appeals' ? (
          /* Appeals Menu - Skip if not in menuOrder (replaced by Our Work) */
          null
        ) : (
          /* Other dynamic menus */
          <div class="mobile-accordion" data-menu={menu.id}>
            <button type="button" class="mobile-accordion-btn w-full flex items-center justify-between py-3 text-[#333] font-medium border-b border-gray-200">
              <span style="font-family: 'Oswald', sans-serif;">{menu.name.toUpperCase()}</span>
              <svg class="mobile-accordion-icon w-4 h-4 transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-accordion-content hidden pl-4 pb-3">
              <a href={`/${menu.id}`} class="flex items-center gap-2 py-2 text-[#D97718] hover:text-[#c46a14] transition">
                <span class="text-sm font-medium">View {menu.name} →</span>
              </a>
            </div>
          </div>
        )
      ))}

      {/* Divider */}
      <div class="border-t border-gray-200 my-3"></div>

      {/* Quick Donate Section */}
      <div class="bg-gradient-to-br from-[#D97718] to-[#c46a14] rounded-xl p-4 mt-2">
        <p class="text-white font-semibold text-sm mb-3" style="font-family: 'Oswald', sans-serif;">QUICK DONATE</p>
        <div class="grid grid-cols-4 gap-2 mb-3">
          <a href="/donate?amount=25" class="bg-white/20 hover:bg-white/30 text-white text-center py-2 rounded-lg text-sm font-medium transition">$25</a>
          <a href="/donate?amount=50" class="bg-white/20 hover:bg-white/30 text-white text-center py-2 rounded-lg text-sm font-medium transition">$50</a>
          <a href="/donate?amount=100" class="bg-white/20 hover:bg-white/30 text-white text-center py-2 rounded-lg text-sm font-medium transition">$100</a>
          <a href="/donate?amount=250" class="bg-white/20 hover:bg-white/30 text-white text-center py-2 rounded-lg text-sm font-medium transition">$250</a>
        </div>
        <a href="/donate" class="block bg-white text-[#D97718] font-semibold py-3 rounded-lg text-center uppercase text-sm transition hover:bg-gray-100" style="font-family: 'Oswald', sans-serif;">
          Custom Amount
        </a>
      </div>
    </div>
  </div>
</header>

<!-- INSTANT SEARCH OVERLAY -->
<div id="search-overlay" class="fixed inset-0 z-[99999] hidden">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

  <!-- Search Container -->
  <div class="relative z-10 flex flex-col items-center pt-20 px-4">
    <!-- Search Box -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
      <!-- Search Input -->
      <div class="relative border-b border-gray-100">
        <svg class="absolute left-5 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="text"
          id="search-input"
          placeholder="Search campaigns, appeals, pages..."
          class="w-full pl-14 pr-12 py-5 text-lg focus:outline-none"
          autocomplete="off"
        />
        <button type="button" id="search-close" class="absolute right-4 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <!-- Initial State -->
        <div id="search-initial" class="p-6">
          <p class="text-sm text-gray-500 mb-4 font-medium">Popular Searches</p>
          <div class="flex flex-wrap gap-2">
            <button type="button" class="quick-search px-4 py-2 bg-gray-100 hover:bg-[#0096D6] hover:text-white rounded-full text-sm transition" data-query="Palestine">Palestine</button>
            <button type="button" class="quick-search px-4 py-2 bg-gray-100 hover:bg-[#0096D6] hover:text-white rounded-full text-sm transition" data-query="Zakat">Zakat</button>
            <button type="button" class="quick-search px-4 py-2 bg-gray-100 hover:bg-[#0096D6] hover:text-white rounded-full text-sm transition" data-query="Ramadan">Ramadan</button>
            <button type="button" class="quick-search px-4 py-2 bg-gray-100 hover:bg-[#0096D6] hover:text-white rounded-full text-sm transition" data-query="Water">Water</button>
            <button type="button" class="quick-search px-4 py-2 bg-gray-100 hover:bg-[#0096D6] hover:text-white rounded-full text-sm transition" data-query="Orphan">Orphan</button>
            <button type="button" class="quick-search px-4 py-2 bg-gray-100 hover:bg-[#0096D6] hover:text-white rounded-full text-sm transition" data-query="Food">Food</button>
          </div>

          <p class="text-sm text-gray-500 mb-4 mt-6 font-medium">Quick Links</p>
          <div class="grid grid-cols-2 gap-2">
            <a href="/zakat-calculator" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
              <div class="w-10 h-10 bg-[#0096D6] rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zm-3 1a1 1 0 10-2 0v2a1 1 0 102 0v-2zm-3-1a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z"></path></svg>
              </div>
              <div>
                <p class="font-medium text-gray-800 text-sm">Zakat Calculator</p>
                <p class="text-xs text-gray-500">Calculate your Zakat</p>
              </div>
            </a>
            <a href="/donate" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
              <div class="w-10 h-10 bg-[#D97718] rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
              </div>
              <div>
                <p class="font-medium text-gray-800 text-sm">Donate Now</p>
                <p class="text-xs text-gray-500">Make a difference today</p>
              </div>
            </a>
            <a href="/contact" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
              <div class="w-10 h-10 bg-[#16a34a] rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
              </div>
              <div>
                <p class="font-medium text-gray-800 text-sm">Contact Us</p>
                <p class="text-xs text-gray-500">Get in touch</p>
              </div>
            </a>
            <a href="/appeals" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
              <div class="w-10 h-10 bg-[#7c3aed] rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path></svg>
              </div>
              <div>
                <p class="font-medium text-gray-800 text-sm">All Appeals</p>
                <p class="text-xs text-gray-500">Browse all campaigns</p>
              </div>
            </a>
          </div>
        </div>

        <!-- Loading State -->
        <div id="search-loading" class="hidden p-8 text-center">
          <div class="inline-block w-8 h-8 border-4 border-[#0096D6] border-t-transparent rounded-full animate-spin"></div>
          <p class="text-gray-500 mt-3">Searching...</p>
        </div>

        <!-- Results -->
        <div id="search-results-list" class="hidden divide-y divide-gray-100">
          <!-- Results will be populated here -->
        </div>

        <!-- No Results -->
        <div id="search-no-results" class="hidden p-8 text-center">
          <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-gray-600 font-medium">No results found</p>
          <p class="text-gray-400 text-sm mt-1">Try different keywords or browse our appeals</p>
          <a href="/appeals" class="inline-block mt-4 px-6 py-2 bg-[#0096D6] text-white rounded-full text-sm font-medium hover:bg-[#0077b3] transition">
            Browse All Appeals
          </a>
        </div>
      </div>

      <!-- Keyboard Hints -->
      <div class="px-6 py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400">
        <div class="flex items-center gap-4">
          <span class="flex items-center gap-1"><kbd class="px-1.5 py-0.5 bg-white rounded border shadow-sm">↵</kbd> to select</span>
          <span class="flex items-center gap-1"><kbd class="px-1.5 py-0.5 bg-white rounded border shadow-sm">↑↓</kbd> to navigate</span>
        </div>
        <span class="flex items-center gap-1"><kbd class="px-1.5 py-0.5 bg-white rounded border shadow-sm">esc</kbd> to close</span>
      </div>
    </div>
  </div>
</div>

<style>
  .nav-link {
    font-family: 'Oswald', sans-serif;
    font-weight: 500;
    font-size: 18px;
    letter-spacing: 1px;
    color: white;
    padding: 8px 20px;
    transition: color 0.2s;
    display: flex;
    align-items: center;
  }

  .nav-link:hover {
    color: #D97706;
  }

  .donate-btn {
    font-family: 'Oswald', sans-serif;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: 0.5px;
    background: #0096D6;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
  }

  .donate-btn:hover {
    background: #0077b3;
  }

  .cart-total {
    font-family: 'Oswald', sans-serif;
    font-weight: 500;
  }

  .mobile-nav-link {
    display: block;
    color: white;
    font-family: 'Oswald', sans-serif;
    font-weight: 500;
    font-size: 16px;
    letter-spacing: 0.5px;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-transform: uppercase;
  }

  .mobile-nav-link:hover {
    color: #D97706;
  }

  .mega-category-btn {
    font-family: 'Signika', sans-serif;
  }

  .appeal-card {
    font-family: 'Signika', sans-serif;
  }

  #appeals-mega-menu {
    font-family: 'Signika', sans-serif;
  }

  #appeals-mega-menu.show,
  .mega-menu-panel.show {
    display: block;
    animation: megaFadeIn 0.15s ease-out;
  }

  @keyframes megaFadeIn {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #aaa;
  }

  .mega-category-btn.active {
    background-color: #fbefdd;
  }

  /* Search Overlay Animations */
  #search-overlay {
    animation: searchFadeIn 0.2s ease-out;
  }

  @keyframes searchFadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  #search-overlay > div:nth-child(2) > div {
    animation: searchSlideIn 0.3s ease-out;
  }

  @keyframes searchSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .search-result {
    transition: all 0.15s ease;
  }

  .search-result:hover {
    transform: translateX(4px);
  }

  /* Currency & Language Dropdown Animations */
  #currency-menu, #language-menu {
    animation: dropdownFadeIn 0.15s ease-out;
  }

  @keyframes dropdownFadeIn {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Translation Toast Animation */
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Hide Google Translate Bar */
  .goog-te-banner-frame,
  .skiptranslate,
  #goog-gt-tt,
  .goog-te-balloon-frame {
    display: none !important;
  }

  body {
    top: 0 !important;
  }

  .goog-text-highlight {
    background: none !important;
    box-shadow: none !important;
  }

  /* RTL Support */
  html.rtl {
    direction: rtl;
  }

  html.rtl .flex {
    flex-direction: row-reverse;
  }

  html.rtl .text-left {
    text-align: right;
  }

  html.rtl .text-right {
    text-align: left;
  }

  html.rtl .ml-auto {
    margin-left: 0;
    margin-right: auto;
  }

  html.rtl .mr-auto {
    margin-right: 0;
    margin-left: auto;
  }

  /* Mobile Menu Accordion Animations */
  #mobile-menu {
    transition: all 0.3s ease-out;
  }

  .mobile-accordion-content {
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.2s ease;
  }

  .mobile-accordion-content.hidden {
    max-height: 0;
    opacity: 0;
    padding-bottom: 0;
    display: block !important;
  }

  .mobile-accordion-content:not(.hidden) {
    max-height: 500px;
    opacity: 1;
  }

  .mobile-accordion-icon {
    transition: transform 0.3s ease;
  }

  .mobile-accordion-btn {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  /* Better touch targets for mobile */
  .mobile-accordion a {
    min-height: 44px;
    display: flex;
    align-items: center;
  }

  /* Active state feedback */
  .mobile-accordion-btn:active {
    opacity: 0.8;
  }
</style>

<script define:vars={{ campaignsJson }}>
  // Parse campaigns data from server
  const campaignsByCategory = JSON.parse(campaignsJson);

  document.addEventListener('DOMContentLoaded', () => {
    // Mobile menu toggle
    const mobileBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const openIcon = mobileBtn?.querySelector('.mobile-menu-open-icon');
    const closeIcon = mobileBtn?.querySelector('.mobile-menu-close-icon');

    mobileBtn?.addEventListener('click', () => {
      mobileMenu?.classList.toggle('hidden');
      // Toggle hamburger icon between bars and X
      const isOpen = !mobileMenu?.classList.contains('hidden');
      mobileBtn.setAttribute('aria-expanded', isOpen.toString());

      // Toggle icon visibility
      if (isOpen) {
        openIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
      } else {
        openIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      }
    });

    // Mobile Accordion Functionality
    document.querySelectorAll('.mobile-accordion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const accordion = btn.closest('.mobile-accordion');
        const content = accordion?.querySelector('.mobile-accordion-content');
        const icon = btn.querySelector('.mobile-accordion-icon');

        if (!content) return;

        // Close other accordions (optional - for single-open behavior)
        document.querySelectorAll('.mobile-accordion').forEach(other => {
          if (other !== accordion) {
            const otherContent = other.querySelector('.mobile-accordion-content');
            const otherIcon = other.querySelector('.mobile-accordion-icon');
            otherContent?.classList.add('hidden');
            if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
          }
        });

        // Toggle current accordion
        const isOpen = content.classList.contains('hidden');
        content.classList.toggle('hidden');
        if (icon) {
          icon.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        }
      });
    });

    // Mobile Sub-Accordion Functionality (for categories with campaigns)
    document.querySelectorAll('.mobile-sub-accordion-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const subAccordion = btn.closest('.mobile-sub-accordion');
        const content = subAccordion?.querySelector('.mobile-sub-accordion-content');
        const icon = btn.querySelector('.mobile-sub-accordion-icon');

        if (!content) return;

        // Toggle current sub-accordion
        const isOpen = content.classList.contains('hidden');
        content.classList.toggle('hidden');
        if (icon) {
          icon.style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
        }
      });
    });

    // Close mobile menu when clicking a link (except accordion buttons)
    mobileMenu?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu?.classList.add('hidden');
        mobileBtn?.setAttribute('aria-expanded', 'false');
        // Restore hamburger icon
        openIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      });
    });

    // Our Work Mega Menu (static fallback with campaign grid)
    const ourWorkTrigger = document.getElementById('our-work-trigger');
    const ourWorkBtn = document.getElementById('our-work-btn');
    const ourWorkMegaMenu = document.getElementById('our-work-mega-menu');
    const ourWorkArrow = document.getElementById('our-work-arrow');
    const campaignsGrid = document.getElementById('campaigns-grid');
    const categoryTitle = document.getElementById('category-title');
    const viewAllLink = document.getElementById('view-all-link');
    const noCampaignsMessage = document.getElementById('no-campaigns-message');

    let isMenuOpen = false;
    let closeTimeout;
    let currentCategory = 'emergencies';

    function getCampaignImage(campaign) {
      return campaign.featured_image || campaign.hero_image_url || campaign.image_url || 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=400';
    }

    function renderCampaigns(categoryId, categoryLabel) {
      // Skip if elements don't exist (when DynamicMegaMenu is used)
      if (!campaignsGrid || !categoryTitle) return;

      const campaigns = campaignsByCategory[categoryId] || [];

      // Update title
      if (categoryTitle) categoryTitle.textContent = categoryLabel;
      if (viewAllLink) {
        viewAllLink.textContent = `All Projects & Appeals in ${categoryLabel}`;
        viewAllLink.href = `/appeals?category=${categoryId}`;
      }

      // Update active state on buttons
      document.querySelectorAll('.mega-category-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-[#fbefdd]');
        if (btn.dataset.category === categoryId) {
          btn.classList.add('active', 'bg-[#fbefdd]');
        }
      });

      // Render campaigns
      if (campaigns.length === 0) {
        campaignsGrid?.classList.add('hidden');
        noCampaignsMessage?.classList.remove('hidden');
      } else {
        campaignsGrid?.classList.remove('hidden');
        noCampaignsMessage?.classList.add('hidden');

        if (campaignsGrid) {
          campaignsGrid.innerHTML = campaigns.map(campaign => `
            <a href="${campaign.slug}" class="appeal-card flex items-center gap-2.5 border border-gray-200 rounded-lg p-2 bg-white hover:shadow-md hover:border-[#D97718]/30 transition-all">
              <img src="${getCampaignImage(campaign)}" alt="${campaign.name}" class="w-16 h-12 object-cover rounded flex-shrink-0" loading="lazy" />
              <span class="text-sm font-semibold text-[#333] leading-tight line-clamp-2">${campaign.name}</span>
            </a>
          `).join('');
        }
      }

      currentCategory = categoryId;
    }

    function positionOurWorkMenu() {
      if (ourWorkBtn && ourWorkMegaMenu) {
        const rect = ourWorkBtn.getBoundingClientRect();
        const menuTop = rect.bottom + 8;
        ourWorkMegaMenu.style.setProperty('--menu-top', `${menuTop}px`);
      }
    }

    function openOurWorkMenu() {
      clearTimeout(closeTimeout);
      positionOurWorkMenu();
      ourWorkMegaMenu?.classList.add('show');
      ourWorkMegaMenu?.classList.remove('hidden');
      ourWorkArrow?.style.setProperty('transform', 'rotate(180deg)');
      isMenuOpen = true;

      // Show emergencies by default when opening
      if (currentCategory === 'emergencies') {
        renderCampaigns('emergencies', 'Emergencies');
      }
    }

    function closeOurWorkMenu() {
      closeTimeout = setTimeout(() => {
        ourWorkMegaMenu?.classList.remove('show');
        ourWorkMegaMenu?.classList.add('hidden');
        ourWorkArrow?.style.setProperty('transform', 'rotate(0deg)');
        isMenuOpen = false;
      }, 150);
    }

    ourWorkTrigger?.addEventListener('mouseenter', openOurWorkMenu);
    ourWorkTrigger?.addEventListener('mouseleave', closeOurWorkMenu);
    ourWorkMegaMenu?.addEventListener('mouseenter', openOurWorkMenu);
    ourWorkMegaMenu?.addEventListener('mouseleave', closeOurWorkMenu);

    // Category tab click handlers
    document.querySelectorAll('.mega-category-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const categoryId = btn.dataset.category;
        const categoryLabel = btn.dataset.label;
        renderCampaigns(categoryId, categoryLabel);
      });
    });

    // Initialize with emergencies
    renderCampaigns('emergencies', 'Emergencies');

    // Setup Zakat, Appeals, and About mega menus (Our Work has its own handler above for campaign grid)
    const megaMenus = [
      { trigger: 'zakat-trigger', btn: 'zakat-btn', menu: 'zakat-mega-menu', arrow: 'zakat-arrow' },
      { trigger: 'appeals-trigger', btn: 'appeals-btn', menu: 'appeals-mega-menu', arrow: 'appeals-arrow' },
      { trigger: 'about-trigger', btn: 'about-btn', menu: 'about-mega-menu', arrow: 'about-arrow' }
    ];

    megaMenus.forEach(({ trigger, btn, menu, arrow }) => {
      const triggerEl = document.getElementById(trigger);
      const btnEl = document.getElementById(btn);
      const menuEl = document.getElementById(menu);
      const arrowEl = document.getElementById(arrow);
      let closeTimer;
      let isOpen = false;

      if (!triggerEl || !menuEl) {
        console.warn('Menu elements not found:', trigger, menu);
        return;
      }

      function positionMegaMenu() {
        if (btnEl && menuEl) {
          const rect = btnEl.getBoundingClientRect();
          menuEl.style.setProperty('--menu-top', `${rect.bottom + 8}px`);
          menuEl.style.top = `${rect.bottom + 8}px`;
        }
      }

      function openMegaMenu() {
        clearTimeout(closeTimer);
        positionMegaMenu();
        menuEl.classList.add('show');
        menuEl.classList.remove('hidden');
        arrowEl?.style.setProperty('transform', 'rotate(180deg)');
        isOpen = true;
      }

      function closeMegaMenu() {
        closeTimer = setTimeout(() => {
          menuEl.classList.remove('show');
          menuEl.classList.add('hidden');
          arrowEl?.style.setProperty('transform', 'rotate(0deg)');
          isOpen = false;
        }, 150);
      }

      function toggleMegaMenu(e) {
        e.preventDefault();
        e.stopPropagation();
        if (isOpen) {
          closeMegaMenu();
        } else {
          openMegaMenu();
        }
      }

      // Hover handlers
      triggerEl.addEventListener('mouseenter', openMegaMenu);
      triggerEl.addEventListener('mouseleave', closeMegaMenu);
      menuEl.addEventListener('mouseenter', () => clearTimeout(closeTimer));
      menuEl.addEventListener('mouseleave', closeMegaMenu);

      // Click handler as fallback
      btnEl?.addEventListener('click', toggleMegaMenu);
    });

    // Setup Dynamic/Extra Menus (created by admin)
    document.querySelectorAll('.dynamic-menu-btn').forEach(btn => {
      const menuId = btn.dataset.menuId;
      const triggerEl = document.getElementById(`${menuId}-trigger`);
      const menuEl = document.getElementById(`${menuId}-mega-menu`);
      const arrowEl = btn.querySelector('.dynamic-menu-arrow');
      let closeTimer;
      let isOpen = false;

      if (!triggerEl || !menuEl) return;

      function positionMegaMenu() {
        const rect = btn.getBoundingClientRect();
        menuEl.style.setProperty('--menu-top', `${rect.bottom + 8}px`);
        menuEl.style.top = `${rect.bottom + 8}px`;
      }

      function openMegaMenu() {
        clearTimeout(closeTimer);
        positionMegaMenu();
        menuEl.classList.add('show');
        menuEl.classList.remove('hidden');
        if (arrowEl) arrowEl.style.transform = 'rotate(180deg)';
        isOpen = true;
      }

      function closeMegaMenu() {
        closeTimer = setTimeout(() => {
          menuEl.classList.remove('show');
          menuEl.classList.add('hidden');
          if (arrowEl) arrowEl.style.transform = 'rotate(0deg)';
          isOpen = false;
        }, 150);
      }

      function toggleMegaMenu(e) {
        e.preventDefault();
        e.stopPropagation();
        if (isOpen) closeMegaMenu();
        else openMegaMenu();
      }

      // Hover handlers
      triggerEl.addEventListener('mouseenter', openMegaMenu);
      triggerEl.addEventListener('mouseleave', closeMegaMenu);
      menuEl.addEventListener('mouseenter', () => clearTimeout(closeTimer));
      menuEl.addEventListener('mouseleave', closeMegaMenu);

      // Click handler
      btn.addEventListener('click', toggleMegaMenu);
    });

    // Mega menu amount buttons
    const megaAmountBtns = document.querySelectorAll('.mega-amount-btn');
    megaAmountBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        megaAmountBtns.forEach(b => {
          b.classList.remove('border-2', 'border-[#D97718]');
          b.classList.add('border', 'border-gray-300');
        });
        btn.classList.remove('border', 'border-gray-300');
        btn.classList.add('border-2', 'border-[#D97718]');
      });
    });

    // Payment toggle
    const singleBtn = document.querySelector('.mega-single-btn');
    const monthlyBtn = document.querySelector('.mega-monthly-btn');

    singleBtn?.addEventListener('click', () => {
      singleBtn.classList.add('bg-[#D97718]', 'text-white');
      singleBtn.classList.remove('bg-[#e8e6e1]', 'text-[#333]');
      monthlyBtn?.classList.remove('bg-[#D97718]', 'text-white');
      monthlyBtn?.classList.add('bg-[#e8e6e1]', 'text-[#333]');
    });

    monthlyBtn?.addEventListener('click', () => {
      monthlyBtn.classList.add('bg-[#D97718]', 'text-white');
      monthlyBtn.classList.remove('bg-[#e8e6e1]', 'text-[#333]');
      singleBtn?.classList.remove('bg-[#D97718]', 'text-white');
      singleBtn?.classList.add('bg-[#e8e6e1]', 'text-[#333]');
    });

    // Update cart display - uses 'donationCart' key (same as DonationCart component)
    function updateCartDisplay() {
      const cart = JSON.parse(localStorage.getItem('donationCart') || '[]');
      const total = cart.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);

      const totalEl = document.querySelector('.cart-total');
      const badgeEl = document.getElementById('cart-badge');
      const mobileBadgeEl = document.getElementById('mobile-cart-badge');

      if (totalEl) totalEl.textContent = `$${total.toFixed(2)}`;

      // Update desktop cart badge
      if (badgeEl) {
        if (count > 0) {
          badgeEl.style.display = 'flex';
          badgeEl.textContent = count.toString();
        } else {
          badgeEl.style.display = 'none';
        }
      }

      // Update mobile cart badge
      if (mobileBadgeEl) {
        if (count > 0) {
          mobileBadgeEl.style.display = 'flex';
          mobileBadgeEl.textContent = count.toString();
        } else {
          mobileBadgeEl.style.display = 'none';
        }
      }
    }

    updateCartDisplay();
    window.addEventListener('storage', updateCartDisplay);
    window.addEventListener('cartUpdated', updateCartDisplay);

    // =============================================
    // INSTANT SEARCH FUNCTIONALITY
    // =============================================
    const searchTrigger = document.getElementById('search-trigger');
    const searchOverlay = document.getElementById('search-overlay');
    const searchBackdrop = document.getElementById('search-backdrop');
    const searchInput = document.getElementById('search-input');
    const searchClose = document.getElementById('search-close');
    const searchInitial = document.getElementById('search-initial');
    const searchLoading = document.getElementById('search-loading');
    const searchResultsList = document.getElementById('search-results-list');
    const searchNoResults = document.getElementById('search-no-results');

    let searchTimeout;
    let allCampaigns = [];

    // Flatten all campaigns for search
    Object.values(campaignsByCategory).forEach(campaigns => {
      allCampaigns.push(...campaigns);
    });

    // Static pages for search
    const staticPages = [
      { name: 'Zakat Calculator', slug: '/zakat-calculator', description: 'Calculate your Zakat obligation', type: 'page' },
      { name: 'Pay Zakat', slug: '/zakat', description: 'Pay your Zakat online', type: 'page' },
      { name: 'Donate Now', slug: '/donate', description: 'Make a donation', type: 'page' },
      { name: 'Contact Us', slug: '/contact', description: 'Get in touch with us', type: 'page' },
      { name: 'About Us', slug: '/about', description: 'Learn about our organization', type: 'page' },
      { name: 'All Appeals', slug: '/appeals', description: 'Browse all our campaigns', type: 'page' },
      { name: 'Ramadan 2026', slug: '/ramadan', description: 'Ramadan giving opportunities', type: 'page' },
      { name: 'Fidya', slug: '/fidya', description: 'Pay Fidya for missed fasts', type: 'page' },
      { name: 'Kaffarah', slug: '/kaffarah', description: 'Pay Kaffarah for broken fasts', type: 'page' },
      { name: 'Zakat ul-Fitr', slug: '/zakat-ul-fitr', description: 'Pay Zakat ul-Fitr', type: 'page' },
      { name: 'Feed Iftar', slug: '/iftar', description: 'Sponsor Iftar meals', type: 'page' },
      { name: 'Food Packs', slug: '/food-packs', description: 'Provide food packs to families', type: 'page' },
      { name: 'Orphan Sponsorship', slug: '/orphans/sponsor-an-orphan', description: 'Sponsor an orphan child', type: 'page' },
      { name: 'Water Wells', slug: '/appeals/water-wells', description: 'Build water wells', type: 'page' },
    ];

    function openSearch() {
      searchOverlay?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => searchInput?.focus(), 100);
    }

    function closeSearch() {
      searchOverlay?.classList.add('hidden');
      document.body.style.overflow = '';
      if (searchInput) searchInput.value = '';
      showInitialState();
    }

    function showInitialState() {
      searchInitial?.classList.remove('hidden');
      searchLoading?.classList.add('hidden');
      searchResultsList?.classList.add('hidden');
      searchNoResults?.classList.add('hidden');
    }

    function showLoading() {
      searchInitial?.classList.add('hidden');
      searchLoading?.classList.remove('hidden');
      searchResultsList?.classList.add('hidden');
      searchNoResults?.classList.add('hidden');
    }

    function showResults(results) {
      searchInitial?.classList.add('hidden');
      searchLoading?.classList.add('hidden');
      searchNoResults?.classList.add('hidden');

      if (results.length === 0) {
        searchResultsList?.classList.add('hidden');
        searchNoResults?.classList.remove('hidden');
        return;
      }

      searchResultsList?.classList.remove('hidden');

      searchResultsList.innerHTML = results.map((item, index) => `
        <a href="${item.slug}"
           class="search-result flex items-center gap-4 p-4 hover:bg-gray-50 transition ${index === 0 ? 'bg-gray-50' : ''}"
           data-index="${index}">
          ${item.type === 'page' ? `
            <div class="w-14 h-14 bg-gradient-to-br from-[#0096D6] to-[#0077b3] rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
              </svg>
            </div>
          ` : `
            <img src="${item.featured_image || item.hero_image_url || item.image_url || 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=100'}"
                 alt="${item.name}"
                 class="w-14 h-14 object-cover rounded-lg flex-shrink-0" />
          `}
          <div class="flex-1 min-w-0">
            <p class="font-semibold text-gray-800 truncate">${item.name}</p>
            <p class="text-sm text-gray-500 truncate">${item.description || 'Campaign'}</p>
          </div>
          <div class="flex-shrink-0">
            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">${item.type === 'page' ? 'Page' : 'Appeal'}</span>
          </div>
        </a>
      `).join('');
    }

    function performSearch(query) {
      const q = query.toLowerCase().trim();

      if (!q) {
        showInitialState();
        return;
      }

      showLoading();

      // Simulate search delay for better UX
      setTimeout(() => {
        // Search campaigns
        const campaignResults = allCampaigns.filter(c =>
          c.name?.toLowerCase().includes(q) ||
          c.slug?.toLowerCase().includes(q)
        ).map(c => ({ ...c, type: 'campaign' }));

        // Search static pages
        const pageResults = staticPages.filter(p =>
          p.name.toLowerCase().includes(q) ||
          p.description.toLowerCase().includes(q)
        );

        // Combine and limit results
        const allResults = [...pageResults, ...campaignResults].slice(0, 8);

        showResults(allResults);
      }, 150);
    }

    // Event Listeners
    searchTrigger?.addEventListener('click', openSearch);
    searchClose?.addEventListener('click', closeSearch);
    searchBackdrop?.addEventListener('click', closeSearch);

    searchInput?.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        performSearch(e.target.value);
      }, 200);
    });

    // Quick search buttons
    document.querySelectorAll('.quick-search').forEach(btn => {
      btn.addEventListener('click', () => {
        const query = btn.dataset.query;
        if (searchInput) searchInput.value = query;
        performSearch(query);
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Open search with Cmd/Ctrl + K
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }

      // Close with Escape
      if (e.key === 'Escape' && !searchOverlay?.classList.contains('hidden')) {
        closeSearch();
      }

      // Navigate results with arrow keys
      if (!searchOverlay?.classList.contains('hidden')) {
        const results = document.querySelectorAll('.search-result');
        const activeResult = document.querySelector('.search-result.bg-gray-50');
        let activeIndex = Array.from(results).indexOf(activeResult);

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          activeIndex = Math.min(activeIndex + 1, results.length - 1);
          results.forEach((r, i) => r.classList.toggle('bg-gray-50', i === activeIndex));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          activeIndex = Math.max(activeIndex - 1, 0);
          results.forEach((r, i) => r.classList.toggle('bg-gray-50', i === activeIndex));
        } else if (e.key === 'Enter' && activeResult) {
          e.preventDefault();
          activeResult.click();
        }
      }
    });

    // =============================================
    // CURRENCY SELECTOR - DISABLED (code saved in /src/lib/currency-converter-PAUSED.js)
    // =============================================

    // =============================================
    // LANGUAGE SELECTOR - GOOGLE TRANSLATE
    // =============================================
    const languageTrigger = document.getElementById('language-trigger');
    const languageMenu = document.getElementById('language-menu');
    const currentLanguageEl = document.getElementById('current-language');
    const currentFlagEl = document.getElementById('current-flag');

    // Language codes for Google Translate
    const langCodes = {
      'en': 'en',
      'ar': 'ar',
      'ur': 'ur',
      'fr': 'fr',
      'es': 'es',
      'tr': 'tr',
      'bn': 'bn'
    };

    let currentLang = localStorage.getItem('language') || 'en';

    // Initialize language display
    const savedLangOption = document.querySelector(`.language-option[data-lang="${currentLang}"]`);
    if (savedLangOption && currentLanguageEl && currentFlagEl) {
      currentLanguageEl.textContent = savedLangOption.dataset.name;
      currentFlagEl.src = `https://flagcdn.com/w20/${savedLangOption.dataset.flag}.png`;
    }

    // Load Google Translate script
    function loadGoogleTranslate() {
      if (document.getElementById('google-translate-script')) return;

      // Create the Google Translate element (hidden)
      const translateDiv = document.createElement('div');
      translateDiv.id = 'google_translate_element';
      translateDiv.style.cssText = 'position: absolute; top: -9999px; left: -9999px;';
      document.body.appendChild(translateDiv);

      // Define the callback
      window.googleTranslateElementInit = function() {
        new google.translate.TranslateElement({
          pageLanguage: 'en',
          includedLanguages: 'en,ar,ur,fr,es,tr,bn',
          autoDisplay: false
        }, 'google_translate_element');
      };

      // Load the script
      const script = document.createElement('script');
      script.id = 'google-translate-script';
      script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
      document.body.appendChild(script);
    }

    // Trigger translation to specific language
    function translateToLanguage(langCode) {
      // Check if Google Translate is loaded
      const select = document.querySelector('.goog-te-combo');
      if (select) {
        select.value = langCode;
        select.dispatchEvent(new Event('change'));
        return true;
      }
      return false;
    }

    languageTrigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      languageMenu?.classList.toggle('hidden');
    });

    document.querySelectorAll('.language-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.dataset.lang;
        const flag = btn.dataset.flag;
        const name = btn.dataset.name;

        currentLang = lang;
        localStorage.setItem('language', lang);

        if (currentLanguageEl) currentLanguageEl.textContent = name;
        if (currentFlagEl) currentFlagEl.src = `https://flagcdn.com/w20/${flag}.png`;
        languageMenu?.classList.add('hidden');

        // Set RTL for Arabic/Urdu
        if (lang === 'ar' || lang === 'ur') {
          document.documentElement.dir = 'rtl';
          document.documentElement.classList.add('rtl');
        } else {
          document.documentElement.dir = 'ltr';
          document.documentElement.classList.remove('rtl');
        }
        document.documentElement.lang = lang;

        if (lang === 'en') {
          // Reset translation - reload page without Google Translate cookie
          document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + window.location.hostname;
          location.reload();
        } else {
          // Show loading indicator
          const loader = document.createElement('div');
          loader.id = 'translate-loader';
          loader.innerHTML = `
            <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99999; display: flex; align-items: center; justify-content: center;">
              <div style="background: white; padding: 24px 48px; border-radius: 12px; text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #0096D6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                <p style="color: #333; font-weight: 600;">Translating to ${name}...</p>
              </div>
            </div>
            <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
          `;
          document.body.appendChild(loader);

          // Load Google Translate if not loaded
          loadGoogleTranslate();

          // Wait for Google Translate to load and translate
          let attempts = 0;
          const tryTranslate = setInterval(() => {
            attempts++;
            if (translateToLanguage(langCodes[lang])) {
              clearInterval(tryTranslate);
              setTimeout(() => loader.remove(), 1000);
            } else if (attempts > 50) { // 5 seconds timeout
              clearInterval(tryTranslate);
              loader.remove();
              alert('Translation is loading. Please try again in a moment.');
            }
          }, 100);
        }
      });
    });

    // Initialize Google Translate on page load if language is not English
    if (currentLang !== 'en') {
      loadGoogleTranslate();
      setTimeout(() => {
        translateToLanguage(langCodes[currentLang]);
      }, 1500);
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!languageMenu?.contains(e.target) && !languageTrigger?.contains(e.target)) {
        languageMenu?.classList.add('hidden');
      }
    });
  });
</script>
