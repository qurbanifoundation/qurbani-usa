---
/**
 * CW DONATION BOX TEMPLATE
 *
 * Charity:water-inspired donation box with dynamic frequency tabs:
 *   - Configurable tabs: Monthly, Give Once, Yearly, Every Friday, Daily
 *   - Each tab has its own amounts, impact texts, and CTA button text
 *   - Upsell view shown only for "single" (one-time) donations
 *
 * Design: Individual rounded pill buttons, soft shadows, clean typography
 */

import { generateImpactTexts, getDefaultMonthlyImpact } from '../../lib/donation-defaults';

interface FrequencyConfig {
  key: string;
  label: string;
  type: 'single' | 'recurring';
  stripeInterval: string | null;
  suffix: string;
  buttonText: string;
  amounts: number[];
  impactTexts: Record<number, string>;
  defaultAmountIndex: number;
  fallbackImpactText: string;
}

interface Props {
  campaignSlug?: string;
  campaignTitle?: string;
  campaignImage?: string;
  frequencies?: FrequencyConfig[];
  // Legacy props (used when frequencies is not provided)
  monthlyAmounts?: number[];
  oneTimeAmounts?: number[];
  impactTexts?: Record<string, Record<number, string>>;
  monthlyImpactText?: string;
  upsellBody?: string;
  upsellSubText?: string;
  upsellMonthlyRatio?: number;
  showSpecialProject?: boolean;
  specialProjectText?: string;
  specialProjectAmount?: number;
  showAlternatePayments?: boolean;
  colors?: {
    accentColor?: string;
    accentTextColor?: string;
  };
  tabEmoji?: string;
  tabLabelMonthly?: string;
  tabLabelOneTime?: string;
  buttonTextMonthly?: string;
  buttonTextOneTime?: string;
  donationBoxHeading?: string;
  className?: string;
}

const {
  campaignSlug = 'general',
  campaignTitle = 'Donation',
  campaignImage = '',
  frequencies,
  monthlyAmounts = [10, 20, 40, 100],
  oneTimeAmounts = [50, 100, 150, 200],
  impactTexts = {},
  monthlyImpactText = 'Gives <strong>12 people</strong> clean water every year.',
  upsellBody = "By making a monthly donation, you'll empower us to make long-term investments to bring clean water to more families around the world.",
  upsellSubText = 'Please consider joining our monthly giving community. Monthly donors are our most impactful and committed supporters.',
  upsellMonthlyRatio = 0.4,
  showSpecialProject = false,
  specialProjectText = 'Sponsor an entire water project',
  specialProjectAmount = 10000,
  showAlternatePayments = false,
  colors = {},
  tabEmoji = '',
  tabLabelMonthly = 'MONTHLY',
  tabLabelOneTime = 'GIVE ONCE',
  buttonTextMonthly = 'JOIN TODAY',
  buttonTextOneTime = 'GIVE',
  donationBoxHeading = '',
  className = '',
} = Astro.props;

const accentColor = colors.accentColor || '#e1861d';
const accentTextColor = colors.accentTextColor || '#ffffff';
const boxId = `cw-box-${Math.random().toString(36).substr(2, 9)}`;

// Auto-detect emoji from campaign slug if not explicitly set
function getEmojiForCampaign(slug: string): string {
  const s = slug.toLowerCase();

  // Home / general
  if (s === 'general' || s === 'where-needed' || s === 'home') return 'â¤ï¸';

  // Water campaigns
  if (s.includes('water') || s.includes('well')) return 'ğŸ’§';

  // Country flags â€” emergency/relief
  if (s.includes('sudan')) return 'ğŸ‡¸ğŸ‡©';
  if (s.includes('gaza') || s.includes('palestin')) return 'ğŸ‡µğŸ‡¸';
  if (s.includes('syria')) return 'ğŸ‡¸ğŸ‡¾';
  if (s.includes('yemen')) return 'ğŸ‡¾ğŸ‡ª';
  if (s.includes('afghanistan') || s.includes('afghan')) return 'ğŸ‡¦ğŸ‡«';
  if (s.includes('pakistan')) return 'ğŸ‡µğŸ‡°';
  if (s.includes('somalia')) return 'ğŸ‡¸ğŸ‡´';
  if (s.includes('bangladesh')) return 'ğŸ‡§ğŸ‡©';
  if (s.includes('turkey') || s.includes('turkiye')) return 'ğŸ‡¹ğŸ‡·';
  if (s.includes('morocco')) return 'ğŸ‡²ğŸ‡¦';
  if (s.includes('libya')) return 'ğŸ‡±ğŸ‡¾';
  if (s.includes('lebanon')) return 'ğŸ‡±ğŸ‡§';
  if (s.includes('iraq')) return 'ğŸ‡®ğŸ‡¶';
  if (s.includes('india')) return 'ğŸ‡®ğŸ‡³';
  if (s.includes('africa')) return 'ğŸŒ';

  // Zakat
  if (s.includes('zakat')) return 'ğŸ¤²';

  // Ramadan / fasting / iftar / fidya / kaffarah
  if (s.includes('ramadan') || s.includes('fasting') || s.includes('iftar') || s.includes('fidya') || s.includes('kaffarah') || s.includes('fitr')) return 'ğŸŒ™';

  // Orphan
  if (s.includes('orphan')) return 'ğŸ‘¶';

  // Food
  if (s.includes('food') || s.includes('feed') || s.includes('meal') || s.includes('hunger')) return 'ğŸ½ï¸';

  // Education / school
  if (s.includes('school') || s.includes('education') || s.includes('quran')) return 'ğŸ“š';

  // Healthcare / medical
  if (s.includes('medical') || s.includes('health') || s.includes('clinic') || s.includes('eye-care')) return 'ğŸ¥';

  // Qurbani
  if (s.includes('qurbani') || s.includes('aqiqah') || s.includes('udhiyah')) return 'ğŸ‘';

  // Mosque
  if (s.includes('mosque') || s.includes('masjid')) return 'ğŸ•Œ';

  // Sadaqah / charity
  if (s.includes('sadaqah') || s.includes('sadaqa') || s.includes('jariyah')) return 'ğŸŒ±';

  // Emergency (generic)
  if (s.includes('emergency') || s.includes('crisis') || s.includes('relief') || s.includes('disaster')) return 'ğŸ†˜';

  // Default â€” use 'heart' as marker for SVG rendering
  return 'heart';
}

const resolvedEmoji = tabEmoji || getEmojiForCampaign(campaignSlug);
const useHeartSvg = resolvedEmoji === 'heart';

// Use provided impactTexts, or auto-generate from campaign slug
const hasCustomImpactTexts = Object.keys(impactTexts).length > 0;
const resolvedImpactTexts = hasCustomImpactTexts ? impactTexts : generateImpactTexts(campaignSlug);

const resolvedMonthlyImpact = monthlyImpactText !== 'Gives <strong>12 people</strong> clean water every year.'
  ? monthlyImpactText
  : getDefaultMonthlyImpact(campaignSlug);

// Build frequency tabs: use provided frequencies or construct from legacy props
const frequencyTabs: FrequencyConfig[] = (frequencies && frequencies.length > 0)
  ? frequencies
  : [
      {
        key: 'monthly',
        label: tabLabelMonthly,
        type: 'recurring' as const,
        stripeInterval: 'month',
        suffix: 'USD/mo',
        buttonText: buttonTextMonthly,
        amounts: monthlyAmounts,
        impactTexts: (resolvedImpactTexts as any)?.monthly || {},
        defaultAmountIndex: 2,
        fallbackImpactText: resolvedMonthlyImpact,
      },
      {
        key: 'single',
        label: tabLabelOneTime,
        type: 'single' as const,
        stripeInterval: null,
        suffix: 'USD',
        buttonText: buttonTextOneTime,
        amounts: oneTimeAmounts,
        impactTexts: (resolvedImpactTexts as any)?.single || {},
        defaultAmountIndex: 1,
        fallbackImpactText: '',
      }
    ];

// Compute tab grid columns class
const tabColsClass = frequencyTabs.length === 2 ? 'grid-cols-2'
  : frequencyTabs.length === 3 ? 'grid-cols-3'
  : frequencyTabs.length === 4 ? 'grid-cols-4'
  : frequencyTabs.length === 5 ? 'grid-cols-5'
  : 'grid-cols-2';

// Tab text size: smaller when 3+ tabs
const tabTextSize = frequencyTabs.length > 2 ? 'text-[11px]' : 'text-[13px]';
---

{donationBoxHeading && (
  <h2 class="text-2xl md:text-3xl font-bold text-white text-center mb-4 font-signika leading-tight" style="text-wrap: balance;">{donationBoxHeading}</h2>
)}
<div
  id={boxId}
  class={`bg-white rounded-md overflow-hidden shadow-xl border border-gray-200 w-full ${className}`}
  data-donation-box
  data-template="cw-donation"
>
  <!-- Toggle header with background -->
  <div class="px-5 pt-5 pb-4 sm:px-7 sm:pt-6 sm:pb-5" style="background-color: #F4F5F0;">
    <!-- Form tabs (shown in form view) -->
    <div class={`cw-form-header grid ${tabColsClass} gap-2`}>
      {frequencyTabs.map((freq, i) => (
        <button
          type="button"
          class={`cw-toggle flex items-center justify-center gap-1 py-2.5 rounded ${tabTextSize} font-bold uppercase tracking-wider transition-all border-2`}
          data-type={freq.key}
          data-freq-index={i}
          style={i === 0
            ? `background-color: ${accentColor}; color: ${accentTextColor}; border-color: ${accentColor};`
            : 'background-color: transparent; color: #9ca3af; border-color: transparent;'}
        >
          {freq.label} {i === 0 && (useHeartSvg ? (
            <svg class="w-4 h-4 inline-block" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
          ) : (
            <span class="text-base">{resolvedEmoji}</span>
          ))}
        </button>
      ))}
    </div>
    <!-- Upsell header (shown in State 3, replaces tabs) -->
    <div class="cw-upsell-header hidden">
      <p class="text-center text-sm text-gray-500 py-1">
        Giving <strong class="cw-upsell-amount text-gray-800 text-base">$50 USD</strong><span class="cw-upsell-period"></span>
        <button type="button" class="cw-edit-link ml-1.5 text-[11px] font-bold text-gray-800 uppercase tracking-wide hover:text-gray-600 transition-colors" style="border-bottom: 1.5px solid currentColor;">EDIT</button>
      </p>
    </div>
  </div>

  <div class="px-5 pt-5 pb-5 sm:px-7 sm:pt-6 sm:pb-6">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- FORM VIEW                                  -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="cw-form-view">

      <!-- Dynamic frequency grids -->
      {frequencyTabs.map((freq, fi) => {
        const amounts = freq.amounts || [];
        const total = amounts.length;
        const row1 = amounts.slice(0, 3);
        const row2 = amounts.slice(3, 5);
        const otherColSpan = 3 - row2.length;
        const needsSmallText = total > 4;
        const amtSize = needsSmallText ? 'text-[14px]' : 'text-[17px]';
        const suffSize = needsSmallText ? 'text-[10px]' : 'text-[11px]';
        const otherSpanClass = otherColSpan === 3 ? 'col-span-3' : otherColSpan === 2 ? 'col-span-2' : '';
        const defaultIdx = freq.defaultAmountIndex ?? 1;
        const defaultAmt = amounts[defaultIdx] || amounts[0] || 0;

        return (
          <div class={`cw-freq-grid ${fi === 0 ? '' : 'hidden'}`} data-freq-key={freq.key}>
            {/* Row 1: first 3 amounts */}
            <div class="grid grid-cols-3 gap-2.5 mb-2.5">
              {row1.map((amt, i) => {
                const isDefault = i === defaultIdx;
                return (
                  <button
                    type="button"
                    class={`cw-amt-btn relative rounded py-3 px-1 text-center transition-all border border-[#e0e1dc] ${isDefault ? 'cw-amt-selected' : ''}`}
                    data-amount={amt}
                    data-freq={freq.key}
                    style={isDefault ? `background-color: ${accentColor}; border-color: ${accentColor}; color: ${accentTextColor};` : 'background-color: #f4f5f0;'}
                  >
                    <span class={`${amtSize} font-bold ${isDefault ? '' : 'text-gray-400'}`}>${amt}</span>
                    <span class={`${suffSize} ml-0.5 font-medium ${isDefault ? 'opacity-70' : 'text-gray-400'}`}>{freq.suffix}</span>
                  </button>
                );
              })}
            </div>
            {/* Row 2: remaining amounts + Other button */}
            <div class="grid grid-cols-3 gap-2.5">
              {row2.map((amt) => {
                const idx = amounts.indexOf(amt);
                const isDefault = idx === defaultIdx;
                return (
                  <button
                    type="button"
                    class={`cw-amt-btn relative rounded py-3 px-1 text-center transition-all border border-[#e0e1dc] ${isDefault ? 'cw-amt-selected' : ''}`}
                    data-amount={amt}
                    data-freq={freq.key}
                    style={isDefault ? `background-color: ${accentColor}; border-color: ${accentColor}; color: ${accentTextColor};` : 'background-color: #f4f5f0;'}
                  >
                    <span class={`${amtSize} font-bold ${isDefault ? '' : 'text-gray-400'}`}>${amt}</span>
                    <span class={`${suffSize} ml-0.5 font-medium ${isDefault ? 'opacity-70' : 'text-gray-400'}`}>{freq.suffix}</span>
                  </button>
                );
              })}
              {/* Other amount button */}
              <button
                type="button"
                class={`cw-freq-other-btn ${otherSpanClass} rounded py-3 px-3 text-center border border-[#e0e1dc] transition-all text-gray-400 font-bold ${amtSize}`}
                style="background-color: #f4f5f0;"
              >
                Other
              </button>
              {/* Custom amount input */}
              <div class={`cw-freq-custom-wrap ${otherSpanClass} hidden`}>
                <div class="relative rounded border border-[#e0e1dc] overflow-hidden" style="background-color: #f4f5f0;">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-[17px]">$</span>
                  <input
                    type="number"
                    step="0.01"
                    min="1"
                    class="cw-freq-custom w-full pl-8 pr-16 py-3 bg-transparent text-[17px] font-bold text-gray-800 focus:outline-none placeholder-gray-400"
                    placeholder="Other"
                  />
                  <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-[11px] font-medium">{freq.suffix}</span>
                </div>
              </div>
            </div>
            {/* Row 3: overflow amounts (6+) */}
            {total > 5 && (
              <div class="grid grid-cols-3 gap-2.5 mt-2.5">
                {amounts.slice(5).map((amt) => {
                  const idx = amounts.indexOf(amt);
                  const isDefault = idx === defaultIdx;
                  return (
                    <button
                      type="button"
                      class={`cw-amt-btn relative rounded py-3 px-1 text-center transition-all border border-[#e0e1dc] ${isDefault ? 'cw-amt-selected' : ''}`}
                      data-amount={amt}
                      data-freq={freq.key}
                      style={isDefault ? `background-color: ${accentColor}; border-color: ${accentColor}; color: ${accentTextColor};` : 'background-color: #f4f5f0;'}
                    >
                      <span class={`${amtSize} font-bold ${isDefault ? '' : 'text-gray-400'}`}>${amt}</span>
                      <span class={`${suffSize} ml-0.5 font-medium ${isDefault ? 'opacity-70' : 'text-gray-400'}`}>{freq.suffix}</span>
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        );
      })}

      {showSpecialProject && (
        <button
          type="button"
          class="cw-special-btn w-full py-3 rounded border-2 border-gray-200 text-sm text-gray-600 font-medium mt-2.5 hover:border-gray-300 transition"
          data-amount={specialProjectAmount}
        >
          {specialProjectText}
        </button>
      )}

      <!-- Impact Line -->
      <div class="cw-impact-line flex items-start gap-2 mt-5 mb-5">
        {useHeartSvg ? (
          <svg class="w-4 h-4 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill={accentColor} xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        ) : (
          <span class="text-sm mt-0.5 flex-shrink-0">{resolvedEmoji}</span>
        )}
        <p class="cw-impact-text text-[13px] text-gray-500 leading-relaxed"></p>
      </div>

      <!-- CTA Button -->
      <button
        type="button"
        class="cw-donate-btn w-full py-4 rounded font-extrabold text-[15px] uppercase tracking-[0.1em] transition-all hover:brightness-105 active:scale-[0.99]"
        style={`background-color: ${accentColor}; color: ${accentTextColor};`}
      >
        {frequencyTabs[0]?.buttonText || buttonTextMonthly}
      </button>

      {showAlternatePayments && (
        <div class="cw-alt-payments hidden text-center mt-3">
          <a href="/donate?method=check" class="text-xs text-gray-500 underline hover:text-gray-700">Give by check or stock</a>
          <span class="text-xs text-gray-300 mx-1">&middot;</span>
          <a href="/donate?method=crypto" class="text-xs text-gray-500 underline hover:text-gray-700">Donate crypto</a>
        </div>
      )}
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- UPSELL VIEW (State 3)                      -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="cw-upsell-view hidden">
      <!-- Title -->
      <h3 class="text-xl font-bold text-gray-800 text-center mb-3" style="font-family: 'Signika', sans-serif;">
        Would you consider something?
      </h3>

      <!-- Body text -->
      <p class="cw-upsell-body text-sm text-gray-500 leading-relaxed mb-5 text-center"></p>

      <!-- Monthly toggle card -->
      <div class="rounded-lg p-4 mb-5 border border-gray-200" style="background-color: #f9f9f7;">
        <div class="flex items-center gap-3">
          <!-- Toggle switch -->
          <button type="button" class="cw-upsell-toggle relative w-14 h-7 rounded-full bg-gray-300 transition-colors flex-shrink-0" role="switch" aria-checked="false">
            <span class="cw-upsell-toggle-dot absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform flex items-center justify-center">
              <svg class="cw-toggle-x w-3 h-3 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="6" y1="6" x2="18" y2="18"/><line x1="18" y1="6" x2="6" y2="18"/></svg>
              <svg class="cw-toggle-check w-3.5 h-3.5 text-white hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </span>
          </button>
          <span class="cw-upsell-monthly-label text-sm font-semibold text-gray-700">
            Give $20 per month instead
          </span>
        </div>
        <p class="cw-upsell-subtext text-xs text-gray-400 mt-2.5 leading-relaxed"></p>
      </div>

      <!-- CTA Button -->
      <button
        type="button"
        class="cw-upsell-btn w-full py-4 rounded font-extrabold text-[15px] uppercase tracking-[0.1em] transition-all hover:brightness-105 active:scale-[0.99]"
        style={`background-color: ${accentColor}; color: ${accentTextColor};`}
      >
        GIVE $50
      </button>
    </div>

  </div>
</div>

<script define:vars={{
  boxId,
  campaignSlug,
  campaignTitle,
  campaignImage,
  frequencyTabs,
  upsellBody,
  upsellSubText,
  upsellMonthlyRatio,
  specialProjectAmount,
  accentColor,
  accentTextColor
}}>
  document.addEventListener('DOMContentLoaded', function() {
    var box = document.getElementById(boxId);
    if (!box) return;

    // Current state
    var activeFreqIndex = 0;
    var activeFreqKey = frequencyTabs[0].key;
    var selectedAmount = frequencyTabs[0].amounts[frequencyTabs[0].defaultAmountIndex] || frequencyTabs[0].amounts[0] || 0;
    var upsellMonthlyActive = false;

    // Elements
    var toggleBtns = box.querySelectorAll('.cw-toggle');
    var freqGrids = box.querySelectorAll('.cw-freq-grid');
    var impactText = box.querySelector('.cw-impact-text');
    var donateBtn = box.querySelector('.cw-donate-btn');
    var altPayments = box.querySelector('.cw-alt-payments');
    var formHeader = box.querySelector('.cw-form-header');
    var upsellHeader = box.querySelector('.cw-upsell-header');
    var formView = box.querySelector('.cw-form-view');
    var upsellView = box.querySelector('.cw-upsell-view');
    var upsellAmountEl = box.querySelector('.cw-upsell-amount');
    var upsellPeriodEl = box.querySelector('.cw-upsell-period');
    var upsellBodyEl = box.querySelector('.cw-upsell-body');
    var upsellSubtextEl = box.querySelector('.cw-upsell-subtext');
    var upsellToggle = box.querySelector('.cw-upsell-toggle');
    var upsellToggleDot = box.querySelector('.cw-upsell-toggle-dot');
    var upsellMonthlyLabel = box.querySelector('.cw-upsell-monthly-label');
    var upsellBtn = box.querySelector('.cw-upsell-btn');
    var editLink = box.querySelector('.cw-edit-link');
    var specialBtn = box.querySelector('.cw-special-btn');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getActiveFreq() {
      return frequencyTabs[activeFreqIndex];
    }

    function getActiveGrid() {
      return box.querySelector('.cw-freq-grid[data-freq-key="' + activeFreqKey + '"]');
    }

    function getAmtSizeClass(btn) {
      var s = btn.querySelector('span:first-child');
      if (s && s.className.indexOf('text-[14px]') !== -1) return 'text-[14px]';
      return 'text-[17px]';
    }

    function getSuffSizeClass(btn) {
      var s = btn.querySelector('span:last-child');
      if (s && s.className.indexOf('text-[10px]') !== -1) return 'text-[10px]';
      return 'text-[11px]';
    }

    function clearGridBtnStyles(grid) {
      if (!grid) return;
      var btns = grid.querySelectorAll('.cw-amt-btn');
      btns.forEach(function(b) {
        b.style.backgroundColor = '#f4f5f0';
        b.style.color = '';
        b.style.borderColor = '#e0e1dc';
        b.classList.remove('cw-amt-selected');
        var amtSpan = b.querySelector('span:first-child');
        if (amtSpan) amtSpan.className = getAmtSizeClass(b) + ' font-bold text-gray-400';
        var suffSpan = b.querySelector('span:last-child');
        if (suffSpan) suffSpan.className = getSuffSizeClass(b) + ' ml-0.5 font-medium text-gray-400';
      });
      if (specialBtn) {
        specialBtn.style.borderColor = '#e0e1dc';
        specialBtn.style.backgroundColor = '#f4f5f0';
        specialBtn.style.color = '';
      }
    }

    function highlightBtn(btn) {
      btn.style.backgroundColor = accentColor;
      btn.style.color = accentTextColor;
      btn.style.borderColor = accentColor;
      btn.classList.add('cw-amt-selected');
      var amtSpan = btn.querySelector('span:first-child');
      if (amtSpan) amtSpan.className = getAmtSizeClass(btn) + ' font-bold';
      var suffSpan = btn.querySelector('span:last-child');
      if (suffSpan) suffSpan.className = getSuffSizeClass(btn) + ' ml-0.5 font-medium opacity-70';
    }

    function updateImpact() {
      if (!impactText) return;
      var freq = getActiveFreq();
      if (!freq) return;

      // Check for amount-specific impact text
      if (freq.impactTexts && selectedAmount > 0) {
        if (freq.impactTexts[selectedAmount]) {
          impactText.innerHTML = freq.impactTexts[selectedAmount];
          return;
        }
        // Find closest lower amount
        var amounts = Object.keys(freq.impactTexts).map(Number).sort(function(a, b) { return b - a; });
        for (var i = 0; i < amounts.length; i++) {
          if (selectedAmount >= amounts[i]) {
            impactText.innerHTML = freq.impactTexts[amounts[i]];
            return;
          }
        }
      }
      // Fallback
      impactText.innerHTML = freq.fallbackImpactText || '';
    }

    function addItemToCart(amount, type) {
      var freq = getActiveFreq();
      var recurringInterval;
      if (freq && freq.type === 'recurring') {
        recurringInterval = freq.key; // 'monthly', 'weekly', 'yearly', 'daily'
      }
      var itemId = campaignSlug + '-' + amount + '-' + type;
      if (typeof window.addToCart === 'function') {
        window.addToCart({
          id: itemId,
          name: campaignTitle,
          label: '$' + amount + ' Donation',
          amount: amount,
          quantity: 1,
          type: type,
          recurringInterval: recurringInterval,
          image: campaignImage,
          campaign: campaignSlug
        });
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB SWITCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    toggleBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var freqKey = this.dataset.type;
        var freqIdx = parseInt(this.dataset.freqIndex || '0', 10);

        activeFreqKey = freqKey;
        activeFreqIndex = freqIdx;

        // Style tabs
        toggleBtns.forEach(function(b) {
          if (b.dataset.type === freqKey) {
            b.style.backgroundColor = accentColor;
            b.style.color = accentTextColor;
            b.style.borderColor = accentColor;
          } else {
            b.style.backgroundColor = 'transparent';
            b.style.color = '#9ca3af';
            b.style.borderColor = 'transparent';
          }
        });

        // Show/hide grids
        freqGrids.forEach(function(g) {
          if (g.dataset.freqKey === freqKey) {
            g.classList.remove('hidden');
          } else {
            g.classList.add('hidden');
          }
        });

        // Show alt payments only for single/one-time
        if (altPayments) {
          if (freqKey === 'single') {
            altPayments.classList.remove('hidden');
          } else {
            altPayments.classList.add('hidden');
          }
        }

        // Reset custom inputs in all grids
        freqGrids.forEach(function(g) {
          var customWrap = g.querySelector('.cw-freq-custom-wrap');
          var customInput = g.querySelector('.cw-freq-custom');
          var otherBtnEl = g.querySelector('.cw-freq-other-btn');
          if (customWrap) customWrap.classList.add('hidden');
          if (customInput) customInput.value = '';
          if (otherBtnEl) otherBtnEl.classList.remove('hidden');
        });

        // Pre-select default amount for the active tab
        var freq = frequencyTabs[freqIdx];
        var defaultIdx = freq.defaultAmountIndex || 0;
        var defaultAmt = freq.amounts[defaultIdx] || freq.amounts[0] || 0;
        selectedAmount = defaultAmt;

        var activeGrid = getActiveGrid();
        clearGridBtnStyles(activeGrid);
        if (activeGrid) {
          var amtBtns = activeGrid.querySelectorAll('.cw-amt-btn');
          amtBtns.forEach(function(b) {
            if (parseFloat(b.dataset.amount) === defaultAmt) {
              highlightBtn(b);
            }
          });
        }

        // Update button text
        donateBtn.textContent = freq.buttonText || 'DONATE';
        updateImpact();
      });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AMOUNT SELECTION (applies to all grids)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    freqGrids.forEach(function(grid) {
      var gridKey = grid.dataset.freqKey;

      // Amount buttons
      var amtBtns = grid.querySelectorAll('.cw-amt-btn');
      amtBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          selectedAmount = parseFloat(this.dataset.amount);
          var customInput = grid.querySelector('.cw-freq-custom');
          var customWrap = grid.querySelector('.cw-freq-custom-wrap');
          var otherBtnEl = grid.querySelector('.cw-freq-other-btn');
          if (customInput) customInput.value = '';
          if (customWrap) customWrap.classList.add('hidden');
          if (otherBtnEl) otherBtnEl.classList.remove('hidden');
          clearGridBtnStyles(grid);
          highlightBtn(this);
          updateImpact();
        });
      });

      // Other button
      var otherBtnEl = grid.querySelector('.cw-freq-other-btn');
      if (otherBtnEl) {
        otherBtnEl.addEventListener('click', function() {
          var customWrap = grid.querySelector('.cw-freq-custom-wrap');
          var customInput = grid.querySelector('.cw-freq-custom');
          if (customWrap) customWrap.classList.remove('hidden');
          otherBtnEl.classList.add('hidden');
          clearGridBtnStyles(grid);
          selectedAmount = 0;
          if (customInput) customInput.focus();
        });
      }

      // Custom input
      var customInput = grid.querySelector('.cw-freq-custom');
      if (customInput) {
        customInput.addEventListener('input', function() {
          if (this.value) {
            selectedAmount = parseFloat(this.value) || 0;
            clearGridBtnStyles(grid);
            updateImpact();
          }
        });
      }
    });

    // Special project button
    if (specialBtn) {
      specialBtn.addEventListener('click', function() {
        selectedAmount = parseFloat(this.dataset.amount);
        var activeGrid = getActiveGrid();
        clearGridBtnStyles(activeGrid);
        var customInput = activeGrid ? activeGrid.querySelector('.cw-freq-custom') : null;
        if (customInput) customInput.value = '';
        specialBtn.style.borderColor = accentColor;
        specialBtn.style.backgroundColor = accentColor;
        specialBtn.style.color = accentTextColor;
        updateImpact();
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CTA BUTTON
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    donateBtn.addEventListener('click', function() {
      var freq = getActiveFreq();
      var amt = selectedAmount;

      // Check for custom input value
      var activeGrid = getActiveGrid();
      if (activeGrid) {
        var customInput = activeGrid.querySelector('.cw-freq-custom');
        if (customInput && customInput.value) {
          amt = parseFloat(customInput.value) || amt;
        }
      }

      if (!amt || amt < 1) {
        alert('Please select or enter a donation amount');
        return;
      }

      // For recurring frequencies, go straight to cart (no upsell)
      if (freq.type === 'recurring') {
        addItemToCart(amt, freq.key);
        return;
      }

      // For single/one-time: show upsell for amounts â‰¤ $200
      if (amt > 200) {
        addItemToCart(amt, 'single');
        return;
      }

      showUpsell(amt);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UPSELL VIEW (State 3) â€” only for single
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showUpsell(amount) {
      var suggestedMonthly = Math.round(amount * upsellMonthlyRatio);
      if (suggestedMonthly < 5) suggestedMonthly = 5;

      // Find the single frequency's button text
      var singleFreq = null;
      for (var i = 0; i < frequencyTabs.length; i++) {
        if (frequencyTabs[i].key === 'single') { singleFreq = frequencyTabs[i]; break; }
      }
      var singleButtonText = singleFreq ? singleFreq.buttonText : 'GIVE';

      formView.classList.add('hidden');
      upsellView.classList.remove('hidden');
      formHeader.classList.add('hidden');
      upsellHeader.classList.remove('hidden');

      upsellAmountEl.textContent = '$' + amount + ' USD';

      // Build dynamic upsell body using the selected amount's impact text
      var impactPhrase = '';
      if (singleFreq && singleFreq.impactTexts && singleFreq.impactTexts[amount]) {
        var temp = document.createElement('div');
        temp.innerHTML = singleFreq.impactTexts[amount];
        impactPhrase = temp.textContent || temp.innerText || '';
        impactPhrase = impactPhrase.charAt(0).toLowerCase() + impactPhrase.slice(1);
      }
      if (impactPhrase) {
        upsellBodyEl.textContent = "By making a monthly donation, you'll empower us to make long-term investments to " + impactPhrase + " for more families around the world.";
      } else {
        upsellBodyEl.textContent = upsellBody;
      }
      upsellSubtextEl.textContent = upsellSubText;
      upsellMonthlyLabel.textContent = 'Give $' + suggestedMonthly + ' per month instead';
      upsellBtn.textContent = singleButtonText + ' $' + amount;

      upsellView._oneTimeAmount = amount;
      upsellView._monthlyAmount = suggestedMonthly;
      upsellMonthlyActive = false;

      upsellToggle.setAttribute('aria-checked', 'false');
      upsellToggle.style.backgroundColor = '#d1d5db';
      upsellToggleDot.style.transform = 'translateX(0)';
      upsellToggleDot.style.backgroundColor = '#ffffff';
      var toggleX = upsellToggleDot.querySelector('.cw-toggle-x');
      var toggleCheck = upsellToggleDot.querySelector('.cw-toggle-check');
      if (toggleX) toggleX.classList.remove('hidden');
      if (toggleCheck) toggleCheck.classList.add('hidden');
    }

    // Edit link â†’ back to form view on single tab
    if (editLink) {
      editLink.addEventListener('click', function() {
        upsellView.classList.add('hidden');
        formView.classList.remove('hidden');
        upsellHeader.classList.add('hidden');
        formHeader.classList.remove('hidden');

        // Switch back to single tab
        var singleIdx = -1;
        for (var i = 0; i < frequencyTabs.length; i++) {
          if (frequencyTabs[i].key === 'single') { singleIdx = i; break; }
        }
        if (singleIdx >= 0) {
          activeFreqKey = 'single';
          activeFreqIndex = singleIdx;
          toggleBtns.forEach(function(b) {
            if (b.dataset.type === 'single') {
              b.style.backgroundColor = accentColor;
              b.style.color = accentTextColor;
              b.style.borderColor = accentColor;
            } else {
              b.style.backgroundColor = 'transparent';
              b.style.color = '#9ca3af';
              b.style.borderColor = 'transparent';
            }
          });
          freqGrids.forEach(function(g) {
            if (g.dataset.freqKey === 'single') {
              g.classList.remove('hidden');
            } else {
              g.classList.add('hidden');
            }
          });
          donateBtn.textContent = frequencyTabs[singleIdx].buttonText || 'GIVE';
        }
        if (altPayments) altPayments.classList.remove('hidden');
      });
    }

    // Upsell toggle switch
    if (upsellToggle) {
      upsellToggle.addEventListener('click', function() {
        upsellMonthlyActive = !upsellMonthlyActive;
        this.setAttribute('aria-checked', upsellMonthlyActive ? 'true' : 'false');
        var toggleX = upsellToggleDot.querySelector('.cw-toggle-x');
        var toggleCheck = upsellToggleDot.querySelector('.cw-toggle-check');

        var singleFreq = null;
        for (var i = 0; i < frequencyTabs.length; i++) {
          if (frequencyTabs[i].key === 'single') { singleFreq = frequencyTabs[i]; break; }
        }
        var singleButtonText = singleFreq ? singleFreq.buttonText : 'GIVE';

        if (upsellMonthlyActive) {
          this.style.backgroundColor = accentColor;
          upsellToggleDot.style.transform = 'translateX(28px)';
          upsellToggleDot.style.backgroundColor = accentColor;
          if (toggleX) toggleX.classList.add('hidden');
          if (toggleCheck) toggleCheck.classList.remove('hidden');
          upsellBtn.textContent = singleButtonText + ' $' + upsellView._monthlyAmount;
          upsellAmountEl.textContent = '$' + upsellView._monthlyAmount + ' USD';
          if (upsellPeriodEl) upsellPeriodEl.textContent = ' per month';
        } else {
          this.style.backgroundColor = '#d1d5db';
          upsellToggleDot.style.transform = 'translateX(0)';
          upsellToggleDot.style.backgroundColor = '#ffffff';
          if (toggleX) toggleX.classList.remove('hidden');
          if (toggleCheck) toggleCheck.classList.add('hidden');
          upsellBtn.textContent = singleButtonText + ' $' + upsellView._oneTimeAmount;
          upsellAmountEl.textContent = '$' + upsellView._oneTimeAmount + ' USD';
          if (upsellPeriodEl) upsellPeriodEl.textContent = '';
        }
      });
    }

    // Upsell CTA button
    if (upsellBtn) {
      upsellBtn.addEventListener('click', function() {
        if (upsellMonthlyActive) {
          addItemToCart(upsellView._monthlyAmount, 'monthly');
        } else {
          addItemToCart(upsellView._oneTimeAmount, 'single');
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIAL STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    updateImpact();
  });
</script>
