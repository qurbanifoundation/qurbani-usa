---
/**
 * MostNeeded Donation Box Template
 * Dark teal theme with single/monthly toggle
 * Matches the reference design from reference design
 */

interface Props {
  campaignSlug?: string;
  campaignTitle?: string;
  currency?: string;
  defaultAmounts?: number[];
  fundTypes?: string[];
  compact?: boolean;
}

const {
  campaignSlug = 'general',
  campaignTitle = 'Most Needed',
  currency = '$',
  defaultAmounts = [40, 50, 100],
  fundTypes = ['General Donation', 'Emergency Relief', 'Orphan Support', 'Water Projects'],
  compact = false,
} = Astro.props;
---

<div class="donation-box-most-needed" data-campaign={campaignSlug}>
  <!-- Header -->
  <div class="db-header text-center py-3" style="background: linear-gradient(135deg, #01534d 0%, #013d39 100%);">
    <p class="text-sm italic text-white/80 mb-1" style="font-family: 'Georgia', serif;">Donate Now</p>
    <h3 class="text-xl font-bold text-white">{campaignTitle}</h3>
  </div>

  <!-- Body -->
  <div class={`db-body ${compact ? 'p-4' : 'p-5'}`} style="background-color: #01534d;">
    <!-- Payment Toggle -->
    <div class="flex rounded-md overflow-hidden mb-4" style="background-color: #024a45;">
      <button
        type="button"
        class="db-toggle-btn flex-1 py-3 px-4 text-sm font-semibold transition-all duration-200 active"
        data-frequency="single"
        style="background-color: #01534d; color: white;"
      >
        Single<br/>Payment
      </button>
      <button
        type="button"
        class="db-toggle-btn flex-1 py-3 px-4 text-sm font-semibold transition-all duration-200"
        data-frequency="monthly"
        style="background-color: transparent; color: rgba(255,255,255,0.7);"
      >
        Monthly<br/>Payment
      </button>
    </div>

    <!-- Amount Buttons -->
    <div class="grid grid-cols-3 gap-2 mb-4">
      {defaultAmounts.map((amount, index) => (
        <button
          type="button"
          class={`db-amount-btn py-3 px-2 rounded font-bold text-sm transition-all duration-200 ${
            index === defaultAmounts.length - 1 ? 'active' : ''
          }`}
          data-amount={amount}
          style={index === defaultAmounts.length - 1
            ? 'background-color: white; color: #01534d; border: 2px solid white;'
            : 'background-color: transparent; color: white; border: 2px solid rgba(255,255,255,0.5);'
          }
        >
          {currency}{amount}
        </button>
      ))}
    </div>

    <!-- Other Amount Input -->
    <div class="relative mb-4">
      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 font-medium">{currency}</span>
      <input
        type="number"
        class="db-custom-amount w-full pl-8 pr-4 py-3 rounded text-white placeholder-white/50 font-medium"
        placeholder="Other amount"
        min="1"
        style="background-color: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);"
      />
    </div>

    <!-- Fund Type Label -->
    <div class="mb-3">
      <div class="py-2 px-4 rounded text-center text-sm font-medium" style="background-color: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
        {campaignTitle}
      </div>
    </div>

    <!-- Fund Type Dropdown -->
    <div class="relative mb-4">
      <select
        class="db-fund-type w-full py-3 px-4 rounded appearance-none font-medium cursor-pointer"
        style="background-color: white; color: #333; border: none;"
      >
        {fundTypes.map((fund) => (
          <option value={fund.toLowerCase().replace(/\s+/g, '-')}>{fund}</option>
        ))}
      </select>
      <svg class="w-5 h-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </div>

    <!-- Donate Button -->
    <button
      type="button"
      class="db-donate-btn w-full py-4 rounded font-bold text-lg flex items-center justify-center gap-2 transition-all duration-200 hover:opacity-90"
      style="background-color: #c41e3a; color: white;"
    >
      <span>Donate Now</span>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>
</div>

<style>
  .donation-box-most-needed {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    font-family: 'Signika', sans-serif;
    max-width: 320px;
  }

  .db-toggle-btn:hover:not(.active) {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: white !important;
  }

  .db-toggle-btn.active {
    background-color: #01534d !important;
    color: white !important;
  }

  .db-amount-btn:hover:not(.active) {
    background-color: rgba(255, 255, 255, 0.2) !important;
    border-color: white !important;
  }

  .db-amount-btn.active {
    background-color: white !important;
    color: #01534d !important;
    border-color: white !important;
  }

  .db-custom-amount:focus {
    outline: none;
    border-color: white;
    background-color: rgba(255, 255, 255, 0.2);
  }

  .db-custom-amount::-webkit-inner-spin-button,
  .db-custom-amount::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .db-fund-type:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(1, 83, 77, 0.3);
  }

  .db-donate-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(196, 30, 58, 0.4);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.donation-box-most-needed').forEach((box) => {
      const toggleBtns = box.querySelectorAll('.db-toggle-btn');
      const amountBtns = box.querySelectorAll('.db-amount-btn');
      const customInput = box.querySelector('.db-custom-amount') as HTMLInputElement;
      const donateBtn = box.querySelector('.db-donate-btn');
      const campaignSlug = box.getAttribute('data-campaign');

      let selectedAmount = 100;
      let isMonthly = false;

      // Toggle buttons (Single/Monthly)
      toggleBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          toggleBtns.forEach(b => {
            b.classList.remove('active');
            (b as HTMLElement).style.backgroundColor = 'transparent';
            (b as HTMLElement).style.color = 'rgba(255,255,255,0.7)';
          });
          btn.classList.add('active');
          (btn as HTMLElement).style.backgroundColor = '#01534d';
          (btn as HTMLElement).style.color = 'white';
          isMonthly = btn.getAttribute('data-frequency') === 'monthly';
        });
      });

      // Amount buttons
      amountBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          amountBtns.forEach(b => {
            b.classList.remove('active');
            (b as HTMLElement).style.backgroundColor = 'transparent';
            (b as HTMLElement).style.color = 'white';
            (b as HTMLElement).style.borderColor = 'rgba(255,255,255,0.5)';
          });
          btn.classList.add('active');
          (btn as HTMLElement).style.backgroundColor = 'white';
          (btn as HTMLElement).style.color = '#01534d';
          (btn as HTMLElement).style.borderColor = 'white';
          selectedAmount = parseInt(btn.getAttribute('data-amount') || '100');
          if (customInput) customInput.value = '';
        });
      });

      // Custom amount input
      customInput?.addEventListener('input', () => {
        if (customInput.value) {
          amountBtns.forEach(b => {
            b.classList.remove('active');
            (b as HTMLElement).style.backgroundColor = 'transparent';
            (b as HTMLElement).style.color = 'white';
            (b as HTMLElement).style.borderColor = 'rgba(255,255,255,0.5)';
          });
          selectedAmount = parseInt(customInput.value) || 0;
        }
      });

      // Donate button
      donateBtn?.addEventListener('click', async () => {
        if (selectedAmount <= 0) {
          alert('Please select or enter an amount');
          return;
        }

        const fundType = (box.querySelector('.db-fund-type') as HTMLSelectElement)?.value || 'general-donation';

        try {
          // Call checkout API
          const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              campaignSlug,
              amountCents: selectedAmount * 100,
              frequency: isMonthly ? 'monthly' : 'single',
              fundType,
            }),
          });

          const data = await response.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            alert(data.error || 'Something went wrong. Please try again.');
          }
        } catch (error) {
          console.error('Checkout error:', error);
          alert('Unable to process donation. Please try again.');
        }
      });
    });
  });
</script>
