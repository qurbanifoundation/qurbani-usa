---
import '../styles/global.css'
import SEO from '../components/SEO.astro';
import DonationCart from '../components/DonationCart.astro';
import { getSettings } from '../lib/settings';

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  canonicalUrl?: string;
  noindex?: boolean;
  campaign?: {
    meta_title?: string;
    meta_description?: string;
    og_image_url?: string;
    canonical_url?: string;
  };
}

const { title, description, ogImage, canonicalUrl, noindex, campaign } = Astro.props;
const settings = await getSettings();

// Determine favicon - use admin setting if available, otherwise fallback to local file
const adminFavicon = settings.site_favicon;
const faviconHref = adminFavicon || '/favicon.png';
const faviconType = adminFavicon
  ? (adminFavicon.endsWith('.svg') ? 'image/svg+xml' : adminFavicon.endsWith('.ico') ? 'image/x-icon' : 'image/png')
  : 'image/png';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Analytics 4 + Google Ads Conversion Tracking -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-0WC0W1PBKC"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // GA4 Config
      gtag('config', 'G-0WC0W1PBKC', {
        send_page_view: true,
        cookie_flags: 'SameSite=None;Secure'
      });

      // Google Ads Config
      gtag('config', 'AW-793369119');

      // E-commerce tracking helper functions
      window.trackAddToCart = function(item) {
        gtag('event', 'add_to_cart', {
          currency: 'USD',
          value: item.amount * (item.quantity || 1),
          items: [{
            item_id: item.id || item.slug,
            item_name: item.name,
            item_category: item.campaign || 'donation',
            price: item.amount,
            quantity: item.quantity || 1
          }]
        });
      };

      window.trackBeginCheckout = function(items, total) {
        gtag('event', 'begin_checkout', {
          currency: 'USD',
          value: total,
          items: items.map(function(item) {
            return {
              item_id: item.id || item.slug,
              item_name: item.name,
              item_category: item.campaign || 'donation',
              price: item.amount,
              quantity: item.quantity || 1
            };
          })
        });
      };

      window.trackPurchase = function(transactionId, items, total) {
        // GA4 Purchase Event
        gtag('event', 'purchase', {
          transaction_id: transactionId,
          currency: 'USD',
          value: total,
          items: items.map(function(item) {
            return {
              item_id: item.id || item.slug,
              item_name: item.name,
              item_category: item.campaign || 'donation',
              price: item.amount,
              quantity: item.quantity || 1
            };
          })
        });

        // Google Ads Conversion - Real-time tracking
        gtag('event', 'conversion', {
          'send_to': 'AW-793369119/2lawCM74xKcBEJ-0p_oC',
          'value': total,
          'currency': 'USD',
          'transaction_id': transactionId
        });
      };

      // View item (campaign/appeal page)
      window.trackViewItem = function(item) {
        gtag('event', 'view_item', {
          currency: 'USD',
          value: item.amount || 0,
          items: [{
            item_id: item.id || item.slug,
            item_name: item.name,
            item_category: item.campaign || item.category || 'donation',
            price: item.amount || 0
          }]
        });
      };

      // View cart
      window.trackViewCart = function(items, total) {
        gtag('event', 'view_cart', {
          currency: 'USD',
          value: total,
          items: items.map(function(item) {
            return {
              item_id: item.id || item.slug,
              item_name: item.name,
              item_category: item.campaign || 'donation',
              price: item.amount,
              quantity: item.quantity || 1
            };
          })
        });
      };

      // Remove from cart
      window.trackRemoveFromCart = function(item) {
        gtag('event', 'remove_from_cart', {
          currency: 'USD',
          value: item.amount * (item.quantity || 1),
          items: [{
            item_id: item.id || item.slug,
            item_name: item.name,
            item_category: item.campaign || 'donation',
            price: item.amount,
            quantity: item.quantity || 1
          }]
        });
      };

      // Add payment info (step 2 of checkout)
      window.trackAddPaymentInfo = function(items, total, paymentType) {
        gtag('event', 'add_payment_info', {
          currency: 'USD',
          value: total,
          payment_type: paymentType || 'credit_card',
          items: items.map(function(item) {
            return {
              item_id: item.id || item.slug,
              item_name: item.name,
              item_category: item.campaign || 'donation',
              price: item.amount,
              quantity: item.quantity || 1
            };
          })
        });
      };

      // Custom donation events
      window.trackDonationEvent = function(eventName, params) {
        gtag('event', eventName, params);
      };
    </script>
    <link rel="icon" type={faviconType} href={faviconHref} />
    <link rel="alternate icon" href="/favicon.ico" />

    <SEO
      title={title}
      description={description}
      ogImage={ogImage}
      canonicalUrl={canonicalUrl}
      noindex={noindex}
      campaign={campaign}
    />

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://images.unsplash.com" />

    <!-- Google Fonts: Signika, Lato & Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Oswald:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Signika:wght@400;500;600;700&display=swap" rel="stylesheet" />
  </head>
  <body class="bg-stone-50 text-stone-900 antialiased">
    <slot />
    <DonationCart />

    <!-- Mobile auto-scroll to donation box on page load -->
    <script is:inline>
      (function() {
        if (window.innerWidth >= 768) return;
        // Only on fresh navigations, not back/forward
        if (window.performance) {
          var nav = window.performance.getEntriesByType('navigation');
          if (nav.length && nav[0].type === 'back_forward') return;
        }
        // Don't scroll if there's already a hash in the URL
        if (window.location.hash) return;

        function scrollToDonate() {
          var target = document.querySelector('[data-mobile-donate]');
          if (!target) return;
          setTimeout(function() {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 300);
        }

        // DOM is already loaded since this script is at end of body
        scrollToDonate();
      })();
    </script>
  </body>
</html>
