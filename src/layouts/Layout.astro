---
import '../styles/global.css'
import SEO from '../components/SEO.astro';
import DonationCart from '../components/DonationCart.astro';
import { getSettings } from '../lib/settings';

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  canonicalUrl?: string;
  noindex?: boolean;
  campaign?: {
    meta_title?: string;
    meta_description?: string;
    og_image_url?: string;
    canonical_url?: string;
  };
}

const { title, description, ogImage, canonicalUrl, noindex, campaign } = Astro.props;
const settings = await getSettings();

// Determine favicon - use admin setting if available, otherwise fallback to local file
const adminFavicon = settings.site_favicon;
const faviconHref = adminFavicon || '/favicon.png';
const faviconType = adminFavicon
  ? (adminFavicon.endsWith('.svg') ? 'image/svg+xml' : adminFavicon.endsWith('.ico') ? 'image/x-icon' : 'image/png')
  : 'image/png';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Analytics 4 -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-0WC0W1PBKC"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0WC0W1PBKC', {
        send_page_view: true,
        cookie_flags: 'SameSite=None;Secure'
      });

      // E-commerce tracking helper functions
      window.trackAddToCart = function(item) {
        gtag('event', 'add_to_cart', {
          currency: 'USD',
          value: item.amount * (item.quantity || 1),
          items: [{
            item_id: item.id || item.slug,
            item_name: item.name,
            item_category: item.campaign || 'donation',
            price: item.amount,
            quantity: item.quantity || 1
          }]
        });
      };

      window.trackBeginCheckout = function(items, total) {
        gtag('event', 'begin_checkout', {
          currency: 'USD',
          value: total,
          items: items.map(function(item) {
            return {
              item_id: item.id || item.slug,
              item_name: item.name,
              item_category: item.campaign || 'donation',
              price: item.amount,
              quantity: item.quantity || 1
            };
          })
        });
      };

      window.trackPurchase = function(transactionId, items, total) {
        gtag('event', 'purchase', {
          transaction_id: transactionId,
          currency: 'USD',
          value: total,
          items: items.map(function(item) {
            return {
              item_id: item.id || item.slug,
              item_name: item.name,
              item_category: item.campaign || 'donation',
              price: item.amount,
              quantity: item.quantity || 1
            };
          })
        });
      };
    </script>
    <link rel="icon" type={faviconType} href={faviconHref} />
    <link rel="alternate icon" href="/favicon.ico" />

    <SEO
      title={title}
      description={description}
      ogImage={ogImage}
      canonicalUrl={canonicalUrl}
      noindex={noindex}
      campaign={campaign}
    />

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://images.unsplash.com" />

    <!-- Google Fonts: Signika, Lato & Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Oswald:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Signika:wght@400;500;600;700&display=swap" rel="stylesheet" />
  </head>
  <body class="bg-stone-50 text-stone-900 antialiased">
    <slot />
    <DonationCart />
  </body>
</html>
